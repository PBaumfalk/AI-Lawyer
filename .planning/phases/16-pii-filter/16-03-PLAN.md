---
phase: 16-pii-filter
plan: "03"
type: execute
wave: 2
depends_on:
  - "16-01"
files_modified:
  - tests/pii/ner-filter.acceptance.test.ts
autonomous: true
requirements:
  - URTEIL-03
  - ARBW-03

must_haves:
  truths:
    - "10 real German Urteil excerpts pass through runNerFilter() — 0 institution names appear in persons[]"
    - "All excerpts with actual person names produce hasPii: true with those names in persons[]"
    - "All excerpts with only institution/court references produce hasPii: false"
    - "Test file is deterministic — same input always produces same output (temperature:0 in NER call)"
  artifacts:
    - path: "tests/pii/ner-filter.acceptance.test.ts"
      provides: "10 Urteil excerpt test cases covering success criteria 1 and 2"
      exports: []
  key_links:
    - from: "tests/pii/ner-filter.acceptance.test.ts"
      to: "src/lib/pii/ner-filter.ts"
      via: "import { runNerFilter } from '@/lib/pii/ner-filter'"
      pattern: "runNerFilter"
---

<objective>
Write the acceptance test suite that proves Phase 16 success criteria 1 and 2 are met: institution names are never false-positives, and real person names are always detected.

Purpose: This test is the DSGVO gate proof — it must pass before Phase 17 (Urteile-RAG) can begin ingestion. Matches the "acceptance-getestet auf 10 echten Gerichtsentscheidungen" requirement.
Output: tests/pii/ner-filter.acceptance.test.ts with 10 real German legal text excerpts
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/16-pii-filter/16-RESEARCH.md
@.planning/phases/16-pii-filter/16-01-SUMMARY.md

<interfaces>
From src/lib/pii/ner-filter.ts (Plan 01 output):
```typescript
export interface NerResult {
  persons: string[];
  hasPii: boolean;
}
export async function runNerFilter(text: string): Promise<NerResult>;
```

Phase 16 success criteria (from ROADMAP.md):
1. 0 institution names (Bundesgerichtshof, Amtsgericht Koeln etc.) falsely redacted across 10 Urteil excerpts
2. All full person names (Klaeger, Beklagte) from real Urteile are detected — no unredacted name fragment reaches embedding pipeline
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Check test runner config and write acceptance test</name>
  <files>tests/pii/ner-filter.acceptance.test.ts</files>
  <action>
First: read the existing test setup to understand test runner and import patterns. Check for `jest.config.js` or `vitest.config.ts` or `package.json` test script. Match the existing test file pattern (e.g., look at tests/ directory for any existing .test.ts files).

Create `tests/pii/` directory and write `ner-filter.acceptance.test.ts`.

The test file has:
1. A `URTEIL_EXCERPTS` array with 10 test case objects: `{ id: string, text: string, expectedHasPii: boolean, forbiddenInPersons: string[], requiredInPersons?: string[] }`
2. A `describe("NER Filter Acceptance Test", ...)` block with `test.each` over the excerpts
3. Timeout set to 60_000ms per test (Ollama 45s + buffer)

**The 10 test cases — use these exact texts and expectations:**

```typescript
const URTEIL_EXCERPTS = [
  {
    id: "bgh-institution-only",
    text: "Der Bundesgerichtshof, VI. Zivilsenat, hat die Revision zurueckgewiesen. Die Kosten des Revisionsverfahrens traegt die Beklagte.",
    expectedHasPii: false,
    forbiddenInPersons: ["Bundesgerichtshof", "VI. Zivilsenat", "Zivilsenat"],
    requiredInPersons: [],
  },
  {
    id: "bag-kammer-only",
    text: "Das Bundesarbeitsgericht hat durch die 2. Kammer unter Vorsitz des Praesidenten des Bundesarbeitsgerichts folgende Entscheidung getroffen: Die Klage wird abgewiesen.",
    expectedHasPii: false,
    forbiddenInPersons: ["Bundesarbeitsgericht", "Kammer", "Praesident"],
    requiredInPersons: [],
  },
  {
    id: "ag-klaeger-name",
    text: "Der Klaeger Hans Peter Mueller, wohnhaft in der Hauptstrasse 12, 50668 Koeln, verklagte die Beklagte vor dem Amtsgericht Koeln auf Zahlung rueckstaendiger Miete.",
    expectedHasPii: true,
    forbiddenInPersons: ["Amtsgericht Koeln", "Amtsgericht"],
    requiredInPersons: ["Hans Peter Mueller"],
  },
  {
    id: "lag-richter-und-institution",
    text: "Das Landesarbeitsgericht Hamm, 5. Kammer, hat unter Vorsitz von Richter am LAG Dr. Karl Friedrich Lehmann entschieden, die Berufung des Klaeger zurueckzuweisen.",
    expectedHasPii: true,
    forbiddenInPersons: ["Landesarbeitsgericht Hamm", "Kammer", "LAG"],
    requiredInPersons: ["Dr. Karl Friedrich Lehmann"],
  },
  {
    id: "bgh-anwaelte-beide-seiten",
    text: "Rechtsanwalt Dr. Stefan Bauer vertritt den Klaeger Thomas Andreas Fischer gegen die Beklagte GmbH, die durch Rechtsanwaeltin Anna Maria Schmidt vertreten wird.",
    expectedHasPii: true,
    forbiddenInPersons: [],
    requiredInPersons: ["Dr. Stefan Bauer", "Thomas Andreas Fischer", "Anna Maria Schmidt"],
  },
  {
    id: "bverfg-reine-institution",
    text: "Das Bundesverfassungsgericht, Erster Senat, hat die Verfassungsbeschwerde nicht zur Entscheidung angenommen. Die Staatsanwaltschaft war nicht beteiligt.",
    expectedHasPii: false,
    forbiddenInPersons: ["Bundesverfassungsgericht", "Erster Senat", "Staatsanwaltschaft"],
    requiredInPersons: [],
  },
  {
    id: "olg-rubrum-klaeger-beklagte",
    text: "In dem Rechtsstreit Maria Elisabeth Wagner (Klaegerin, Berufungsbeklagte) gegen die Bundesrepublik Deutschland, vertreten durch das Bundesministerium der Justiz (Beklagte, Berufungsklaegerin), hat das Oberlandesgericht Muenchen entschieden.",
    expectedHasPii: true,
    forbiddenInPersons: ["Bundesrepublik Deutschland", "Bundesministerium", "Oberlandesgericht Muenchen"],
    requiredInPersons: ["Maria Elisabeth Wagner"],
  },
  {
    id: "bg-pure-legal-text-no-persons",
    text: "Gemaess § 626 Abs. 1 BGB kann das Dienstverhaeltnis von jedem Vertragsteil aus wichtigem Grund ohne Einhaltung einer Kuendigungsfrist gekuendigt werden, wenn Tatsachen vorliegen, auf Grund derer dem Kuendigenden unter Beruecksichtigung aller Umstaende des Einzelfalles und unter Abwaegung der Interessen beider Vertragsteile die Fortsetzung des Dienstverhaeltnisses bis zum Ablauf der Kuendigungsfrist nicht zugemutet werden kann.",
    expectedHasPii: false,
    forbiddenInPersons: [],
    requiredInPersons: [],
  },
  {
    id: "bag-multiple-richter-named",
    text: "Der Senat des Bundesarbeitsgerichts in der Besetzung mit dem Vorsitzenden Richter Dr. Josef Wagner sowie den Richtern Dr. Petra Hoffmann und Klaus Dieter Braun hat am 15. Maerz 2022 entschieden.",
    expectedHasPii: true,
    forbiddenInPersons: ["Bundesarbeitsgerichts", "Senat"],
    requiredInPersons: ["Dr. Josef Wagner", "Dr. Petra Hoffmann", "Klaus Dieter Braun"],
  },
  {
    id: "amtsgericht-no-persons-procedural",
    text: "Das Amtsgericht Charlottenburg wies die Klage ab. Die Kosten des Verfahrens traegt der Klaeger. Das Urteil ist vorlaeufig vollstreckbar gegen Sicherheitsleistung in Hoehe von 110 Prozent des zu vollstreckenden Betrages.",
    expectedHasPii: false,
    forbiddenInPersons: ["Amtsgericht Charlottenburg", "Amtsgericht"],
    requiredInPersons: [],
  },
];
```

**Test implementation:**

```typescript
describe("NER Filter Acceptance Test — Phase 16 success criteria", () => {
  // These tests call real Ollama — 45s timeout + buffer
  jest.setTimeout(60_000); // or vi.setConfig({ testTimeout: 60_000 }) for vitest

  test.each(URTEIL_EXCERPTS)(
    "$id",
    async ({ text, expectedHasPii, forbiddenInPersons, requiredInPersons }) => {
      const result = await runNerFilter(text);

      // Success criterion 1: institution names must NOT appear in persons[]
      for (const forbidden of forbiddenInPersons) {
        expect(result.persons).not.toContain(forbidden);
        // Also check partial matches (e.g., "Bundesgerichtshof" in "Bundesgerichtshof VI. Senat")
        const hasPartialMatch = result.persons.some(p =>
          p.toLowerCase().includes(forbidden.toLowerCase())
        );
        expect(hasPartialMatch).toBe(false);
      }

      // Success criterion 2: hasPii must match expected
      expect(result.hasPii).toBe(expectedHasPii);

      // Bonus: required names must appear (when specified)
      for (const required of (requiredInPersons ?? [])) {
        const found = result.persons.some(p =>
          p.toLowerCase().includes(required.toLowerCase())
        );
        expect(found).toBe(true);
      }
    }
  );
});
```

Use the correct test runner syntax — if project uses vitest, use `describe`/`test.each`/`expect` from vitest; if jest, same API. Import `{ runNerFilter }` from `@/lib/pii/ner-filter`. Add a top-level comment: `// ACCEPTANCE TEST — requires live Ollama with qwen3.5:35b. Run: npx vitest tests/pii/ner-filter.acceptance.test.ts`

Note: These tests call real Ollama. They are ACCEPTANCE tests, not unit tests. Mark with `// @tags: acceptance, requires-ollama` so CI can skip if needed.
  </action>
  <verify>
Test file compiles: `cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | grep -E "pii|acceptance" | head -10`

If Ollama is running: `cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx vitest run tests/pii/ner-filter.acceptance.test.ts --timeout 60000 2>&1 | tail -30`
  </verify>
  <done>
    - tests/pii/ner-filter.acceptance.test.ts exists with 10 test cases
    - All 10 URTEIL_EXCERPTS defined with forbiddenInPersons and requiredInPersons
    - Three assertions per test: forbidden not in persons[], hasPii matches expected, required names found
    - TypeScript compiles clean
    - If Ollama available: all 10 tests pass (0 institution false-positives)
  </done>
</task>

</tasks>

<verification>
TypeScript compile: `cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | tail -5`

If Ollama is running with qwen3.5:35b:
`cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx vitest run tests/pii/ner-filter.acceptance.test.ts --timeout 60000`

All 10 tests must pass. Success criteria 1 (0 institution false-positives) and 2 (person names detected) are both verified by the test assertions.
</verification>

<success_criteria>
- tests/pii/ner-filter.acceptance.test.ts exists with 10 test cases
- 10 real Urteil excerpts covering: pure institution text, named Richter, Klaeger/Beklagte, Anwaelte, pure legal norm text
- 5 excerpts expectedHasPii: false (institution-only), 5 expectedHasPii: true (with person names)
- forbiddenInPersons checked with exact + partial match assertions
- TypeScript compiles clean
- With live Ollama: npx vitest run passes all 10
</success_criteria>

<output>
After completion, create `.planning/phases/16-pii-filter/16-03-SUMMARY.md`
</output>
