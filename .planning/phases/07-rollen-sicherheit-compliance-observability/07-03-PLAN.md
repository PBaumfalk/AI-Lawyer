---
phase: 07-rollen-sicherheit-compliance-observability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/dezernat-dialog.tsx
  - src/app/(dashboard)/admin/dezernate/page.tsx
  - src/app/(dashboard)/akten/[id]/page.tsx
  - src/components/admin/admin-override-dialog.tsx
autonomous: true
requirements: [REQ-RS-001, REQ-RS-002, REQ-RS-003, REQ-RS-004, REQ-RS-005, REQ-RS-006]
gap_closure: true

must_haves:
  truths:
    - "Admin can click 'Zugriff uebernehmen' on any Akte detail page and create an AdminOverride with a reason"
    - "Admin can see a list of their active overrides and revoke them"
    - "Admin can assign Akten to a Dezernat via the Dezernat edit dialog"
    - "Admin can remove Akten from a Dezernat via the Dezernat edit dialog"
  artifacts:
    - path: "src/components/admin/admin-override-dialog.tsx"
      provides: "Admin Override creation dialog with grund field"
      min_lines: 60
    - path: "src/components/admin/dezernat-dialog.tsx"
      provides: "Dezernat dialog with both member and Akte multi-select"
      contains: "selectedAkten"
    - path: "src/app/(dashboard)/akten/[id]/page.tsx"
      provides: "Akte detail page with admin override button"
      contains: "AdminOverrideDialog"
  key_links:
    - from: "src/components/admin/admin-override-dialog.tsx"
      to: "/api/admin/override"
      via: "fetch POST with akteId and grund"
      pattern: "fetch.*api/admin/override"
    - from: "src/components/admin/dezernat-dialog.tsx"
      to: "/api/admin/dezernate/[id]"
      via: "PATCH with addAkten/removeAkten"
      pattern: "addAkten|removeAkten"
    - from: "src/app/(dashboard)/akten/[id]/page.tsx"
      to: "src/components/admin/admin-override-dialog.tsx"
      via: "import and render AdminOverrideDialog"
      pattern: "AdminOverrideDialog"
---

<objective>
Close two verification gaps from Phase 7: (1) Admin Override UI missing — add a "Zugriff uebernehmen" button on the Akte detail page that calls POST /api/admin/override with a grund field, plus a list of active overrides with revoke capability; (2) Dezernat dialog missing Akte assignment — add an Akte multi-select field to the DezernatDialog that calls addAkten/removeAkten via PATCH /api/admin/dezernate/[id].

Purpose: Both gaps make REQ-RS-001 (Akten-Zugriff via Dezernate + Admin-Override) partially unusable from the UI despite the API layer being complete.
Output: Two UI components wired to existing APIs, closing all verification gaps.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-01-SUMMARY.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-VERIFICATION.md

Key existing code:
@src/app/api/admin/override/route.ts
@src/app/api/admin/dezernate/[id]/route.ts
@src/components/admin/dezernat-dialog.tsx
@src/app/(dashboard)/akten/[id]/page.tsx
@src/app/(dashboard)/admin/dezernate/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin Override UI on Akte detail page + active overrides list on Dezernate page</name>
  <files>
    src/components/admin/admin-override-dialog.tsx
    src/app/(dashboard)/akten/[id]/page.tsx
    src/app/(dashboard)/admin/dezernate/page.tsx
  </files>
  <action>
**1. Create `src/components/admin/admin-override-dialog.tsx`:**
A client component ("use client") dialog/modal that:
- Accepts props: `{ open, onOpenChange, akteId, aktenzeichen }`
- Shows a form with a required `grund` textarea (reason for override) and an optional `gueltigBis` date input
- On submit, calls `POST /api/admin/override` with `{ akteId, grund, gueltigBis? }` body
- Shows success/error feedback
- Calls `onOpenChange(false)` on success
- Use the same modal pattern as `dezernat-dialog.tsx` (fixed inset-0 z-50 overlay with centered card)
- Import X from lucide-react for close button, keep styling consistent with existing dialogs

**2. Modify `src/app/(dashboard)/akten/[id]/page.tsx`:**
- Import the new `AdminOverrideDialog` component
- Import `useSession` is NOT possible here (server component), so instead create a small client component wrapper `AdminOverrideButton` inline or at bottom of file that:
  - Uses `useSession()` to check if `session.user.role === "ADMIN"`
  - If ADMIN, renders a button: "Zugriff uebernehmen" with Shield icon from lucide-react
  - Clicking opens AdminOverrideDialog with akteId and aktenzeichen from props
  - Also fetches `GET /api/admin/override` on mount to check if override already exists for this Akte, and if so shows "Zugriff aktiv" badge instead with a "Zugriff aufheben" button that calls `DELETE /api/admin/override?id={overrideId}`
- Place the AdminOverrideButton in the header area after the Helena quick action section, before the stats row
- The AdminOverrideButton component receives akteId and aktenzeichen as props from the server component

**3. Add active overrides list on `/admin/dezernate/page.tsx`:**
- Add a section below the Dezernate grid titled "Aktive Admin-Zugriffsueberschreibungen"
- Fetch `GET /api/admin/override` on mount (alongside dezernate fetch)
- Display as a simple list/table: Akte (aktenzeichen + kurzrubrum), Grund, Erstellt am, with a "Aufheben" button per entry that calls `DELETE /api/admin/override?id={id}`
- Show empty state if no active overrides
- This gives admins a central place to see and manage all their overrides
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | tail -20</automated>
    <manual>Navigate to an Akte detail page as ADMIN and verify the "Zugriff uebernehmen" button appears. Navigate to /admin/dezernate and verify the active overrides section is visible.</manual>
  </verify>
  <done>
- AdminOverrideDialog component exists and renders a form with grund + optional gueltigBis
- Akte detail page shows "Zugriff uebernehmen" button for ADMIN users that opens the dialog
- If an override already exists for the Akte, shows "Zugriff aktiv" with revoke option
- /admin/dezernate page shows a list of active admin overrides with revoke capability
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Akte multi-select to DezernatDialog</name>
  <files>
    src/components/admin/dezernat-dialog.tsx
    src/app/(dashboard)/admin/dezernate/page.tsx
  </files>
  <action>
**1. Modify `src/components/admin/dezernat-dialog.tsx`:**

Extend the DezernatData interface to include akten:
```typescript
interface DezernatData {
  id: string;
  name: string;
  beschreibung: string | null;
  mitglieder: { id: string; name: string; email: string; role: string }[];
  akten: { id: string; aktenzeichen: string; kurzrubrum: string | null; status: string }[];
}
```

Add Akte selection state and loading:
- Add `selectedAkten: string[]` state (initialized from `dezernat.akten.map(a => a.id)` in edit mode)
- Add `availableAkten: AkteOption[]` state with interface `{ id: string; aktenzeichen: string; kurzrubrum: string | null }`
- Fetch available Akten from `GET /api/akten` on dialog open (same pattern as loading users)
- Add a search/filter input above the Akten list for quick filtering by aktenzeichen or kurzrubrum (client-side filter of the loaded list)

Add Akten multi-select section below the Mitglieder section:
- Label: "Zugewiesene Akten ({selectedAkten.length} ausgewaehlt)"
- Scrollable checkbox list (same visual pattern as the Mitglieder checkboxes) with each entry showing aktenzeichen and kurzrubrum
- `toggleAkte(akteId)` function mirroring `toggleMember`
- A small text filter input above the list that filters `availableAkten` by aktenzeichen or kurzrubrum (case-insensitive includes)

Update the handleSave function for the update path:
- Compute `addAkten` and `removeAkten` diff arrays (same pattern as addMitglieder/removeMitglieder)
- Include `addAkten` and `removeAkten` in the PATCH body

For the create path:
- After creating the new Dezernat, if `selectedAkten.length > 0`, send a follow-up PATCH to assign Akten (same pattern as the existing member assignment after create)

**2. Modify `src/app/(dashboard)/admin/dezernate/page.tsx`:**
- Update the Dezernat interface to include `akten` array (matching the GET /api/admin/dezernate response — the list endpoint already includes counts but not full akten data)
- The GET /api/admin/dezernate list response may not include full akten array by default. If that is the case, the DezernatDialog should fetch the full Dezernat detail from `GET /api/admin/dezernate/{id}` when editing (on dialog open in edit mode) to get the current akten list. This is more reliable than depending on the list endpoint.
- Update DezernatDialog `dezernat` prop to allow the extended type with akten
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | tail -20</automated>
    <manual>Open the Dezernat edit dialog, verify an "Zugewiesene Akten" section appears below Mitglieder with a searchable checkbox list. Select/deselect Akten and save — verify the Dezernat's Akten count updates on the card.</manual>
  </verify>
  <done>
- DezernatDialog has a searchable Akten multi-select section below the Mitglieder section
- In edit mode, currently assigned Akten are pre-selected
- Saving sends addAkten/removeAkten in the PATCH body
- In create mode, Akten can be assigned after initial creation
- The Akten list is filterable by aktenzeichen or kurzrubrum
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Admin Override UI: Akte detail page shows override button for ADMIN, dialog submits to POST /api/admin/override, active overrides visible on /admin/dezernate
3. Dezernat Akte assignment: DezernatDialog has Akten multi-select, save sends addAkten/removeAkten to PATCH endpoint
4. All 18/18 must-haves from 07-VERIFICATION.md now pass (the 2 partial truths are resolved)
</verification>

<success_criteria>
- Both verification gaps from 07-VERIFICATION.md are closed
- REQ-RS-001 is fully satisfied (Admin-Override UI + Dezernat Akte assignment both functional)
- No TypeScript errors introduced
- Existing functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/07-rollen-sicherheit-compliance-observability/07-03-SUMMARY.md`
</output>
