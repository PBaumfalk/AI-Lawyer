---
phase: 02-deadline-calculation-document-templates
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - prisma/schema.prisma
  - src/app/api/fristen/rechner/route.ts
  - src/app/api/fristen/presets/route.ts
  - src/app/api/kalender/route.ts
  - src/app/api/kalender/[id]/erledigt/route.ts
  - src/app/api/kalender/[id]/verlaengerung/route.ts
  - src/components/fristen/fristenrechner-sheet.tsx
  - src/components/fristen/fristenrechner-form.tsx
  - src/components/fristen/fristenrechner-ergebnis.tsx
  - src/components/fristen/fristen-ampel.tsx
  - src/components/fristen/tagesuebersicht.tsx
  - src/components/kalender/kalender-eintrag-dialog.tsx
  - src/workers/processors/frist-reminder.ts
  - src/lib/queues.ts
autonomous: true
requirements:
  - REQ-FK-003
  - REQ-FK-004
  - REQ-FK-005

must_haves:
  truths:
    - "KalenderEintrag model has prioritaet (5 levels), fristArt, bundesland, istNotfrist, quittiert, erledigungsgrund, vorfristen array, halbfrist, hauptfrist relation, sachbearbeiterId, serienId, serienRegel, dokumentIds"
    - "Fristen API calculates deadlines using the FristenRechner library and returns detailed breakdown"
    - "FristenRechner sidebar sheet opens from Cmd+K and dedicated shortcut, shows presets, allows manual input, displays detailed result with Ampel color"
    - "Tagesuebersicht dashboard widget shows today's Fristen (with Ampel), Wiedervorlagen, and Termine sorted by urgency"
    - "Warn-Ampel uses correct colors: green (>7d), yellow (3-7d), red (<3d), black (overdue)"
    - "BullMQ frist-reminder job checks for upcoming deadlines and sends notifications via existing notification service"
    - "Erledigungsgrund is mandatory when marking a Frist as done"
    - "Fristverlaengerung workflow preserves old Fristende in history and recalculates Vorfristen"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Enhanced KalenderEintrag with Frist fields, FristPrioritaet enum, FristPreset model, new relations"
      contains: "enum FristPrioritaet"
    - path: "src/app/api/fristen/rechner/route.ts"
      provides: "POST endpoint for deadline calculation"
      exports: ["POST"]
    - path: "src/app/api/fristen/presets/route.ts"
      provides: "CRUD for Fristen-Presets (admin-managed)"
      exports: ["GET", "POST", "PUT", "DELETE"]
    - path: "src/components/fristen/fristenrechner-sheet.tsx"
      provides: "Sidebar Sheet (~600px) with FristenRechner form + result"
      min_lines: 80
    - path: "src/components/fristen/fristen-ampel.tsx"
      provides: "Color-coded deadline indicator component"
      exports: ["FristenAmpel"]
    - path: "src/components/fristen/tagesuebersicht.tsx"
      provides: "Dashboard widget showing today's deadlines, WV, and appointments"
      exports: ["Tagesuebersicht"]
    - path: "src/workers/processors/frist-reminder.ts"
      provides: "BullMQ processor for deadline reminder notifications"
      exports: ["processFristReminder"]
  key_links:
    - from: "src/app/api/fristen/rechner/route.ts"
      to: "src/lib/fristen/rechner.ts"
      via: "import berechneFrist"
      pattern: "import.*berechneFrist.*from.*lib/fristen"
    - from: "src/components/fristen/fristenrechner-sheet.tsx"
      to: "src/app/api/fristen/rechner/route.ts"
      via: "fetch POST /api/fristen/rechner"
      pattern: "fetch.*api/fristen/rechner"
    - from: "src/workers/processors/frist-reminder.ts"
      to: "src/lib/notifications"
      via: "createNotification from Phase 1 notification service"
      pattern: "createNotification"
    - from: "src/components/fristen/fristen-ampel.tsx"
      to: "date-fns"
      via: "differenceInDays for color calculation"
      pattern: "differenceInDays"
---

<objective>
Add Prisma schema enhancements for Fristen/Kalender, build the FristenRechner UI (sidebar sheet + inline), Tagesuebersicht dashboard widget, Warn-Ampel, Vorfristen reminder worker, and deadline management workflows (Erledigung with mandatory reason, Fristverlaengerung).

Purpose: Attorneys need a daily-use power tool for deadline calculation accessible from anywhere (Cmd+K, calendar form), plus a morning overview of all due items. The Warn-Ampel (green/yellow/red/black) provides instant visual risk assessment. The BullMQ reminder job ensures no deadline is missed.

Output: Enhanced schema, Fristen API endpoints, FristenRechner UI components, Tagesuebersicht widget, reminder worker processor.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md
@.planning/phases/02-deadline-calculation-document-templates/02-01-SUMMARY.md

@prisma/schema.prisma
@src/lib/queues.ts
@src/workers/processors/
@src/lib/fristen/index.ts
@src/components/kalender/
@src/app/api/kalender/route.ts
@src/app/(dashboard)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema Enhancements + Fristen API + Presets CRUD + Reminder Worker</name>
  <files>
    prisma/schema.prisma,
    src/app/api/fristen/rechner/route.ts,
    src/app/api/fristen/presets/route.ts,
    src/app/api/kalender/route.ts,
    src/app/api/kalender/[id]/erledigt/route.ts,
    src/app/api/kalender/[id]/verlaengerung/route.ts,
    src/workers/processors/frist-reminder.ts,
    src/lib/queues.ts
  </files>
  <action>
    **1. Prisma Schema (prisma/schema.prisma):**
    Add `FristPrioritaet` enum: SEHR_NIEDRIG, NIEDRIG, NORMAL, HOCH, DRINGEND.
    Enhance `KalenderEintrag` model with:
    - `prioritaet FristPrioritaet @default(NORMAL)`
    - `fristArt String?` (EREIGNISFRIST | BEGINNFRIST)
    - `bundesland String?` (BundeslandCode)
    - `istNotfrist Boolean @default(false)`
    - `quittiert Boolean @default(false)`, `quittiertAm DateTime?`, `quittiertVonId String?`
    - `erledigungsgrund String?` (MANDATORY when erledigt=true -- enforced in API)
    - `vorfristen DateTime[]` (array of pre-deadline dates)
    - `halbfrist DateTime?`
    - Self-relation for Hauptfrist/Vorfrist: `hauptfristId String?`, `hauptfrist KalenderEintrag? @relation("VorfristZuHauptfrist", ...)`, `vorfristEintraege KalenderEintrag[] @relation("VorfristZuHauptfrist")`
    - `sachbearbeiterId String?` with User relation
    - `serienId String?`, `serienRegel String?` for recurring events
    - `dokumentIds String[]` for linked documents
    Add indexes on `prioritaet`, `istNotfrist`, `hauptfristId`.

    Add `FristPreset` model: id, name, fristArt, dauerWochen/Monate/Tage (Int?), istNotfrist, defaultVorfristen (Int[]), kategorie, beschreibung, sortierung, aktiv, createdAt, updatedAt.

    Run `npx prisma db push` to apply.

    **2. Fristen Rechner API (src/app/api/fristen/rechner/route.ts):**
    POST endpoint accepting: `{ zustellungsdatum, fristArt, dauer, bundesland, section193, richtung?, presetId? }`.
    Validate with zod. Call `berechneFrist()` or `berechneFristRueckwaerts()` from the lib. Also call `berechneVorfristen()` and `berechneHalbfrist()`. Return full FristErgebnis with Vorfristen and Halbfrist.
    If `presetId` provided, load preset from DB and use its defaults (overridable).
    Auth required (any authenticated user).

    **3. Presets CRUD API (src/app/api/fristen/presets/route.ts):**
    GET: List all active presets (sorted by sortierung). Any authenticated user.
    POST: Create preset. ADMIN only.
    PUT: Update preset. ADMIN only.
    DELETE: Soft-delete (set aktiv=false). ADMIN only.
    Seed default presets on first GET if none exist (using DEFAULT_FRISTEN_PRESETS from lib).

    **4. Enhanced Kalender API (src/app/api/kalender/route.ts):**
    Extend existing POST/PUT to accept new fields (prioritaet, fristArt, bundesland, istNotfrist, vorfristen, halbfrist, sachbearbeiterId, dokumentIds).
    Extend GET to support filtering by prioritaet, istNotfrist, erledigt, and date range.
    When creating a FRIST type entry with vorfristen, also create child KalenderEintrag records (typ=FRIST, linked via hauptfristId) for each Vorfrist date.

    **5. Erledigt Endpoint (src/app/api/kalender/[id]/erledigt/route.ts):**
    PATCH: Mark as erledigt. Body: `{ erledigungsgrund: string }`. Validate erledigungsgrund is not empty for FRIST typ entries (mandatory per user decision). Update erledigt=true, erledigtAm=now(). Log to audit trail.
    For overdue Fristen (past datum): require additional `ueberschreitungsgrund` field.

    **6. Verlaengerung Endpoint (src/app/api/kalender/[id]/verlaengerung/route.ts):**
    POST: Extend a deadline. Body: `{ neueDauer: FristDauer }`. Old Fristende stays in history (store in a `fristHistorie` JSON field or create audit entry). Recalculate new endDatum using berechneFrist(). Recalculate all Vorfristen + Halbfrist. Update child Vorfrist calendar entries. Mark old Vorfrist entries as "veraltet" (erledigt=true, erledigungsgrund="Frist verlaengert").

    **7. BullMQ Frist Reminder (src/workers/processors/frist-reminder.ts + src/lib/queues.ts):**
    Add `fristReminderQueue` to queues.ts (follow existing pattern from Phase 1).
    Create processor: queries DB for KalenderEintraege where typ=FRIST, erledigt=false, and vorfristen dates match today (or within window). For each match, call `createNotification()` (existing from Phase 1) with appropriate urgency. Handle escalation: if Vorfrist unquittiert for X hours, notify Vertreter/Admin (read escalation config from SystemSettings).
    Register repeatable job: `*/5 7-19 * * 1-5` (every 5 min, Mon-Fri 7-19h -- per Kanzlei-Arbeitszeiten, loaded from settings).
    Also check for overdue Fristen (datum < now, erledigt=false) and send alarm to Verantwortlicher + Admin.
  </action>
  <verify>
    <automated>npx prisma db push --accept-data-loss 2>&1 | tail -5 && curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/fristen/presets</automated>
    <manual>Verify schema compiles and API endpoints respond</manual>
  </verify>
  <done>Schema has all new Fristen fields and FristPreset model. Fristen rechner API returns correct calculations. Presets CRUD works. Erledigt requires reason. Verlaengerung preserves history. Reminder worker registered.</done>
</task>

<task type="auto">
  <name>Task 2: FristenRechner UI + Tagesuebersicht + Warn-Ampel Components</name>
  <files>
    src/components/fristen/fristenrechner-sheet.tsx,
    src/components/fristen/fristenrechner-form.tsx,
    src/components/fristen/fristenrechner-ergebnis.tsx,
    src/components/fristen/fristen-ampel.tsx,
    src/components/fristen/tagesuebersicht.tsx,
    src/components/kalender/kalender-eintrag-dialog.tsx,
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
    **1. FristenAmpel Component (src/components/fristen/fristen-ampel.tsx):**
    Takes `datum: Date` and `erledigt: boolean` props. Uses `differenceInDays(datum, new Date())` from date-fns.
    Colors per user decision: `>7d = emerald` (green), `3-7d = amber` (yellow), `<3d = rose` (red), `overdue = slate-900` (black/schwarz). Erledigt = slate-400 (greyed out).
    Renders as small colored dot/badge with optional label. Reusable everywhere Fristen are shown (calendar list, Akte header, dashboard, etc.).
    Use existing design system risk colors from CLAUDE.md: niedrig=emerald, mittel=amber, hoch=rose.

    **2. FristenRechner Form (src/components/fristen/fristenrechner-form.tsx):**
    Input form with:
    - Richtung toggle: "Vorwaerts" (Zustellung -> Fristende) / "Rueckwaerts" (Fristende -> Zustellungstermin). Per user decision: both directions supported.
    - Preset dropdown (fetches from /api/fristen/presets). Auto-fills dauer fields but all editable. Validation warning if user overrides preset default: yellow hint "Die uebliche Dauer fuer [Fristtyp] ist [X]. Sie haben [Y] eingetragen."
    - Date picker for Zustellungsdatum (or Fristende in backward mode).
    - Duration fields: Wochen, Monate, Tage (number inputs). Clear grouping.
    - Bundesland selector: All 16 Bundeslaender. Default from Akte's Gericht if linked, else from Kanzlei-default setting (SystemSetting), else NRW.
    - Section 193 toggle (default true).
    - Notfrist checkbox (auto-set from preset). When checked, displays red "NOTFRIST" badge + warning "Diese Frist ist nicht verlaengerbar."
    - Batch mode: checkbox to enable selecting multiple presets simultaneously.
    - Submit button calls POST /api/fristen/rechner.

    **3. FristenRechner Ergebnis (src/components/fristen/fristenrechner-ergebnis.tsx):**
    Displays the full FristErgebnis:
    - Start date, raw end date, final end date (with FristenAmpel color).
    - Each shift reason listed: "Verschoben wegen: Samstag 18.04.2026, Sonntag 19.04.2026".
    - Vorfristen dates with Ampel.
    - Halbfrist date (if applicable).
    - Notfrist badge and warning.
    - "Als Frist speichern" button: opens a mini-form to select Akte (auto-suggest from linked context) and creates KalenderEintrag via POST /api/kalender.
    - In batch mode: all results in overview table, "Alle speichern" button.
    - Historie: Display last 10 calculations (stored in localStorage).

    **4. FristenRechner Sheet (src/components/fristen/fristenrechner-sheet.tsx):**
    Uses shadcn/ui Sheet component (~600px width, opens from right). Contains FristenRechnerForm + FristenRechnerErgebnis.
    Triggered by:
    - Keyboard shortcut (Cmd+Shift+F or similar -- Claude's discretion).
    - Command Palette entry (Cmd+K -> "Frist berechnen").
    Register the shortcut in the app's keyboard handler. Register Command Palette entry.

    **5. Tagesuebersicht Widget (src/components/fristen/tagesuebersicht.tsx):**
    Dashboard widget showing three sections:
    - Fristen: Today's + overdue, each with FristenAmpel, titel, Akte link, Verantwortlicher. Sorted by urgency (overdue first, then by proximity).
    - Wiedervorlagen: Today's WV with blue/yellow visual distinction from Fristen. Different icon.
    - Termine: Today's appointments with Uhrzeit + Ort + Bemerkungen.
    Fetches from GET /api/kalender with date filter. Empty state: "Keine Eintraege fuer heute."
    Quick-Actions per item: "Erledigen" (opens erledigungsgrund dialog for Fristen), "Oeffnen" (navigates to Akte).

    **6. Integrate into Dashboard (src/app/(dashboard)/dashboard/page.tsx):**
    Add Tagesuebersicht widget prominently at top of dashboard page. This should be "the first thing an attorney checks" per user specifics.

    **7. Enhance Kalender Dialog (src/components/kalender/kalender-eintrag-dialog.tsx):**
    Add inline FristenRechner when typ=FRIST is selected. Show prioritaet dropdown (5 levels with colors). Show Bundesland selector. Show Notfrist toggle. Show Vorfristen display. Auto-calculate when fields change.

    Use Tailwind CSS throughout. German UI labels, English code comments. Follow existing component patterns.
  </action>
  <verify>
    <automated>npx next build 2>&1 | tail -10</automated>
    <manual>Open dashboard, verify Tagesuebersicht shows. Open FristenRechner sheet via Cmd+K or shortcut. Enter a deadline, verify Ampel colors and result breakdown.</manual>
  </verify>
  <done>FristenRechner sidebar sheet accessible via keyboard shortcut and Cmd+K. Form supports presets, both directions, all 16 Bundeslaender, Notfrist. Result shows detailed breakdown with Ampel. Tagesuebersicht widget on dashboard shows today's Fristen/WV/Termine. Warn-Ampel uses correct green/yellow/red/black colors.</done>
</task>

</tasks>

<verification>
```bash
# Schema compiles
npx prisma validate

# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build

# FristenRechner tests still pass (from Plan 01)
npx vitest run src/lib/fristen/rechner.test.ts
```
</verification>

<success_criteria>
- KalenderEintrag schema has all new Frist fields (prioritaet, fristArt, bundesland, istNotfrist, quittiert, erledigungsgrund, vorfristen, halbfrist, hauptfrist relation)
- FristPreset model exists and CRUD API works
- FristenRechner API correctly calculates and returns full breakdown
- FristenRechner Sheet opens via keyboard shortcut, displays presets + result with Ampel
- Tagesuebersicht widget is prominent on dashboard
- Warn-Ampel colors: emerald >7d, amber 3-7d, rose <3d, slate-900 overdue
- Erledigungsgrund mandatory for Fristen
- Fristverlaengerung preserves history and recalculates
- BullMQ reminder job registered and processes
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-02-SUMMARY.md`
</output>
