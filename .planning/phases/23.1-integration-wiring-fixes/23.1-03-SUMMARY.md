---
phase: 23.1-integration-wiring-fixes
plan: 03
subsystem: ui
tags: [react, chat, schriftsatz, rueckfragen, useChat, pipeline, frontend]

# Dependency graph
requires:
  - phase: 23.1-integration-wiring-fixes
    plan: 02
    provides: "JSON response type discriminator (schriftsatz_rueckfrage/complete/error/conflict), pending-pipeline CRUD service"
provides:
  - "Custom fetch wrapper for non-streaming pipeline response interception in useChat"
  - "RueckfrageMessage component with round counter and collapsible Bisherige Angaben"
  - "PendingReminderBanner with Verwerfen (dismiss) action"
  - "GET/DELETE /api/ki-chat/pending endpoints for proactive reminder and dismissal"
  - "Schriftsatz metadata embedding pattern (<!--schriftsatz:...--> HTML comment in message content)"
affects: [helena-agent, chat-ui]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Custom fetch wrapper to intercept JSON before useChat stream parser", "HTML comment metadata embedding for pipeline state in chat messages", "setMessagesRef pattern for circular dependency avoidance with useChat"]

key-files:
  created:
    - src/app/api/ki-chat/pending/route.ts
  modified:
    - src/components/ki/chat-layout.tsx
    - src/components/ki/chat-messages.tsx

key-decisions:
  - "Custom fetch wrapper (not onResponse) for JSON interception -- most reliable way to prevent useChat from crashing on non-streaming responses"
  - "HTML comment metadata embedding (<!--schriftsatz:...-->) for pipeline state survives through useChat message state management"
  - "setMessagesRef pattern to avoid circular dependency between custom fetch and useChat destructured setMessages"
  - "Native HTML details element for Bisherige Angaben -- simplest approach for Chrome-only target"

patterns-established:
  - "Custom fetch on useChat for non-streaming response interception with fake empty stream fallback"
  - "HTML comment metadata in message content for pipeline state preservation across React re-renders"

requirements-completed: [ORCH-04]

# Metrics
duration: 4min
completed: 2026-02-27
---

# Phase 23.1 Plan 03: Schriftsatz Rueckfragen Frontend UI Summary

**Custom fetch wrapper intercepting non-streaming pipeline JSON in useChat, RueckfrageMessage with round counter + Bisherige Angaben, PendingReminderBanner with Verwerfen, and proactive reminder API endpoints**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-27T22:51:15Z
- **Completed:** 2026-02-27T22:55:49Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- GET/DELETE /api/ki-chat/pending endpoints for checking and dismissing pending Rueckfragen
- Custom fetch wrapper on useChat intercepts application/json responses and returns fake empty stream to prevent crashes
- Synthetic assistant messages with embedded <!--schriftsatz:{...}--> metadata for pipeline state
- RueckfrageMessage component renders Rueckfrage text with round counter (N/M) and native HTML details for Bisherige Angaben
- PendingReminderBanner with amber styling and Verwerfen button for proactive reminder on Akte open
- Proactive reminder useEffect fetches pending state when selectedAkteId changes
- Copy button strips schriftsatz metadata before writing to clipboard

## Task Commits

Each task was committed atomically:

1. **Task 1: Create pending check API endpoint and add Verwerfen endpoint** - `4c465ab` (feat)
2. **Task 2: Handle non-streaming pipeline responses in chat-layout and render Rueckfragen in chat-messages** - `732fd19` (feat)

## Files Created/Modified
- `src/app/api/ki-chat/pending/route.ts` - GET/DELETE endpoints for pending Rueckfrage check and dismissal
- `src/components/ki/chat-layout.tsx` - Custom fetch wrapper, pendingReminder state, proactive reminder useEffect, Verwerfen handler
- `src/components/ki/chat-messages.tsx` - parseSchriftsatzMeta helper, RueckfrageMessage component, PendingReminderBanner component, Schriftsatz-aware message rendering

## Decisions Made
- Used custom `fetch` option on useChat (not onResponse) for JSON interception -- onResponse cannot reliably prevent useChat from consuming the response body as a stream
- Embedded pipeline metadata as HTML comments (<!--schriftsatz:...-->) in message content -- survives through useChat's message state management and React re-renders
- Used setMessagesRef pattern (ref updated after useChat destructuring) to break circular dependency between custom fetch closure and setMessages
- Used native HTML `<details>` element for Bisherige Angaben collapsible section -- Chrome-only target means no cross-browser concerns
- Returns fake empty ReadableStream when intercepting JSON responses so useChat processes cleanly without errors

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed TypeScript regex dotAll flag compatibility**
- **Found during:** Task 2 (chat-messages.tsx)
- **Issue:** Regex `/s` flag (dotAll) requires ES2018 target; project tsconfig has no explicit target (defaults to lower)
- **Fix:** Replaced `.` with `[\s\S]` in regex patterns to avoid `s` flag
- **Files modified:** src/components/ki/chat-messages.tsx
- **Verification:** `npx tsc --noEmit` passes for all modified files
- **Committed in:** 732fd19 (Task 2 commit)

**2. [Rule 1 - Bug] Fixed implicit any type on setter callback parameter**
- **Found during:** Task 2 (chat-layout.tsx)
- **Issue:** `prev` parameter in `setter((prev) => ...)` callbacks had implicit `any` type due to ref typing
- **Fix:** Explicitly typed `prev: any[]` in all three setter callbacks
- **Files modified:** src/components/ki/chat-layout.tsx
- **Verification:** `npx tsc --noEmit` passes for all modified files
- **Committed in:** 732fd19 (Task 2 commit)

**3. [Rule 2 - Missing Critical] Added metadata stripping for copy button**
- **Found during:** Task 2 (chat-messages.tsx)
- **Issue:** Copy button would copy raw `<!--schriftsatz:...-->` metadata to clipboard
- **Fix:** Added `parseSchriftsatzMeta` call before `parseThinking` in copy handler
- **Files modified:** src/components/ki/chat-messages.tsx
- **Verification:** Copy button handler now strips metadata before clipboard write
- **Committed in:** 732fd19 (Task 2 commit)

---

**Total deviations:** 3 auto-fixed (2 bugs, 1 missing critical)
**Impact on plan:** All fixes necessary for compilation and correct UX. No scope creep.

## Issues Encountered
- Pre-existing type errors in src/lib/helena/index.ts (5 errors) -- not related to this plan's changes, out of scope

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Full Schriftsatz Rueckfragen frontend chain is complete
- Pipeline JSON responses correctly intercepted and rendered in chat UI
- Proactive reminders appear when navigating to Akte with pending Rueckfrage
- Phase 23.1 integration wiring fixes are now complete (all 3 plans done)
- Ready for Phase 24 (Scanner + Alerts)

---
*Phase: 23.1-integration-wiring-fixes*
*Completed: 2026-02-27*
