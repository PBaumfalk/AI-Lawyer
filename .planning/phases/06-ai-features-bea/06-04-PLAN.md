---
phase: 06-ai-features-bea
plan: 04
type: execute
wave: 3
depends_on:
  - "06-03"
files_modified:
  - package.json
  - prisma/schema.prisma
  - src/lib/bea/client.ts
  - src/lib/bea/session.ts
  - src/lib/bea/auto-assign.ts
  - src/lib/xjustiz/parser.ts
autonomous: true
requirements:
  - REQ-BA-001
  - REQ-BA-005
  - REQ-BA-006

user_setup:
  - service: bea.expert
    why: "beA electronic legal messaging integration"
    env_vars:
      - name: BEA_API_URL
        source: "bea.expert account — API endpoint provided after registration"
    dashboard_config:
      - task: "Register for bea.expert account"
        location: "https://bea.expert — registration requires active beA SAFE-ID"
      - task: "Obtain software token"
        location: "beA BRAK portal — each lawyer needs their own software token"

must_haves:
  truths:
    - "bea.expert JS library is installed or vendored and importable"
    - "BeaNachricht model has eEB and XJustiz fields in Prisma schema"
    - "XJustiz XML is parsed into typed Grunddaten, Beteiligte, Instanzen, Termine"
    - "Auto-assignment matches beA messages to Akten via Aktenzeichen, SAFE-ID, and court reference"
    - "Browser-side beA session context manages authentication state in memory"
  artifacts:
    - path: "src/lib/bea/client.ts"
      provides: "bea.expert API wrapper for browser-side calls"
      exports: ["beaLogin", "beaGetPostboxes", "beaGetMessages", "beaGetMessage", "beaSendMessage", "beaSendEeb", "beaGetPruefprotokoll"]
    - path: "src/lib/xjustiz/parser.ts"
      provides: "XJustiz XML parser extracting Grunddaten, Beteiligte, Instanzen, Termine"
      exports: ["parseXJustiz"]
    - path: "src/lib/bea/auto-assign.ts"
      provides: "Auto-assignment of beA messages to Akten"
      exports: ["autoAssignToAkte"]
    - path: "src/lib/bea/session.ts"
      provides: "React context for beA session state"
      exports: ["BeaSessionProvider", "useBeaSession"]
  key_links:
    - from: "src/lib/bea/client.ts"
      to: "bea.expert JS library"
      via: "dynamic import of bea.expert API"
      pattern: "import.*bea\\.expert|beaExpertApi"
    - from: "src/lib/bea/auto-assign.ts"
      to: "prisma.akte"
      via: "Aktenzeichen regex matching"
      pattern: "prisma\\.akte\\.findMany"
---

<objective>
Install the bea.expert JS library, extend the BeaNachricht schema with eEB and XJustiz fields, build the browser-side bea.expert API client with session management, create the XJustiz XML parser, and implement auto-assignment logic for matching beA messages to Akten.

Purpose: Foundation layer for all beA UI -- schema, client wrapper, parser, and matching logic must exist before pages/components can be built.
Output: Working bea.expert client, XJustiz parser, auto-assign logic, and extended Prisma schema.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md
@.planning/phases/06-ai-features-bea/06-01-SUMMARY.md
@.planning/phases/06-ai-features-bea/06-03-SUMMARY.md

# Existing beA stub and model
@src/app/(dashboard)/bea/page.tsx
@prisma/schema.prisma

# Kontakt model with beaSafeId
@src/app/api/kontakte/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install bea.expert Library + Schema Changes + bea.expert Client + Session Context</name>
  <files>
    package.json
    prisma/schema.prisma
    src/lib/bea/client.ts
    src/lib/bea/session.ts
  </files>
  <action>
0. Install/vendor the bea.expert JS library:
   - Check GitLab at `gitlab.com/beaexpert/` for the current JS library package.
   - If available as npm package: `npm install bea-expert-api` (or the correct package name from GitLab).
   - If NOT available as npm package: Download the `bea.expert_api.js` library from GitLab, place it in `src/lib/bea/vendor/bea-expert-api.js`, and import via relative path.
   - If the library is designed for CDN loading (script tag): Create a dynamic loader in client.ts that injects a script tag and resolves when the global is available.
   - Confirm the library is importable and document the chosen approach in a code comment.
   - Add `package.json` changes (if npm install) or vendor file to git.

1. Update `prisma/schema.prisma` BeaNachricht model -- add fields:
   - `eebStatus String?` // AUSSTEHEND | BESTAETIGT | NICHT_ERFORDERLICH
   - `eebDatum DateTime?`
   - `xjustizData Json?` // Parsed XJustiz content for quick rendering
   - `safeIdAbsender String?`
   - `safeIdEmpfaenger String?`
   Run `npx prisma db push`.

2. Install `fast-xml-parser`: `npm install fast-xml-parser`.

3. Create `src/lib/bea/client.ts` ("use client" -- browser-only module):
   - beA client wrapper that encapsulates bea.expert REST API calls.
   - Since bea.expert requires browser-side authentication (crypto operations with software token), this module runs ONLY in the browser.
   - Functions (all return Promises, all require sessionKeys from login):
     a) `beaLogin(softwareToken: File, pin: string)`: Initiates browser-side login. Uses bea.expert JS library for token processing and session key derivation. Returns session context.
     b) `beaGetPostboxes(session)`: Call PostboxOverview. Returns [{safeId, name, type}].
     c) `beaGetFolders(session, safeId)`: Call FolderOverview. Returns folder tree.
     d) `beaGetMessages(session, safeId, folderId)`: Paginated message list.
     e) `beaGetMessage(session, messageId)`: Full message with decrypted content.
     f) `beaSendMessage(session, {recipientSafeId, subject, body, attachments[]})`: Send message.
     g) `beaSendEeb(session, messageId, date)`: Acknowledge receipt via eEBanswer.
     h) `beaGetPruefprotokoll(session, messageId)`: Get verification protocol.
   - Error handling: Wrap each call in try-catch, return structured errors. Handle session expiry gracefully.
   - Use dynamic import pattern for the bea.expert library. If library unavailable, show "beA-Bibliothek konnte nicht geladen werden" error.

4. Create `src/lib/bea/session.ts` ("use client"):
   - React context for beA session state.
   - `BeaSessionProvider`: Manages session keys in memory (NOT localStorage -- security sensitive).
   - `useBeaSession()`: Hook returning {isAuthenticated, session, login, logout, error}.
   - Session timeout: auto-logout after 30 minutes of inactivity.
   - Login state persists only in memory -- refreshing the page requires re-authentication.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Verify bea.expert library is importable (npm ls or vendor file exists). Verify BeaNachricht schema changes applied with npx prisma db push.</manual>
  </verify>
  <done>bea.expert JS library installed/vendored and importable. BeaNachricht model extended with eEB and XJustiz fields. bea.expert client wrapper handles all API calls with browser-side session management. Session context provides React hook for authentication state.</done>
</task>

<task type="auto">
  <name>Task 2: XJustiz Parser + Auto-Assignment Logic + Unit Tests</name>
  <files>
    src/lib/xjustiz/parser.ts
    src/lib/bea/auto-assign.ts
  </files>
  <action>
1. Create `src/lib/xjustiz/parser.ts`:
   - `parseXJustiz(xmlString: string)`: Parse XJustiz XML using fast-xml-parser with namespace awareness.
   - Configure parser: `{ ignoreAttributes: false, attributeNamePrefix: "@_", removeNSPrefix: true }`.
   - Extract and return typed object:
     ```typescript
     interface XJustizData {
       version: string; // Detected XJustiz version
       grunddaten?: {
         aktenzeichen?: string;
         verfahrensgegenstand?: string;
         gericht?: string;
         eingangsdatum?: string;
       };
       beteiligte: Array<{
         name: string;
         rolle: string;
         anschrift?: string;
         safeId?: string;
       }>;
       instanzen: Array<{
         gericht: string;
         aktenzeichen: string;
         beginn?: string;
         ende?: string;
       }>;
       termine: Array<{
         art: string;
         datum: string;
         ort?: string;
         bemerkung?: string;
       }>;
     }
     ```
   - Handle XJustiz versions 3.4.1 through 3.5.1. Use flexible parsing that doesn't break on unknown elements.
   - Return raw data structure -- rendering handled by viewer component in Plan 06-05.

2. Create `src/lib/bea/auto-assign.ts` (server-side):
   - `autoAssignToAkte(nachricht: {betreff, absender, inhalt, safeIdAbsender})`: Attempts to match a beA message to an Akte.
   - Matching strategies (in priority order):
     a) Aktenzeichen regex in betreff or inhalt: Match known Aktenzeichen patterns from existing Akten.
     b) SAFE-ID match: Look up safeIdAbsender in Kontakt.beaSafeId, find Akten where that Kontakt is a Beteiligter.
     c) Court reference matching: Extract Gerichtsaktenzeichen from betreff, match against Akte.gerichtsAktenzeichen.
   - Returns: {akteId: string | null, confidence: 'SICHER' | 'WAHRSCHEINLICH' | 'UNSICHER', reason: string}.
   - If confidence is SICHER, auto-assign. If WAHRSCHEINLICH, suggest with confirmation. If UNSICHER, leave unassigned.

3. Write unit tests for the two core pure-logic modules:
   - `src/lib/xjustiz/__tests__/parser.test.ts`: Test parseXJustiz with sample XJustiz XML strings covering: v3.4.1 Grunddaten extraction, v3.5.1 Beteiligte list, Instanzen timeline, Termine, empty/malformed XML graceful handling, namespace stripping.
   - `src/lib/bea/__tests__/auto-assign.test.ts`: Test autoAssignToAkte with mocked Prisma: Aktenzeichen found in betreff (SICHER), SAFE-ID match via Kontakt (WAHRSCHEINLICH), no match (UNSICHER), court reference extraction.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx vitest run src/lib/xjustiz/__tests__/parser.test.ts src/lib/bea/__tests__/auto-assign.test.ts --reporter=verbose 2>&1 | tail -30</automated>
    <manual>Check that parseXJustiz returns correct typed output for sample XJustiz XML. Check that autoAssignToAkte returns expected confidence levels.</manual>
  </verify>
  <done>XJustiz parser extracts Grunddaten, Beteiligte, Instanzen, Termine from XML versions 3.4.1-3.5.1 with unit tests passing. Auto-assignment logic matches beA messages to Akten via Aktenzeichen, SAFE-ID, and court reference with unit tests passing.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. bea.expert JS library is installed/vendored (check package.json or vendor directory)
3. BeaNachricht model has eebStatus, eebDatum, xjustizData, safeIdAbsender, safeIdEmpfaenger fields
4. XJustiz parser unit tests pass
5. Auto-assignment unit tests pass
6. bea.expert client wrapper compiles without errors
7. BeaSessionProvider context hook is functional
</verification>

<success_criteria>
- bea.expert JS library is available for import in the project
- BeaNachricht schema extended with all required fields
- XJustiz parser handles versions 3.4.1 through 3.5.1 correctly
- Auto-assignment logic matches messages with appropriate confidence levels
- All unit tests pass
- Browser-side session management is ready for UI consumption
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-04-SUMMARY.md`
</output>
