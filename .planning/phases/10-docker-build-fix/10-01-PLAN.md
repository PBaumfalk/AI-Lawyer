---
phase: 10-docker-build-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logger.ts
  - next.config.mjs
  - Dockerfile
  - .dockerignore
autonomous: true
requirements: [BUILD-01]

must_haves:
  truths:
    - "`npm run build` (Next.js production build) completes without errors, including page data collection phase"
    - "Logger does not crash when /var/log/ai-lawyer does not exist at build time"
    - "Docker build stage completes: `docker build --target builder .` exits 0"
    - "esbuild server and worker bundles are created successfully during Docker build"
  artifacts:
    - path: "src/lib/logger.ts"
      provides: "Build-safe pino logger that defers file transport to runtime"
      contains: "pino-roll transport only activates when not in build phase"
    - path: "next.config.mjs"
      provides: "Next.js config with serverExternalPackages for node-only modules"
      contains: "serverComponentsExternalPackages"
    - path: "Dockerfile"
      provides: "Multi-stage Docker build that compiles without errors"
      contains: "node:20-alpine"
    - path: ".dockerignore"
      provides: "Docker ignore file that excludes non-essential files"
  key_links:
    - from: "src/lib/logger.ts"
      to: "next build"
      via: "pino transport initialization"
      pattern: "buildTransport.*NODE_ENV"
---

<objective>
Fix the Next.js production build so it compiles completely without errors, including the page data collection phase that currently crashes due to pino logger trying to create /var/log/ai-lawyer.

Purpose: The production build is the prerequisite for everything else in Docker. Without a working `next build`, no Docker image can be created.

Output: A `next build` that exits 0, Dockerfile builder stage that completes, esbuild bundles for server and worker.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-docker-build-fix/10-CONTEXT.md

Key issue: `npm run build` compiles webpack successfully but crashes during "Collecting page data" (SSR prerendering) because `src/lib/logger.ts` initializes pino with pino-roll transport that calls `mkdir: true` for `/var/log/ai-lawyer`. This path doesn't exist outside Docker and cannot be created without root permissions.

The error:
```
Error: EACCES: permission denied, mkdir '/var/log/ai-lawyer'
```

The logger is imported by 26 files across the codebase (server.ts, worker.ts, API routes, processors). It initializes eagerly at module load time, so any server-side import triggers the crash.

<interfaces>
From src/lib/logger.ts:
```typescript
export const rootLogger: Logger = pino({...});
export function createLogger(module: string): Logger;
```

Used by: src/server.ts, src/worker.ts, and 24 other files via `import { createLogger } from "@/lib/logger"`.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pino logger to be build-safe</name>
  <files>src/lib/logger.ts</files>
  <action>
Modify `src/lib/logger.ts` so the pino-roll file transport is NOT activated during `next build` (page data collection / SSR prerendering).

The fix must handle TWO scenarios:
1. **Build time**: `next build` runs SSR prerendering where server-side modules are imported. The pino-roll transport must NOT try to create directories.
2. **Runtime (Docker)**: In production Docker container, pino-roll should work normally with `/var/log/ai-lawyer`.

Implementation approach:

In `buildTransport()`, when `NODE_ENV === "production"`:
- Check if we are in the Next.js build phase by checking `process.env.NEXT_PHASE === 'phase-production-build'` (Next.js sets this during `next build`).
- Also check `process.env.NEXT_RUNTIME` -- during build page collection, this may be set.
- As a reliable fallback, wrap the pino-roll target in a try/catch or simply skip file transport when building.

The simplest reliable approach: If `process.env.NEXT_PHASE === 'phase-production-build'`, return stdout-only transport (no pino-roll). Otherwise, return the full multi-transport with pino-roll.

```typescript
function buildTransport() {
  if (process.env.NODE_ENV !== "production") {
    // Dev: pino-pretty
    return { target: "pino-pretty", options: { ... } };
  }

  // During next build SSR prerendering, skip file transport
  if (process.env.NEXT_PHASE === 'phase-production-build') {
    return { target: "pino/file", options: { destination: 1 } };
  }

  // Production runtime: stdout + pino-roll file rotation
  const logFilePath = process.env.LOG_FILE_PATH || "/var/log/ai-lawyer/app";
  const targets = [
    { target: "pino/file", options: { destination: 1 }, level: "trace" },
    { target: "pino-roll", options: { file: logFilePath, frequency: "daily", size: "10m", mkdir: true, extension: ".log" }, level: "trace" },
  ];
  return { targets };
}
```

Keep the exported API (`rootLogger`, `createLogger`) exactly the same -- no breaking changes for consumers.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy" npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `npm run build` (with dummy DATABASE_URL) completes without the EACCES error
    - Logger module exports remain unchanged: rootLogger and createLogger
    - In production runtime (not build), pino-roll file transport still works
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden next.config.mjs and Dockerfile for production build</name>
  <files>next.config.mjs, Dockerfile, .dockerignore</files>
  <action>
1. **next.config.mjs**: The `experimental.serverComponentsExternalPackages` config key is deprecated in Next.js 14.2+. Move it to the top-level `serverExternalPackages` (non-experimental). Add additional packages that are Node.js-only and should not be bundled by webpack for the browser:
   - Keep existing: `bullmq`, `ioredis`, `pino`, `pino-roll`
   - Add: `pino-pretty` (dev transport, should not be bundled), `pdf-parse` (uses require(), Node-only), `imapflow`, `nodemailer`, `@prisma/client`

   ```javascript
   const nextConfig = {
     output: "standalone",
     reactStrictMode: true,
     eslint: { ignoreDuringBuilds: true },
     typescript: { ignoreBuildErrors: true },
     serverExternalPackages: [
       "bullmq", "ioredis", "pino", "pino-roll", "pino-pretty",
       "pdf-parse", "imapflow", "nodemailer", "@prisma/client"
     ],
     // Remove the old experimental.serverComponentsExternalPackages
     async headers() { ... } // keep existing headers unchanged
   };
   ```

2. **Dockerfile**:
   - The Dockerfile is mostly correct. Ensure the `LOG_FILE_PATH` directory exists in the runner stage:
     ```dockerfile
     # In runner stage, before USER nextjs:
     RUN mkdir -p /var/log/ai-lawyer && chown nextjs:nodejs /var/log/ai-lawyer
     ```
   - Ensure `NEXT_PHASE` env is NOT set during the build stage (it shouldn't be, but verify the build command doesn't accidentally set it).
   - The `RUN chown -R nextjs:nodejs /app` line should come AFTER the log directory creation.

3. **.dockerignore**: The current `.dockerignore` excludes `*.md` which is fine (prevents copying README etc.), but verify it does NOT exclude files needed for the build. Add explicit exclusions for `.planning/` and `dist-server/` and `dist-worker/` (stale local builds) to prevent them from being copied into Docker context:
   ```
   node_modules
   .next
   .git
   .DS_Store
   *.md
   .ralph
   .claude
   .planning
   .env
   .env.*
   dist-server
   dist-worker
   ```
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && node -e "const c = (await import('./next.config.mjs')).default; console.log('serverExternalPackages:', c.serverExternalPackages); console.log('experimental:', c.experimental); if(c.serverExternalPackages?.includes('bullmq')) console.log('OK'); else { console.log('FAIL'); process.exit(1); }"</automated>
  </verify>
  <done>
    - next.config.mjs uses top-level serverExternalPackages (not experimental)
    - Dockerfile creates /var/log/ai-lawyer with correct ownership
    - .dockerignore excludes .planning/, dist-server/, dist-worker/
    - `docker build --target builder .` (if Docker available) exits 0, or at minimum `next build` still passes
  </done>
</task>

</tasks>

<verification>
1. `DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy" npm run build` completes without errors (exit code 0)
2. `.next/standalone/` directory is created with server files
3. `npx tsx scripts/build-server.ts` creates `dist-server/index.js`
4. `npx tsx scripts/build-worker.ts` creates `dist-worker/index.js`
5. No `experimental.serverComponentsExternalPackages` remains in next.config.mjs
</verification>

<success_criteria>
- Next.js production build completes all phases: compilation, page data collection, static generation
- The build does not crash due to pino logger, Redis connections, or any other server-only module initialization
- Dockerfile builder stage can complete (requires Docker to verify fully, but local `next build` proves the critical path)
</success_criteria>

<output>
After completion, create `.planning/phases/10-docker-build-fix/10-01-SUMMARY.md`
</output>
