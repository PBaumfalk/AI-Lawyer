---
milestone: v3.4
audited: 2026-02-24T16:00:00Z
status: tech_debt
scores:
  requirements: 24/24
  phases: 5/5
  integration: 21/24
  flows: 2/4
gaps:
  requirements: []
  integration:
    - id: "INT-001"
      severity: "critical"
      from: "Phase 3 (email IMAP connection-manager)"
      to: "Phase 1 (Socket.IO rooms)"
      issue: "mailbox:{kontoId} Socket.IO room is dead — emitter sends to room no client ever joins"
      affected_requirements: ["REQ-IF-003", "REQ-EM-001", "REQ-EM-003"]
      evidence: "connection-manager.ts:127 emits to mailbox:{kontoId}, rooms.ts only handles user:/role:/akte: rooms, folder-tree.tsx listens on window CustomEvent instead of socket"
      fix: "Add join:mailbox event to rooms.ts, emit from FolderTree, bridge socket event to CustomEvent"
    - id: "INT-002"
      severity: "medium"
      from: "Phase 3 (compose-popup.tsx)"
      to: "Phase 3 (email-signature API)"
      issue: "GET /api/email-signature route does not exist — compose preview shows no signature"
      affected_requirements: ["REQ-EM-006"]
      evidence: "compose-popup.tsx:123 fetches /api/email-signature?kontoId= which 404s; catch suppresses error; send processor has own inline renderSignature"
      fix: "Create src/app/api/email-signature/route.ts calling renderSignature() from lib/email/signature.ts"
    - id: "INT-003"
      severity: "low"
      from: "Phase 3 (compose-manager.tsx)"
      to: "Phase 3 (email layout)"
      issue: "ComposeManager context provider never mounted in component tree"
      affected_requirements: ["REQ-EM-006"]
      evidence: "compose-manager.tsx defines ComposeManager/useComposeManager but zero imports found outside definition file; email layout.tsx does not render it"
      fix: "Wrap email layout or dashboard layout children with <ComposeManager>"
  flows:
    - flow: "Email arrival → Socket.IO → browser update"
      status: "broken"
      break_point: "Socket.IO emits to mailbox:{kontoId} room, no client is in that room"
      affected_requirements: ["REQ-EM-001", "REQ-EM-003", "REQ-IF-003"]
    - flow: "Email compose → signature preview"
      status: "partial"
      break_point: "/api/email-signature route missing — signature not shown in compose, but injected at send time"
      affected_requirements: ["REQ-EM-006"]
tech_debt:
  - phase: 01-infrastructure-foundation
    items:
      - "PUT handler in /api/admin/jobs returns 501 'Nicht implementiert' (Bull Board adapter stub)"
      - "Worker log.level runtime update commented out (pino supports it, just not wired)"
  - phase: 02-deadline-calculation-document-templates
    items:
      - "OnlyOffice Briefkopf editing mode shows placeholder — users must save in form mode first"
  - phase: 02.1-wire-frist-reminder-pipeline
    items:
      - "Pre-existing TSC error in .next/types/app/api/ordner-schemata/route.ts (generated file)"
  - phase: 02.2-fix-api-routes-ui-paths
    items:
      - "Pre-existing next build failure at worker thread stage (unrelated to phase changes)"
  - phase: 03-email-client
    items:
      - "syncNewMessages() exported from sync.ts is dead code (connection-manager calls syncMailbox directly)"
      - "email:received notification type defined but never emitted by IMAP connection manager"
  - phase: integration
    items:
      - "INT-001: Socket.IO mailbox room wiring broken — real-time email browser updates do not fire"
      - "INT-002: /api/email-signature route missing — compose preview lacks signature"
      - "INT-003: ComposeManager context not mounted — compose-from-anywhere unavailable"
---

# Milestone v3.4 Audit Report

**Milestone:** v3.4 (re-audit after gap closure)
**Audited:** 2026-02-24
**Status:** tech_debt
**Phases:** 5/5 passed | **Requirements:** 24/24 satisfied | **Integration:** 21/24 wired | **Flows:** 2/4 complete

---

## Previous Audit Gap Resolution

The previous v3.4 audit (2026-02-24T13:00:00Z) found 3 unsatisfied/partial requirements. All were resolved:

| Gap | Previous Status | Resolution | Phase |
|-----|----------------|------------|-------|
| REQ-FK-003 Vorfristen-Erinnerungen | unsatisfied (dead code) | processFristReminders registered in worker.ts, cron scheduled | Phase 2.1 |
| REQ-DV-008 Ordner-Schemata | partial (missing /[id] route) | /api/ordner-schemata/[id] PATCH/DELETE created | Phase 2.2 |
| REQ-DV-009 Vorlagenkategorien | partial (wrong favorit URL) | Favorit toggle fixed to PATCH /api/vorlagen/[id] | Phase 2.2 |

---

## Requirements Coverage (3-Source Cross-Reference)

All 24 milestone requirements verified across 3 independent sources:

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final |
|--------|-------------|-------|-------------|---------|-----------------|-------|
| REQ-IF-001 | Redis 7 in Docker Compose | 1 | passed | listed | Complete | **satisfied** |
| REQ-IF-002 | Worker-Prozess worker.ts BullMQ | 1 | passed | listed | Complete | **satisfied** |
| REQ-IF-003 | Custom server.ts + Socket.IO | 1 | passed | listed | Complete | **satisfied** |
| REQ-IF-005 | Graceful Shutdown Worker | 1 | passed | listed | Complete | **satisfied** |
| REQ-FK-001 | BGB §§187-193 Fristberechnung | 2 | passed | listed | Complete | **satisfied** |
| REQ-FK-002 | Feiertagskalender pro Bundesland | 2 | passed | listed | Complete | **satisfied** |
| REQ-FK-003 | Vorfristen-Erinnerungen 7/3/1 | 2.1 | passed | listed | Complete | **satisfied** |
| REQ-FK-004 | Tagesuebersicht + Quick-Actions | 2 | passed | listed | Complete | **satisfied** |
| REQ-FK-005 | Prioritaeten 5 Stufen | 2 | passed | listed | Complete | **satisfied** |
| REQ-DV-001 | Vorlagen-System mit Platzhaltern | 2 | passed | listed | Complete | **satisfied** |
| REQ-DV-002 | Briefkopf-Verwaltung | 2 | passed | listed | Complete | **satisfied** |
| REQ-DV-003 | PDF-Export mit Briefkopf | 2 | passed | listed | Complete | **satisfied** |
| REQ-DV-008 | Ordner-Schemata fuer Akten | 2.2 | passed | listed | Complete | **satisfied** |
| REQ-DV-009 | Vorlagenkategorien | 2.2 | passed | listed | Complete | **satisfied** |
| REQ-DV-010 | WOPI-Protokoll stabil | 2 | passed | listed | Complete | **satisfied** |
| REQ-DV-011 | Track Changes, Kommentare | 2 | passed | listed | Complete | **satisfied** |
| REQ-EM-001 | IMAP-Sync mit IDLE | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-002 | Shared + per-User Mailboxen | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-003 | Inbox-Seite mit Filtern | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-004 | E-Mail-Detailansicht | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-005 | E-Mail verakten | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-006 | Compose-View + SMTP | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-007 | Ticket aus E-Mail | 3 | passed | listed | Complete | **satisfied** |
| REQ-EM-008 | Akte Tab E-Mails | 3 | passed | listed | Complete | **satisfied** |

**No orphaned requirements.** All 24 REQ-IDs assigned to milestone phases appear in at least one VERIFICATION.md, at least one SUMMARY.md frontmatter, and the REQUIREMENTS.md traceability table.

---

## Phase Verification Summary

| Phase | Status | Score | Anti-Patterns |
|-------|--------|-------|---------------|
| 01 Infrastructure Foundation | passed | 13/13 | 2 INFO (PUT stub, log level comment) |
| 02 Deadline Calculation + Templates | passed | 6/6 | 1 INFO (Briefkopf OnlyOffice placeholder) |
| 02.1 Wire Frist-Reminder Pipeline | passed | 5/5 | 0 (1 pre-existing TSC error) |
| 02.2 Fix API Routes + UI Paths | passed | 5/5 | 0 (1 pre-existing build error) |
| 03 Email Client | passed | 18/18 | 1 INFO (syncNewMessages dead code) |

All 5 phases passed verification with 0 blocking gaps.

---

## Cross-Phase Integration

### Wired Connections (21/24)

All infrastructure-to-feature phase connections verified:
- **Phase 1 → Phase 2**: Redis + BullMQ queues used by frist-reminder processor
- **Phase 1 → Phase 2.1**: Queue registry consolidated, frist-reminder registered in worker.ts
- **Phase 1 → Phase 3**: Worker runs IMAP connections, email send queue via BullMQ
- **Phase 1 → Phase 3**: Socket.IO notification path works for general notifications
- **Phase 2 → Phase 2.1**: processFristReminders() correctly wired with dual-channel delivery
- **Phase 2 → Phase 2.2**: Ordner-Schemata and favorit toggle APIs complete
- **Phase 2 → Phase 3**: Notification service used for email-related alerts

### Integration Gaps (3)

**INT-001 (Critical): Socket.IO mailbox room dead**
- `connection-manager.ts` emits `email:folder-update` to `mailbox:{kontoId}` room
- `rooms.ts` only handles `user:`, `role:`, `akte:` rooms — no `mailbox:` room join
- `folder-tree.tsx` listens on `window` CustomEvent, not Socket.IO socket
- **Impact**: Real-time email unread badge updates never fire in browser
- **Workaround**: Page refresh shows new emails correctly
- **Affects**: REQ-IF-003, REQ-EM-001, REQ-EM-003

**INT-002 (Medium): Missing /api/email-signature route**
- `compose-popup.tsx` fetches `GET /api/email-signature?kontoId=` which 404s
- Signature IS injected at SMTP send time by the send processor
- **Impact**: Signature not visible in compose preview; delivery correct
- **Affects**: REQ-EM-006

**INT-003 (Low): ComposeManager context unmounted**
- `compose-manager.tsx` defines ComposeManager/useComposeManager but is never wrapped in any layout
- **Impact**: "Neue E-Mail" action from outside inbox layout has no compose provider
- **Affects**: REQ-EM-006

---

## E2E Flow Verification

| Flow | Status | Details |
|------|--------|---------|
| Frist → Vorfrist → cron → notification → toast | **Complete** | Full chain verified: cron triggers processFristReminders, createNotification emits via user:{id} room, NotificationProvider shows toast |
| Template → placeholders → Briefkopf → PDF | **Complete** | VorlagenWizard fetches Briefkopf, generieren endpoint fills + merges, PDF export via OnlyOffice convert |
| Email arrival → IMAP sync → Socket.IO → browser | **Broken** | IMAP IDLE sync to DB works; Socket.IO emission to mailbox room is dead (INT-001) |
| Email compose → BullMQ → undo → SMTP | **Partial** | Send flow complete; signature preview missing (INT-002); ComposeManager not mounted (INT-003) |

---

## Tech Debt Summary

### By Phase

**Phase 01: Infrastructure Foundation**
- PUT handler in /api/admin/jobs returns 501 stub
- Worker log.level runtime update commented out

**Phase 02: Deadline Calculation + Templates**
- OnlyOffice Briefkopf editing mode shows placeholder (form mode works)

**Phase 02.1: Wire Frist-Reminder Pipeline**
- Pre-existing TSC error in generated .next/types file

**Phase 02.2: Fix API Routes + UI Paths**
- Pre-existing next build failure at worker thread stage

**Phase 03: Email Client**
- `syncNewMessages()` is dead code (never called)
- `email:received` notification type defined but never emitted

**Integration**
- INT-001: Socket.IO mailbox room wiring broken
- INT-002: /api/email-signature route missing
- INT-003: ComposeManager context not mounted

### Total: 10 items across 6 categories

---

_Audited: 2026-02-24T16:00:00Z_
_Auditor: Claude (milestone audit orchestrator + gsd-integration-checker)_
_Previous audit: 2026-02-24T13:00:00Z (gaps_found — all 3 gaps resolved by phases 2.1 + 2.2)_
