---
phase: 05-financial-module
plan: 06
type: execute
wave: 5
depends_on: ["05-01", "05-02", "05-03", "05-04", "05-05"]
files_modified:
  - src/app/(dashboard)/finanzen/page.tsx
  - src/app/(dashboard)/finanzen/rechner/page.tsx
  - src/app/(dashboard)/finanzen/rechnungen/page.tsx
  - src/app/(dashboard)/finanzen/rechnungen/[id]/page.tsx
  - src/app/(dashboard)/finanzen/aktenkonto/page.tsx
  - src/app/(dashboard)/finanzen/layout.tsx
  - src/components/finanzen/rvg-calculator.tsx
  - src/components/finanzen/invoice-list.tsx
  - src/components/finanzen/invoice-detail.tsx
  - src/components/finanzen/aktenkonto-ledger.tsx
  - src/components/finanzen/timer-sidebar-widget.tsx
autonomous: false
requirements:
  - REQ-FI-001
  - REQ-FI-003
  - REQ-FI-005
  - REQ-FI-006
  - REQ-FI-011

must_haves:
  truths:
    - "User can open the RVG calculator page, enter a Streitwert, add VV positions via presets or searchable dropdown, see running totals with Anrechnung notices, and export as PDF or transfer to invoice"
    - "User can view the invoice list page with filters (status, date, Mandant, Akte, amount, ueberfaellig), summary cards (Gesamtumsatz, offene Forderungen, ueberfaellige Betraege), and sortable columns"
    - "User can open an invoice detail page showing all positions, status badge, action buttons (Stellen, PDF, E-Rechnung, Stornieren), and Teilzahlungen"
    - "User can view the Aktenkonto page for a case with summary cards (Saldo, Fremdgeld, Offene Forderungen, Auslagen), chronological ledger with running balance, and Fremdgeld section with color-coding and compliance alerts"
    - "Timer sidebar widget shows active timer with Akte name, elapsed time, and stop/switch controls"
  artifacts:
    - path: "src/app/(dashboard)/finanzen/rechner/page.tsx"
      provides: "RVG calculator page with builder pattern UI"
      min_lines: 50
    - path: "src/app/(dashboard)/finanzen/rechnungen/page.tsx"
      provides: "Invoice list page with filters and summary cards"
      min_lines: 50
    - path: "src/app/(dashboard)/finanzen/rechnungen/[id]/page.tsx"
      provides: "Invoice detail page with actions"
      min_lines: 50
    - path: "src/app/(dashboard)/finanzen/aktenkonto/page.tsx"
      provides: "Aktenkonto page with ledger and Fremdgeld compliance"
      min_lines: 50
    - path: "src/components/finanzen/timer-sidebar-widget.tsx"
      provides: "Timer sidebar widget showing active timer"
      min_lines: 30
  key_links:
    - from: "src/components/finanzen/rvg-calculator.tsx"
      to: "/api/finanzen/rvg"
      via: "POST to calculate fees and save per Akte"
      pattern: "fetch.*api/finanzen/rvg"
    - from: "src/components/finanzen/invoice-list.tsx"
      to: "/api/finanzen/rechnungen"
      via: "GET with filters for invoice list"
      pattern: "fetch.*api/finanzen/rechnungen"
    - from: "src/components/finanzen/aktenkonto-ledger.tsx"
      to: "/api/finanzen/aktenkonto"
      via: "GET per-case bookings with running balance"
      pattern: "fetch.*api/finanzen/aktenkonto"
    - from: "src/components/finanzen/timer-sidebar-widget.tsx"
      to: "/api/finanzen/zeiterfassung/timer"
      via: "GET active timer, PATCH to stop, PUT to switch"
      pattern: "fetch.*zeiterfassung/timer"
    - from: "src/components/finanzen/rvg-calculator.tsx"
      to: "/api/finanzen/rechnungen"
      via: "One-click transfer RVG calculation to new invoice (Uebernehmen als Rechnung)"
      pattern: "uebernehmenAlsRechnung|POST.*rechnungen"
---

<objective>
Build all financial module UI pages: RVG calculator with builder pattern, invoice list and detail pages, Aktenkonto ledger with Fremdgeld compliance display, and timer sidebar widget.

Purpose: Plans 01-05 are API-only backends. Without UI pages, users cannot interact with any financial features. The CONTEXT.md locked decisions specify detailed UI requirements for each page (builder pattern for RVG, summary cards for invoices, chronological ledger for Aktenkonto, sidebar widget for timer).

Output: Complete set of financial UI pages connected to the APIs built in Plans 01-05, enabling attorneys to calculate fees, create invoices, track case financials, and see active timers.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-module/05-CONTEXT.md
@.planning/phases/05-financial-module/05-01-SUMMARY.md
@.planning/phases/05-financial-module/05-02-SUMMARY.md
@.planning/phases/05-financial-module/05-03-SUMMARY.md
@.planning/phases/05-financial-module/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finanzen Layout + RVG Calculator Page + Invoice Pages</name>
  <files>
    src/app/(dashboard)/finanzen/page.tsx
    src/app/(dashboard)/finanzen/layout.tsx
    src/app/(dashboard)/finanzen/rechner/page.tsx
    src/components/finanzen/rvg-calculator.tsx
    src/app/(dashboard)/finanzen/rechnungen/page.tsx
    src/app/(dashboard)/finanzen/rechnungen/[id]/page.tsx
    src/components/finanzen/invoice-list.tsx
    src/components/finanzen/invoice-detail.tsx
  </files>
  <action>
    **1. Finanzen Layout** (src/app/(dashboard)/finanzen/layout.tsx):
    Create a layout with sub-navigation tabs: Uebersicht, Rechner, Rechnungen, Aktenkonto.
    Use the existing tab pattern from the app (see email/layout.tsx or similar).
    Navigation links: /finanzen, /finanzen/rechner, /finanzen/rechnungen, /finanzen/aktenkonto.

    **2. Finanzen Overview** (src/app/(dashboard)/finanzen/page.tsx):
    Replace the placeholder with a dashboard showing:
    - Summary KPI cards: Umsatz MTD/YTD, offene Forderungen, ueberfaellige Rechnungen, Fremdgeld-Warnungen count
    - Quick actions: "Neue Berechnung", "Neue Rechnung", "Banking-Import"
    - Fetch summary data from GET /api/finanzen/rechnungen (summary stats) and GET /api/finanzen/aktenkonto (Fremdgeld alerts)

    **3. RVG Calculator Page** (src/app/(dashboard)/finanzen/rechner/page.tsx + src/components/finanzen/rvg-calculator.tsx):
    Per CONTEXT locked decisions — builder pattern with running totals:

    The page renders the RvgCalculator component. If opened from within an Akte context (?akteId=...), auto-populate Streitwert and Mandant.

    RVG Calculator component (src/components/finanzen/rvg-calculator.tsx):
    - **Streitwert input**: large number input with currency formatting, Streitwert-Vorschlaege dropdown (Kuendigungsschutz, Mietstreit, etc.)
    - **Preset buttons**: "Typisches Klageverfahren", "Aussergerichtliche Vertretung", "Klageverfahren mit Einigung", "Berufung", "Mahnverfahren" — clicking a preset adds all positions at once
    - **Manual add**: searchable dropdown for VV positions by number or keyword. Use the VV catalog from Plan 01. When adding, UI adapts for Wertgebuehr (shows rate factor slider) vs Betragsrahmengebuehr (shows amount input within range)
    - **Position list**: table showing each VV position (Nr, Name, Gebuehrensatz, Betrag). Anrechnung notice highlighted in amber when auto-detected. User can override/disable Anrechnung per position. Erhoehungsgebuehr row shows number of Auftraggeber input.
    - **Running totals**: live-updating sidebar/footer showing Zwischensumme (netto), VV 7002 Auslagenpauschale, VV 7008 USt 19%, Gesamtbetrag. Toggles to disable VV 7002 and VV 7008 auto-add.
    - **Result section**: itemized table, "Kopieren als Text" button (formatted for Schriftsaetze), "Als PDF exportieren" button, "Uebernehmen als Rechnung" button (calls POST /api/finanzen/rechnungen with pre-filled data from /api/finanzen/rvg uebernehmenAlsRechnung), "DAV Vergleich" link to external DAV Prozesskostenrechner
    - **API integration**: POST /api/finanzen/rvg for calculation, POST /api/finanzen/rvg/[akteId] to save per Akte
    - Use react-hook-form for form state management

    **4. Invoice List Page** (src/app/(dashboard)/finanzen/rechnungen/page.tsx + src/components/finanzen/invoice-list.tsx):
    Per CONTEXT locked decisions — filters, summary cards, batch operations:

    InvoiceList component:
    - **Summary cards at top**: Gesamtumsatz (current period), offene Forderungen, ueberfaellige Betraege, Stornoquote — fetched from GET /api/finanzen/rechnungen summary stats
    - **Filter bar**: Status dropdown (Entwurf/Gestellt/Bezahlt/Storniert/Alle), date range picker, Mandant search/select, Akte search/select, amount range (min/max), ueberfaellig checkbox
    - **Sortable table columns**: Rechnungsnummer, Datum, Mandant, Aktenzeichen, Betrag (netto/brutto), Status, Faelligkeit
    - **Status badges**: color-coded (Entwurf=gray, Gestellt=blue, Bezahlt=green, Storniert=red, Ueberfaellig=amber)
    - **Ueberfaellig-Eskalation colors**: green (within term), yellow (1-14d), orange (15-30d), red (30+d)
    - **Batch operations**: checkbox selection, action bar with "Alle stellen", "PDFs herunterladen", "Mahnungen senden"
    - **Row click**: navigate to /finanzen/rechnungen/[id]
    - Pagination with page size selector
    - Fetch: GET /api/finanzen/rechnungen with query params

    **5. Invoice Detail Page** (src/app/(dashboard)/finanzen/rechnungen/[id]/page.tsx + src/components/finanzen/invoice-detail.tsx):
    InvoiceDetail component:
    - **Header**: Rechnungsnummer, Status badge, Rechnungsdatum, Faelligkeit
    - **Mandant/Empfaenger block**: name, address, contact
    - **Position table**: Nr, VV-Nr (if RVG), Beschreibung, Menge, Einzelpreis, USt-Satz, Betrag
    - **Totals section**: Netto, USt per rate, Brutto, Restbetrag (if Teilzahlungen)
    - **Teilzahlungen list**: date, amount, Verwendungszweck
    - **Mahnungen timeline**: Stufe, Datum, Gesendet status
    - **Action buttons** (conditional on status):
      - ENTWURF: "Bearbeiten", "Stellen" (with confirmation dialog), "Loeschen"
      - GESTELLT: "PDF herunterladen", "XRechnung herunterladen", "Bezahlt markieren", "Stornieren", "Mahnung erstellen"
      - BEZAHLT: "PDF herunterladen", read-only view
    - PDF actions: call GET /api/finanzen/rechnungen/[id]/pdf, E-Rechnung: GET /api/finanzen/rechnungen/[id]/e-rechnung
    - Status transitions: call PATCH /api/finanzen/rechnungen/[id] with { action }
    - Fetch: GET /api/finanzen/rechnungen/[id]
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Navigate to /finanzen/rechner — verify Streitwert input, preset buttons, VV position add, running totals. Navigate to /finanzen/rechnungen — verify list with filters and summary cards. Navigate to /finanzen/rechnungen/[id] — verify detail with actions.</manual>
  </verify>
  <done>
    Finanzen layout with sub-navigation. RVG calculator page with builder pattern, presets, searchable VV dropdown, running totals, Anrechnung notices, and transfer-to-invoice button. Invoice list with filters, summary cards, batch operations. Invoice detail with action buttons, Teilzahlungen, and PDF/E-Rechnung download.
  </done>
</task>

<task type="auto">
  <name>Task 2: Aktenkonto Page + Timer Sidebar Widget</name>
  <files>
    src/app/(dashboard)/finanzen/aktenkonto/page.tsx
    src/components/finanzen/aktenkonto-ledger.tsx
    src/components/finanzen/timer-sidebar-widget.tsx
  </files>
  <action>
    **1. Aktenkonto Page** (src/app/(dashboard)/finanzen/aktenkonto/page.tsx + src/components/finanzen/aktenkonto-ledger.tsx):
    Per CONTEXT locked decisions — summary cards + chronological ledger + Fremdgeld compliance:

    Page: Akte selector at top (search/select Akte by Aktenzeichen or Mandant name). Once Akte selected, render AktenkontoLedger.

    AktenkontoLedger component:
    - **Summary cards**: Saldo (green/red), Fremdgeld (blue/purple, separate), Offene Forderungen, Auslagen — fetched from GET /api/finanzen/aktenkonto/[akteId] SaldoResult
    - **Fremdgeld compliance alerts**: if FremdgeldAlerts exist, show red banner with countdown per alert. Dringlichkeit color: normal=blue, warnung=amber, kritisch=orange, ueberfaellig=red. 15k Anderkonto threshold: prominent warning banner.
    - **Chronological ledger table**: columns: Datum, Buchungstyp badge (color-coded: Einnahme=green, Ausgabe=red, Fremdgeld=purple, Auslage=amber), Verwendungszweck, Betrag (positive green / negative red), Laufender Saldo, Beleg-Link (clickable if dokumentId)
    - **Running balance**: calculated and displayed in rightmost column, cumulative
    - **Fremdgeld section/tab**: dedicated tab or collapsible section showing only Fremdgeld entries, color-coded purple/blue per CONTEXT decision, with Weiterleitungsfrist countdown per entry
    - **Manual booking form**: button "Neue Buchung" opens dialog/drawer with: Buchungstyp select, Betrag input, Verwendungszweck text, Buchungsdatum picker, Kostenstelle select, Konto select (Geschaeft/Anderkonto), Beleg upload. POST /api/finanzen/aktenkonto/[akteId].
    - **Storno action**: per-row "Stornieren" button (ANWALT/ADMIN only), opens confirmation dialog with Grund input, POST /api/finanzen/aktenkonto/[akteId]/storno.
    - **Filters**: Buchungstyp, date range, Kostenstelle
    - Pagination for large ledgers
    - Fetch: GET /api/finanzen/aktenkonto/[akteId]

    **2. Timer Sidebar Widget** (src/components/finanzen/timer-sidebar-widget.tsx):
    Per CONTEXT locked decisions — sidebar widget shows active timer:

    This component is designed to be embedded in the dashboard sidebar (src/app/(dashboard)/layout.tsx).
    - **Active timer display**: Akte Aktenzeichen/name, elapsed time (HH:MM:SS updating every second via setInterval), pulsing green dot indicator
    - **Controls**: "Stop" button (calls PATCH /api/finanzen/zeiterfassung/timer with optional beschreibung), "Switch" button (not needed here — switching happens via Akte navigation auto-start)
    - **Stop flow**: when stopping, if the Akte is a Stundenhonorar-Akte, show a mandatory Taetigkeitsbeschreibung input before confirming stop
    - **No timer state**: show subtle "Kein Timer aktiv" text or nothing
    - **Polling**: GET /api/finanzen/zeiterfassung/timer every 30 seconds to sync state (in case timer was started/stopped from another tab)
    - **Integration note**: Add the TimerSidebarWidget to the dashboard layout sidebar. Import and render it below the navigation links.

    Update src/app/(dashboard)/layout.tsx:
    - Import and render `<TimerSidebarWidget />` in the sidebar section, below navigation
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Navigate to /finanzen/aktenkonto — verify Akte selector, summary cards, ledger table, Fremdgeld alerts. Check sidebar for timer widget showing active timer or "Kein Timer aktiv".</manual>
  </verify>
  <done>
    Aktenkonto page with summary cards (Saldo, Fremdgeld, Forderungen, Auslagen), chronological ledger with running balance, Fremdgeld compliance alerts (5-Werktage countdown, 15k Anderkonto warning), manual booking form, and Storno. Timer sidebar widget with elapsed time, stop control, and Stundenhonorar Pflichtangabe enforcement. Widget integrated into dashboard sidebar.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Financial Module UI</name>
  <action>
    Human verifies the complete financial module UI built in Tasks 1-2.
    What was built: Complete financial module UI -- RVG calculator with builder pattern, invoice list and detail pages, Aktenkonto ledger with Fremdgeld compliance, and timer sidebar widget -- all connected to the APIs from Plans 01-05.
  </action>
  <verify>
    <manual>
    1. Navigate to /finanzen — verify dashboard with summary KPI cards and quick actions
    2. Navigate to /finanzen/rechner — enter Streitwert 5000, click "Typisches Klageverfahren" preset, verify positions 3100+3104+7002+7008 appear with running totals
    3. Navigate to /finanzen/rechnungen — verify list loads with filters and summary cards
    4. Click any invoice — verify detail page with positions, status badge, action buttons
    5. Navigate to /finanzen/aktenkonto — select an Akte, verify summary cards and ledger
    6. Check sidebar — verify timer widget shows active timer or idle state
    7. Open any Akte (/akten/[id]) — verify timer auto-starts (check timer API or widget)
    </manual>
  </verify>
  <done>User approves all financial module UI pages and interactions.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with all new pages and components
- RVG calculator page renders with Streitwert input, presets, and running totals
- Invoice list page shows filters, summary cards, and sortable table
- Invoice detail page shows positions, actions, and PDF download
- Aktenkonto page shows summary cards, ledger, and Fremdgeld compliance alerts
- Timer sidebar widget displays in dashboard sidebar
</verification>

<success_criteria>
- RVG calculator: user can enter Streitwert, add positions via presets or dropdown, see running totals with Anrechnung, and transfer to invoice
- Invoice list: filters by status/date/Mandant/Akte work, summary cards show totals, batch operations available
- Invoice detail: all action buttons functional (Stellen, PDF, E-Rechnung, Stornieren), Teilzahlungen visible
- Aktenkonto: summary cards show correct Saldo/Fremdgeld/Forderungen, ledger shows chronological bookings with running balance, Fremdgeld alerts visible with countdown
- Timer widget: shows active timer with elapsed time, stop works with Stundenhonorar Pflichtangabe enforcement
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-module/05-06-SUMMARY.md`
</output>
