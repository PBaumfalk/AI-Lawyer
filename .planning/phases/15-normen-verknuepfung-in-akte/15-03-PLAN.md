---
phase: 15-normen-verknuepfung-in-akte
plan: 03
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - src/components/akten/normen-section.tsx
  - src/app/(dashboard)/akten/[id]/page.tsx
autonomous: true
requirements:
  - GESETZ-04

must_haves:
  truths:
    - "A 'Verknüpfte Normen' section is visible in the Akte detail page between the stats row and AkteDetailTabs"
    - "Clicking 'Norm hinzufügen' opens a search modal where the user can type a § number or law name and see live results from /api/akten/[id]/normen/search"
    - "Selecting a result in the modal and clicking 'Hinzufügen' adds the norm (with optional Anmerkung) and the chip appears immediately after router.refresh()"
    - "Each norm chip shows 'gesetzKuerzel paragraphNr' with a clickable label and an X remove button"
    - "Clicking a chip label opens a Sheet side panel showing the full § content and 'nicht amtlich' disclaimer"
    - "Clicking X on a chip removes the norm and the chip disappears after router.refresh()"
    - "Empty state: 'Noch keine Normen verknüpft' message is shown when no norms are pinned"
  artifacts:
    - path: "src/components/akten/normen-section.tsx"
      provides: "NormenSection client component with chip-list + NormSearchModal + NormDetailSheet"
      exports: ["NormenSection"]
    - path: "src/app/(dashboard)/akten/[id]/page.tsx"
      provides: "Akte detail page with normen Prisma include + NormenSection rendered"
      contains: "NormenSection"
  key_links:
    - from: "src/components/akten/normen-section.tsx"
      to: "/api/akten/[id]/normen/search"
      via: "fetch in useEffect debounce (300ms)"
      pattern: "normen/search"
    - from: "src/components/akten/normen-section.tsx"
      to: "/api/akten/[id]/normen"
      via: "fetch POST / DELETE"
      pattern: "method.*POST|method.*DELETE"
    - from: "src/app/(dashboard)/akten/[id]/page.tsx"
      to: "src/components/akten/normen-section.tsx"
      via: "import + render with akteId + initialNormen props"
      pattern: "NormenSection"
---

<objective>
Build the NormenSection UI component and wire it into the Akte detail page. The component contains the chip-list of pinned normen, the search modal (debounced ILIKE search), and the detail sheet (full § text side panel). The Akte detail page is updated to include normen in its Prisma query and render NormenSection between the stats row and AkteDetailTabs.

Purpose: The API layer (Plan 01) and Helena integration (Plan 02) are already complete. This plan creates the user-facing interface that calls those APIs.
Output: Working normen chip UI visible in every Akte detail page.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-normen-verknuepfung-in-akte/15-01-SUMMARY.md

<interfaces>
<!-- Existing patterns to follow. Extracted from codebase. -->

From src/components/akten/beteiligte-add-dialog.tsx (search dialog pattern — follow EXACTLY):
- Pattern: useState search + setTimeout(300ms) debounce in useEffect + fetch + results list
- State variables: search, results, loading, adding
- router.refresh() after successful mutation (NOT optimistic update)
- toast.success() / toast.error() via sonner

From src/components/ui/sheet.tsx (confirmed exists):
- Exports: Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription (standard shadcn)

From src/components/ui/badge.tsx (confirmed exists):
- Exports: Badge with variants including "outline"

Available UI primitives (all in src/components/ui/):
- button.tsx, input.tsx, badge.tsx, sheet.tsx
- alert-dialog.tsx (for confirm patterns)

Note: dialog.tsx does NOT exist. Use Radix Dialog primitive directly:
```typescript
import * as Dialog from "@radix-ui/react-dialog";
// OR build the modal as a conditional render with position:fixed overlay
// following the BeteiligteAddDialog pattern (no Radix Dialog wrapper needed)
```

From src/app/(dashboard)/akten/[id]/page.tsx — current Prisma query:
```typescript
const akte = await prisma.akte.findUnique({
  where: { id },
  include: {
    anwalt: { select: { id: true, name: true, email: true } },
    sachbearbeiter: { select: { id: true, name: true, email: true } },
    kanzlei: { select: { name: true } },
    beteiligte: { include: { kontakt: true }, orderBy: { createdAt: "asc" } },
    dokumente: { orderBy: { createdAt: "desc" }, include: { ... } },
    kalenderEintraege: { orderBy: { datum: "asc" }, include: { ... } },
    auditLogs: { orderBy: { createdAt: "desc" }, take: 50, include: { ... } },
    _count: { select: { dokumente, kalenderEintraege, zeiterfassungen, chatNachrichten, emailMessages } },
  },
});
```
Add to the include:
```typescript
normen: {
  include: { addedBy: { select: { name: true } } },
  orderBy: { createdAt: "desc" },
},
```

Current page render (line ~125):
```tsx
{/* Tabbed content */}
<AkteDetailTabs akte={serializedAkte} />
```
Insert NormenSection BEFORE this line (after the stats grid).

Glass card design pattern used in this project:
```tsx
<div className="glass-card rounded-xl p-4">
```

Lucide icons available: Scale, Plus, X, Loader2, Search, ExternalLink
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build NormenSection component</name>
  <files>src/components/akten/normen-section.tsx</files>
  <action>
Create `src/components/akten/normen-section.tsx` — a client component ("use client") with:

**Props interface:**
```typescript
interface PinnedNorm {
  id: string;
  gesetzKuerzel: string;
  paragraphNr: string;
  anmerkung: string | null;
  addedBy: { name: string | null };
  createdAt: string;
}

interface SearchResult {
  id: string;
  gesetzKuerzel: string;
  paragraphNr: string;
  titel: string;
  content: string;
  sourceUrl: string | null;
  syncedAt: string;
}

interface NormenSectionProps {
  akteId: string;
  initialNormen: PinnedNorm[];
}
```

**State:**
- `modalOpen: boolean` — controls add-norm modal visibility
- `search: string` — controlled input for search query
- `results: SearchResult[]` — search results from API
- `searching: boolean` — loading indicator during search fetch
- `adding: boolean` — loading indicator during POST
- `removing: string | null` — normId being removed (shows spinner on that chip's X)
- `anmerkung: string` — optional note for the norm being added
- `selectedResult: SearchResult | null` — norm selected in search results list (awaiting confirm)
- `detailNorm: SearchResult | null` — norm shown in detail Sheet
- `detailOpen: boolean` — controls detail Sheet visibility

**Debounced search (identical to BeteiligteAddDialog):**
```typescript
useEffect(() => {
  if (!modalOpen) return;
  const timer = setTimeout(() => {
    if (search.length >= 2) {
      setSearching(true);
      fetch(`/api/akten/${akteId}/normen/search?q=${encodeURIComponent(search)}`)
        .then(r => r.json())
        .then(setResults)
        .catch(() => {})
        .finally(() => setSearching(false));
    } else {
      setResults([]);
    }
  }, 300);
  return () => clearTimeout(timer);
}, [search, modalOpen, akteId]);
```

**handleAdd function:**
POST to `/api/akten/${akteId}/normen` with `{ gesetzKuerzel, paragraphNr, anmerkung: anmerkung || null }`. On success: toast.success, close modal, reset state, router.refresh(). On error: toast.error with message from response body.

**handleRemove function:**
DELETE to `/api/akten/${akteId}/normen/${normId}`. On success: toast.success("Norm entfernt"), router.refresh(). On error: toast.error.

**handleChipClick function (for detail sheet):**
Re-use the search endpoint: fetch `/api/akten/${akteId}/normen/search?q=${encodeURIComponent(norm.paragraphNr + " " + norm.gesetzKuerzel)}` → find matching result → setDetailNorm + setDetailOpen(true). Show loading state while fetching.

**Component render structure:**
```tsx
<div className="glass-card rounded-xl p-4">
  {/* Header row: Scale icon + "Verknüpfte Normen" title + count + "Norm hinzufügen" button */}

  {/* Chip list OR empty state */}
  {/* Each chip: "gesetzKuerzel paragraphNr" clickable label + optional anmerkung truncated to 30 chars + X remove button */}

  {/* Add Modal — use @radix-ui/react-dialog or conditional fixed overlay (follow BeteiligteAddDialog pattern) */}
  {/* Modal contents: search Input + results list + optional anmerkung textarea + Hinzufügen button */}

  {/* Detail Sheet — use Sheet from src/components/ui/sheet.tsx */}
  {/* Sheet contents: title "gesetzKuerzel paragraphNr" + content in <pre className="whitespace-pre-wrap text-sm"> + sourceUrl link */}
</div>
```

**Stale props guard:** Use `initialNormen` as the prop directly (passed as server data). Do NOT put initialNormen into useState — let router.refresh() re-run the server component and pass fresh props. For the chip list, render from `initialNormen` prop directly.

**Design details:**
- Chip styles: `inline-flex items-center gap-1 px-2.5 py-1 rounded-full border bg-background text-xs font-medium`
- Header: `flex items-center justify-between mb-3`
- Button for "Norm hinzufügen": `variant="outline" size="sm" className="h-7 text-xs"`
- Empty state: `<p className="text-xs text-muted-foreground">Noch keine Normen verknüpft. Normen fließen automatisch in Helenas Kontext ein.</p>`
- Glass card section: consistent with other glass-card sections in the project

**Modal implementation:** Since `dialog.tsx` does not exist, implement the modal as a Radix Dialog using the primitive directly:
```typescript
import * as Dialog from "@radix-ui/react-dialog";
```
Use `Dialog.Root`, `Dialog.Portal`, `Dialog.Overlay` (with `fixed inset-0 bg-black/50 z-50`), and `Dialog.Content` (with `fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-background rounded-xl p-6 shadow-xl z-50 w-full max-w-md`). Set `Dialog.Title` to "Norm hinzufügen".
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "normen-section" | head -10</verify>
  <done>NormenSection component file exists with exported NormenSection function. TypeScript errors: 0. Component renders chip list, handles add/remove interactions, shows search modal and detail sheet.</done>
</task>

<task type="auto">
  <name>Task 2: Wire NormenSection into Akte detail page</name>
  <files>src/app/(dashboard)/akten/[id]/page.tsx</files>
  <action>
Modify `src/app/(dashboard)/akten/[id]/page.tsx` to:

1. **Add normen to Prisma include** — inside the existing `prisma.akte.findUnique` call, add to the `include` object:
```typescript
normen: {
  include: { addedBy: { select: { name: true } } },
  orderBy: { createdAt: "desc" },
},
```

2. **Import NormenSection:**
```typescript
import { NormenSection } from "@/components/akten/normen-section";
```

3. **Render NormenSection between stats grid and AkteDetailTabs:**

Find the existing comment `{/* Tabbed content */}` above `<AkteDetailTabs ...>`. Insert NormenSection immediately before it:
```tsx
{/* Verknüpfte Normen — pinned § for Helena context */}
<NormenSection
  akteId={id}
  initialNormen={serializedAkte.normen ?? []}
/>

{/* Tabbed content */}
<AkteDetailTabs akte={serializedAkte} />
```

`serializedAkte` is already `JSON.parse(JSON.stringify(akte))` which serializes all dates to strings. The `normen` field will be present after the Prisma include is added.

**Nothing else changes in page.tsx.** Do not modify AkteDetailTabs, the stats grid, or any other component.
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "akten/\[id\]/page" | head -10</verify>
  <done>
- TypeScript errors: 0
- `grep "NormenSection" src/app/\(dashboard\)/akten/\[id\]/page.tsx` returns 2 matches (import + JSX)
- `grep "normen:" src/app/\(dashboard\)/akten/\[id\]/page.tsx` returns 1 match (Prisma include)
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript clean
npx tsc --noEmit 2>&1 | grep -E "normen" | head -20

# Verify component exists and exports NormenSection
grep -n "export function NormenSection" src/components/akten/normen-section.tsx

# Verify page.tsx wires NormenSection
grep -n "NormenSection" "src/app/(dashboard)/akten/[id]/page.tsx"

# Verify normen Prisma include added
grep -n "normen:" "src/app/(dashboard)/akten/[id]/page.tsx"
```
</verification>

<success_criteria>
- `npx tsc --noEmit` passes with 0 new errors
- NormenSection component renders in Akte detail page (visible at /akten/[id])
- "Norm hinzufügen" button opens search modal
- Typing "BGB" in the search input fetches results from /api/akten/[id]/normen/search
- Adding a norm creates it (POST returns 201) and chip appears after router.refresh()
- Clicking X on a chip deletes it (DELETE returns 204) and chip disappears after router.refresh()
- Clicking a chip label opens a Sheet with the full § text
- Empty state message is shown when no norms are pinned
</success_criteria>

<output>
After completion, create `.planning/phases/15-normen-verknuepfung-in-akte/15-03-SUMMARY.md`
</output>
