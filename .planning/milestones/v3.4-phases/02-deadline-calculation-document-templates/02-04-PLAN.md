---
phase: 02-deadline-calculation-document-templates
plan: 04
type: execute
wave: 2
depends_on:
  - 02-03
files_modified:
  - prisma/schema.prisma
  - src/lib/vorlagen.ts
  - src/lib/briefkopf.ts
  - src/app/api/vorlagen/route.ts
  - src/app/api/vorlagen/[id]/route.ts
  - src/app/api/vorlagen/[id]/generieren/route.ts
  - src/app/api/vorlagen/[id]/freigabe/route.ts
  - src/app/api/briefkopf/route.ts
  - src/app/api/briefkopf/[id]/route.ts
  - src/app/api/ordner-schemata/route.ts
autonomous: true
requirements:
  - REQ-DV-001
  - REQ-DV-002
  - REQ-DV-003
  - REQ-DV-008
  - REQ-DV-009

must_haves:
  truths:
    - "Generated document has all placeholders auto-filled from case data (mandant.name, akte.aktenzeichen, gegner.name, etc.)"
    - "Briefkopf is applied to generated documents -- logo + firm name at top, contact details in right sidebar, minimal header on subsequent pages"
    - "Multiple Briefkoepfe are supported (per Standort/team), one marked as default"
    - "Ordner-Schemata can be configured per Rechtsgebiet and are applied when creating new Akten"
    - "Templates support conditional sections and loops via docxtemplater"
    - "Template versioning tracks all changes, old versions accessible"
    - "Freigabe workflow: anyone creates drafts, only Admin/Anwalt can freigeben"
  artifacts:
    - path: "src/lib/vorlagen.ts"
      provides: "Enhanced template engine with conditional sections, loops, custom fields, Briefkopf merge"
      exports: ["fillDocxTemplate", "resolvePlatzhalter", "extractPlatzhalterFromDocx", "applyBriefkopf"]
    - path: "src/lib/briefkopf.ts"
      provides: "Briefkopf DOCX header/footer manipulation and PDF export via OnlyOffice Conversion API"
      exports: ["applyBriefkopfToDocx", "convertToPdf"]
    - path: "src/app/api/vorlagen/[id]/generieren/route.ts"
      provides: "4-step template generation endpoint"
      exports: ["POST"]
    - path: "src/app/api/briefkopf/route.ts"
      provides: "Briefkopf CRUD API"
      exports: ["GET", "POST"]
    - path: "src/app/api/ordner-schemata/route.ts"
      provides: "OrdnerSchema CRUD API"
      exports: ["GET", "POST", "PUT", "DELETE"]
  key_links:
    - from: "src/app/api/vorlagen/[id]/generieren/route.ts"
      to: "src/lib/vorlagen.ts"
      via: "resolvePlatzhalter + fillDocxTemplate"
      pattern: "resolvePlatzhalter|fillDocxTemplate"
    - from: "src/app/api/vorlagen/[id]/generieren/route.ts"
      to: "src/lib/briefkopf.ts"
      via: "applyBriefkopfToDocx for letterhead application"
      pattern: "applyBriefkopf"
    - from: "src/lib/briefkopf.ts"
      to: "src/app/api/onlyoffice/convert/route.ts"
      via: "convertToPdf calls OnlyOffice Conversion API"
      pattern: "converter|convert"
---

<objective>
Build the backend for the Vorlagen-System: enhanced schema (template versioning, Freigabe, custom fields, tags), template engine enhancements (conditional sections, loops), Briefkopf management library and API, document generation endpoint, Ordner-Schemata API, and Vorlagen Freigabe API.

Purpose: This plan builds all backend infrastructure required for template-based document generation, Briefkopf application, and organization schema management. The UI for browsing/wizards/settings is in Plan 02-05 (depends on this plan).

Output: Enhanced Prisma schema, Briefkopf + Vorlagen libraries, all API endpoints for CRUD + generation + Freigabe + Briefkopf + Ordner-Schemata.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md
@.planning/phases/02-deadline-calculation-document-templates/02-03-SUMMARY.md

@src/lib/vorlagen.ts
@src/lib/onlyoffice.ts
@prisma/schema.prisma
@src/app/api/vorlagen/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema + Enhanced Vorlagen Library + Briefkopf Library</name>
  <files>
    prisma/schema.prisma,
    src/lib/vorlagen.ts,
    src/lib/briefkopf.ts
  </files>
  <action>
    **1. Schema Changes (prisma/schema.prisma):**
    Enhance `DokumentVorlage` model:
    - Add `version Int @default(1)`
    - Add `tags String[]` for search/filter
    - Add `freigegeben Boolean @default(false)`
    - Add `freigegebenVonId String?` with optional User relation
    - Add `freigegebenAm DateTime?`
    - Add `customFelder Json?` -- stores array of `{ key: string, label: string, typ: 'TEXT'|'NUMBER'|'DATE'|'DROPDOWN', optionen?: string[] }`
    - Add `favoritenVon String[]` -- User IDs who favorited
    - Add `VorlageVersion` model for template version history (similar to DokumentVersion: id, vorlageId, version, dateipfad, createdById, createdAt)

    Add `Briefkopf` model:
    - id, name, dateipfad (MinIO path to DOCX), logoUrl (MinIO path to logo), kanzleiName, adresse, telefon, fax, email, website, steuernr, ustIdNr, iban, bic, bankName, braoInfo, istStandard Boolean @default(false), createdAt, updatedAt

    Add `OrdnerSchema` model:
    - id, name, sachgebiet (Sachgebiet? enum), ordner (String[]), istStandard Boolean @default(false), createdAt, updatedAt

    Run `npx prisma db push`.

    **2. Enhanced Vorlagen Library (src/lib/vorlagen.ts):**
    Keep existing `resolvePlatzhalter()`, `fillDocxTemplate()`, `extractPlatzhalterFromDocx()`, `createBlankDocx()`.
    Enhance `fillDocxTemplate()` to support:
    - Conditional sections: `{#if condition}...{/if}` and `{^if condition}...{/if}` (inverted)
    - Loops: `{#items}...{/items}` for arrays
    - Custom fields merged into the data object alongside case data
    Ensure docxtemplater is configured with `paragraphLoop: true, linebreaks: true, delimiters: { start: "{{", end: "}}" }`.

    **3. Briefkopf Library (src/lib/briefkopf.ts):**
    `applyBriefkopfToDocx(docxBuffer: Buffer, briefkopfBuffer: Buffer): Buffer`:
    - Uses PizZip to open both documents.
    - Copies header/footer XML parts from briefkopf DOCX to target DOCX.
    - Copies referenced media (images/logo) from briefkopf.
    - Updates relationships in `word/_rels/document.xml.rels`.
    - Updates `[Content_Types].xml` for new media.
    - Handles first-page-different header: full letterhead on first page, minimal on subsequent.
    - Returns merged DOCX as Buffer.
    - CRITICAL: Test with actual DOCX files. If PizZip manipulation proves too brittle for header/footer merge (per RESEARCH.md Open Question #3), fall back to full-template approach where Briefkopf is a complete DOCX template and content is injected into it.

    `convertToPdf(dokumentId: string): Promise<Buffer>`:
    - Load document from DB + MinIO.
    - Call OnlyOffice Conversion API (POST /converter) endpoint -- reuse the existing convert route logic or call it internally.
    - Return PDF buffer.
  </action>
  <verify>
    <automated>npx prisma validate && npx tsc --noEmit src/lib/vorlagen.ts src/lib/briefkopf.ts</automated>
    <manual>Test fillDocxTemplate with conditional sections. Test applyBriefkopfToDocx with a sample DOCX.</manual>
  </verify>
  <done>DokumentVorlage has versioning, tags, Freigabe, customFelder. Briefkopf and OrdnerSchema models exist. Vorlagen library supports conditionals and loops. Briefkopf library merges headers/footers into DOCX.</done>
</task>

<task type="auto">
  <name>Task 2: Vorlagen CRUD + Freigabe + Generation + Briefkopf + Ordner-Schemata APIs</name>
  <files>
    src/app/api/vorlagen/route.ts,
    src/app/api/vorlagen/[id]/route.ts,
    src/app/api/vorlagen/[id]/generieren/route.ts,
    src/app/api/vorlagen/[id]/freigabe/route.ts,
    src/app/api/briefkopf/route.ts,
    src/app/api/briefkopf/[id]/route.ts,
    src/app/api/ordner-schemata/route.ts
  </files>
  <action>
    **1. Enhanced Vorlagen API (src/app/api/vorlagen/route.ts):**
    GET: List templates with filtering by kategorie, tags, freigegeben. Include favoritenVon (check if current user favorited). Sort: favorites first, then "Zuletzt verwendet" (track in localStorage on client), then by kategorie.
    POST: Create template. Upload DOCX to MinIO. Extract placeholders. Set freigegeben=false (draft). Accept customFelder definition. Accept tags.

    **2. Vorlagen Detail API (src/app/api/vorlagen/[id]/route.ts):**
    GET: Single template with all fields.
    PUT: Update template. Upload new DOCX, increment version, create VorlageVersion snapshot of previous.
    DELETE: Soft-delete or hard-delete.
    PATCH (favorite): Toggle favorite for current user (add/remove userId from favoritenVon).

    **3. Freigabe API (src/app/api/vorlagen/[id]/freigabe/route.ts):**
    POST: Set freigegeben=true, freigegebenVonId=current user, freigegebenAm=now.
    Only ADMIN or ANWALT roles allowed (per user decision).
    DELETE: Revoke Freigabe (set freigegeben=false). Only ADMIN or ANWALT.

    **4. Generation Endpoint (src/app/api/vorlagen/[id]/generieren/route.ts):**
    POST body: `{ akteId: string, customFelderValues?: Record<string, string>, briefkopfId?: string, openInEditor?: boolean, targetOrdner?: string, dateiname?: string }`.
    Steps:
    1. Load template DOCX from MinIO.
    2. Load Akte with all Beteiligte, Anwalt, Kanzlei data (Prisma include).
    3. Call `resolvePlatzhalter(akteData)` to get all placeholder values.
    4. Merge customFelderValues into the data object.
    5. Call `fillDocxTemplate(templateBuffer, mergedData)`.
    6. If briefkopfId provided (or use default Briefkopf), call `applyBriefkopfToDocx(filledBuffer, briefkopfBuffer)`.
    7. Auto-generate filename: `{Aktenzeichen}_{VorlageTyp}_{Partei}_{Datum}` (per user decision, editable via dateiname param).
    8. Upload generated DOCX to MinIO in the Akte's folder (use targetOrdner or suggest based on template category).
    9. Create Dokument record in DB (linked to Akte, status ENTWURF, erstelltDurch="system").
    10. Return Dokument record. If openInEditor=true, also return OnlyOffice editor config for immediate editing.

    **5. Briefkopf API (src/app/api/briefkopf/route.ts + [id]/route.ts):**
    GET: List all Briefkoepfe. Mark which is default.
    POST: Create Briefkopf. Upload logo to MinIO. If structured form: create DOCX with header/footer from form data. If DOCX upload: store directly.
    PUT: Update Briefkopf fields + file.
    DELETE: Delete Briefkopf (not if it's the only one or default).
    PATCH: Set as default (toggle istStandard, unset on others).

    **6. Ordner-Schemata API (src/app/api/ordner-schemata/route.ts):**
    GET: List all schemas. Can filter by sachgebiet.
    POST: Create schema with name, sachgebiet, ordner array.
    PUT: Update schema.
    DELETE: Delete (not if istStandard).
    When creating a new Akte (check existing Akte creation endpoint), apply matching OrdnerSchema to create default folder structure.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Test template generation via API with a real Akte. Test Briefkopf CRUD. Test Ordner-Schemata CRUD.</manual>
  </verify>
  <done>Vorlagen CRUD with versioning, tags, Freigabe (ADMIN/ANWALT only). Generation endpoint fills template with case data and applies Briefkopf. Briefkopf CRUD with default selection. Ordner-Schemata CRUD. All API routes working.</done>
</task>

</tasks>

<verification>
```bash
# Schema validates
npx prisma validate

# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build
```
</verification>

<success_criteria>
- DokumentVorlage model has versioning, tags, Freigabe, customFelder fields
- Briefkopf model exists with full CRUD API and default selection
- OrdnerSchema model exists with CRUD API
- Generation endpoint fills template with case data and applies Briefkopf
- Briefkopf header/footer merge works (full letterhead first page, minimal subsequent)
- Template versioning tracks all changes
- Freigabe workflow: anyone creates drafts, only Admin/Anwalt can freigeben
- Ordner-Schemata applied when creating new Akten
- All API endpoints respond correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-04-SUMMARY.md`
</output>
