---
phase: 16-pii-filter
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pii/ner-filter.ts
  - src/lib/pii/institution-whitelist.ts
autonomous: true
requirements:
  - URTEIL-03

must_haves:
  truths:
    - "runNerFilter() returns { persons: string[], hasPii: boolean } for any German legal text input"
    - "Institution names (Bundesgerichtshof, Amtsgericht Koeln, BGH, 2. Senat, Kammer) are never present in persons[]"
    - "45s AbortSignal.timeout fires on Ollama non-response — function throws, never returns hasPii: false silently"
    - "format:json + JSON extraction both applied as double defense against <think> token leakage"
  artifacts:
    - path: "src/lib/pii/ner-filter.ts"
      provides: "runNerFilter(), buildNerPrompt(), NerResult interface"
      exports:
        - runNerFilter
        - buildNerPrompt
        - NerResult
    - path: "src/lib/pii/institution-whitelist.ts"
      provides: "INSTITUTION_PATTERNS[], isInstitutionName()"
      exports:
        - isInstitutionName
        - INSTITUTION_PATTERNS
  key_links:
    - from: "src/lib/pii/ner-filter.ts"
      to: "http://OLLAMA_URL/api/generate"
      via: "fetch with AbortSignal.timeout(45_000)"
      pattern: "AbortSignal\\.timeout\\(45_000\\)"
    - from: "src/lib/pii/ner-filter.ts"
      to: "src/lib/pii/institution-whitelist.ts"
      via: "isInstitutionName() filter after NER extraction"
      pattern: "isInstitutionName"
---

<objective>
Build the core NER-PII filter module: two files that any downstream consumer (BullMQ processor in Plan 02, Phase 17 Urteil scraper) can import and call directly.

Purpose: DSGVO gate — no text reaches pgvector without passing through person-name extraction + institution whitelist filtering.
Output: src/lib/pii/ner-filter.ts + src/lib/pii/institution-whitelist.ts
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-pii-filter/16-RESEARCH.md

<interfaces>
<!-- Verified from project codebase — executor uses these directly -->

From src/lib/ai/reranker.ts (Ollama pattern to replicate):
```typescript
const response = await fetch(`${OLLAMA_URL}/api/generate`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    model: RERANKER_MODEL,
    prompt,
    stream: false,
    temperature: 0,
    num_predict: 500,
  }),
  signal: AbortSignal.timeout(timeoutMs),
});
const data = (await response.json()) as { response: string };
// Extract JSON — handles potential <think>...</think> prefix
const jsonMatch = data.response.match(/\{[\s\S]*\}/);
```

From src/lib/logger.ts (logger pattern):
```typescript
import { createLogger } from "@/lib/logger";
const log = createLogger("ner-filter");
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create institution-whitelist.ts</name>
  <files>src/lib/pii/institution-whitelist.ts</files>
  <action>
Create `src/lib/pii/` directory and `institution-whitelist.ts` with:

1. `INSTITUTION_PATTERNS: RegExp[]` — covers all German court and government name patterns:
   - 7 Bundesgerichte (Bundesgerichtshof, Bundesarbeitsgericht, Bundesverwaltungsgericht, Bundesfinanzhof, Bundessozialgericht, Bundespatentgericht, Bundesverfassungsgericht) — each as `/\bBundesXXX\b/i`
   - Regional court pattern: `/\b(Amtsgericht|Landgericht|Oberlandesgericht|Arbeitsgericht|Landesarbeitsgericht|Sozialgericht|Landessozialgericht|Finanzgericht|Verwaltungsgericht|Oberverwaltungsgericht)\s+\w+/i`
   - Court abbreviations: `/\b(AG|LG|OLG|LAG|LSG|SG|VG|OVG|BAG|BGH|BVerfG|BFH|BVerwG|BSG|BPatG)\b/`
   - Government bodies: `/\bBundesministerium\b/i`, `/\bLandesministerium\b/i`, `/\bSenatskommission\b/i`, `/\bSenat\b/i`, `/\bKammer\b/i`, `/\bStaatsanwaltschaft\b/i`, `/\bGeneralbundesanwalt\b/i`, `/\bJustizminister(ium)?\b/i`
   - Also: `/\bBundesrepublik\b/i`, `/\bLandtag\b/i`, `/\bBundestag\b/i`

2. `export function isInstitutionName(candidate: string): boolean` — returns true if ANY pattern in INSTITUTION_PATTERNS matches the candidate string.

Note: This function must return true for the candidate "Bundesgerichtshof", "Amtsgericht Koeln", "BGH", "2. Senat", "Kammer", "Staatsanwaltschaft Muenchen". Success criterion 1 depends entirely on this whitelist being comprehensive.
  </action>
  <verify>TypeScript compiles: `cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit src/lib/pii/institution-whitelist.ts 2>&1 | head -20`</verify>
  <done>File exists with exported INSTITUTION_PATTERNS and isInstitutionName(); isInstitutionName("Bundesgerichtshof") returns true; isInstitutionName("Hans Mueller") returns false</done>
</task>

<task type="auto">
  <name>Task 2: Create ner-filter.ts core module</name>
  <files>src/lib/pii/ner-filter.ts</files>
  <action>
Create `src/lib/pii/ner-filter.ts` with the following exports and behavior:

**Constants:**
```typescript
const OLLAMA_URL = process.env.OLLAMA_URL ?? "http://localhost:11434";
const NER_MODEL = "qwen3.5:35b";
const NER_TIMEOUT_MS = 45_000; // BRAO §43a compliance — hard kill, never silent pass
```

**NerResult interface (exported):**
```typescript
export interface NerResult {
  persons: string[];  // full names of natural persons after whitelist filter
  hasPii: boolean;    // true if any persons[] remain
}
```

**buildNerPrompt(text: string): string (exported)** — returns the few-shot German legal NER prompt from RESEARCH.md Pattern 4. Use BOTH `text.slice(0, 6000)` for the main text AND the comment that callers handling Muster should pass `text.slice(0, 6000) + "\n...\n" + text.slice(-2000)` (document this in JSDoc, the caller is responsible for the text window). The function itself just embeds whatever `text` string it receives.

Include all 6 few-shot examples from the research document exactly as written (the BGH Senat example, the Klaeger Hans Mueller example, the Richterin Dr. Sabine Hoffmann example, the Rechtsanwalt Dr. Klaus Weber example, the LAG Hamm Karl Lehmann example, and the "Klage wird abgewiesen" no-names example).

**runNerFilter(text: string): Promise<NerResult> (exported):**
1. Build prompt via `buildNerPrompt(text)`
2. POST to `${OLLAMA_URL}/api/generate` with `{ model: NER_MODEL, prompt, stream: false, format: "json", temperature: 0, num_predict: 500 }` and `signal: AbortSignal.timeout(NER_TIMEOUT_MS)`
3. If `!response.ok` throw `new Error(\`Ollama NER failed HTTP ${response.status}\`)`
4. Parse: `const data = await response.json() as { response: string }`
5. Extract JSON using BOTH defenses: `const jsonMatch = data.response.match(/\{[\s\S]*\}/)` — if no match, throw `new Error("NER response contained no JSON")`
6. Parse: `const parsed = JSON.parse(jsonMatch[0]) as { persons?: unknown }` — wrap in try/catch, throw on parse error
7. `const rawPersons = Array.isArray(parsed.persons) ? (parsed.persons as string[]).filter(p => typeof p === "string") : []`
8. `const filteredPersons = rawPersons.filter(p => !isInstitutionName(p))`
9. Return `{ persons: filteredPersons, hasPii: filteredPersons.length > 0 }`

Import `isInstitutionName` from `./institution-whitelist`. Import `createLogger` from `@/lib/logger`. Log at `log.debug` on successful extraction, `log.warn` on empty rawPersons.

CRITICAL: Do NOT catch the AbortError from `AbortSignal.timeout`. Let it propagate so BullMQ processor knows NER failed. Never return `hasPii: false` on timeout.
  </action>
  <verify>`cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | grep -E "pii" | head -20`</verify>
  <done>TypeScript compiles clean for pii/ directory; NerResult interface and runNerFilter are exported; isInstitutionName imported and applied; AbortSignal.timeout(45_000) present in fetch call</done>
</task>

</tasks>

<verification>
`cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | tail -5`

Both files compile without TypeScript errors. No new packages installed (all patterns use existing fetch + existing logger).
</verification>

<success_criteria>
- src/lib/pii/institution-whitelist.ts exists with isInstitutionName() and INSTITUTION_PATTERNS
- src/lib/pii/ner-filter.ts exists with runNerFilter(), buildNerPrompt(), NerResult
- 6 few-shot examples embedded in buildNerPrompt()
- AbortSignal.timeout(45_000) — no silent catch
- format:"json" + /\{[\s\S]*\}/ double defense both present
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/16-pii-filter/16-01-SUMMARY.md`
</output>
