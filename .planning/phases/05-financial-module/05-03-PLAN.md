---
phase: 05-financial-module
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/lib/finance/aktenkonto/types.ts
  - src/lib/finance/aktenkonto/booking.ts
  - src/lib/finance/aktenkonto/fremdgeld.ts
  - src/lib/finance/aktenkonto/saldo.ts
  - src/app/api/finanzen/aktenkonto/route.ts
  - src/app/api/finanzen/aktenkonto/[akteId]/route.ts
  - src/app/api/finanzen/aktenkonto/[akteId]/storno/route.ts
  - src/app/api/finanzen/buchungsperioden/route.ts
  - src/app/api/finanzen/kostenstellen/route.ts
  - src/app/api/finanzen/rechnungen/[id]/route.ts
  - src/lib/finance/aktenkonto/__tests__/fremdgeld.test.ts
autonomous: true
requirements:
  - REQ-FI-005
  - REQ-FI-006

must_haves:
  truths:
    - "Aktenkonto displays all bookings (Einnahme/Ausgabe/Fremdgeld/Auslage) with running Saldo per case"
    - "Bookings are append-only: corrections happen via Stornobuchung + new booking, never editing existing entries"
    - "Fremdgeld is displayed separately with a dedicated section and color-coding"
    - "5-Werktage forwarding alert fires when Fremdgeld booking exceeds the deadline"
    - "15k EUR Anderkonto threshold warning triggers when total Fremdgeld approaches the limit"
    - "Buchungsperioden can be locked by ADMIN, preventing backdated bookings into closed months"
  artifacts:
    - path: "src/lib/finance/aktenkonto/booking.ts"
      provides: "Append-only booking creation and Storno logic"
      exports: ["createBooking", "stornoBooking"]
    - path: "src/lib/finance/aktenkonto/fremdgeld.ts"
      provides: "Fremdgeld compliance checks and deadline calculation"
      exports: ["checkFremdgeldCompliance", "calculateFremdgeldDeadline", "getFremdgeldAlerts"]
    - path: "src/lib/finance/aktenkonto/saldo.ts"
      provides: "Balance calculation per case and per Buchungstyp"
      exports: ["calculateSaldo", "calculateFremdgeldSaldo"]
    - path: "src/app/api/finanzen/aktenkonto/[akteId]/route.ts"
      provides: "Per-case Aktenkonto bookings API"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/finanzen/aktenkonto/[akteId]/route.ts"
      to: "src/lib/finance/aktenkonto/booking.ts"
      via: "createBooking for new entries"
      pattern: "createBooking"
    - from: "src/app/api/finanzen/aktenkonto/[akteId]/route.ts"
      to: "src/lib/finance/aktenkonto/fremdgeld.ts"
      via: "Fremdgeld compliance check on every Fremdgeld booking"
      pattern: "checkFremdgeldCompliance|calculateFremdgeldDeadline"
    - from: "src/app/api/finanzen/aktenkonto/[akteId]/route.ts"
      to: "src/lib/finance/aktenkonto/saldo.ts"
      via: "Running balance calculation for response"
      pattern: "calculateSaldo"
    - from: "src/app/api/finanzen/rechnungen/[id]/route.ts"
      to: "src/lib/finance/aktenkonto/booking.ts"
      via: "Auto-book Aktenkonto on invoice status transition"
      pattern: "autoBookFromInvoice"
---

<objective>
Build the Aktenkonto (case account) backend with append-only booking model, Storno workflow, Fremdgeld compliance checks (5-Werktage forwarding alerts + 15k Anderkonto threshold), balance calculation, and Buchungsperioden with period locking.

Purpose: The Aktenkonto is legally mandated (SS 43a BRAO) and Fremdgeld compliance violations can trigger Kammerdisziplinarverfahren. The append-only model mirrors real accounting (GoBD-compliant) and the period-locking prevents backdated modifications.

Output: Working Aktenkonto API with Fremdgeld compliance, Storno workflow, balance tracking, Buchungsperioden, and Kostenstellen management.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-module/05-RESEARCH.md
@.planning/phases/05-financial-module/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Aktenkonto Library (Booking + Fremdgeld + Saldo)</name>
  <files>
    src/lib/finance/aktenkonto/types.ts
    src/lib/finance/aktenkonto/booking.ts
    src/lib/finance/aktenkonto/fremdgeld.ts
    src/lib/finance/aktenkonto/saldo.ts
  </files>
  <action>
    **1. Types** (src/lib/finance/aktenkonto/types.ts):
    - `BookingInput { akteId, buchungstyp: BuchungsTyp, betrag: number, verwendungszweck, buchungsdatum?, rechnungId?, bankTransaktionId?, dokumentId?, kostenstelle?, konto?: KontoTyp, gebuchtVon: string }`
    - `StornoInput { originalId: string, grund: string, userId: string }`
    - `SaldoResult { gesamtSaldo: number, einnahmen: number, ausgaben: number, fremdgeld: number, auslagen: number, offeneForderungen: number }`
    - `FremdgeldAlert { buchungId: string, akteId: string, betrag: number, eingangsDatum: Date, frist: Date, verbleibendeTage: number, dringlichkeit: "normal" | "warnung" | "kritisch" | "ueberfaellig" }`
    - `AnderkontoAlert { akteId: string, totalFremdgeld: number, schwelle: number, ueberschritten: boolean }`

    **2. Booking** (src/lib/finance/aktenkonto/booking.ts):
    - `createBooking(input: BookingInput)`: Creates a new AktenKontoBuchung. Validates:
      - Buchungsperiode for buchungsdatum month is not GESPERRT
      - If FREMDGELD: calculate and store fremdgeldFrist (5 business days from buchungsdatum using feiertagejs + date-fns)
      - Log via audit trail
    - `stornoBooking(input: StornoInput)`: Creates a negating Stornobuchung:
      - Load original booking
      - Create new booking with negated betrag, stornoVon = originalId, stornoGrund = grund
      - Audit log: "Stornobuchung fuer {original.verwendungszweck}"
    - `autoBookFromInvoice(rechnungId, transition)`: When invoice transitions:
      - GESTELLT: create EINNAHME booking (Forderung) with positive betrag
      - BEZAHLT: no additional booking (Forderung already booked)
      - STORNIERT: create Stornobuchung for the Forderung booking

    **3. Fremdgeld Compliance** (src/lib/finance/aktenkonto/fremdgeld.ts):
    - `calculateFremdgeldDeadline(buchungsdatum: Date, bundesland?: string): Date`:
      Use feiertagejs (already installed) for German holidays (NRW default) and date-fns for business day arithmetic. Count 5 business days forward from buchungsdatum, skipping weekends and holidays.
    - `checkFremdgeldCompliance(akteId: string): Promise<{ alerts: FremdgeldAlert[], anderkontoAlert?: AnderkontoAlert }>`:
      Query all FREMDGELD bookings that are not yet forwarded (no matching Ausgabe booking with stornoVon).
      For each: calculate verbleibendeTage from fremdgeldFrist. Classify dringlichkeit:
        - verbleibendeTage > 3: "normal"
        - verbleibendeTage 1-3: "warnung"
        - verbleibendeTage 0: "kritisch"
        - verbleibendeTage < 0: "ueberfaellig"
      Sum total Fremdgeld. If >= 15000: create AnderkontoAlert.
    - `getFremdgeldAlerts(): Promise<FremdgeldAlert[]>`: Global query across all Akten for active Fremdgeld alerts (for dashboard widget and BullMQ cron job).

    **4. Saldo** (src/lib/finance/aktenkonto/saldo.ts):
    - `calculateSaldo(akteId: string): Promise<SaldoResult>`:
      Aggregate AktenKontoBuchung by buchungstyp. Return breakdown.
    - `calculateFremdgeldSaldo(akteId: string): Promise<number>`:
      Sum all FREMDGELD bookings (includes Storno entries which are negative).
    - `calculateRunningBalance(akteId: string): Promise<Array<AktenKontoBuchung & { laufenderSaldo: number }>>`:
      Return chronological bookings with running balance computed from cumulative sum.
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Verify booking.ts creates append-only entries and stornoBooking negates correctly</manual>
  </verify>
  <done>
    Aktenkonto library handles append-only bookings with Storno, Fremdgeld compliance with 5-Werktage deadline using feiertagejs, 15k Anderkonto threshold, and running balance calculation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Aktenkonto + Buchungsperioden + Kostenstellen API Routes + Invoice Auto-Booking Wiring</name>
  <files>
    src/app/api/finanzen/aktenkonto/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/storno/route.ts
    src/app/api/finanzen/buchungsperioden/route.ts
    src/app/api/finanzen/kostenstellen/route.ts
    src/app/api/finanzen/rechnungen/[id]/route.ts
    src/lib/finance/aktenkonto/__tests__/fremdgeld.test.ts
  </files>
  <action>
    **1. Cross-Case Aktenkonto** (src/app/api/finanzen/aktenkonto/route.ts):
    - GET: List all bookings across cases with filters (akteId, buchungstyp, dateRange, kostenstelle, konto). Pagination. Include akte.aktenzeichen. Summary stats: total Einnahmen, Ausgaben, Fremdgeld, Auslagen.

    **2. Per-Case Aktenkonto** (src/app/api/finanzen/aktenkonto/[akteId]/route.ts):
    - GET: All bookings for this Akte with running balance (calculateRunningBalance). Also return SaldoResult and FremdgeldAlerts. Filters: buchungstyp, dateRange.
    - POST: Create manual booking. Zod schema: `{ buchungstyp, betrag (positive number), verwendungszweck, buchungsdatum?, kostenstelle?, konto?, dokumentId? }`. Call createBooking(). Auth check: ANWALT/SACHBEARBEITER can book all types, SEKRETARIAT cannot book FREMDGELD (403), PRAKTIKANT read-only (403 on POST). Return new booking + updated SaldoResult.

    **3. Storno Endpoint** (src/app/api/finanzen/aktenkonto/[akteId]/storno/route.ts):
    - POST: `{ buchungId, grund }`. Call stornoBooking(). Validate: booking belongs to akteId. Auth check: ANWALT/ADMIN only. Audit log.

    **4. Buchungsperioden** (src/app/api/finanzen/buchungsperioden/route.ts):
    - GET: List all Buchungsperioden for active Kanzlei with status. Include booking counts per period.
    - POST: Lock a period. `{ jahr, monat }`. ADMIN-only. Set status = GESPERRT, gesperrtVon = userId, gesperrtAm = now(). Prevent if earlier periods are still OFFEN (must close sequentially).
    - PATCH: Unlock a period. `{ jahr, monat, action: "entsperren" }`. ADMIN-only. Set status = OFFEN.

    **5. Kostenstellen** (src/app/api/finanzen/kostenstellen/route.ts):
    - GET: List active Kostenstellen for Kanzlei. Include usage count.
    - POST: Create new Kostenstelle. `{ name, beschreibung?, sachkonto? }`. ADMIN-only.
    - PATCH: Update Kostenstelle. `{ id, name?, beschreibung?, sachkonto?, aktiv? }`. ADMIN-only.
    - DELETE: Deactivate (set aktiv=false, never hard delete if bookings reference it).

    All routes: auth(), Zod validation, German error messages, audit logging for mutations.

    **6. Invoice → Aktenkonto Auto-Booking Wiring** (src/app/api/finanzen/rechnungen/[id]/route.ts):
    Update the PATCH handler (created in Plan 02) to call `autoBookFromInvoice()` after `transitionInvoiceStatus()` completes. Per CONTEXT locked decision: "Invoice → Aktenkonto: auto-book on status change (Gestellt → Forderung, Bezahlt → Einnahme, Storno → Stornobuchung)".
    - Import `autoBookFromInvoice` from `@/lib/finance/aktenkonto/booking`
    - After `transitionInvoiceStatus(rechnungId, action)` succeeds, call `autoBookFromInvoice(rechnungId, action)` within the same Prisma transaction
    - This ensures every invoice status change automatically creates the corresponding Aktenkonto entry

    **7. Fremdgeld Compliance Tests** (src/lib/finance/aktenkonto/__tests__/fremdgeld.test.ts):
    Create vitest test file covering:
    - `calculateFremdgeldDeadline()`: verify 5-business-day calculation skips weekends and NRW holidays (test with known holiday dates)
    - `checkFremdgeldCompliance()`: verify dringlichkeit classification (normal/warnung/kritisch/ueberfaellig)
    - `AnderkontoAlert`: verify 15k EUR threshold triggers warning
    - At least 10 test cases for Fremdgeld deadline edge cases
  </action>
  <verify>
    <automated>npx vitest run src/lib/finance/aktenkonto/__tests__/fremdgeld.test.ts && npx tsc --noEmit</automated>
    <manual>Verify Fremdgeld booking creates 5-day deadline, Storno creates negating entry, period locking prevents backdated bookings, invoice status change auto-books Aktenkonto entry</manual>
  </verify>
  <done>
    Aktenkonto CRUD with running balance, Fremdgeld compliance alerts, Storno workflow, Buchungsperioden with ADMIN-only period locking, and configurable Kostenstellen. Role-based access: SEKRETARIAT no Fremdgeld, PRAKTIKANT read-only. Invoice status transitions auto-book Aktenkonto entries. Fremdgeld deadline tests pass.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- POST booking creates append-only entry and returns updated Saldo
- Fremdgeld booking sets fremdgeldFrist 5 business days out (skipping weekends/holidays)
- Storno creates negating booking with stornoVon reference
- SEKRETARIAT user gets 403 when trying to book FREMDGELD
- Period locking prevents booking creation in GESPERRT month
</verification>

<success_criteria>
- Aktenkonto per case shows chronological bookings with running balance
- Fremdgeld compliance: 5-Werktage deadline calculated using feiertagejs, alerts fire with correct dringlichkeit
- 15k Anderkonto threshold warning active when sum exceeds limit
- Append-only model: no UPDATE/DELETE on bookings, only Storno
- Buchungsperioden lockable by ADMIN, sequential closing enforced
- RBAC: SEKRETARIAT no Fremdgeld, PRAKTIKANT read-only, ADMIN all + period lock
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-module/05-03-SUMMARY.md`
</output>
