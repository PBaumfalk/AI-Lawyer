---
phase: 06-ai-features-bea
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
  - prisma/seed.ts
  - src/lib/ai/provider.ts
  - src/lib/ai/token-tracker.ts
  - src/lib/ai/ollama.ts
  - src/lib/ai/process-tasks.ts
  - src/lib/settings/defaults.ts
  - src/app/(dashboard)/einstellungen/ki/page.tsx
  - src/app/api/ki/provider-test/route.ts
  - src/app/api/ki/usage/route.ts
  - src/app/api/openclaw/process/route.ts
  - src/middleware.ts
autonomous: true
requirements:
  - REQ-KI-002
  - REQ-KI-009
  - REQ-KI-012
  - REQ-KI-008

must_haves:
  truths:
    - "Admin can select AI provider (Ollama/OpenAI/Anthropic) in Einstellungen and test connection"
    - "All AI-generated outputs are marked as ENTWURF with KI badge and cannot be sent without explicit human Freigabe"
    - "Helena bot user exists in the system and is attributed as author of AI-generated content"
    - "Token usage is tracked per request (function, user, model) and aggregated for admin dashboard"
    - "/api/openclaw/process is restricted to ADMIN role with rate limiting"
    - "App displays 'Helena ist gerade nicht verfuegbar' banner when AI provider is unreachable"
  artifacts:
    - path: "src/lib/ai/provider.ts"
      provides: "Multi-provider AI factory reading from SystemSetting"
      exports: ["getModel", "getEmbeddingModel", "testProviderConnection"]
    - path: "src/lib/ai/token-tracker.ts"
      provides: "Token usage tracking and budget enforcement"
      exports: ["trackTokenUsage", "getTokenUsageSummary", "checkBudget"]
    - path: "src/app/(dashboard)/einstellungen/ki/page.tsx"
      provides: "Admin AI settings page with provider selection and test"
    - path: "prisma/schema.prisma"
      provides: "TokenUsage model and User.isSystem field"
      contains: "model TokenUsage"
  key_links:
    - from: "src/lib/ai/provider.ts"
      to: "SystemSetting"
      via: "getSetting('ai.provider')"
      pattern: "getSetting.*ai\\.provider"
    - from: "src/lib/ai/token-tracker.ts"
      to: "prisma.tokenUsage"
      via: "database insert after each AI call"
      pattern: "prisma\\.tokenUsage\\.create"
    - from: "src/lib/ai/process-tasks.ts"
      to: "src/lib/ai/provider.ts"
      via: "getModel() call replacing direct Ollama fetch"
      pattern: "getModel\\(\\)"
---

<objective>
Install AI SDK v4 with multi-provider support (Ollama, OpenAI, Anthropic), create provider factory driven by SystemSettings, enforce KI-Entwurf workflow (all AI output = ENTWURF, badges, versand-gate), create Helena bot user, implement token usage tracking with monthly budget, add rate limiting on OpenClaw process endpoint, and build admin AI settings page.

Purpose: Foundation layer that all subsequent AI plans depend on -- provider abstraction, safety enforcement, and usage tracking.
Output: Working AI provider factory, token tracker, admin settings UI, Helena user, rate-limited API.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md

# Existing AI infrastructure
@src/lib/ai/ollama.ts
@src/lib/ai/process-tasks.ts
@src/lib/ai/prompt-templates.ts
@src/lib/settings/defaults.ts
@src/lib/versand-gate.ts
@src/lib/openclaw-auth.ts
@prisma/schema.prisma
@prisma/seed.ts
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AI SDK v4 + Create Provider Factory + Schema Changes + Helena User</name>
  <files>
    package.json
    prisma/schema.prisma
    prisma/seed.ts
    src/lib/ai/provider.ts
    src/lib/ai/token-tracker.ts
    src/lib/ai/ollama.ts
    src/lib/ai/process-tasks.ts
    src/lib/settings/defaults.ts
  </files>
  <action>
1. Install AI SDK v4 packages: `npm install ai@^4.0 @ai-sdk/openai@^1.0 @ai-sdk/anthropic@^1.0 @ai-sdk/react@^1.0 ollama-ai-provider-v2`. Pin to v4 per user decision (zod 3.23.8 lock).

2. Add to `prisma/schema.prisma`:
   - `TokenUsage` model: id (cuid), userId (relation to User), akteId (nullable), funktion String (CHAT|SCAN|ENTWURF|BRIEFING), provider String (ollama|openai|anthropic), model String, tokensIn Int, tokensOut Int, createdAt DateTime. Index on (userId, createdAt) and (createdAt).
   - Add `isSystem Boolean @default(false)` field to User model.
   Run `npx prisma db push` after schema changes.

3. Create `src/lib/ai/provider.ts`:
   - Import createOllama from 'ollama-ai-provider-v2', createOpenAI from '@ai-sdk/openai', createAnthropic from '@ai-sdk/anthropic'.
   - `getModel()`: Reads ai.provider, ai.provider.apiKey, ai.provider.model, ai.ollama.url from SystemSetting via getSettingTyped(). Returns LanguageModel. Switch: ollama -> createOllama({baseURL})('mistral:7b' or configured model), openai -> createOpenAI({apiKey})(model), anthropic -> createAnthropic({apiKey})(model). Cache provider instances (not per-request creation).
   - `testProviderConnection()`: Attempts a minimal generateText call ("Antworte nur mit OK") with 50 maxTokens. Returns {success: boolean, latency: number, error?: string}.
   - `isProviderAvailable()`: Quick health check (Ollama: GET /api/version, cloud: test API key validity).
   - Export PROVIDER_OPTIONS constant: [{value: 'ollama', label: 'Ollama (Lokal)'}, {value: 'openai', label: 'OpenAI'}, {value: 'anthropic', label: 'Anthropic'}].

4. Create `src/lib/ai/token-tracker.ts`:
   - `trackTokenUsage({userId, akteId?, funktion, provider, model, tokensIn, tokensOut})`: Insert into TokenUsage via Prisma.
   - `getTokenUsageSummary({period: 'day'|'week'|'month', userId?})`: Aggregate SUM(tokensIn + tokensOut) grouped by funktion, user. Return structured summary.
   - `checkBudget()`: Read ai.monthly_budget from SystemSetting. Compare with current month's total. Return {used, limit, percentage, paused: boolean}. Paused when percentage >= 100.
   - `wrapWithTracking(aiCallFn, metadata)`: Higher-order function that wraps an AI SDK call (streamText/generateText/generateObject), captures token usage from the result, and tracks it. Returns the result transparently.

5. Refactor `src/lib/ai/ollama.ts`: Keep `ollamaHealthCheck()` (still useful for quick Ollama-specific checks). Replace `ollamaGenerate()` internals to use AI SDK provider via getModel() instead of direct fetch. Maintain the same function signature for backward compatibility with process-tasks.ts. If AI SDK call fails, include graceful error with provider info.

6. Update `src/lib/ai/process-tasks.ts`: Replace direct `ollamaGenerate()` calls with AI SDK generateText() via getModel(). Wrap with trackTokenUsage. Ensure all created ChatNachricht records use Helena's userId (not null). Import Helena user ID lookup (query User where isSystem=true AND name='Helena').

7. Update `prisma/seed.ts`: Add Helena system user creation: `{ name: "Helena", email: "helena@system.local", role: "SYSTEM", isSystem: true, image: "/helena-avatar.png" }`. Use upsert to be idempotent.

8. Update `src/lib/settings/defaults.ts`: Add default SystemSettings:
   - ai.provider = 'ollama'
   - ai.provider.apiKey = ''
   - ai.provider.model = 'mistral:7b'
   - ai.ollama.url = process.env.OLLAMA_BASE_URL || 'http://ollama:11434'
   - ai.monthly_budget = '0' (0 = unlimited)
   - ai.scan_enabled = 'true'
   - ai.scan_interval = '0 */4 * * *'
   - ai.briefing_enabled = 'false'
   - ai.briefing_time = '07:00'
   - bea.api_url = 'https://api.bea.expert'
   - bea.enabled = 'false'
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Verify package.json has ai@^4.0, @ai-sdk/openai, @ai-sdk/anthropic, ollama-ai-provider-v2. Verify schema has TokenUsage model and User.isSystem field.</manual>
  </verify>
  <done>AI SDK v4 installed. Provider factory reads from SystemSetting and returns correct LanguageModel for each provider. Token tracker inserts usage records. process-tasks.ts uses AI SDK via provider factory. Helena user in seed. All settings registered with defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Admin AI Settings Page + Rate Limiting + KI-Entwurf Enforcement + Graceful Degradation</name>
  <files>
    src/app/(dashboard)/einstellungen/ki/page.tsx
    src/app/api/ki/provider-test/route.ts
    src/app/api/ki/usage/route.ts
    src/app/api/openclaw/process/route.ts
    src/middleware.ts
  </files>
  <action>
1. Create `src/app/(dashboard)/einstellungen/ki/page.tsx` (Admin AI settings page):
   - Server component that checks session.user.role === 'ADMIN', redirects otherwise.
   - Client component form with:
     a) Provider selection dropdown (Ollama/OpenAI/Anthropic) reading from/writing to SystemSetting.
     b) API Key input (password field, only shown for openai/anthropic).
     c) Model name input (pre-filled based on provider: mistral:7b for Ollama, gpt-4o for OpenAI, claude-sonnet-4-20250514 for Anthropic).
     d) Ollama URL input (only for Ollama provider).
     e) "Verbindung testen" button -> calls POST /api/ki/provider-test, shows success/latency or error.
     f) Monthly token budget input (0 = unlimited).
     g) Proactive scanning toggle (ai.scan_enabled).
     h) Daily briefing toggle + time picker (ai.briefing_enabled, ai.briefing_time).
   - Token usage summary section: shows tokens today/week/month via GET /api/ki/usage. Bar chart or simple table breakdown by function (Chat, Scan, Entwurf, Briefing) and by user.
   - "Helena ist gerade nicht verfuegbar" banner at top if provider test fails (check on page load).
   - Save settings via existing /api/einstellungen/import pattern (POST settings as key-value pairs).
   - German UI labels throughout. Style: glass-card panels consistent with existing Einstellungen pages.

2. Create `POST /api/ki/provider-test/route.ts`:
   - Auth check: ADMIN only.
   - Reads provider config from request body (provider, apiKey, model, ollamaUrl) -- uses request values NOT saved settings (so user can test before saving).
   - Calls testProviderConnection() with provided config.
   - Returns {success, latency, error?}.

3. Create `GET /api/ki/usage/route.ts`:
   - Auth check: ADMIN only.
   - Query params: period (day|week|month, default month).
   - Calls getTokenUsageSummary(). Returns structured usage data.
   - Include budget info from checkBudget().

4. Update `src/app/api/openclaw/process/route.ts` (existing POST handler):
   - Add RBAC check: verify session.user.role === 'ADMIN'. Return 403 if not. Per REQ-KI-012.
   - Add simple rate limiting: Use in-memory Map with sliding window (max 10 requests per minute per user). Return 429 Too Many Requests if exceeded. Include Retry-After header.
   - Keep existing OpenClaw token auth as secondary auth method (backward compatibility).

5. KI-Entwurf workflow enforcement (explicit code changes):
   - The existing versand-gate.ts already blocks sending non-FREIGEGEBEN documents (checkDokumenteFreigegeben).
   - The existing DokumentStatus enum already has ENTWURF as first state.
   - Update `src/lib/ai/process-tasks.ts`: In every `prisma.chatNachricht.create()` call, explicitly set `userId: helenaUserId` (looked up from User where isSystem=true) and `erstelltDurch: 'ai'`. Replace any existing `userId: null` with Helena's user ID.
   - Update `src/lib/ai/process-tasks.ts`: In any code path that creates or updates a Dokument (e.g., when generating a draft document), explicitly set `erstelltDurch: 'ai'` and `status: 'ENTWURF'`. Ensure no code path can set status to FREIGEGEBEN or VERSENDET.
   - Add a `getHelenaUserId()` helper in `src/lib/ai/provider.ts` that queries `prisma.user.findFirst({ where: { isSystem: true, name: 'Helena' } })` and caches the result. Use this in process-tasks.ts.
   - Add comment block in provider.ts documenting Helena's HARD LIMITS: NEVER send, NEVER activate deadlines, NEVER delete, NEVER modify finances.

6. Update `src/middleware.ts`: Add /api/ki/* to the path exemption list (same pattern as /api/openclaw/* and /api/onlyoffice/*) so provider-test and usage endpoints are accessible.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Visit /einstellungen/ki page -- provider dropdown, test button, usage summary visible. POST to /api/openclaw/process without ADMIN role returns 403.</manual>
  </verify>
  <done>Admin can configure AI provider, test connection, view token usage, set budget. /api/openclaw/process restricted to ADMIN with rate limiting. KI-Entwurf workflow verified: all AI output is ENTWURF with erstelltDurch="ai". Helena bot user attributed as author. Graceful degradation banner shown when provider unavailable.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `prisma/schema.prisma` contains TokenUsage model and User.isSystem field
3. Helena user exists in seed.ts with isSystem: true
4. Provider factory in src/lib/ai/provider.ts correctly instantiates Ollama, OpenAI, Anthropic providers
5. Token tracker persists usage to database
6. /einstellungen/ki page renders with provider selection and test button
7. /api/openclaw/process returns 403 for non-ADMIN users
8. process-tasks.ts uses AI SDK provider instead of direct Ollama fetch
</verification>

<success_criteria>
- AI SDK v4 installed and working with all three provider types
- Admin can switch providers, enter API keys, test connections from settings UI
- All AI outputs are ENTWURF with KI attribution (enforced by code, verified by versand-gate)
- Token usage tracked per call and viewable in admin dashboard
- /api/openclaw/process rate-limited and ADMIN-only
- Helena bot user created in seed with isSystem flag
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-01-SUMMARY.md`
</output>
