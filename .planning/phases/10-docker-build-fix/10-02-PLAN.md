---
phase: 10-docker-build-fix
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - docker-entrypoint.sh
  - docker-compose.yml
  - src/app/api/health/route.ts
autonomous: false
requirements: [BUILD-02]

must_haves:
  truths:
    - "`docker compose build` completes successfully (app image built without errors)"
    - "`docker compose up` starts all 8 services and they reach healthy state"
    - "The application is reachable at http://localhost:3000 in the Docker-built production image"
    - "Login works with seeded credentials in the Docker environment"
    - "docker-entrypoint.sh uses `prisma migrate deploy` instead of `prisma db push`"
    - "Seed is idempotent -- runs safely on both fresh and existing databases"
  artifacts:
    - path: "docker-entrypoint.sh"
      provides: "Production-safe entrypoint with migrate deploy and conditional seed"
      contains: "prisma migrate deploy"
    - path: "docker-compose.yml"
      provides: "Complete compose stack with all 8 core services"
      contains: "healthcheck"
    - path: "src/app/api/health/route.ts"
      provides: "Health check endpoint that works for Docker healthcheck (unauthenticated basic check)"
      exports: ["GET"]
  key_links:
    - from: "docker-entrypoint.sh"
      to: "prisma/migrations/"
      via: "prisma migrate deploy"
      pattern: "migrate deploy"
    - from: "docker-compose.yml"
      to: "src/app/api/health/route.ts"
      via: "healthcheck test command"
      pattern: "/api/health"
---

<objective>
Make the complete Docker Compose stack build and run successfully with all 8 services healthy and the application reachable in the browser.

Purpose: This is the final step of Phase 10 -- proving the application works end-to-end in Docker production mode.

Output: Working `docker compose up` with all services healthy, application reachable at localhost:3000 with login working.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-docker-build-fix/10-CONTEXT.md

Depends on Plan 01 completing successfully (build works).

Current docker-entrypoint.sh issues:
- Uses `prisma db push --skip-generate` which is unsafe for production (can drop data)
- Seed runs unconditionally every startup (seed.ts uses upsert so it's safe, but wasteful)

Current docker-compose.yml is comprehensive with 8 services but may need:
- Log directory volume for pino-roll (app and worker write to /var/log/ai-lawyer)
- Start period adjustments for slow services (OnlyOffice needs 60s+)

Health endpoint at /api/health works for Docker healthcheck (unauthenticated returns basic status).

<interfaces>
From docker-compose.yml:
- app: port 3000, healthcheck via /api/health
- worker: no healthcheck (command override)
- db: PostgreSQL on 5432
- redis: port 6379
- minio: ports 9000/9001
- meilisearch: port 7700
- onlyoffice: port 8080
- stirling-pdf: port 8081

From docker-entrypoint.sh:
- Waits for PostgreSQL
- Runs prisma db push
- Runs seed
- Starts the main command (server or worker)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden docker-entrypoint.sh and docker-compose.yml for production</name>
  <files>docker-entrypoint.sh, docker-compose.yml</files>
  <action>
1. **docker-entrypoint.sh** -- Update for production safety:

   a. Replace `prisma db push --skip-generate` with `prisma migrate deploy`:
      ```sh
      echo "==> Running Prisma migrate deploy..."
      node node_modules/prisma/build/index.js migrate deploy
      ```
      This applies pending migrations without risk of data loss. The migrations directory already exists at `prisma/migrations/20260223124855_init/`.

   b. Make seed conditional -- only run if no users exist:
      ```sh
      echo "==> Checking if database needs seeding..."
      NEEDS_SEED=$(node -e "
        const { PrismaClient } = require('@prisma/client');
        const p = new PrismaClient();
        p.user.count().then(c => { console.log(c === 0 ? 'yes' : 'no'); p.\$disconnect(); }).catch(() => { console.log('yes'); p.\$disconnect(); });
      " 2>/dev/null)

      if [ "$NEEDS_SEED" = "yes" ]; then
        echo "==> Running Prisma seed (first run)..."
        node node_modules/tsx/dist/cli.mjs prisma/seed.ts || echo "    Seed failed (non-fatal)"
      else
        echo "==> Database already seeded, skipping"
      fi
      ```

   c. Keep the PostgreSQL wait loop and the final `exec "$@"` unchanged.

2. **docker-compose.yml** -- Adjustments:

   a. Ensure the `app_logs` and `worker_logs` volumes are correctly mapped to `/var/log/ai-lawyer` inside the containers. The current config already does this via `volumes: - app_logs:/var/log/ai-lawyer`. This is correct.

   b. The worker service has no healthcheck. This is acceptable for now (it's an internal process). Leave as-is.

   c. Add `start_period: 30s` to the `app` service healthcheck if not present (it already has `start_period: 60s`, which is good).

   d. Verify the `worker` service `depends_on` includes `app` with `condition: service_healthy`. This ensures the app is up before the worker starts (worker needs Redis and DB, but having app healthy first ensures migrations are run).

   e. Add a comment documenting the default login credentials for development:
      ```yaml
      # Default credentials after seed: admin@kanzlei-baumfalk.de / password123
      ```

   f. The compose file currently lists 7 core services (app, worker, db, redis, minio, meilisearch, onlyoffice) plus stirling-pdf = 8 total. Verify this matches the BUILD-02 requirement of "alle Services erfolgreich". The optional services (languagetool, ollama) are in profiles and don't count.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && grep -c "migrate deploy" docker-entrypoint.sh && grep -c "NEEDS_SEED\|already seeded" docker-entrypoint.sh</automated>
  </verify>
  <done>
    - docker-entrypoint.sh uses `prisma migrate deploy` instead of `db push`
    - Seed is conditional (only runs when no users exist)
    - docker-compose.yml is complete with all 8 services, health checks, and proper depends_on ordering
    - Worker depends on app being healthy (ensures migrations ran first)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Docker Compose full stack runs end-to-end</name>
  <files>docker-compose.yml</files>
  <action>
Run `docker compose build` followed by `docker compose up -d` and verify all 8 services start and become healthy. Then verify the application is reachable at http://localhost:3000 and login works.

What was built:
- Fixed Next.js build (from Plan 01)
- Production-safe entrypoint with migrate deploy and conditional seed
- All 8 services configured with health checks

How to verify:
1. Build: `docker compose build` -- should complete without errors
2. Start: `docker compose up -d`
3. Check health: `docker compose ps` -- all 8 services should show "Up" / "healthy" (OnlyOffice may take 1-2 min)
4. Check app logs: `docker compose logs app --tail 30` -- should show "Prisma migrate deploy" success, "Server ready"
5. Open http://localhost:3000 -- login page should appear
6. Login with: admin@kanzlei-baumfalk.de / password123 -- dashboard should load
7. Check worker: `docker compose logs worker --tail 10` -- should show "Worker started"
  </action>
  <verify>
    <automated>docker compose ps --format json 2>/dev/null | head -20 || echo "Docker not available for automated check"</automated>
  </verify>
  <done>
    - All 8 Docker services (app, worker, db, redis, minio, meilisearch, onlyoffice, stirling-pdf) are running and healthy
    - Application reachable at http://localhost:3000
    - Login works with seeded credentials
    - User types "approved" to confirm
  </done>
</task>

</tasks>

<verification>
1. `docker compose build` exits 0
2. `docker compose up -d` starts all 8 services
3. `docker compose ps` shows all services as healthy (core services: app, db, redis, minio, meilisearch)
4. `curl -s http://localhost:3000/api/health` returns `{"status":"ok"}` (or "degraded" if optional services not ready yet)
5. Browser at http://localhost:3000 shows login page
6. Login with admin@kanzlei-baumfalk.de / password123 works
7. `docker compose logs app` shows no crash errors
</verification>

<success_criteria>
- Docker Compose builds and runs all 8 services without errors
- Application is reachable and functional in the browser
- Login works with seeded credentials
- Health endpoint responds correctly for Docker healthcheck
- Entrypoint uses production-safe migration approach
</success_criteria>

<output>
After completion, create `.planning/phases/10-docker-build-fix/10-02-SUMMARY.md`
</output>
