---
phase: 08-integration-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql
  - src/lib/rbac.ts
  - src/components/layout/sidebar.tsx
  - src/app/api/admin/rollen/route.ts
  - src/app/api/ki-entwuerfe/route.ts
  - src/app/api/finanzen/aktenkonto/[akteId]/route.ts
  - src/app/api/dokumente/[id]/route.ts
  - src/app/api/akten/route.ts
  - src/app/api/akten/[id]/dokumente/route.ts
  - src/app/(dashboard)/admin/benutzer/page.tsx
autonomous: true
requirements:
  - REQ-RS-001
  - REQ-RS-002
  - REQ-RS-003

must_haves:
  truths:
    - "PRAKTIKANT role no longer exists in the system -- Prisma schema has only 4 UserRole values (ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT)"
    - "canSeeKanzleiFinanzen Boolean field exists on User model with default false"
    - "No PRAKTIKANT references remain in active TypeScript code (only in migration SQL and git history)"
    - "RBAC PERMISSIONS constant has 4 role entries, not 5"
    - "Sidebar nav items no longer reference PRAKTIKANT in hideForRoles arrays"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "UserRole enum without PRAKTIKANT; User.canSeeKanzleiFinanzen Boolean field"
      contains: "canSeeKanzleiFinanzen"
    - path: "prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql"
      provides: "Safe migration: UPDATE PRAKTIKANT users, ALTER enum, ADD column"
    - path: "src/lib/rbac.ts"
      provides: "PERMISSIONS without PRAKTIKANT entry; ROLE_LABELS with 4 roles"
  key_links:
    - from: "prisma/schema.prisma"
      to: "src/lib/rbac.ts"
      via: "UserRole enum values must match PERMISSIONS keys"
      pattern: "ADMIN|ANWALT|SACHBEARBEITER|SEKRETARIAT"
    - from: "src/lib/rbac.ts"
      to: "src/components/layout/sidebar.tsx"
      via: "hideForRoles arrays reference valid role names"
      pattern: "hideForRoles"
---

<objective>
Remove the PRAKTIKANT role entirely from the codebase and add the canSeeKanzleiFinanzen field to the User model.

Purpose: Simplify the role model from 5 to 4 roles per user decision (REQ-RS-003 becomes obsolete). Add the per-user kanzlei-wide finance visibility flag needed by Plan 08-02.
Output: Prisma migration, cleaned RBAC helpers, cleaned API routes/sidebar, admin UI checkbox for canSeeKanzleiFinanzen.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-hardening/08-CONTEXT.md
@.planning/phases/08-integration-hardening/08-RESEARCH.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove PRAKTIKANT from schema + migration + rbac.ts + ROLE_LABELS</name>
  <files>
    prisma/schema.prisma
    prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql
    src/lib/rbac.ts
  </files>
  <action>
    **Prisma schema changes:**
    1. In `prisma/schema.prisma`, remove `PRAKTIKANT` from the `UserRole` enum (keep ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT).
    2. Add `canSeeKanzleiFinanzen Boolean @default(false)` field to the `User` model.

    **Create migration SQL manually** (database not running) at `prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql`:
    ```sql
    -- Step 1: Convert any PRAKTIKANT users to SACHBEARBEITER (must happen BEFORE enum value removal)
    UPDATE "User" SET "role" = 'SACHBEARBEITER' WHERE "role" = 'PRAKTIKANT';

    -- Step 2: Remove PRAKTIKANT from UserRole enum
    -- Create new enum type, migrate column, drop old
    CREATE TYPE "UserRole_new" AS ENUM ('ADMIN', 'ANWALT', 'SACHBEARBEITER', 'SEKRETARIAT');
    ALTER TABLE "User" ALTER COLUMN "role" TYPE "UserRole_new" USING ("role"::text::"UserRole_new");
    ALTER TYPE "UserRole" RENAME TO "UserRole_old";
    ALTER TYPE "UserRole_new" RENAME TO "UserRole";
    DROP TYPE "UserRole_old";

    -- Step 3: Add canSeeKanzleiFinanzen field
    ALTER TABLE "User" ADD COLUMN "canSeeKanzleiFinanzen" BOOLEAN NOT NULL DEFAULT false;
    ```

    **RBAC cleanup in `src/lib/rbac.ts`:**
    1. Remove the `PRAKTIKANT` entry from the `PERMISSIONS` constant (the entire PRAKTIKANT key and its permission object).
    2. Remove `PRAKTIKANT` from `ROLE_LABELS` map.
    3. In `requireAkteAccess()`, remove any PRAKTIKANT-specific check/comment.
    4. In `buildAkteAccessFilter()`, remove PRAKTIKANT-specific handling if any.

    Run `npx prisma validate` to confirm schema is valid.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx prisma validate && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>Grep for "PRAKTIKANT" in rbac.ts -- should not appear</manual>
  </verify>
  <done>
    - UserRole enum has exactly 4 values: ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT
    - canSeeKanzleiFinanzen field exists on User model with default false
    - Migration SQL safely converts PRAKTIKANT users before removing enum value
    - RBAC PERMISSIONS constant has 4 role entries, not 5
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean PRAKTIKANT references from sidebar + API routes + admin UI</name>
  <files>
    src/components/layout/sidebar.tsx
    src/app/api/admin/rollen/route.ts
    src/app/api/ki-entwuerfe/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/route.ts
    src/app/api/dokumente/[id]/route.ts
    src/app/api/akten/route.ts
    src/app/api/akten/[id]/dokumente/route.ts
    src/app/(dashboard)/admin/benutzer/page.tsx
  </files>
  <action>
    **Sidebar cleanup in `src/components/layout/sidebar.tsx`:**
    1. Remove all `hideForRoles: ["PRAKTIKANT"]` arrays from nav items. If a nav item ONLY hid for PRAKTIKANT, remove the `hideForRoles` property entirely. If it hid for both PRAKTIKANT and SEKRETARIAT, keep `hideForRoles: ["SEKRETARIAT"]`.

    **API route PRAKTIKANT reference removal:**
    - `src/app/api/admin/rollen/route.ts`: Remove PRAKTIKANT from the roles array.
    - `src/app/api/ki-entwuerfe/route.ts`: Remove the PRAKTIKANT-specific block/check. Per user decision, KI is open to all logged-in users.
    - `src/app/api/finanzen/aktenkonto/[akteId]/route.ts`: Remove PRAKTIKANT read-only check. Replace with standard `requireAkteAccess(akteId)` if not already using it.
    - `src/app/api/dokumente/[id]/route.ts`: Remove/update PRAKTIKANT-blocking comment.
    - `src/app/api/akten/route.ts`: Remove PRAKTIKANT cannot-create check.
    - `src/app/api/akten/[id]/dokumente/route.ts`: Remove PRAKTIKANT blocked-from-uploads check.
    - Do NOT touch beA routes in this task (Plan 08-03 handles those).

    **Admin UI for canSeeKanzleiFinanzen:**
    - If a user management page exists at `src/app/(dashboard)/admin/benutzer/page.tsx` or similar, add a checkbox "Kanzleiweite Finanzen" that is only visible when the user's role is ANWALT. The checkbox toggles the `canSeeKanzleiFinanzen` field via a PATCH to the user endpoint.
    - If no user management page exists, add the field to the admin rollen page or create a minimal toggle in the existing user detail/edit flow.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>Grep for "PRAKTIKANT" across the codebase -- should only appear in migration SQL and git history, not in active TypeScript code</manual>
  </verify>
  <done>
    - No PRAKTIKANT references remain in sidebar, API routes (except beA routes handled in Plan 08-03)
    - Sidebar nav items have clean hideForRoles arrays
    - canSeeKanzleiFinanzen checkbox available in admin user management for ANWALT users
    - All API routes that previously had PRAKTIKANT-specific checks are cleaned up
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes with updated schema (no PRAKTIKANT, has canSeeKanzleiFinanzen)
2. `npx tsc --noEmit` passes cleanly (or with only pre-existing errors)
3. `grep -r "PRAKTIKANT" src/ --include="*.ts" --include="*.tsx"` returns zero results
4. RBAC PERMISSIONS constant has exactly 4 role entries
</verification>

<success_criteria>
- PRAKTIKANT role fully removed from codebase (schema, rbac, API routes, sidebar)
- canSeeKanzleiFinanzen field on User model controls ANWALT kanzlei-wide finance visibility
- Migration SQL safely converts existing PRAKTIKANT users to SACHBEARBEITER
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-hardening/08-01-SUMMARY.md`
</output>
