# Phase 2.1: Wire Frist-Reminder Pipeline + Settings Init - Context

**Gathered:** 2026-02-24
**Status:** Ready for planning

<domain>
## Phase Boundary

Wire the existing frist-reminder processor into the live BullMQ worker runtime. Register the processor, schedule the cron job, consolidate the queue registry, and call initializeDefaults() at startup. All code pieces already exist from Phase 2 — this phase connects them.

</domain>

<decisions>
## Implementation Decisions

### Cron Schedule & Timing
- Daily scan at 6:00 AM (Europe/Berlin timezone)
- Runs every day including weekends, but weekend/holiday reminders are shifted to the preceding Friday
- Scan time is admin-configurable in Kanzlei-Einstellungen from day one (stored in SystemSettings)

### Notification Delivery
- Dual-channel delivery: in-app (Socket.IO bell + toast) AND email
- Notification content: Akte reference + Frist description + days remaining (e.g. "Frist in 3 Tagen: Berufungsfrist — Akte 123/2026 Mueller ./. Schmidt")
- Email format: simple text/HTML — no firm letterhead needed for internal reminders
- Vertretung: both primary user AND deputy receive the reminder when primary is on vacation

### Startup & Initialization
- initializeDefaults() runs in worker process only (not in Next.js app) — worker starts first in Docker
- Skip silently if defaults already exist in DB — no log output on repeat starts
- Consolidate into a single queue registry file (src/lib/queues/registry.ts) listing ALL queues including frist-reminder
- Minimal changes to worker.ts — add import + registration only, no refactoring

### Failure & Retry Behavior
- BullMQ retry: 3 attempts with exponential backoff on cron job failure
- Catch-up: scan for any unsent reminders regardless of original due date — nothing missed after downtime
- Deduplication: track sent status per Vorfrist reminder in DB — never send the same reminder twice
- Independent channel retry: if email fails but in-app succeeds, retry email separately
- Maximum retry age: 3 days — stop retrying email for reminders older than 3 days
- Permanently failed reminders: visible in Bull Board as failed + admin notification sent

### Claude's Discretion
- Exact BullMQ job options (concurrency, limiter settings)
- initializeDefaults() implementation details (upsert strategy)
- Email template structure and exact wording
- Bull Board configuration for frist-reminder queue visibility

</decisions>

<specifics>
## Specific Ideas

- Weekend/holiday shift: if a reminder would fire on Saturday or Sunday, send it on the preceding Friday instead — mirrors how German Kanzleien handle Fristenzettel
- Notification format should be immediately actionable: staff should know which Akte and which Frist at a glance without clicking through

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 02.1-wire-frist-reminder-pipeline*
*Context gathered: 2026-02-24*
