---
phase: 06-ai-features-bea
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - src/app/api/ki-chat/route.ts
  - src/app/api/ki-chat/conversations/route.ts
  - src/app/api/ki-chat/conversations/[id]/route.ts
  - src/app/(dashboard)/ki-chat/page.tsx
  - src/app/(dashboard)/ki-chat/layout.tsx
  - src/components/ki/chat-layout.tsx
  - src/components/ki/chat-messages.tsx
  - src/components/ki/chat-input.tsx
  - src/components/ki/source-citations.tsx
  - src/components/ki/conversation-sidebar.tsx
  - src/lib/embedding/vector-store.ts
  - src/app/(dashboard)/ki-entwuerfe/page.tsx
  - src/app/(dashboard)/akten/[id]/page.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/command-palette.tsx
autonomous: true
requirements:
  - REQ-KI-003
  - REQ-KI-007
  - REQ-KI-010

must_haves:
  truths:
    - "User can ask a question about case documents and receive a streamed answer with source citations"
    - "Source citations appear as inline numbered references [1][2] with document name and passage below"
    - "User sees 'Ich bin mir nicht sicher...' or 'Dazu habe ich keine Informationen' when confidence is low or no sources found"
    - "Chat history is saved per Akte and per user, accessible from the conversation sidebar"
    - "User can select an Akte to scope the chat, or toggle cross-Akte queries"
    - "Quick-action buttons provide common prompts (Zusammenfassung, Fristen pruefen, Schriftsatz entwerfen, Beteiligte identifizieren)"
    - "/ki-entwuerfe redirects to /ki-chat"
    - "Sidebar shows 'Helena' instead of 'KI-Entwuerfe'"
    - "Cmd+K 'Helena fragen' action opens /ki-chat with pre-filled text"
    - "Akte detail page has a 'Fallzusammenfassung' button that navigates to /ki-chat with pre-filled summary prompt"
    - "Conversations have a 'Link kopieren' button that copies a shareable URL, enforcing Akte RBAC on access"
  artifacts:
    - path: "src/app/api/ki-chat/route.ts"
      provides: "Streaming RAG chat endpoint"
      exports: ["POST"]
    - path: "src/app/(dashboard)/ki-chat/page.tsx"
      provides: "Main chat page with ChatGPT-like layout"
    - path: "src/components/ki/chat-messages.tsx"
      provides: "Message list with Markdown rendering and source citations"
    - path: "src/components/ki/conversation-sidebar.tsx"
      provides: "Conversation history grouped by Akte"
    - path: "src/app/api/ki-chat/conversations/route.ts"
      provides: "Conversation CRUD API"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/app/api/ki-chat/route.ts"
      to: "src/lib/embedding/vector-store.ts"
      via: "searchSimilar() for RAG retrieval"
      pattern: "searchSimilar"
    - from: "src/app/api/ki-chat/route.ts"
      to: "src/lib/ai/provider.ts"
      via: "getModel() for streaming"
      pattern: "streamText.*getModel"
    - from: "src/app/(dashboard)/ki-chat/page.tsx"
      to: "/api/ki-chat"
      via: "useChat hook from @ai-sdk/react"
      pattern: "useChat.*api.*ki-chat"
---

<objective>
Build the document chat system: a streaming RAG API that retrieves relevant document chunks via pgvector, streams AI responses with inline source citations, and a ChatGPT-style UI at /ki-chat with conversation history per Akte, quick-action buttons, Markdown rendering, and Cmd+K integration.

Purpose: Core AI interaction surface where attorneys ask questions about case documents and get sourced, streamed answers.
Output: Working /ki-chat page with streaming responses, source citations, conversation persistence, and sidebar/palette integration.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md
@.planning/phases/06-ai-features-bea/06-01-SUMMARY.md

# Existing RAG infrastructure (Phase 4)
@src/lib/embedding/vector-store.ts
@src/lib/embedding/embedder.ts
@src/lib/embedding/chunker.ts

# AI provider (from Plan 01)
@src/lib/ai/provider.ts
@src/lib/ai/token-tracker.ts

# Existing pages to modify
@src/components/layout/sidebar.tsx
@src/components/layout/command-palette.tsx
@src/app/(dashboard)/ki-entwuerfe/page.tsx

# Existing models
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Streaming RAG Chat API + Conversation CRUD + Vector Store Cross-Akte Toggle</name>
  <files>
    src/app/api/ki-chat/route.ts
    src/app/api/ki-chat/conversations/route.ts
    src/app/api/ki-chat/conversations/[id]/route.ts
    src/lib/embedding/vector-store.ts
  </files>
  <action>
1. Update `src/lib/embedding/vector-store.ts`:
   - Add optional `crossAkte` parameter to `searchSimilar()`. When true, search all chunks the user has access to (join DocumentChunk -> Dokument -> Akte, filter by Akten the user is assigned to via prisma query). When false (default), scope to single akteId as before.
   - Add `userId` parameter for RBAC filtering in cross-Akte mode.
   - Return chunks with additional metadata: dokumentName, akteAktenzeichen, akteBeschreibung for source citation display.

2. Create `POST /api/ki-chat/route.ts` (streaming RAG endpoint):
   - Auth check via auth().
   - Parse request body: messages (array of {role, content}), akteId (nullable), conversationId (nullable), crossAkte (boolean, default false).
   - RAG retrieval: Take the last user message, generate query embedding via Ollama embedder (using "query: " prefix per E5 format), call searchSimilar() with akteId scope (or cross-Akte if toggled), top 10 results, cosine similarity.
   - Confidence handling: If no chunks found OR highest score < 0.3, set a flag to instruct LLM to express uncertainty.
   - Build system prompt in German:
     ```
     Du bist Helena, eine digitale Rechtsanwaltsfachangestellte. Du antwortest immer auf Deutsch.
     Beantworte die Frage basierend auf den folgenden Dokumenten-Auszuegen.
     Zitiere deine Quellen als nummerierte Referenzen [1], [2] etc.
     Wenn du dir nicht sicher bist, sage "Ich bin mir nicht sicher, aber..." oder "Dazu habe ich keine ausreichenden Informationen in den Akten gefunden."
     Erfinde KEINE Informationen. Antworte NUR basierend auf den bereitgestellten Dokumenten.
     Disclaimer: "Dieser Hinweis ersetzt keine anwaltliche Pruefung."
     ```
   - Append retrieved chunks as context in the system prompt with numbered references:
     ```
     [1] Dokument: {name} (Akte: {aktenzeichen})
     {chunk_content}

     [2] ...
     ```
   - Use AI SDK `streamText()` with getModel() from provider.ts. Pass full message history + system prompt.
   - After stream completes: track token usage via trackTokenUsage() with funktion='CHAT'.
   - Save/update AiConversation: If conversationId provided, append messages to existing Json array. If not, create new AiConversation with akteId, userId, titel (derived from first message, max 50 chars), messages, model, tokenCount.
   - Return sources metadata alongside stream: Use `streamText().toDataStreamResponse()` with custom data including sources array [{dokumentId, name, akteAktenzeichen, passage (first 200 chars of chunk), score}].

3. Create `GET/POST /api/ki-chat/conversations/route.ts`:
   - GET: List conversations for current user. Optional akteId filter. Order by updatedAt DESC. Return id, akteId, titel, updatedAt, messageCount (length of messages Json array). Paginated (take 50, cursor-based).
   - POST: Create new conversation. Body: {akteId?, titel?}. Returns created conversation.

4. Create `GET/PATCH/DELETE /api/ki-chat/conversations/[id]/route.ts`:
   - GET: Return full conversation with messages. Auth check: user owns conversation.
   - PATCH: Update titel or append messages. Auth check.
   - DELETE: Delete conversation. Auth check.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>curl POST /api/ki-chat with test message and akteId returns streaming response with sources metadata.</manual>
  </verify>
  <done>Streaming RAG chat API works: retrieves chunks, streams AI response with source citations, saves conversation history. Cross-Akte toggle supported. Conversation CRUD endpoints operational. Token usage tracked per chat request.</done>
</task>

<task type="auto">
  <name>Task 2: Chat UI Page + Message Components + Conversation Sidebar + Navigation Integration</name>
  <files>
    src/app/(dashboard)/ki-chat/page.tsx
    src/app/(dashboard)/ki-chat/layout.tsx
    src/components/ki/chat-layout.tsx
    src/components/ki/chat-messages.tsx
    src/components/ki/chat-input.tsx
    src/components/ki/source-citations.tsx
    src/components/ki/conversation-sidebar.tsx
    src/app/(dashboard)/ki-entwuerfe/page.tsx
    src/app/(dashboard)/akten/[id]/page.tsx
    src/components/layout/sidebar.tsx
    src/components/layout/command-palette.tsx
  </files>
  <action>
1. Create `src/app/(dashboard)/ki-chat/layout.tsx`:
   - Server component with auth check.
   - Renders ChatLayout as full-height flex container.

2. Create `src/components/ki/chat-layout.tsx` ("use client"):
   - Three-column layout: conversation sidebar (left, 280px, collapsible), chat area (center, flex-1), source panel (right, conditionally shown).
   - State: selectedAkteId, selectedConversationId, crossAkte toggle.
   - Akte selector: dropdown at top of chat area. Fetches user's accessible Akten. "Alle Akten" option enables cross-Akte mode.
   - "Neuer Chat" button to start fresh conversation.
   - Pass props down to child components.

3. Create `src/components/ki/conversation-sidebar.tsx` ("use client"):
   - Fetches conversations from GET /api/ki-chat/conversations?akteId={selected}.
   - Groups conversations by Akte (if no Akte filter selected, show all grouped).
   - Each entry: titel, relative time (date-fns formatDistanceToNow), message count.
   - Click to load conversation. Delete button (with confirmation).
   - Skeleton loading state.

4. Create `src/components/ki/chat-messages.tsx` ("use client"):
   - Uses `useChat` hook from `@ai-sdk/react` with api: '/api/ki-chat', body: {akteId, conversationId, crossAkte}.
   - Renders message list: user messages right-aligned (blue), Helena messages left-aligned (with Helena avatar).
   - Helena messages rendered with full Markdown support: install `react-markdown` + `remark-gfm` for tables/lists. Use `rehype-highlight` for code blocks if needed.
   - Inline source references [1], [2] rendered as clickable superscript links that scroll to source list.
   - Streaming indicator: "Helena denkt nach..." with pulsing dots animation while isLoading.
   - Auto-scroll to bottom on new messages.
   - Empty state: Helena introduction "Hallo! Ich bin Helena, Ihre digitale Rechtsanwaltsfachangestellte. Stellen Sie mir eine Frage zu Ihren Akten-Dokumenten."
   - "Als Entwurf speichern" and "Als Dokument speichern" buttons on each Helena message.

5. Create `src/components/ki/chat-input.tsx` ("use client"):
   - Textarea with auto-resize (min 1 row, max 6 rows).
   - Send button (disabled when empty or loading). Enter to send, Shift+Enter for newline.
   - Quick-action buttons above input: "Zusammenfassung erstellen", "Fristen pruefen", "Schriftsatz entwerfen", "Beteiligte identifizieren". Each inserts pre-defined prompt text.
   - File drag & drop zone (visual indicator on drag-over): "Dokument hier ablegen fuer sofortige Analyse". On drop, upload file via existing /api/akten/[id]/dokumente endpoint, show processing state. (Stub for now -- full OCR-on-the-fly is complex; show info toast "Dokument wird verarbeitet, bitte warten...")

6. Create `src/components/ki/source-citations.tsx`:
   - Renders numbered source list below Helena's message.
   - Each source: [N] document icon + document name (link to /dokumente/[id]) + Akte badge + relevant passage excerpt (max 200 chars).
   - Cross-Akte: show which Akte each source belongs to.
   - If no sources: show subtle "Keine Quellenverweise" text.

7. Create `src/app/(dashboard)/ki-chat/page.tsx`:
   - Server component that renders ChatLayout.
   - Accept optional searchParams: akteId (pre-select Akte), q (pre-fill first message from Cmd+K).

8. Update `src/app/(dashboard)/ki-entwuerfe/page.tsx`:
   - Replace content with redirect to /ki-chat. Use Next.js redirect() function.

9. Update `src/components/layout/sidebar.tsx`:
   - Rename "KI-Entwuerfe" menu item to "Helena".
   - Update href from /ki-entwuerfe to /ki-chat.
   - Keep Bot icon or change to a more fitting icon (Sparkles or Brain from lucide-react).

10. Update `src/components/layout/command-palette.tsx`:
    - Add "Helena fragen" command. When selected, navigate to /ki-chat?q={searchInput}.
    - Place in prominent position in command list (top of "Navigation" group or own "KI" group).

11. Update `src/app/(dashboard)/akten/[id]/page.tsx` (Akte detail page):
    - Add a "Fallzusammenfassung" button in the Akte detail header area (next to existing action buttons or as a prominent action in the KPI cards section).
    - Use Sparkles icon from lucide-react. Label: "Fallzusammenfassung".
    - On click: Navigate to `/ki-chat?akteId={akte.id}&q=Erstelle+eine+Fallzusammenfassung+fuer+diese+Akte`. This pre-selects the Akte and pre-fills the prompt.
    - Per CONTEXT locked decision: generates structured timeline + key facts, saved as Entwurf.

12. Add shareable conversation URLs:
    - In `src/components/ki/chat-messages.tsx`: Add a "Link kopieren" (Copy link) button on each conversation header.
    - On click: Copy URL `/ki-chat?conversationId={id}` to clipboard. Show toast: "Link kopiert".
    - When accessing a shared conversation URL, verify the viewer has access to the linked Akte (RBAC check in the API route GET /api/ki-chat/conversations/[id]). Return 403 if the user does not have access to the Akte the conversation belongs to.
    - Conversations without an Akte scope are shareable to all authenticated users.

Install `react-markdown` and `remark-gfm` packages: `npm install react-markdown remark-gfm`.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Navigate to /ki-chat -- conversation sidebar loads, Akte selector works, typing a question streams a response with source citations. /ki-entwuerfe redirects to /ki-chat. Cmd+K shows "Helena fragen".</manual>
  </verify>
  <done>Chat UI at /ki-chat with ChatGPT-like layout, streaming responses, Markdown rendering, inline source citations, conversation history sidebar, quick-action buttons, Akte selector with cross-Akte toggle. /ki-entwuerfe redirects. Sidebar renamed to Helena. Cmd+K "Helena fragen" integration works. Fallzusammenfassung button on Akte detail page navigates to chat with pre-filled prompt. Shareable conversation URLs with RBAC enforcement.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. POST /api/ki-chat returns streaming response with sources metadata
3. Conversation CRUD endpoints work (create, list, get, update, delete)
4. /ki-chat page renders with chat layout, sidebar, Akte selector
5. Source citations display as numbered references with document links
6. /ki-entwuerfe redirects to /ki-chat
7. Sidebar shows "Helena" instead of "KI-Entwuerfe"
8. Cmd+K has "Helena fragen" command
</verification>

<success_criteria>
- User can chat about documents within a specific Akte and receive streamed answers with source citations
- Source citations are clickable and show document name + passage
- Low-confidence responses use natural language uncertainty
- Chat history persists per Akte and per user
- Quick-action buttons generate useful pre-defined prompts
- Navigation integration complete (sidebar, Cmd+K, redirect)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-02-SUMMARY.md`
</output>
