---
phase: 02-deadline-calculation-document-templates
plan: 06
type: execute
wave: 2
depends_on:
  - 02-02
files_modified:
  - prisma/schema.prisma
  - src/app/api/users/[id]/vertretung/route.ts
  - src/app/api/users/[id]/urlaub/route.ts
  - src/app/api/einstellungen/export/route.ts
  - src/app/api/einstellungen/import/route.ts
  - src/components/einstellungen/vertretung-urlaub-tab.tsx
  - src/components/einstellungen/onboarding-wizard.tsx
  - src/components/einstellungen/import-export-tab.tsx
  - src/app/(dashboard)/einstellungen/page.tsx
  - src/workers/processors/frist-reminder.ts
autonomous: true
requirements:
  - REQ-FK-003
  - REQ-FK-005

must_haves:
  truths:
    - "Each user has a Vertreter (deputy) field configurable in user management"
    - "Admin or attorney can activate Vertretungs-Modus with Zeitraum + Vertreter, and all Fristen/Termine of the absent user appear for the Vertreter marked as 'Vertretung fuer [Name]'"
    - "Users can enter vacation date ranges (Jahresurlaub) which are considered for Fristen/WV/Termine assignments"
    - "Frist-Reminder worker considers Vertretung: if Verantwortlicher is on vacation, Vorfristen and escalations go to Vertreter"
    - "Settings can be exported as JSON and imported from JSON (backup/restore)"
    - "First-login Onboarding-Wizard guides through essential setup steps"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "User model enhancements: vertreterId, vacation date ranges, vertretungAktiv fields"
      contains: "vertreterId"
    - path: "src/app/api/users/[id]/vertretung/route.ts"
      provides: "API for setting/activating Vertretung with Zeitraum"
      exports: ["GET", "PUT"]
    - path: "src/app/api/users/[id]/urlaub/route.ts"
      provides: "API for managing vacation date ranges"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/components/einstellungen/vertretung-urlaub-tab.tsx"
      provides: "Settings tab for Vertretung and Urlaub configuration"
      exports: ["VertretungUrlaubTab"]
    - path: "src/components/einstellungen/onboarding-wizard.tsx"
      provides: "First-login guided setup wizard"
      exports: ["OnboardingWizard"]
    - path: "src/app/api/einstellungen/export/route.ts"
      provides: "Settings export as JSON"
      exports: ["GET"]
  key_links:
    - from: "src/workers/processors/frist-reminder.ts"
      to: "prisma.user"
      via: "Check vertretung status when sending Vorfrist notifications"
      pattern: "vertreter|vertretung|urlaub"
    - from: "src/components/einstellungen/vertretung-urlaub-tab.tsx"
      to: "src/app/api/users/[id]/vertretung/route.ts"
      via: "fetch PUT to activate/deactivate Vertretung"
      pattern: "api/users/.*/vertretung"
---

<objective>
Implement Vertretung & Urlaub (deputy/vacation) system with User model enhancements, Vertretungs-Modus activation, vacation date management, and integration with the Frist-Reminder worker. Add settings Import/Export as JSON and first-login Onboarding-Wizard.

Purpose: Law firms need deputy coverage during vacations to ensure no deadlines are missed. The Vertretungs-Modus ensures all Fristen/Termine automatically route to the designated deputy. Import/Export and Onboarding-Wizard complete the Kanzlei-Einstellungen feature set per locked decisions.

Output: User model with Vertreter/Urlaub fields, Vertretung API, Urlaub API, enhanced reminder worker, settings Import/Export endpoints, Onboarding-Wizard component, Vertretung/Urlaub settings tab.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md
@.planning/phases/02-deadline-calculation-document-templates/02-02-SUMMARY.md

@prisma/schema.prisma
@src/workers/processors/frist-reminder.ts
@src/app/(dashboard)/einstellungen/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vertretung & Urlaub Schema + APIs + Reminder Worker Enhancement</name>
  <files>
    prisma/schema.prisma,
    src/app/api/users/[id]/vertretung/route.ts,
    src/app/api/users/[id]/urlaub/route.ts,
    src/app/api/einstellungen/export/route.ts,
    src/app/api/einstellungen/import/route.ts,
    src/workers/processors/frist-reminder.ts
  </files>
  <action>
    **1. Schema Changes (prisma/schema.prisma):**
    Enhance `User` model with:
    - `vertreterId String?` -- FK to another User who is the designated deputy.
    - `vertreter User? @relation("Vertretung", fields: [vertreterId], references: [id])` -- relation to deputy User.
    - `vertretenVon User[] @relation("Vertretung")` -- reverse relation (who this user is deputy for).
    - `vertretungAktiv Boolean @default(false)` -- whether Vertretungs-Modus is currently active.
    - `vertretungVon DateTime?` -- start of vacation/Vertretung period.
    - `vertretungBis DateTime?` -- end of vacation/Vertretung period.

    Add `UrlaubZeitraum` model:
    ```
    model UrlaubZeitraum {
      id        String   @id @default(cuid())
      userId    String
      user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
      von       DateTime
      bis       DateTime
      notiz     String?  // Optional note (e.g., "Sommerurlaub 2026")
      createdAt DateTime @default(now())
      @@index([userId])
      @@map("urlaub_zeitraeume")
    }
    ```
    - Add `urlaubZeitraeume UrlaubZeitraum[]` relation on User model.

    Run `npx prisma db push`.

    **2. Vertretung API (src/app/api/users/[id]/vertretung/route.ts):**
    GET: Return current Vertretung status for user (vertreterId, vertretungAktiv, vertretungVon, vertretungBis, vertreter name).
    PUT: Set or update Vertretung. Body: `{ vertreterId: string, vertretungVon?: DateTime, vertretungBis?: DateTime, aktivieren?: boolean }`.
    - Only ADMIN or the user's manager (ANWALT) or the user themselves can set their Vertreter.
    - When `aktivieren=true`: set vertretungAktiv=true. If vertretungBis is in the past, reject.
    - Auto-deactivation: vertretungAktiv should auto-reset to false when vertretungBis has passed (checked in reminder worker).
    - Log to audit trail.

    **3. Urlaub API (src/app/api/users/[id]/urlaub/route.ts):**
    GET: List all UrlaubZeitraum records for a user, ordered by von DESC.
    POST: Create vacation period. Body: `{ von: DateTime, bis: DateTime, notiz?: string }`. Validate von < bis. Check for overlapping vacation periods.
    DELETE: Remove a vacation period by ID.
    - Any authenticated user can manage their own vacation. ADMIN can manage anyone's.
    - Log to audit trail.

    **4. Enhanced Frist Reminder Worker (src/workers/processors/frist-reminder.ts):**
    Update the existing frist-reminder processor (from Plan 02-02) to consider Vertretung:
    - When sending Vorfrist notification to Verantwortlicher: check if user has vertretungAktiv=true AND current date is within vertretungVon..vertretungBis.
    - If on vacation: send notification to vertreter instead, with prefix "[Vertretung fuer {userName}]" in notification title.
    - Also send a copy to the original Verantwortlicher (they may still have access) but mark it as "(delegiert an Vertreter)".
    - When checking for overdue Fristen: include Vertreter in escalation chain (Verantwortlicher -> Vertreter -> Admin).
    - Auto-deactivation: If vertretungBis < now and vertretungAktiv=true, set vertretungAktiv=false.

    **5. Settings Export API (src/app/api/einstellungen/export/route.ts):**
    GET: Export all SystemSettings, FristPresets, Briefkoepfe metadata (not files), OrdnerSchemata as a single JSON file.
    Return with Content-Type: application/json and Content-Disposition: attachment; filename="kanzlei-einstellungen-{datum}.json".
    Auth: ADMIN only.

    **6. Settings Import API (src/app/api/einstellungen/import/route.ts):**
    POST: Accept JSON file upload. Validate structure matches export format. Upsert SystemSettings, FristPresets, OrdnerSchemata. For Briefkoepfe: only import metadata, skip file references (files must be uploaded separately).
    Show summary of what was imported/overwritten.
    Auth: ADMIN only.
    Log entire import action to audit trail.
  </action>
  <verify>
    <automated>npx prisma validate && npx tsc --noEmit</automated>
    <manual>Test setting a Vertreter for a user. Test activating Vertretungs-Modus. Test vacation date CRUD. Test settings export/import round-trip.</manual>
  </verify>
  <done>User model has vertreterId, vertretungAktiv, vertretungVon/Bis fields. UrlaubZeitraum model stores vacation periods. Vertretung API allows setting/activating deputy. Urlaub API manages vacation dates. Frist-Reminder routes notifications to Vertreter when user is on vacation. Settings export/import as JSON works.</done>
</task>

<task type="auto">
  <name>Task 2: Vertretung/Urlaub Settings Tab + Onboarding-Wizard + Import/Export Tab</name>
  <files>
    src/components/einstellungen/vertretung-urlaub-tab.tsx,
    src/components/einstellungen/onboarding-wizard.tsx,
    src/components/einstellungen/import-export-tab.tsx,
    src/app/(dashboard)/einstellungen/page.tsx
  </files>
  <action>
    **1. Vertretung & Urlaub Tab (src/components/einstellungen/vertretung-urlaub-tab.tsx):**
    Admin-accessible tab in Kanzlei-Einstellungen showing:
    - User list with current Vertreter assignment. Dropdown to select Vertreter for each user.
    - "Vertretungs-Modus aktivieren" button per user: opens dialog with Zeitraum (von/bis) + Vertreter (pre-filled from user's default Vertreter).
    - Active Vertretungen section: list of currently active vacation replacements with deactivation button.
    - Urlaub section: Calendar-like view or list showing all users' vacation periods. Add vacation button per user.
    - Visual indicator: users currently on vacation shown with "Abwesend" badge.
    - logAuditEvent on every change.
    - "Auf Standard zuruecksetzen" button (resets all Vertretung assignments, not vacation dates).

    **2. Onboarding-Wizard (src/components/einstellungen/onboarding-wizard.tsx):**
    Guided first-login setup wizard (per locked decision: "5-7 steps for essential settings"):
    - Step 1: Kanzleidaten (firm name, address, phone, email). Pre-fill from existing SystemSettings if any.
    - Step 2: Briefkopf (logo upload + basic firm data). Use simplified BriefkopfEditor.
    - Step 3: Default Bundesland selection (dropdown, default NRW).
    - Step 4: Vorfristen defaults (7/3/1 days, editable).
    - Step 5: Ordner-Schema (select or create default folder structure).
    - Step 6: Benutzer overview (list existing users, invite link or note to add more in settings).
    - "Ueberspringen" (skip) button on every step and for the entire wizard.
    - "Spaeter einrichten" option to dismiss wizard entirely.
    - On completion, set SystemSetting "onboarding_completed" to true.
    - Show wizard on first admin login when "onboarding_completed" is not true. Render as full-screen overlay/dialog.

    **3. Import/Export Tab (src/components/einstellungen/import-export-tab.tsx):**
    Simple tab in Kanzlei-Einstellungen:
    - "Einstellungen exportieren" button: calls GET /api/einstellungen/export and triggers download.
    - "Einstellungen importieren" section: file upload input (accepts .json), preview of what will be imported (list of setting categories and counts), "Importieren" button with confirmation dialog.
    - Info text: "Exportiert werden: Allgemeine Einstellungen, Fristen-Presets, Ordner-Schemata. Briefkopf-Dateien und Vorlagen-Dateien muessen separat uebertragen werden."
    - logAuditEvent on import action.

    **4. Settings Page Integration (src/app/(dashboard)/einstellungen/page.tsx):**
    Add new tabs to existing settings page:
    - "Vertretung & Urlaub" tab containing VertretungUrlaubTab.
    - "Import/Export" tab containing ImportExportTab.
    Also add OnboardingWizard component: render conditionally based on SystemSetting "onboarding_completed".
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Open Einstellungen, verify Vertretung & Urlaub tab. Assign a Vertreter, activate vacation mode. Test Onboarding-Wizard on fresh login state. Test Import/Export round-trip.</manual>
  </verify>
  <done>Vertretung & Urlaub tab shows user deputies and vacation management. Onboarding-Wizard guides through 6 essential setup steps on first admin login (skippable). Import/Export tab allows JSON backup and restore of settings. All new tabs integrated into Einstellungen page.</done>
</task>

</tasks>

<verification>
```bash
# Schema validates
npx prisma validate

# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build
```
</verification>

<success_criteria>
- User model has Vertreter field and vacation date ranges
- Vertretungs-Modus can be activated with Zeitraum + Vertreter
- Frist-Reminder routes to Vertreter when user is on vacation
- Vacation dates are manageable per user
- Settings exportable/importable as JSON
- Onboarding-Wizard appears on first admin login and guides through essential setup
- Vertretung & Urlaub tab in Einstellungen with full management UI
- Import/Export tab in Einstellungen
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-06-SUMMARY.md`
</output>
