---
phase: 11-glass-ui-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - tailwind.config.ts
  - src/app/layout.tsx
  - src/components/providers/theme-provider.tsx
  - prisma/schema.prisma
  - src/app/api/user/theme/route.ts
autonomous: true
requirements:
  - UI-01
  - UI-02
  - UI-03

must_haves:
  truths:
    - "Body renders a fixed gradient mesh background behind all content"
    - "Dark mode toggles by adding/removing .dark class on <html>"
    - "System preference auto-detects dark mode on first load"
    - "User theme preference persists in database across sessions"
    - "Font stack uses SF Pro Display -> Inter -> system-ui (no Google Fonts DM fonts)"
    - "Four glass utility classes exist: glass-input (8px), glass-card (16px), glass-panel (24px), glass-panel-elevated and glass-sidebar (40px)"
    - "CSS variables use oklch throughout; dark mode variables defined in .dark block"
  artifacts:
    - path: "src/app/globals.css"
      provides: "Design token foundation — oklch variables, 4 glass tiers, body gradient mesh, macOS scrollbars, dark mode structure, global 200ms transition"
    - path: "tailwind.config.ts"
      provides: "Inter font stack, sidebar color tokens removed (replaced by glass-sidebar class)"
    - path: "src/components/providers/theme-provider.tsx"
      provides: "ThemeProvider — reads system preference, applies .dark class to <html>, stores/loads from API"
    - path: "prisma/schema.prisma"
      provides: "UserSettings.theme field (String default 'system')"
    - path: "src/app/api/user/theme/route.ts"
      provides: "GET/PATCH /api/user/theme for theme persistence"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/components/providers/theme-provider.tsx"
      via: "ThemeProvider wraps <body>"
      pattern: "ThemeProvider"
    - from: "src/components/providers/theme-provider.tsx"
      to: "/api/user/theme"
      via: "fetch on mount and on toggle"
      pattern: "fetch.*api/user/theme"
    - from: "globals.css"
      to: ".dark class on <html>"
      via: "CSS variable overrides in .dark block"
      pattern: "\\.dark \\{"
---

<objective>
Establish the design token foundation for the Glass UI: upgrade globals.css to full oklch design system with 4 glass tiers, gradient mesh body background, macOS scrollbars, and dark mode CSS structure. Install Motion/React. Wire ThemeProvider. Add theme persistence to Prisma + API.

Purpose: Every subsequent plan depends on these CSS tokens and ThemeProvider existing. No page migration can proceed without the foundation.
Output: globals.css with complete glass design system, ThemeProvider component, Prisma migration, API route, Motion/React installed.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-glass-ui-migration/11-CONTEXT.md

<interfaces>
<!-- Current globals.css structure (to replace, not append): -->
<!-- - :root uses HSL variables (--background, --foreground, --primary, etc.) -->
<!-- - .dark block has HSL overrides -->
<!-- - Glass tokens: --glass-bg, --glass-bg-heavy, --glass-border, --glass-shadow, --glass-shadow-lg -->
<!-- - Utilities: .glass (blur 16px), .glass-heavy (blur 20px), .glass-lg (blur 24px) -->
<!-- - Body uses @apply bg-background text-foreground font-sans -->
<!-- - .bg-mesh utility uses CSS var-based radial gradients -->

<!-- Current tailwind.config.ts: -->
<!-- - fontFamily.heading: ["DM Serif Display", "Georgia", "serif"] -->
<!-- - fontFamily.sans: ["DM Sans", "system-ui", "sans-serif"] -->
<!-- - colors.sidebar: rgba slate-900 values (to be removed) -->
<!-- - darkMode: "class" (correct, keep) -->

<!-- Current src/app/layout.tsx: -->
<!-- - <html lang="de" suppressHydrationWarning> -->
<!-- - <body> (no ThemeProvider yet) -->
<!-- - <Toaster position="bottom-right" richColors /> -->

<!-- Current prisma/schema.prisma UserSettings: no theme field yet -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade globals.css to full oklch glass design system</name>
  <files>src/app/globals.css</files>
  <action>
    Completely rewrite globals.css. Remove the Google Fonts @import (DM Serif Display + DM Sans). The file must implement:

    **1. CSS Variables (:root — light mode):**
    Use oklch for all color tokens. Keep shadcn/ui variable names so existing components still work, but switch values to oklch:
    - `--background: oklch(97% 0.005 250)`
    - `--foreground: oklch(15% 0.01 250)`
    - `--card: oklch(100% 0 0 / 0.8)`
    - `--card-foreground: oklch(15% 0.01 250)`
    - `--popover: oklch(100% 0 0 / 0.9)`
    - `--popover-foreground: oklch(15% 0.01 250)`
    - `--primary: oklch(45% 0.2 260)` (brand blue — locked decision)
    - `--primary-foreground: oklch(98% 0 0)`
    - `--secondary: oklch(94% 0.01 250)`
    - `--secondary-foreground: oklch(20% 0.01 250)`
    - `--muted: oklch(94% 0.01 250)`
    - `--muted-foreground: oklch(55% 0.015 250)`
    - `--accent: oklch(94% 0.01 250)`
    - `--accent-foreground: oklch(20% 0.01 250)`
    - `--destructive: oklch(55% 0.22 25)`
    - `--destructive-foreground: oklch(98% 0 0)`
    - `--border: oklch(88% 0.01 250 / 0.6)`
    - `--input: oklch(88% 0.01 250 / 0.4)`
    - `--ring: oklch(45% 0.2 260)`
    - `--radius: 0.625rem`
    - Risk colors: `--risk-low: oklch(55% 0.18 155)`, `--risk-medium: oklch(70% 0.18 75)`, `--risk-high: oklch(55% 0.22 25)`
    - Text tiers: `--text-primary: oklch(15% 0.01 250)`, `--text-secondary: oklch(40% 0.015 250)`, `--text-tertiary: oklch(60% 0.01 250)`

    **2. Glass tier tokens (:root — light mode):**
    - `--glass-input-bg: oklch(100% 0 0 / 0.5)`
    - `--glass-card-bg: oklch(100% 0 0 / 0.6)`
    - `--glass-panel-bg: oklch(100% 0 0 / 0.72)`
    - `--glass-elevated-bg: oklch(100% 0 0 / 0.82)`
    - `--glass-sidebar-bg: oklch(100% 0 0 / 0.35)`
    - `--glass-border-color: oklch(100% 0 0 / 0.5)`
    - `--glass-shadow: 0 4px 24px oklch(0% 0 0 / 0.06)`
    - `--glass-shadow-lg: 0 8px 48px oklch(0% 0 0 / 0.10)`

    **3. .dark block — dark mode overrides:**
    - `--background: oklch(12% 0.02 250)`
    - `--foreground: oklch(92% 0.005 250)`
    - `--card: oklch(18% 0.03 250 / 0.7)`
    - `--card-foreground: oklch(92% 0.005 250)`
    - `--popover: oklch(16% 0.03 250 / 0.95)`
    - `--popover-foreground: oklch(92% 0.005 250)`
    - `--primary: oklch(55% 0.22 260)` (slightly brighter in dark)
    - `--primary-foreground: oklch(10% 0.02 260)`
    - `--secondary: oklch(20% 0.03 250)`
    - `--secondary-foreground: oklch(88% 0.005 250)`
    - `--muted: oklch(20% 0.03 250)`
    - `--muted-foreground: oklch(65% 0.01 250)`
    - `--accent: oklch(20% 0.03 250)`
    - `--accent-foreground: oklch(88% 0.005 250)`
    - `--destructive: oklch(45% 0.2 25)`
    - `--destructive-foreground: oklch(98% 0 0)`
    - `--border: oklch(30% 0.03 250 / 0.5)`
    - `--input: oklch(30% 0.03 250 / 0.4)`
    - `--ring: oklch(55% 0.22 260)`
    - `--text-primary: oklch(92% 0.005 250)`, `--text-secondary: oklch(65% 0.01 250)`, `--text-tertiary: oklch(50% 0.01 250)`
    - Dark glass tokens:
      - `--glass-input-bg: oklch(20% 0.03 250 / 0.5)`
      - `--glass-card-bg: oklch(18% 0.03 250 / 0.55)`
      - `--glass-panel-bg: oklch(16% 0.03 250 / 0.68)`
      - `--glass-elevated-bg: oklch(14% 0.03 250 / 0.78)`
      - `--glass-sidebar-bg: oklch(15% 0.03 250 / 0.4)`
      - `--glass-border-color: oklch(50% 0.02 250 / 0.3)`
      - `--glass-shadow: 0 4px 24px oklch(0% 0 0 / 0.25)`
      - `--glass-shadow-lg: 0 8px 48px oklch(0% 0 0 / 0.35)`
    - Dark mesh: `--mesh-1: oklch(30% 0.08 250 / 0.3)`, `--mesh-2: oklch(25% 0.06 270 / 0.25)`, `--mesh-3: oklch(20% 0.04 230 / 0.2)`, `--mesh-4: oklch(28% 0.05 260 / 0.2)`

    **4. @layer base reset:**
    ```css
    @layer base {
      * { @apply border-border; }
      body {
        @apply text-foreground antialiased;
        font-family: 'SF Pro Display', 'SF Pro Text', Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
        background:
          radial-gradient(80% 50% at 20% 20%, var(--mesh-1, oklch(85% 0.08 250 / 0.25)), transparent),
          radial-gradient(60% 60% at 80% 30%, var(--mesh-2, oklch(80% 0.06 270 / 0.20)), transparent),
          radial-gradient(70% 40% at 50% 80%, var(--mesh-3, oklch(90% 0.04 230 / 0.15)), transparent),
          oklch(97% 0.005 250);
        background-attachment: fixed;
      }
      /* 200ms global transition for theme switches */
      *, *::before, *::after {
        transition: background-color 200ms ease, color 200ms ease, border-color 200ms ease;
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: 'SF Pro Display', 'SF Pro Text', Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
      }
    }
    ```

    **5. Glass utility classes (@layer utilities):**
    Replace old .glass, .glass-heavy, .glass-lg with the 4-tier system:
    ```css
    .glass-input {
      background: var(--glass-input-bg);
      backdrop-filter: blur(8px) saturate(1.3);
      -webkit-backdrop-filter: blur(8px) saturate(1.3);
      border: 1px solid var(--glass-border-color);
      box-shadow: var(--glass-shadow);
    }
    .glass-card {
      background: var(--glass-card-bg);
      backdrop-filter: blur(16px) saturate(1.4);
      -webkit-backdrop-filter: blur(16px) saturate(1.4);
      border: 1px solid var(--glass-border-color);
      box-shadow: var(--glass-shadow);
    }
    .glass-panel {
      background: var(--glass-panel-bg);
      backdrop-filter: blur(24px) saturate(1.5);
      -webkit-backdrop-filter: blur(24px) saturate(1.5);
      border: 1px solid var(--glass-border-color);
      box-shadow: var(--glass-shadow-lg);
    }
    .glass-panel-elevated {
      background: var(--glass-elevated-bg);
      backdrop-filter: blur(40px) saturate(1.6);
      -webkit-backdrop-filter: blur(40px) saturate(1.6);
      border: 1px solid var(--glass-border-color);
      box-shadow: var(--glass-shadow-lg);
    }
    .glass-sidebar {
      background: var(--glass-sidebar-bg);
      backdrop-filter: blur(40px) saturate(1.6);
      -webkit-backdrop-filter: blur(40px) saturate(1.6);
      border-right: 1px solid var(--glass-border-color);
    }
    /* Backward-compat aliases (existing components use these) */
    .glass { @apply glass-card; }
    .glass-heavy { @apply glass-panel; }
    .glass-lg { @apply glass-panel-elevated; }
    ```

    **6. macOS-style scrollbars:**
    ```css
    @layer utilities {
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb {
        background: oklch(60% 0.01 250 / 0.35);
        border-radius: 9999px;
      }
      ::-webkit-scrollbar-thumb:hover { background: oklch(50% 0.01 250 / 0.5); }
      .dark ::-webkit-scrollbar-thumb { background: oklch(60% 0.01 250 / 0.25); }
      .dark ::-webkit-scrollbar-thumb:hover { background: oklch(70% 0.01 250 / 0.4); }
    }
    ```

    **7. Dark mode body:**
    ```css
    .dark body {
      background:
        radial-gradient(80% 50% at 20% 20%, var(--mesh-1), transparent),
        radial-gradient(60% 60% at 80% 30%, var(--mesh-2), transparent),
        radial-gradient(70% 40% at 50% 80%, var(--mesh-3), transparent),
        oklch(12% 0.02 250);
      background-attachment: fixed;
    }
    ```

    **8. Glass shimmer skeleton animation:**
    ```css
    @keyframes glass-shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .glass-shimmer {
      background: linear-gradient(90deg,
        var(--glass-card-bg) 25%,
        oklch(100% 0 0 / 0.15) 50%,
        var(--glass-card-bg) 75%);
      background-size: 200% 100%;
      animation: glass-shimmer 1.5s ease-in-out infinite;
    }
    ```

    NOTE: Do NOT include @import for Google Fonts. Fonts are loaded via system font stack only.
    NOTE: Keep @tailwind base; @tailwind components; @tailwind utilities; at top.
    NOTE: Keep all existing .bg-mesh utility (update to use new mesh token vars).
  </action>
  <verify>
    Open browser DevTools on any page → Elements panel → :root computed styles show --glass-card-bg. Toggle .dark class on html manually → body background changes. No console errors about missing CSS.
    Also check: `grep -c "oklch" src/app/globals.css` returns 30+.
  </verify>
  <done>globals.css has oklch variables, 4 glass tiers + aliases, gradient mesh body, macOS scrollbars, dark mode block, shimmer animation. No Google Fonts @import. Backward compat aliases .glass/.glass-heavy/.glass-lg present.</done>
</task>

<task type="auto">
  <name>Task 2: Update tailwind.config.ts fonts + install Motion/React</name>
  <files>tailwind.config.ts</files>
  <action>
    **Install Motion/React v11:**
    Run: `npm install motion@latest`
    This installs the motion package which exports `motion/react` for React components and `useReducedMotion` hook.

    **Update tailwind.config.ts:**
    Change the fontFamily section:
    - `heading`: `["SF Pro Display", "SF Pro Text", "Inter", "ui-sans-serif", "system-ui", "-apple-system", "sans-serif"]`
    - `sans`: `["SF Pro Text", "Inter", "ui-sans-serif", "system-ui", "-apple-system", "sans-serif"]`

    Remove the `sidebar` color object from colors (sidebar is now styled via `glass-sidebar` CSS class, not Tailwind color tokens).

    Add glass shadow utilities to extend.boxShadow:
    - Keep existing `glass` and `glass-lg` shadow tokens (they read from CSS vars).

    Do NOT change darkMode: "class" (already correct).
    Do NOT change content paths.
    Do NOT change borderRadius tokens.
  </action>
  <verify>
    `npm run build` (or `npx tsc --noEmit`) completes without errors.
    `node -e "require('./node_modules/motion/react')"` exits 0 (or check package.json for "motion" key).
  </verify>
  <done>tailwind.config.ts uses Inter/system font stack. motion package in package.json. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 3: ThemeProvider + Prisma theme field + API route</name>
  <files>
    src/components/providers/theme-provider.tsx
    src/app/layout.tsx
    prisma/schema.prisma
    src/app/api/user/theme/route.ts
  </files>
  <action>
    **1. Create src/components/providers/theme-provider.tsx:**
    "use client" component. Logic:
    - On mount: fetch GET /api/user/theme → get stored preference ("light" | "dark" | "system"), fall back to "system" on error
    - Apply resolved theme: if "system" use window.matchMedia("(prefers-color-scheme: dark)"), else use stored value directly
    - Toggle .dark class on document.documentElement
    - Listen for system preference change events (add/remove listener in useEffect cleanup)
    - Export: `ThemeProvider` (wraps children in a React context), `useTheme()` hook that returns `{ theme: "light" | "dark" | "system", resolvedTheme: "light" | "dark", setTheme: (t) => void }`
    - `setTheme` calls PATCH /api/user/theme with the new value AND applies it immediately
    - Context stored in React Context (`ThemeContext`), default value: `{ theme: "system", resolvedTheme: "light", setTheme: () => {} }`
    - No Zustand store — use React Context only (simpler, works with RSC layout)

    ThemeProvider implementation pattern:
    ```tsx
    "use client";
    import { createContext, useContext, useEffect, useState, type ReactNode } from "react";

    type Theme = "light" | "dark" | "system";
    interface ThemeContextValue {
      theme: Theme;
      resolvedTheme: "light" | "dark";
      setTheme: (t: Theme) => void;
    }
    const ThemeContext = createContext<ThemeContextValue>({ theme: "system", resolvedTheme: "light", setTheme: () => {} });

    export function ThemeProvider({ children }: { children: ReactNode }) {
      const [theme, setThemeState] = useState<Theme>("system");
      const [resolvedTheme, setResolvedTheme] = useState<"light" | "dark">("light");

      // Load from API on mount
      useEffect(() => {
        fetch("/api/user/theme").then(r => r.ok ? r.json() : null).then(d => {
          if (d?.theme) setThemeState(d.theme as Theme);
        }).catch(() => {});
      }, []);

      // Apply .dark class based on theme
      useEffect(() => {
        const root = document.documentElement;
        const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
        const apply = () => {
          const resolved = theme === "system" ? (mediaQuery.matches ? "dark" : "light") : theme;
          root.classList.toggle("dark", resolved === "dark");
          setResolvedTheme(resolved as "light" | "dark");
        };
        apply();
        mediaQuery.addEventListener("change", apply);
        return () => mediaQuery.removeEventListener("change", apply);
      }, [theme]);

      const setTheme = (t: Theme) => {
        setThemeState(t);
        fetch("/api/user/theme", { method: "PATCH", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ theme: t }) }).catch(() => {});
      };

      return <ThemeContext.Provider value={{ theme, resolvedTheme, setTheme }}>{children}</ThemeContext.Provider>;
    }

    export const useTheme = () => useContext(ThemeContext);
    ```

    **2. Update src/app/layout.tsx:**
    Import ThemeProvider. Wrap `<body>` content with `<ThemeProvider>`. Keep Toaster. Keep suppressHydrationWarning on html.

    **3. Update prisma/schema.prisma:**
    Find the `model UserSettings` block. Add field: `theme    String   @default("system")`
    Run: `npx prisma db push` to apply without creating a migration file (development mode).
    Run: `npx prisma generate` to update the client.

    **4. Create src/app/api/user/theme/route.ts:**
    ```ts
    import { auth } from "@/lib/auth";
    import { prisma } from "@/lib/db";
    import { NextResponse } from "next/server";

    // GET /api/user/theme — returns { theme: "system" | "light" | "dark" }
    export async function GET() {
      const session = await auth();
      if (!session?.user?.id) return NextResponse.json({ theme: "system" });
      const settings = await prisma.userSettings.findUnique({ where: { userId: session.user.id }, select: { theme: true } });
      return NextResponse.json({ theme: settings?.theme ?? "system" });
    }

    // PATCH /api/user/theme — body: { theme: "system" | "light" | "dark" }
    export async function PATCH(request: Request) {
      const session = await auth();
      if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
      const { theme } = await request.json();
      if (!["system", "light", "dark"].includes(theme)) return NextResponse.json({ error: "Invalid" }, { status: 400 });
      await prisma.userSettings.upsert({
        where: { userId: session.user.id },
        update: { theme },
        create: { userId: session.user.id, theme },
      });
      return NextResponse.json({ theme });
    }
    ```
  </action>
  <verify>
    `npx tsc --noEmit` — no TypeScript errors.
    `npx prisma validate` — schema valid.
    Manual: Load app → no flash of wrong theme. Open DevTools → Application → check html element has no class (system=light) or dark class (if system=dark).
  </verify>
  <done>ThemeProvider component exists + wired in layout.tsx. Prisma schema has theme field. API route responds at GET/PATCH /api/user/theme. No TS errors.</done>
</task>

</tasks>

<verification>
1. `grep -c "oklch" src/app/globals.css` returns 30+ lines with oklch
2. `grep "glass-card\|glass-panel\|glass-input\|glass-sidebar" src/app/globals.css` shows all 4 tiers
3. `grep "motion" package.json` — motion package present
4. `grep "ThemeProvider" src/app/layout.tsx` — wired in root layout
5. `npx prisma validate` — no schema errors
6. `grep "theme" prisma/schema.prisma` — field present in UserSettings
7. Browser: body has gradient mesh, no Google Fonts network requests, .dark toggles body background
</verification>

<success_criteria>
- globals.css: oklch variables, 4 glass tiers (.glass-input/.glass-card/.glass-panel/.glass-panel-elevated + .glass-sidebar), backward-compat aliases (.glass → glass-card etc.), gradient mesh body, macOS scrollbars, dark mode CSS block, 200ms transition
- tailwind.config.ts: SF Pro/Inter font stack, motion package installed
- ThemeProvider: reads/writes /api/user/theme, applies .dark to html, exports useTheme()
- Prisma: theme field on UserSettings, db pushed
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-glass-ui-migration/11-01-SUMMARY.md`
</output>
