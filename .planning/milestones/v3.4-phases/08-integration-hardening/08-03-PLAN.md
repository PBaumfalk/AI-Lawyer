---
phase: 08-integration-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/audit.ts
  - src/lib/versand-gate.ts
  - src/app/api/email-send/route.ts
  - src/app/api/bea/messages/route.ts
  - src/app/api/bea/messages/[id]/route.ts
  - src/app/api/bea/messages/[id]/eeb/route.ts
  - src/app/api/bea/auto-assign/route.ts
  - src/app/api/kontakte/[id]/route.ts
  - src/app/api/ki-chat/route.ts
  - src/app/api/ki-chat/conversations/route.ts
  - src/app/api/helena/suggestions/route.ts
  - src/components/email/email-compose-view.tsx
  - src/components/bea/bea-compose.tsx
  - src/app/(dashboard)/akten/[id]/page.tsx
autonomous: true
requirements:
  - REQ-RS-004
  - REQ-KI-003
  - REQ-KI-009

must_haves:
  truths:
    - "ENTWURF documents cannot be sent via email -- checkDokumenteFreigegeben() blocks the send and returns 400"
    - "ENTWURF documents cannot be sent via beA -- same checkDokumenteFreigegeben() blocks beA send with 400"
    - "ENTWURF documents are visible but greyed out in attach dialogs with 'Noch nicht freigegeben' hint and Quick-Release button"
    - "All beA API operations (send, receive, eEB, message open, assignment change) create audit log entries via logAuditEvent()"
    - "beA attachment download is logged via BEA_ANHANG_HERUNTERGELADEN audit action in the message detail GET route"
    - "Safe-ID changes on contacts are logged via BEA_SAFEID_GEAENDERT audit action in the kontakte PATCH route"
    - "beA audit entries include detailed metadata: user, aktion, timestamp, Aktenzeichen, empfaenger-Safe-ID, document list, result (Erfolg/Fehler)"
    - "Pruefprotokoll tab in Akte detail shows chronological beA audit log queried from prisma.auditLog"
    - "KI-Chat routes (/api/ki-chat, /api/ki-chat/conversations, /api/helena/suggestions) require authentication but no role restriction"
  artifacts:
    - path: "src/lib/audit.ts"
      provides: "beA-specific AuditAktion types (BEA_NACHRICHT_GESENDET, BEA_NACHRICHT_EMPFANGEN, BEA_EEB_BESTAETIGT, BEA_NACHRICHT_GELESEN, BEA_ZUORDNUNG_GEAENDERT, BEA_ANHANG_HERUNTERGELADEN, BEA_SAFEID_GEAENDERT, BEA_POSTFACH_GEWECHSELT)"
      contains: "BEA_NACHRICHT_GESENDET"
    - path: "src/app/api/email-send/route.ts"
      provides: "Versand-Gate check before email queuing"
      contains: "checkDokumenteFreigegeben"
    - path: "src/app/api/bea/messages/route.ts"
      provides: "Versand-Gate check on beA send + audit logging on all beA operations"
      contains: "logAuditEvent"
    - path: "src/app/api/bea/messages/[id]/route.ts"
      provides: "Audit logging for message open (BEA_NACHRICHT_GELESEN) and attachment download (BEA_ANHANG_HERUNTERGELADEN)"
      contains: "BEA_ANHANG_HERUNTERGELADEN"
    - path: "src/app/api/kontakte/[id]/route.ts"
      provides: "Audit logging for Safe-ID changes (BEA_SAFEID_GEAENDERT)"
      contains: "BEA_SAFEID_GEAENDERT"
    - path: "src/app/(dashboard)/akten/[id]/page.tsx"
      provides: "Pruefprotokoll tab showing beA audit history"
      contains: "Pruefprotokoll"
  key_links:
    - from: "src/app/api/email-send/route.ts"
      to: "src/lib/versand-gate.ts"
      via: "import checkDokumenteFreigegeben"
      pattern: "checkDokumenteFreigegeben"
    - from: "src/app/api/bea/messages/route.ts"
      to: "src/lib/versand-gate.ts"
      via: "import checkDokumenteFreigegeben"
      pattern: "checkDokumenteFreigegeben"
    - from: "src/app/api/bea/messages/route.ts"
      to: "src/lib/audit.ts"
      via: "import logAuditEvent"
      pattern: "logAuditEvent"
    - from: "src/app/api/bea/messages/[id]/route.ts"
      to: "src/lib/audit.ts"
      via: "import logAuditEvent for BEA_NACHRICHT_GELESEN and BEA_ANHANG_HERUNTERGELADEN"
      pattern: "logAuditEvent"
    - from: "src/app/api/kontakte/[id]/route.ts"
      to: "src/lib/audit.ts"
      via: "import logAuditEvent for BEA_SAFEID_GEAENDERT"
      pattern: "logAuditEvent"
    - from: "src/app/(dashboard)/akten/[id]/page.tsx"
      to: "prisma.auditLog"
      via: "findMany query with beA aktion filter"
      pattern: "auditLog.findMany"
---

<objective>
Wire the Versand-Gate (checkDokumenteFreigegeben) into email and beA send flows, add comprehensive audit logging to all beA routes including attachment download and Safe-ID changes, add Pruefprotokoll tab to Akte detail, ensure KI-Chat routes use auth-only checks, and update attach dialog UIs with ENTWURF greyed-out + Quick-Release.

Purpose: Close integration gaps INT-A02 (Versand-Gate), INT-A04 (beA audit), INT-A05 (KPI display), and ensure KI-Entwurf safety (ENTWURF docs never sent) per user decision.
Output: Versand-Gate wired in 2 send flows, beA audit logging in 6+ route files (including attachment download and Safe-ID change), Pruefprotokoll tab, updated attach dialogs, simplified KI-Chat auth.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-hardening/08-CONTEXT.md
@.planning/phases/08-integration-hardening/08-RESEARCH.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Versand-Gate in email/beA send + attach dialog UI + KI-Chat auth simplification</name>
  <files>
    src/lib/versand-gate.ts
    src/app/api/email-send/route.ts
    src/app/api/bea/messages/route.ts
    src/app/api/ki-chat/route.ts
    src/app/api/ki-chat/conversations/route.ts
    src/app/api/helena/suggestions/route.ts
    src/components/email/email-compose-view.tsx
    src/components/bea/bea-compose.tsx
  </files>
  <action>
    **Step 1: Examine `src/lib/versand-gate.ts`** to understand the existing `checkDokumenteFreigegeben()` function signature and return type. It should accept an array of document IDs and return `{ ok: boolean, errors?: string[] }` or similar.

    **Step 2: Wire Versand-Gate into email send route (`src/app/api/email-send/route.ts`):**
    - Import `checkDokumenteFreigegeben` from `@/lib/versand-gate`
    - Before queuing the email for send, extract DMS document IDs from the attachments array. Per RESEARCH.md Pitfall 6: Email compose attachments may use `dms-{dokumentId}` format for DMS documents and `upload-{random}` for direct uploads. Only DMS-source attachments need the check.
    - Filter attachments to those starting with `dms-`, extract the document ID portion, pass to `checkDokumenteFreigegeben()`.
    - If check fails (not ok), return `Response.json({ error: "Nicht freigegebene Dokumente koennen nicht versendet werden", details: check.errors }, { status: 400 })`.
    - If no DMS attachments, skip the check.

    **Step 3: Wire Versand-Gate into beA send route (`src/app/api/bea/messages/route.ts` POST):**
    - Import `checkDokumenteFreigegeben` from `@/lib/versand-gate`
    - Before creating/sending the beA message, check any attached documents.
    - Examine the beA compose data shape to understand how document attachments are referenced (likely by dokumentId directly).
    - If any documents are ENTWURF, return 400 with the same error pattern.

    **Step 4: Update email attach dialog (`src/components/email/email-compose-view.tsx` or wherever the document picker lives):**
    - Fetch ALL documents for the Akte (not just FREIGEGEBEN ones).
    - Display ENTWURF/ZUR_PRUEFUNG documents greyed out (`opacity-50 cursor-not-allowed`) with a "Noch nicht freigegeben" text label in amber.
    - Add a Quick-Release button next to each greyed-out document that calls `PATCH /api/dokumente/{id}` with `{ status: "FREIGEGEBEN" }` to immediately release the document. After successful release, refresh the document list so the document becomes selectable.
    - Non-ENTWURF documents remain normally selectable.

    **Step 5: Update beA attach/compose (`src/components/bea/bea-compose.tsx`):**
    - Same pattern as email: show all documents, grey out ENTWURF with Quick-Release button.
    - Currently the beA compose may only fetch FREIGEGEBEN docs. Change the fetch to include all statuses, then handle ENTWURF display in the UI.

    **Step 6: KI-Chat auth simplification:**
    Per user decision, KI-Chat is open to ALL logged-in users -- no role restriction, just authentication check.
    - `src/app/api/ki-chat/route.ts`: Ensure it uses `requireAuth()` (not `requirePermission('canUseKI')`). If it already uses basic auth, leave it. Remove any role-based permission check.
    - `src/app/api/ki-chat/conversations/route.ts`: Same -- requireAuth only.
    - `src/app/api/helena/suggestions/route.ts`: Same -- requireAuth only.
    - Also remove any PRAKTIKANT-specific comments in these files (cleaning up references from removed role).
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>
      1. Grep for "checkDokumenteFreigegeben" in email-send/route.ts and bea/messages/route.ts -- should appear in both
      2. Grep for "canUseKI" in ki-chat routes -- should NOT appear (removed)
      3. Verify compose components show ENTWURF documents greyed out (code review)
    </manual>
  </verify>
  <done>
    - Email send route rejects ENTWURF DMS attachments with 400 Bad Request
    - beA send route rejects ENTWURF document attachments with 400 Bad Request
    - Email attach dialog shows ENTWURF docs greyed out with "Noch nicht freigegeben" hint and Quick-Release
    - beA compose shows ENTWURF docs greyed out with Quick-Release
    - KI-Chat routes require only authentication, no role restriction
    - No PRAKTIKANT references remain in beA or KI routes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add beA audit logging to all routes (incl. attachment download + Safe-ID) + Pruefprotokoll tab</name>
  <files>
    src/lib/audit.ts
    src/app/api/bea/messages/route.ts
    src/app/api/bea/messages/[id]/route.ts
    src/app/api/bea/messages/[id]/eeb/route.ts
    src/app/api/bea/auto-assign/route.ts
    src/app/api/kontakte/[id]/route.ts
    src/app/(dashboard)/akten/[id]/page.tsx
  </files>
  <action>
    **Step 1: Extend audit action types in `src/lib/audit.ts`:**
    Add beA-specific audit action types to the `AuditAktion` type union:
    - `"BEA_NACHRICHT_GESENDET"` -- beA message sent
    - `"BEA_NACHRICHT_EMPFANGEN"` -- beA message received/synced
    - `"BEA_EEB_BESTAETIGT"` -- eEB acknowledgment
    - `"BEA_NACHRICHT_GELESEN"` -- beA message opened/read
    - `"BEA_ZUORDNUNG_GEAENDERT"` -- case assignment changed
    - `"BEA_ANHANG_HERUNTERGELADEN"` -- attachment downloaded
    - `"BEA_SAFEID_GEAENDERT"` -- Safe-ID modified on contact
    - `"BEA_POSTFACH_GEWECHSELT"` -- beA mailbox switched

    Add corresponding labels to `AKTION_LABELS`:
    ```typescript
    BEA_NACHRICHT_GESENDET: "beA Nachricht gesendet",
    BEA_NACHRICHT_EMPFANGEN: "beA Nachricht empfangen",
    BEA_EEB_BESTAETIGT: "eEB bestaetigt",
    BEA_NACHRICHT_GELESEN: "beA Nachricht gelesen",
    BEA_ZUORDNUNG_GEAENDERT: "beA Zuordnung geaendert",
    BEA_ANHANG_HERUNTERGELADEN: "beA Anhang heruntergeladen",
    BEA_SAFEID_GEAENDERT: "Safe-ID geaendert",
    BEA_POSTFACH_GEWECHSELT: "beA Postfach gewechselt",
    ```

    **Step 2: Add audit logging to beA message list/sync (`src/app/api/bea/messages/route.ts`):**
    - POST handler (message send or sync): After successful operation, call:
      ```typescript
      logAuditEvent({
        userId: session.user.id,
        akteId: nachricht.akteId,
        aktion: "BEA_NACHRICHT_GESENDET", // or BEA_NACHRICHT_EMPFANGEN based on direction
        details: {
          nachrichtId: nachricht.id,
          betreff: nachricht.betreff || data.betreff,
          empfaengerSafeId: nachricht.safeIdEmpfaenger || data.safeIdEmpfaenger,
          anhaengeAnzahl: (nachricht.anhaenge || []).length,
          nachrichtenTyp: nachricht.typ || "NORMAL",
          ergebnis: "ERFOLG",
        },
      }).catch(() => {});
      ```
    - On error, log with `ergebnis: "FEHLER"` and include `fehlerMeldung` and `fehlerCode` in details.

    **Step 3: Add audit logging to beA message detail (`src/app/api/bea/messages/[id]/route.ts`):**
    - GET handler: After fetching message, log `BEA_NACHRICHT_GELESEN` with message metadata.
    - GET handler: If the request includes a query param `?download=anhangId` (or similar pattern), also log `BEA_ANHANG_HERUNTERGELADEN` with the attachment name and size.
      **Note on attachment downloads:** The current beA architecture uses browser-side decryption (bea.expert library in `src/lib/bea/client.ts`). Attachments are decrypted in-browser, so there is NO dedicated server-side attachment download route. The audit log for `BEA_ANHANG_HERUNTERGELADEN` must be triggered from the message detail GET route. Add logic: when the GET request includes a `download` query parameter with an attachment ID, log the download event. The frontend `bea-message-detail.tsx` attachment download buttons should append `?download={attachmentId}` to a secondary fetch call (or POST to an audit-only endpoint) when user clicks download.
      **Implementation choice (Claude's discretion):** Either (a) add a `?download=anhangId` query param to the existing GET route that triggers the audit log, or (b) add a small POST endpoint like `/api/bea/messages/[id]/download-log` that just logs the event. Option (b) is cleaner since it separates concerns. If choosing (b), add the route file to this task's file list.
    - PATCH handler (assignment change): Log `BEA_ZUORDNUNG_GEAENDERT` with old and new akteId.
    - All with fire-and-forget `.catch(() => {})`.

    **Step 4: Add audit logging to eEB (`src/app/api/bea/messages/[id]/eeb/route.ts`):**
    - POST handler: After eEB acknowledgment, log `BEA_EEB_BESTAETIGT` with:
      - nachrichtId, betreff, senderSafeId, ergebnis (ERFOLG or FEHLER)
    - On error, log with FEHLER details.

    **Step 5: Add audit logging to auto-assign (`src/app/api/bea/auto-assign/route.ts`):**
    - POST handler: After auto-assignment, log `BEA_ZUORDNUNG_GEAENDERT` with:
      - nachrichtId, akteId (assigned), confidence level, ergebnis
    - Also remove any remaining PRAKTIKANT comments in this file.

    **Step 6: Add audit logging for Safe-ID changes (`src/app/api/kontakte/[id]/route.ts`):**
    - In the PATCH handler: Before updating the contact, check if `beaSafeId` is in the update payload AND if it differs from the current value.
    - If `beaSafeId` changed, after the successful update, log `BEA_SAFEID_GEAENDERT` with:
      ```typescript
      logAuditEvent({
        userId: session.user.id,
        aktion: "BEA_SAFEID_GEAENDERT",
        details: {
          kontaktId: id,
          kontaktName: existing.vorname ? `${existing.vorname} ${existing.nachname}` : existing.firma,
          alteSafeId: existing.beaSafeId || null,
          neueSafeId: parsed.data.beaSafeId,
          ergebnis: "ERFOLG",
        },
      }).catch(() => {});
      ```
    - Note: The kontakte route currently uses raw `auth()` -- update it to use `requireAuth()` from rbac.ts for consistency, then use `session.user.id` for the audit log. This also fixes a security gap (the route should use standardized auth).

    **Step 7: Postfach switching note:**
    - `BEA_POSTFACH_GEWECHSELT` is defined as an audit type but Postfach switching is currently a client-side operation (the `beaGetPostboxes()` function in `client.ts` retrieves available postboxes, and the inbox uses `session.safeId`). There is NO server-side Postfach switch route.
    - The audit type is registered in audit.ts for future use. When Postfach switching UI is built (currently not implemented -- only single-postbox login exists), the event should be logged.
    - Add a comment in audit.ts: `// BEA_POSTFACH_GEWECHSELT: reserved for future multi-postbox UI`

    **Step 8: Add Pruefprotokoll tab in Akte detail (`src/app/(dashboard)/akten/[id]/page.tsx`):**
    - Add a "Pruefprotokoll" section/tab to the Akte detail page that queries the AuditLog table for beA-specific actions related to this Akte.
    - Query: `prisma.auditLog.findMany({ where: { akteId, aktion: { in: ["BEA_NACHRICHT_GESENDET", "BEA_NACHRICHT_EMPFANGEN", "BEA_EEB_BESTAETIGT", "BEA_NACHRICHT_GELESEN", "BEA_ZUORDNUNG_GEAENDERT", "BEA_ANHANG_HERUNTERGELADEN"] } }, orderBy: { zeitpunkt: "desc" }, include: { user: { select: { name: true } } } })`
    - Display as a chronological list with: timestamp (formatted German), user name, action label (from AKTION_LABELS), details (betreff, empfaenger, anhaengeAnzahl, ergebnis).
    - If no beA audit entries exist for this Akte, show a "Keine beA-Aktivitaeten" placeholder.
    - This can be a collapsible section within the existing Akte detail tabs, or a new tab depending on the current page structure. Use Claude's discretion for the exact layout -- a simple table or timeline view is fine.
    - Error entries (ergebnis: FEHLER) should be highlighted in red/rose.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>
      1. Grep for "logAuditEvent" in all bea route files -- should appear in every beA route
      2. Grep for "logAuditEvent" in kontakte/[id]/route.ts -- should appear with BEA_SAFEID_GEAENDERT
      3. Grep for "BEA_NACHRICHT_GESENDET" in audit.ts -- should appear in type union and AKTION_LABELS
      4. Grep for "BEA_ANHANG_HERUNTERGELADEN" in bea/messages/[id]/route.ts -- should appear
      5. Verify Akte detail page has Pruefprotokoll section with beA audit query (auditLog.findMany)
    </manual>
  </verify>
  <done>
    - All beA route files call logAuditEvent with appropriate beA audit action types
    - Attachment download is logged via BEA_ANHANG_HERUNTERGELADEN in the message detail route
    - Safe-ID changes are logged via BEA_SAFEID_GEAENDERT in the kontakte PATCH route
    - BEA_POSTFACH_GEWECHSELT type is registered for future use (no server-side Postfach switch exists yet)
    - Audit entries include detailed metadata: user, aktion, timestamp, betreff, empfaenger-Safe-ID, anhaenge count, ergebnis
    - Both success AND failure paths are logged
    - AuditAktion type includes all 8 beA-specific action types with German labels
    - Pruefprotokoll tab/section on Akte detail page shows chronological beA audit log from prisma.auditLog
    - Error entries are visually highlighted
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes cleanly (or with only pre-existing errors)
2. `grep -r "checkDokumenteFreigegeben" src/app/api/email-send/ src/app/api/bea/messages/` confirms Versand-Gate wired in both send flows
3. `grep -r "logAuditEvent" src/app/api/bea/` confirms audit logging in all beA routes
4. `grep -r "logAuditEvent" src/app/api/kontakte/` confirms Safe-ID audit logging
5. `grep -r "BEA_" src/lib/audit.ts` shows all beA audit action types defined (8 types)
6. `grep -r "canUseKI" src/app/api/ki-chat/ src/app/api/helena/` returns zero results (permission removed)
7. `grep -r "auditLog.findMany" src/app/\(dashboard\)/akten/` confirms Pruefprotokoll query
8. Akte detail page contains Pruefprotokoll section
</verification>

<success_criteria>
- Versand-Gate prevents ENTWURF documents from being sent via email AND beA (400 Bad Request on API)
- Attach dialogs show ENTWURF docs greyed out with Quick-Release button for immediate Freigabe
- All beA operations create detailed audit log entries (success and failure)
- beA attachment downloads are audit-logged (BEA_ANHANG_HERUNTERGELADEN)
- Safe-ID changes on contacts are audit-logged (BEA_SAFEID_GEAENDERT)
- BEA_POSTFACH_GEWECHSELT audit type is registered for future multi-postbox UI
- Pruefprotokoll tab on Akte detail displays chronological beA audit history from prisma.auditLog
- KI-Chat routes require only authentication, not specific role permissions
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-hardening/08-03-SUMMARY.md`
</output>
