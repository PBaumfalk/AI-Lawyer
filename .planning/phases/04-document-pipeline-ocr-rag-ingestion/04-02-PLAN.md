---
phase: 04-document-pipeline-ocr-rag-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(dashboard)/akten/[id]/dokumente/[docId]/page.tsx
  - src/components/dokumente/pdf-viewer.tsx
  - src/components/dokumente/document-detail.tsx
  - src/components/dokumente/version-timeline.tsx
  - src/components/dokumente/document-actions-bar.tsx
  - src/components/dokumente/tag-manager.tsx
  - src/app/api/dokumente/[id]/route.ts
  - src/app/api/dokumente/[id]/tags/route.ts
  - src/app/api/dokumente/[id]/preview/route.ts
  - src/components/dokumente/dokument-list.tsx
  - package.json
autonomous: true
requirements:
  - REQ-DV-006
  - REQ-DV-007

must_haves:
  truths:
    - "User can view PDFs in-browser with page navigation, zoom, fit-to-width, and text selection"
    - "Document detail page shows metadata (filename, type, size, upload date, uploader, case link, OCR status, tags, status, version count)"
    - "Version history displays as a vertical timeline in the right sidebar with restore action"
    - "Actions bar provides rename, move to folder, add/remove tags, change status, download, delete, re-OCR, open in OnlyOffice"
    - "Non-PDF documents show PDF preview with 'In OnlyOffice bearbeiten' button for editable formats"
    - "Tags can be added/removed per document with colored tag chips"
    - "Split view layout: PDF on left (~65%), metadata/actions panel on right (~35%) with resizable panels"
  artifacts:
    - path: "src/app/(dashboard)/akten/[id]/dokumente/[docId]/page.tsx"
      provides: "Document detail page route"
    - path: "src/components/dokumente/pdf-viewer.tsx"
      provides: "react-pdf based PDF viewer with text layer and controls"
      exports: ["PdfViewer"]
    - path: "src/components/dokumente/document-detail.tsx"
      provides: "Document detail page layout with split view"
      exports: ["DocumentDetail"]
    - path: "src/components/dokumente/version-timeline.tsx"
      provides: "Vertical timeline of document versions"
      exports: ["VersionTimeline"]
    - path: "src/components/dokumente/document-actions-bar.tsx"
      provides: "Actions toolbar for document operations"
      exports: ["DocumentActionsBar"]
    - path: "src/components/dokumente/tag-manager.tsx"
      provides: "Tag add/remove component for documents"
      exports: ["TagManager"]
  key_links:
    - from: "src/app/(dashboard)/akten/[id]/dokumente/[docId]/page.tsx"
      to: "/api/dokumente/[id]"
      via: "Fetches document data including versions, tags, metadata"
      pattern: "fetch.*api/dokumente"
    - from: "src/components/dokumente/pdf-viewer.tsx"
      to: "/api/dokumente/[id]/preview"
      via: "Loads PDF URL for rendering"
      pattern: "getDownloadUrl|presigned"
    - from: "src/components/dokumente/document-detail.tsx"
      to: "src/components/dokumente/pdf-viewer.tsx"
      via: "Renders PDF viewer in left panel of split view"
      pattern: "PdfViewer"
---

<objective>
Build the document detail page with in-browser PDF viewing, metadata display, version history timeline, actions bar, and tag management -- the primary interface for viewing and managing individual documents.

Purpose: Users need to view, inspect, and manage documents within cases. The document detail page is the central hub for document interaction, replacing the current minimal document list experience.

Output: A rich document detail page at `/akten/[id]/dokumente/[docId]` with split-view PDF preview, comprehensive metadata panel, version timeline, and full actions bar.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-document-pipeline-ocr-rag-ingestion/04-RESEARCH.md
@.planning/phases/04-document-pipeline-ocr-rag-ingestion/04-CONTEXT.md
@.planning/phases/04-document-pipeline-ocr-rag-ingestion/04-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/storage.ts
@src/components/dokumente/dokument-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf + Create PDF Viewer Component + Document API</name>
  <files>
    package.json
    src/components/dokumente/pdf-viewer.tsx
    src/app/api/dokumente/[id]/route.ts
    src/app/api/dokumente/[id]/preview/route.ts
    src/app/api/dokumente/[id]/tags/route.ts
  </files>
  <action>
    **1. Install dependencies:**
    ```bash
    npm install react-pdf pdfjs-dist
    ```
    If Node < 22: also `npm install core-js` for Promise.withResolvers polyfill.

    **2. Create PDF viewer component (src/components/dokumente/pdf-viewer.tsx):**
    "use client" component using react-pdf v9 with pdfjs-dist v4.

    Set `pdfjs.GlobalWorkerOptions.workerSrc` using `import.meta.url` pattern in the SAME file:
    ```typescript
    pdfjs.GlobalWorkerOptions.workerSrc = new URL(
      "pdfjs-dist/build/pdf.worker.min.mjs",
      import.meta.url
    ).toString();
    ```

    Import CSS for text and annotation layers:
    ```typescript
    import "react-pdf/dist/esm/Page/AnnotationLayer.css";
    import "react-pdf/dist/esm/Page/TextLayer.css";
    ```

    Component props: `{ url: string; className?: string }`
    State: `numPages`, `pageNumber`, `scale`, `showThumbnails`, `isFullscreen`
    Features (per user decision):
    - Page navigation: Previous/Next buttons + page number input + "Page X of Y" display
    - Zoom controls: zoom in (+), zoom out (-), fit-to-width button, zoom percentage display (50%-300% range)
    - Thumbnail sidebar: toggle button, shows all pages as small thumbnails in a scrollable side panel, click to navigate
    - Text layer enabled: `renderTextLayer={true}` for text selection/copy
    - Annotation layer: `renderAnnotationLayer={true}` for links in PDF
    - Search within PDF: Use pdfjs-dist's `findController` -- search input field, highlight matches, next/prev match navigation
    - Print button: `window.print()` with print-specific CSS
    - Fullscreen toggle: use Fullscreen API (`document.fullscreenElement`)
    - Download button: direct link to presigned URL
    - Loading state: skeleton placeholder while PDF loads
    - Error state: "PDF konnte nicht geladen werden" with retry button

    Layout: Controls toolbar at top, PDF content below (scrollable for multi-page), optional thumbnail sidebar on left.
    Use Tailwind + shadcn Button/Input/Tooltip components.

    **3. Create document detail API (src/app/api/dokumente/[id]/route.ts):**
    GET handler:
    - Auth check
    - Fetch Dokument with relations: `{ akte: { select: { id, aktenzeichen, kurzrubrum } }, createdBy: { select: { id, name } }, versionen: { orderBy: { version: "desc" } }, freigegebenDurch: { select: { id, name } } }`
    - Also fetch DokumentTagKategorie records for the document's tags array
    - Return complete document object including presigned download URL and preview URL
    PATCH handler:
    - Auth check
    - Accept: `{ name?, ordner?, status?, tags? }` (Zod validated)
    - For status changes, enforce workflow rules (ENTWURF -> ZUR_PRUEFUNG -> FREIGEGEBEN requires ADMIN/ANWALT)
    - For rename: update name field
    - For move: update ordner field
    - For tags: update tags array
    - Log audit event
    DELETE handler:
    - Auth check (ADMIN or document creator)
    - Delete from MinIO + Prisma + Meilisearch
    - Log audit event

    **4. Create document preview endpoint (src/app/api/dokumente/[id]/preview/route.ts):**
    GET handler:
    - Auth check
    - Fetch Dokument record
    - If PDF: return presigned URL for the original file
    - If non-PDF with previewPfad: return presigned URL for the preview PDF
    - If non-PDF without previewPfad: return 202 "Preview wird generiert" (preview job may still be running)
    - Response: `{ url: string; status: "ready" | "generating" }`

    **5. Create document tags API (src/app/api/dokumente/[id]/tags/route.ts):**
    PUT handler:
    - Auth check
    - Accept `{ tags: string[] }` -- array of tag category names
    - Update Dokument.tags array
    - Re-index in Meilisearch
    - Return updated document
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify react-pdf installed, PDF viewer component has controls, document API returns full metadata</manual>
  </verify>
  <done>
    - react-pdf v9 and pdfjs-dist installed
    - PdfViewer component renders PDFs with navigation, zoom, thumbnails, search, print, fullscreen, download
    - Document detail API returns full metadata with relations, presigned URLs, and supports PATCH/DELETE
    - Preview API returns PDF URL (original or generated preview)
    - Tags API allows updating document tags
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Detail Page + Version Timeline + Actions Bar + Tag Manager + List Link</name>
  <files>
    src/app/(dashboard)/akten/[id]/dokumente/[docId]/page.tsx
    src/components/dokumente/document-detail.tsx
    src/components/dokumente/version-timeline.tsx
    src/components/dokumente/document-actions-bar.tsx
    src/components/dokumente/tag-manager.tsx
    src/components/dokumente/dokument-list.tsx
  </files>
  <action>
    **1. Create document detail page route (src/app/(dashboard)/akten/[id]/dokumente/[docId]/page.tsx):**
    Server component that:
    - Extracts `id` (akteId) and `docId` (dokumentId) from params
    - Renders `<DocumentDetail akteId={id} dokumentId={docId} />`
    - Page metadata: document name as title

    **2. Create DocumentDetail component (src/components/dokumente/document-detail.tsx):**
    "use client" component.
    Props: `{ akteId: string; dokumentId: string }`
    Fetches document data from `GET /api/dokumente/{dokumentId}`.

    Split view layout using `react-resizable-panels` (already in project):
    - Left panel (~65%): PdfViewer component with the document's preview/download URL
    - Right panel (~35%): Metadata + actions panel
    - Resizable divider between panels

    Right panel sections (scrollable):
    **a) Header:** Document name (editable inline), document status badge (Entwurf/ZurPruefung/Freigegeben/Versendet)
    **b) Metadata card:**
    - Dateityp (MIME type with icon)
    - Groesse (formatted bytes: KB/MB)
    - Hochgeladen am (formatted date)
    - Hochgeladen von (user name with link)
    - Akte (aktenzeichen + kurzrubrum with link to case)
    - OCR Status: OcrStatusBadge component
    - Versionen: count
    - AI-indexed: subtle chip if document has embeddings (check DocumentChunk count)
    **c) Tags section:** TagManager component
    **d) Actions bar:** DocumentActionsBar component
    **e) Version history:** VersionTimeline component

    For non-PDF editable documents (DOCX, ODT): show a prominent "In OnlyOffice bearbeiten" button above the PDF preview.

    Loading state: Skeleton with panels outline.
    Error state: "Dokument nicht gefunden" with back link.

    **3. Create VersionTimeline component (src/components/dokumente/version-timeline.tsx):**
    Props: `{ versions: DokumentVersion[]; dokumentId: string; onRestore: (versionId: string) => void }`
    Vertical timeline (newest at top):
    - Each entry: version number, date (relative), author name, named snapshot label if present
    - "Wiederherstellen" button on each version (except current)
    - Restore calls existing version restore API (POST /api/akten/[id]/dokumente/[dId]/versionen with `{ action: "restore", versionId }`)
    Styling: vertical line with circle markers, Tailwind utilities.

    **4. Create DocumentActionsBar component (src/components/dokumente/document-actions-bar.tsx):**
    Props: `{ dokument: DokumentData; onUpdate: () => void }`
    Vertical button list with icons (per user decision -- all actions):
    - **Umbenennen**: Dialog with name input, PATCH /api/dokumente/{id} with `{ name }`
    - **Verschieben**: Dialog with folder selector (dropdown of existing ordner values from case), PATCH with `{ ordner }`
    - **Status aendern**: Dropdown select (Entwurf/ZurPruefung/Freigegeben/Versendet), PATCH with `{ status }`
    - **Herunterladen**: Direct download via presigned URL (`window.open`)
    - **Loeschen**: AlertDialog confirmation, DELETE /api/dokumente/{id}, redirect to case documents tab
    - **Erneut OCR**: POST /api/dokumente/{id}/ocr (only if status is FEHLGESCHLAGEN)
    - **In OnlyOffice oeffnen**: Link to existing OnlyOffice editor page (only for DOCX/ODT/XLSX)
    Use shadcn Button with variant="ghost", lucide-react icons.

    **5. Create TagManager component (src/components/dokumente/tag-manager.tsx):**
    Props: `{ dokumentId: string; currentTags: string[]; onTagsChange: (tags: string[]) => void }`
    - Displays current tags as colored chips (fetch colors from DokumentTagKategorie)
    - Remove tag: click X on chip
    - Add tag: Combobox/Popover with list of available tags (fetched from GET /api/dokumente/tags)
    - Also allows creating custom tags inline (type name, press Enter)
    - On change: PUT /api/dokumente/{id}/tags with updated tags array
    - Colors: predefined tags show their category color, custom tags get a default slate color

    **6. Update dokument-list.tsx:**
    Add a clickable link on each document row that navigates to `/akten/{akteId}/dokumente/{docId}`.
    Add OcrStatusBadge next to each document name in the list.
    Ensure the existing document list shows OCR status and links to detail page.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Navigate to /akten/{id}/dokumente/{docId} -- see split view with PDF on left, metadata on right, version timeline, actions bar, tags</manual>
  </verify>
  <done>
    - Document detail page renders at /akten/[id]/dokumente/[docId] with split view layout
    - PDF viewer on left shows document with full controls (navigation, zoom, thumbnails, search, text selection)
    - Right panel shows metadata, tags, actions bar, and version timeline
    - All actions work: rename, move, status change, download, delete, re-OCR, open in OnlyOffice
    - Tags can be added/removed with colored chips
    - Version timeline shows history with restore action
    - Document list links to detail page and shows OCR status badges
    - Non-PDF editable documents show "In OnlyOffice bearbeiten" button
  </done>
</task>

</tasks>

<verification>
1. `npm install` succeeds with react-pdf and pdfjs-dist
2. `npx tsc --noEmit` passes
3. Document detail page renders split view at `/akten/[id]/dokumente/[docId]`
4. PDF viewer renders PDFs with text selection enabled
5. Actions bar provides all required operations (rename, move, tag, status, download, delete, re-OCR, OnlyOffice)
6. Version timeline shows document versions
7. Tag manager shows colored tags with add/remove
</verification>

<success_criteria>
- User can navigate to a document detail page from the document list
- PDF documents render in-browser with page navigation, zoom, and text selection
- Non-PDF documents show generated PDF preview with "In OnlyOffice bearbeiten" button
- Document metadata is displayed comprehensively (all fields per user decision)
- Version history is visible as a vertical timeline with restore capability
- Tags can be managed with colored chips
- All document actions (rename, move, status change, download, delete, re-OCR) are functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-document-pipeline-ocr-rag-ingestion/04-02-SUMMARY.md`
</output>
