---
phase: 05-financial-module
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/finance/rvg/types.ts
  - src/lib/finance/rvg/fee-table.ts
  - src/lib/finance/rvg/gkg-table.ts
  - src/lib/finance/rvg/vv-catalog.ts
  - src/lib/finance/rvg/calculator.ts
  - src/lib/finance/rvg/anrechnung.ts
  - src/lib/finance/rvg/pkh.ts
  - src/lib/finance/rvg/presets.ts
  - src/lib/finance/rvg/__tests__/calculator.test.ts
autonomous: true
requirements:
  - REQ-FI-001
  - REQ-FI-002

must_haves:
  truths:
    - "RVG calculator correctly computes fees from Streitwert using KostBRaeG 2025 step algorithm"
    - "VV catalog contains all major fee positions (3100, 3104, 1000/1003, 7002, 7008, 1008, 2300, 3200, 3305/3307) with correct metadata"
    - "Anrechnung algorithm deducts half the Geschaeftsgebuehr rate (capped at 0.75) from Verfahrensgebuehr per Vorbem. 3 Abs. 4"
    - "GKG court fee table correctly looks up fees for all Streitwert ranges including above-500k formula"
    - "Fee tables are versioned with validity dates and correct table is selected by Auftragseingang date"
    - "50+ unit tests pass covering edge cases (zero Streitwert, boundary values, Anrechnung, GKG, PKH, Erhoehungsgebuehr)"
  artifacts:
    - path: "src/lib/finance/rvg/calculator.ts"
      provides: "Core RVG fee calculation engine"
      exports: ["computeRvgFee", "buildCalculation", "RvgCalculator"]
    - path: "src/lib/finance/rvg/fee-table.ts"
      provides: "Versioned RVG Anlage 2 fee table data with step algorithm"
      exports: ["computeBaseFee", "RVG_2025", "RVG_2021", "getTableForDate"]
    - path: "src/lib/finance/rvg/gkg-table.ts"
      provides: "GKG Anlage 2 court fee table data"
      exports: ["computeGkgFee", "GKG_2025"]
    - path: "src/lib/finance/rvg/vv-catalog.ts"
      provides: "VV Verguetungsverzeichnis positions catalog"
      exports: ["VV_CATALOG", "getVvPosition", "searchVvPositions"]
    - path: "src/lib/finance/rvg/anrechnung.ts"
      provides: "Anrechnung algorithm (Vorbem. 3 Abs. 4)"
      exports: ["calculateAnrechnung"]
    - path: "src/lib/finance/rvg/types.ts"
      provides: "TypeScript types for RVG domain"
      min_lines: 50
  key_links:
    - from: "src/lib/finance/rvg/calculator.ts"
      to: "src/lib/finance/rvg/fee-table.ts"
      via: "computeBaseFee lookup"
      pattern: "computeBaseFee\\(.*streitwert"
    - from: "src/lib/finance/rvg/calculator.ts"
      to: "src/lib/finance/rvg/anrechnung.ts"
      via: "Anrechnung detection and application"
      pattern: "calculateAnrechnung"
    - from: "src/lib/finance/rvg/calculator.ts"
      to: "src/lib/finance/rvg/vv-catalog.ts"
      via: "VV position lookup for fee type determination"
      pattern: "getVvPosition|VV_CATALOG"
---

<objective>
Build the RVG fee calculator as a pure-function library with versioned KostBRaeG 2025 fee tables, VV position catalog, Anrechnung algorithm, GKG court fees, PKH reduced tables, and comprehensive unit tests.

Purpose: This is the foundation of the entire financial module. Correct fee calculation is a legal liability risk (Haftungsrisiko #1) and must be verified against DAV Prozesskostenrechner test cases. Pure functions with no side effects enable thorough TDD.

Output: Complete RVG/GKG calculator library with 50+ passing unit tests, ready for UI integration and invoice pre-filling.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-module/05-RESEARCH.md
</context>

<feature>
  <name>RVG/GKG Fee Calculator Library</name>
  <files>
    src/lib/finance/rvg/types.ts
    src/lib/finance/rvg/fee-table.ts
    src/lib/finance/rvg/gkg-table.ts
    src/lib/finance/rvg/vv-catalog.ts
    src/lib/finance/rvg/calculator.ts
    src/lib/finance/rvg/anrechnung.ts
    src/lib/finance/rvg/pkh.ts
    src/lib/finance/rvg/presets.ts
    src/lib/finance/rvg/__tests__/calculator.test.ts
  </files>
  <behavior>
    ## RVG Fee Table (SS 13 RVG)

    The fee table uses a step algorithm, NOT a flat lookup:
    - Up to 500 EUR: base fee 51.50 EUR (KostBRaeG 2025)
    - 500-2000: +41.50 per 500 step
    - 2000-10000: +59.50 per 1000 step
    - 10000-25000: +55.00 per 3000 step
    - 25000-50000: +86.00 per 5000 step
    - 50000-200000: +99.50 per 15000 step
    - 200000-500000: +140.00 per 30000 step
    - Above 500000: +175.00 per 50000 step

    Round Streitwert up to next step boundary before computing.

    Also include RVG 2021 table for historical calculations (validUntil: 2025-05-31).
    Auto-select correct table by Auftragseingang date via getTableForDate().

    Test cases (Streitwert -> 1.0 base fee):
    - 500 -> 51.50
    - 1000 -> 93.00
    - 5000 -> 334.00
    - 10000 -> 631.00
    - 25000 -> 906.00
    - 50000 -> 1336.00
    - Verify against official table at rvg-rechner.de

    ## VV Position Catalog

    Every VV position has: nr (string), name (German), feeType (wertgebuehr|betragsrahmen|festgebuehr|auslagen), defaultRate, minRate, maxRate, part (1-7), category, triggersAnrechnung, anrechnungTarget, isAutoAddable.

    Required positions:
    - Part 1: 1000 (Einigungsgebuehr 1.5), 1003 (gerichtl. 1.0), 1008 (Erhoehungsgebuehr 0.3/max 2.0)
    - Part 2: 2300 (Geschaeftsgebuehr 1.3/0.5-2.5, triggersAnrechnung on 3100)
    - Part 3: 3100 (Verfahrensgebuehr 1.3), 3104 (Terminsgebuehr 1.2), 3200 (Berufung 1.6), 3202 (Berufung Termin 1.2), 3305/3307 (Mahnverfahren)
    - Part 7: 7002 (Auslagenpauschale 20% max 20 EUR), 7003 (Fahrtkosten 0.42/km), 7005 (Abwesenheitsgeld 30-80), 7008 (USt 19%)

    searchVvPositions(query): search by nr or keyword, return matching positions.
    getVvPosition(nr): exact lookup by VV number.

    ## Anrechnung (Vorbem. 3 Abs. 4 VV RVG)

    When Geschaeftsgebuehr (2300) AND Verfahrensgebuehr (3100) both present for SAME Gegenstand:
    1. Take Geschaeftsgebuehr rate (e.g., 1.3)
    2. Halve it: 1.3 / 2 = 0.65
    3. Cap at 0.75: min(0.65, 0.75) = 0.65
    4. Credit = capped rate * base fee
    5. Reduce Verfahrensgebuehr by credit amount

    Test cases:
    - Geschaeftsgebuehr 1.3, Verfahrensgebuehr 1.3, base 100 -> credit = 65, reduced VG = 65
    - Geschaeftsgebuehr 2.5, Verfahrensgebuehr 1.3, base 100 -> halved 1.25, capped 0.75, credit = 75, reduced VG = 55
    - User can override (disable Anrechnung)

    ## GKG Court Fees (Anlage 2 GKG)

    Direct lookup table for values up to 500k, formula above 500k.
    Fee is per "Gebuehr" unit, multiply by Gebuehrensatz (e.g., 3.0 for Verfahrensgebuehr).

    Test cases:
    - 5000 -> 170.50
    - 25000 -> 435.50
    - 50000 -> 638.00
    - 500000 -> 4138.00
    - 600000 -> 4138.00 + ceil(100000/50000) * 180.00 = 4498.00

    ## PKH Reduced Table (SS 49 RVG)

    Betragsrahmengebuehren for PKH cases. Cap extended to 80k by KostBRaeG 2025.
    Store as versioned data like the main table.
    For Streitwert above cap, use full RVG table.

    ## Calculator Engine

    Builder pattern per user decision:
    - start(streitwert, auftragseingang?) -> selects correct fee table version
    - addPosition(vvNr, options?) -> adds position with computed fee
    - options: { rate?, gegenstandswert?, anzahlAuftraggeber?, km?, tage? }
    - Auto-detect Anrechnung when both 2300 and 3100 are present
    - Auto-add VV 7002 (Auslagenpauschale) and VV 7008 (USt) unless disabled
    - Erhoehungsgebuehr (1008): 0.3 per additional Auftraggeber, max 2.0
    - getResult() -> itemized calculation result with all positions, amounts, Anrechnung notice, totals

    ## Presets

    Quick presets that pre-configure common position combinations:
    - "Typisches Klageverfahren 1. Instanz": 3100 + 3104 + 7002 + 7008
    - "Aussergerichtliche Vertretung": 2300 + 7002 + 7008
    - "Klageverfahren mit Einigung": 3100 + 3104 + 1003 + 7002 + 7008
    - "Berufung": 3200 + 3202 + 7002 + 7008
    - "Mahnverfahren": 3305 + 7002 + 7008

    Each preset has: id, name, description, vvPositions[].

    ## Streitwert-Vorschlaege

    Presets for common case types:
    - Kuendigungsschutz: 3 * Monatsgehalt
    - Mietstreit: 12 * Monatsmiete
    - Verkehrsunfall: Schadenshoehe
    - Schmerzensgeld: geschaetzte Summe

    ## Important Implementation Notes

    - ALL monetary calculations MUST use number type with Math.round() to nearest cent for display (the fee table itself uses exact decimal values from the law). For database persistence, Prisma Decimal will be used in Plan 02.
    - The calculator is a pure function library with NO database dependencies.
    - Export types for downstream consumers (invoice system, UI).
    - Rate versioning: RVG_2021 and RVG_2025 with getTableForDate() auto-selection.
    - Mehrvergleich: when Vergleichssumme provided and exceeds Streitwert, compute Einigungsgebuehr + adjusted Terminsgebuehr on the higher Gegenstandswert (Streitwert + Mehrvergleich).
    - Streitgenossenzuschlag (1008): 0.3 per additional Auftraggeber (above 1), max total increase 2.0.
  </behavior>
  <implementation>
    1. Create types.ts with all interfaces (FeeTableVersion, FeeTableStep, VVPosition, CalculationResult, etc.)
    2. Create fee-table.ts with RVG_2025 and RVG_2021 data, computeBaseFee(), getTableForDate()
    3. Create gkg-table.ts with GKG_2025 data, computeGkgFee()
    4. Create vv-catalog.ts with full VV position catalog, getVvPosition(), searchVvPositions()
    5. Create anrechnung.ts with calculateAnrechnung()
    6. Create pkh.ts with PKH_2025 reduced table data, computePkhFee()
    7. Create calculator.ts with RvgCalculator class (builder pattern)
    8. Create presets.ts with quick presets and Streitwert suggestions
    9. Create __tests__/calculator.test.ts with 50+ test cases

    Install vitest if not present: npm install -D vitest
    Configure vitest in package.json or vitest.config.ts if not already configured.
  </implementation>
</feature>

<verification>
- `npx vitest run src/lib/finance/rvg/__tests__/calculator.test.ts` passes with 50+ tests
- All fee computations match official RVG Anlage 2 table values for KostBRaeG 2025
- Anrechnung correctly applies half-credit with 0.75 cap
- GKG table correctly handles all ranges including above-500k formula
- TypeScript compilation: `npx tsc --noEmit` passes
</verification>

<success_criteria>
- 50+ unit tests pass covering: basic fee computation, boundary values, Anrechnung, GKG, PKH, Erhoehungsgebuehr, Auslagenpauschale, USt, presets, rate versioning
- RVG fee for Streitwert 5000 EUR at 1.3 rate = 434.20 EUR (334.00 * 1.3) with KostBRaeG 2025 table
- Anrechnung for Geschaeftsgebuehr 1.3 + Verfahrensgebuehr 1.3 at Streitwert 5000 correctly deducts 0.65 * 334.00 = 217.10 from Verfahrensgebuehr
- Calculator builder produces complete itemized result with all positions, Anrechnung notice, VV 7002, VV 7008, and Gesamtbetrag
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-module/05-01-SUMMARY.md`
</output>
