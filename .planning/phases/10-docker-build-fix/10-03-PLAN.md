---
phase: 10-docker-build-fix
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/embedding/vector-store.ts
autonomous: false
gap_closure: true
requirements:
  - BUILD-02

must_haves:
  truths:
    - "Raw SQL queries in vector-store.ts use correct PostgreSQL column names matching the Prisma migration"
    - "KI-Chat RAG similarity search does not throw 'column dc.dokument_id does not exist' error"
    - "Docker app image contains all latest code fixes (ki-chat Prisma relation fix + vector-store column fix)"
  artifacts:
    - path: "src/lib/embedding/vector-store.ts"
      provides: "pgvector CRUD with correct column names"
      contains: "dokumentId"
  key_links:
    - from: "src/lib/embedding/vector-store.ts"
      to: "document_chunks table"
      via: "raw SQL queries"
      pattern: 'dc\."dokumentId"'
---

<objective>
Fix vector-store.ts raw SQL column name mismatch and rebuild Docker app image to deploy all accumulated fixes.

Purpose: Close the last two gaps preventing KI-Chat (Helena) from working end-to-end in the Docker production environment. Bug 1 is a code fix (wrong column names in raw SQL), Bug 2 is an operational step (rebuild Docker image to include recent commits).

Output: Working vector-store.ts with correct column names, rebuilt Docker app image with all fixes deployed.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-docker-build-fix/.continue-here.md

<interfaces>
<!-- The document_chunks table uses camelCase column names (Prisma default without @map). -->
<!-- From prisma/migrations/20260225190818_init/migration.sql: -->

```sql
CREATE TABLE "document_chunks" (
    "id" TEXT NOT NULL,
    "dokumentId" TEXT NOT NULL,
    "chunkIndex" INTEGER NOT NULL,
    "content" TEXT NOT NULL,
    "embedding" vector(1024),
    "modelVersion" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "document_chunks_pkey" PRIMARY KEY ("id")
);
```

<!-- CRITICAL: The Prisma schema has NO @map annotations on DocumentChunk fields. -->
<!-- Prisma preserves camelCase field names as-is in PostgreSQL. -->
<!-- The raw SQL in vector-store.ts incorrectly uses snake_case (dokument_id, chunk_index, model_version). -->
<!-- Must change to quoted camelCase: "dokumentId", "chunkIndex", "modelVersion", "createdAt". -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix vector-store.ts raw SQL column names from snake_case to camelCase</name>
  <files>src/lib/embedding/vector-store.ts</files>
  <action>
The `document_chunks` table uses camelCase column names (Prisma default without `@map` annotations), but all raw SQL queries in vector-store.ts use snake_case. Fix every raw SQL query to use the correct quoted camelCase column names.

**Column name mapping (wrong -> correct):**
- `dokument_id` -> `"dokumentId"`
- `chunk_index` -> `"chunkIndex"`
- `model_version` -> `"modelVersion"`
- `created_at` -> `"createdAt"`

**Queries to fix (6 total):**

1. **insertChunks** (line ~27): The INSERT statement uses `dokument_id`, `chunk_index`, `model_version`, `created_at`. Change to quoted camelCase. Note: `id`, `content`, `embedding` are already lowercase and correct — leave them.

2. **deleteChunks** (line ~39): Uses `dokument_id` in WHERE clause. Change to `"dokumentId"`.

3. **searchSimilar - crossAkte with modelVersion** (lines ~108-125): Uses `dc.dokument_id`, `dc.chunk_index`, `dc.model_version`. Change all to quoted camelCase.

4. **searchSimilar - crossAkte without modelVersion** (lines ~129-146): Same fixes as above.

5. **searchSimilar - singleAkte with modelVersion** (lines ~153-171): Same fixes.

6. **searchSimilar - singleAkte without modelVersion** (lines ~174-190): Same fixes.

7. **getEmbeddingStats** (lines ~206-213): Uses `dokument_id` and `model_version` in three sub-queries. Change to `"dokumentId"` and `"modelVersion"`.

**Also fix the JOIN conditions:**
- `d.akte_id` -> `d."akteId"` (the `dokumente` table also uses camelCase from Prisma)
- `a.anwalt_id` -> `a."anwaltId"`
- `a.sachbearbeiter_id` -> `a."sachbearbeiterId"`

Wait — before changing JOIN columns, verify them first. Check the Prisma schema for the `Dokument` model's `akteId` field and `Akte` model's `anwaltId`/`sachbearbeiterId` fields to confirm they also lack `@map` annotations (meaning they are camelCase in DB). If they DO have `@map`, use the mapped name instead.

**Important:** When using camelCase column names in PostgreSQL, they MUST be double-quoted in SQL (e.g., `dc."dokumentId"`) because PostgreSQL lowercases unquoted identifiers.

**CRITICAL: Fix RawRow type and mapRow to match renamed column output (Approach B).**

When a bare column reference like `dc.dokument_id` is renamed to `dc."dokumentId"` in SELECT without an explicit `AS` alias, PostgreSQL returns the key as `dokumentId` (camelCase). The `RawRow` type and `mapRow` function currently use snake_case for these two fields. You MUST update them:

1. **RawRow type (lines ~84-92):** Change `dokument_id: string` to `dokumentId: string` and `chunk_index: number` to `chunkIndex: number`. The other fields (`dokument_name`, `akte_aktenzeichen`, `akte_beschreibung`, `score`, `content`) have explicit `AS` aliases in the SELECT and are fine as-is.

2. **mapRow function (lines ~94-102):** Change `r.dokument_id` to `r.dokumentId` and `r.chunk_index` to `r.chunkIndex`.

3. **getEmbeddingStats (lines ~211-219):** The `SELECT DISTINCT model_version` becomes `SELECT DISTINCT "modelVersion"`, which returns key `modelVersion`. Update the type annotation from `{ model_version: string }[]` to `{ modelVersion: string }[]` and the map from `r.model_version` to `r.modelVersion`.

**SELECT aliases that already use `AS` (like `d.name AS dokument_name`) remain unchanged** — the alias controls the output key, not the column name. Only bare column references without `AS` are affected by the rename.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit src/lib/embedding/vector-store.ts 2>&1 | head -20 && echo "---TSC DONE---" && grep -n 'dokument_id\|chunk_index\|model_version\|created_at\|akte_id\|anwalt_id\|sachbearbeiter_id' src/lib/embedding/vector-store.ts && echo "SNAKE_CASE FOUND - FIX INCOMPLETE" || echo "OK - no snake_case column refs remain"</automated>
  </verify>
  <done>All 6+ raw SQL queries in vector-store.ts use correct quoted camelCase column names matching the actual PostgreSQL schema. RawRow type and mapRow updated to match the camelCase keys returned by renamed bare column references. No more "column dc.dokument_id does not exist" errors.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Rebuild Docker app image and verify KI-Chat works</name>
  <files>docker-compose.yml</files>
  <action>
Rebuild the Docker app image to deploy all accumulated fixes (vector-store column names, ki-chat Prisma relation, NaN tokenCount):

```bash
docker compose build app && docker compose up -d app
```

Wait for the app container to reach healthy state, then verify KI-Chat works end-to-end.
  </action>
  <what-built>Fixed vector-store.ts column names and all previous fixes (ki-chat Prisma relation, NaN tokenCount). Docker image rebuilt to deploy.</what-built>
  <how-to-verify>
    1. Run: `docker compose build app && docker compose up -d app`
    2. Wait for app to be healthy: `docker compose ps` (app should show "healthy")
    3. Open http://localhost:3000 and log in
    4. Navigate to KI-Chat (Helena)
    5. Send a test message (e.g., "Hallo Helena")
    6. Verify: Response appears (may take 30-60s on CPU-only Ollama — this is expected)
    7. Check logs for no errors: `docker logs ailawyer-app 2>&1 | grep -i "error\|failed" | tail -20`
    8. If chat message gets a response: Phase 10 is fully complete
  </how-to-verify>
  <verify>
    <automated>docker compose ps --format json | grep -c '"healthy"'</automated>
  </verify>
  <done>Docker app image rebuilt with all fixes, KI-Chat responds to messages, no database column errors in logs.</done>
  <resume-signal>Type "approved" if KI-Chat responds, or describe any errors you see</resume-signal>
</task>

</tasks>

<verification>
1. `grep -n 'dokument_id\|chunk_index\|model_version\|created_at\|akte_id\|anwalt_id\|sachbearbeiter_id' src/lib/embedding/vector-store.ts` returns NO matches (all snake_case column references eliminated)
2. `grep -c 'dokumentId\|chunkIndex\|modelVersion\|createdAt' src/lib/embedding/vector-store.ts` shows multiple matches (camelCase used throughout)
3. Docker app image rebuilt and running with latest code
4. KI-Chat sends and receives messages without database errors
</verification>

<success_criteria>
- vector-store.ts raw SQL uses correct camelCase column names matching PostgreSQL schema
- No "column does not exist" errors when KI-Chat performs RAG search
- Docker app image contains all Phase 10 fixes (build fix, Prisma relation fix, vector-store fix)
- All 9 Docker services healthy
- KI-Chat (Helena) responds to user messages end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/10-docker-build-fix/10-03-SUMMARY.md`
</output>
