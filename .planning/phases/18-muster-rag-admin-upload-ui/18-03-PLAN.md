---
phase: 18-muster-rag-admin-upload-ui
plan: "03"
type: execute
wave: 3
depends_on: ["18-01", "18-02"]
files_modified:
  - src/app/api/ki-chat/route.ts
autonomous: true
requirements: [ARBW-05]

must_haves:
  truths:
    - "Helena retrieves top-5 muster_chunks in parallel with Chain D and Chain E — no extra latency added (all three run concurrently)"
    - "When muster_chunks returns results, a MUSTER-QUELLEN block appears in Helena's system prompt with Muster name, herkunft (Kanzlei-Muster / Amtliches Formular), and parentContent"
    - "Helena's Schriftsatz-Entwurf output contains RUBRUM / ANTRÄGE / BEGRÜNDUNG structure with explicit {{PLATZHALTER}}"
    - "Chain F failure is non-fatal — catch returns [] and Helena responds without Muster context"
    - "MUSTER-QUELLEN injection includes closing instruction: ENTWURF marker + all missing data as {{PLATZHALTER}}"
  artifacts:
    - path: "src/app/api/ki-chat/route.ts"
      provides: "Chain F musterChunksPromise + MUSTER-QUELLEN system prompt injection"
      contains: "musterChunksPromise"
  key_links:
    - from: "src/app/api/ki-chat/route.ts:Chain F"
      to: "searchMusterChunks(queryEmbedding, { limit: 5, minScore: 0.55 })"
      via: "queryEmbeddingPromise shared with Chain D and Chain E (single Ollama call)"
      pattern: "searchMusterChunks"
    - from: "src/app/api/ki-chat/route.ts:MUSTER-QUELLEN block"
      to: "system prompt string"
      via: "conditional injection after URTEILE-QUELLEN block"
      pattern: "MUSTER-QUELLEN"
---

<objective>
Wire ki-chat Chain F: searchMusterChunks() parallel retrieval from muster_chunks with MUSTER-QUELLEN system prompt injection, mirror the existing Chain D/E pattern exactly.

Purpose: This is the final plan completing Phase 18. It makes Helena aware of kanzlei-eigene Schriftsatzmuster and amtliche Formulare for structurally correct Schriftsatz-Entwurf generation.

Output: src/app/api/ki-chat/route.ts — Chain F + 6th Promise.all element + MUSTER-QUELLEN injection block
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-RESEARCH.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-01-SUMMARY.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/app/api/ki-chat/route.ts (CURRENT STATE after Phase 17 — lines to understand):

Chain E (template to mirror for Chain F):
```typescript
// Chain E: urteil_chunks retrieval (Urteile-RAG)
// Chain E comment line ~492
const urteilChunksPromise = skipRag
  ? Promise.resolve([] as UrteilChunkResult[])
  : (async (): Promise<UrteilChunkResult[]> => {
      const tE = Date.now();
      try {
        const queryEmbedding = await queryEmbeddingPromise;
        if (!queryEmbedding) return [];
        const results = await searchUrteilChunks(queryEmbedding, { limit: 5, minScore: 0.6 });
        console.log(`[ki-chat] Chain E (urteil_chunks) took ${Date.now() - tE}ms, ${results.length} results`);
        return results;
      } catch (err) {
        console.error("[ki-chat] Urteil chunks search failed:", err);
        return [];
      }
    })();
```

Promise.all CURRENT (5 elements — must be extended to 6):
```typescript
const [{ aktenKontextBlock, pinnedNormenBlock }, ragResult, [model, modelName, providerName], lawChunks, urteilChunks] =
  await Promise.all([akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise, urteilChunksPromise]);
```

URTEILE-QUELLEN injection block (Chain F goes AFTER this):
```typescript
// Inject Urteile-Quellen block (Chain E results) — only when urteil_chunks found with score >= 0.6
if (urteilChunks.length > 0) {
  systemPrompt += "\n\n--- URTEILE-QUELLEN ---\n";
  urteilChunks.forEach((u, i) => {
    systemPrompt += `\n[U${i + 1}] ${u.gericht} ${u.aktenzeichen} vom ${u.datum.toLocaleDateString("de-DE")}\n`;
    systemPrompt += `${u.content}\n`;
    systemPrompt += `Quelle: ${u.sourceUrl}\n`;
  });
  systemPrompt += "\n--- ENDE URTEILE-QUELLEN ---";
  systemPrompt += "\n\nWenn du ein Urteil zitierst, verwende NUR die AZ aus diesen URTEILE-QUELLEN. Erfinde kein AZ. Wenn kein AZ in den Quellen steht, zitiere das Urteil NICHT.";
}
```

From src/lib/muster/ingestion.ts (Plan 01 output):
```typescript
export interface MusterChunkResult {
  id: string;
  musterId: string;
  content: string;
  parentContent: string | null;
  musterName: string;
  kategorie: string;
  kanzleiEigen: boolean;
  score: number;
}
export async function searchMusterChunks(
  queryEmbedding: number[],
  opts?: { limit?: number; minScore?: number }
): Promise<MusterChunkResult[]>
```

Key decisions from STATE.md (Phase 17):
- queryEmbeddingPromise is SHARED between Chain B, D, and E — single Ollama call. Chain F MUST also share it (do not call generateQueryEmbedding again).
- minScore for muster_chunks: 0.55 (lower than 0.6 for law/urteil — template content has lower embedding signal due to {{PLATZHALTER}} density).
- Chain F is non-fatal — catch returns [] like Chain E.
- MUSTER-QUELLEN injection goes AFTER URTEILE-QUELLEN injection.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Chain F and MUSTER-QUELLEN injection to ki-chat route</name>
  <files>src/app/api/ki-chat/route.ts</files>
  <action>
Make exactly 5 targeted insertions to src/app/api/ki-chat/route.ts. Do NOT rewrite the file. Read it first, then make surgical edits.

**Insertion 1 — Import (at the top, with other lib/muster imports):**
```typescript
import { searchMusterChunks, type MusterChunkResult } from "@/lib/muster/ingestion";
```
Add after the `import { searchUrteilChunks, type UrteilChunkResult }` import line.

**Insertion 2 — Chain F comment block (before the Promise.all):**
Add a comment block mirroring the Chain E comment:
```typescript
// Chain F: muster_chunks retrieval (Muster-RAG, ARBW-05)
// Schriftsatzmuster für strukturierte Entwürfe (kanzlei-eigene + amtliche Formulare)
```

**Insertion 3 — Chain F promise definition (immediately after Chain E promise, before Promise.all):**
```typescript
const musterChunksPromise = skipRag
  ? Promise.resolve([] as MusterChunkResult[])
  : (async (): Promise<MusterChunkResult[]> => {
      const tF = Date.now();
      try {
        const queryEmbedding = await queryEmbeddingPromise;
        if (!queryEmbedding) return [];
        const results = await searchMusterChunks(queryEmbedding, { limit: 5, minScore: 0.55 });
        console.log(`[ki-chat] Chain F (muster_chunks) took ${Date.now() - tF}ms, ${results.length} results`);
        return results;
      } catch (err) {
        console.error("[ki-chat] Muster chunks search failed:", err);
        return [];
      }
    })();
```

NOTE: minScore is 0.55 (NOT 0.6 like law/urteil) — template text with {{PLATZHALTER}} has lower embedding signal.

**Insertion 4 — Extend Promise.all to include Chain F (6th element):**
Replace the current 5-element destructuring:
```typescript
const [{ aktenKontextBlock, pinnedNormenBlock }, ragResult, [model, modelName, providerName], lawChunks, urteilChunks] =
  await Promise.all([akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise, urteilChunksPromise]);
```
With:
```typescript
const [{ aktenKontextBlock, pinnedNormenBlock }, ragResult, [model, modelName, providerName], lawChunks, urteilChunks, musterChunks] =
  await Promise.all([akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise, urteilChunksPromise, musterChunksPromise]);
```

CRITICAL: Both the destructuring array and the Promise.all array must be updated atomically. TypeScript will catch a length mismatch at compile time.

**Insertion 5 — MUSTER-QUELLEN system prompt injection (after the URTEILE-QUELLEN injection block):**
```typescript
// Inject Muster-Quellen block (Chain F results) — Schriftsatz-RAG (ARBW-05)
if (musterChunks.length > 0) {
  systemPrompt += "\n\n--- MUSTER-QUELLEN ---\n";
  systemPrompt += "Nutze diese Schriftsatzmuster als Strukturvorlage. Übernimm den Aufbau (Rubrum, Anträge, Begründung) und fülle alle {{PLATZHALTER}} mit den Akte-Daten — oder behalte sie als explizite Platzhalter wenn Daten fehlen.\n";
  musterChunks.forEach((m, i) => {
    const herkunft = m.kanzleiEigen ? "Kanzlei-Muster" : "Amtliches Formular";
    systemPrompt += `\n[M${i + 1}] ${m.musterName} (${herkunft}, Kategorie: ${m.kategorie})\n`;
    systemPrompt += `${m.parentContent ?? m.content}\n`;
  });
  systemPrompt += "\n--- ENDE MUSTER-QUELLEN ---";
  systemPrompt += "\n\nWenn du einen Schriftsatz-Entwurf erstellst: Beginne mit RUBRUM (Kläger, Beklagte, Gericht), dann ANTRÄGE (nummeriert), dann BEGRÜNDUNG (I., II., ...). Alle fehlenden Angaben als {{PLATZHALTER}}. Schließe ab mit: '\u26a0\ufe0f ENTWURF — Platzhalter prüfen und vor Einreichung ausfüllen.'";
}
```

After making all 5 insertions, run `npx tsc --noEmit` to verify TypeScript is clean.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -20 && grep "searchMusterChunks" src/app/api/ki-chat/route.ts && grep "musterChunks" src/app/api/ki-chat/route.ts | wc -l</automated>
  </verify>
  <done>`grep "searchMusterChunks" route.ts` finds import (line ~29) + usage (Chain F promise); `grep "musterChunks" route.ts` returns at least 6 lines (promise def, Promise.all, injection block); `grep "MUSTER-QUELLEN" route.ts` finds block header + ENDE; `npx tsc --noEmit` exits 0</done>
</task>

</tasks>

<verification>
- `grep "import.*searchMusterChunks" src/app/api/ki-chat/route.ts` — import present
- `grep "musterChunksPromise" src/app/api/ki-chat/route.ts` — Chain F promise defined
- `grep "minScore: 0.55" src/app/api/ki-chat/route.ts` — correct threshold (NOT 0.6)
- `grep "MUSTER-QUELLEN" src/app/api/ki-chat/route.ts` — injection block present
- `grep "ENDE MUSTER-QUELLEN" src/app/api/ki-chat/route.ts` — closing tag present
- `grep "ENTWURF.*Platzhalter" src/app/api/ki-chat/route.ts` — closing ENTWURF instruction present
- `grep "Promise.all" src/app/api/ki-chat/route.ts | grep "musterChunksPromise"` — Promise.all has 6th element
- `npx tsc --noEmit` — exits 0
</verification>

<success_criteria>
- Chain F is defined as musterChunksPromise — mirrors Chain E exactly (skipRag guard, async IIFE, non-fatal catch returning [])
- queryEmbeddingPromise is SHARED (no second generateQueryEmbedding call for muster)
- minScore is 0.55 (not 0.6) for wider muster template retrieval
- Promise.all has 6 elements: akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise, urteilChunksPromise, musterChunksPromise
- MUSTER-QUELLEN block injected after URTEILE-QUELLEN — includes herkunft (Kanzlei-Muster vs. Amtliches Formular), parentContent fallback to content, closing ENTWURF instruction
- TypeScript clean (tsc --noEmit exits 0)
- Phase 18 complete: all 5 requirements (ARBW-01 through ARBW-05) addressed across 3 plans
</success_criteria>

<output>
After completion, create `.planning/phases/18-muster-rag-admin-upload-ui/18-03-SUMMARY.md`
</output>
