---
phase: 06-ai-features-bea
plan: 04
type: execute
wave: 3
depends_on:
  - "06-03"
files_modified:
  - prisma/schema.prisma
  - src/lib/bea/client.ts
  - src/lib/bea/session.ts
  - src/lib/bea/auto-assign.ts
  - src/lib/xjustiz/parser.ts
  - src/app/(dashboard)/bea/page.tsx
  - src/app/(dashboard)/bea/[id]/page.tsx
  - src/app/(dashboard)/bea/compose/page.tsx
  - src/app/api/bea/messages/route.ts
  - src/app/api/bea/messages/[id]/route.ts
  - src/app/api/bea/messages/[id]/eeb/route.ts
  - src/app/api/bea/auto-assign/route.ts
  - src/components/bea/bea-inbox.tsx
  - src/components/bea/bea-message-detail.tsx
  - src/components/bea/bea-compose.tsx
  - src/components/bea/xjustiz-viewer.tsx
  - src/components/bea/pruefprotokoll-viewer.tsx
  - src/components/bea/eeb-button.tsx
autonomous: false
requirements:
  - REQ-BA-001
  - REQ-BA-002
  - REQ-BA-003
  - REQ-BA-004
  - REQ-BA-005
  - REQ-BA-006

user_setup:
  - service: bea.expert
    why: "beA electronic legal messaging integration"
    env_vars:
      - name: BEA_API_URL
        source: "bea.expert account — API endpoint provided after registration"
    dashboard_config:
      - task: "Register for bea.expert account"
        location: "https://bea.expert — registration requires active beA SAFE-ID"
      - task: "Obtain software token"
        location: "beA BRAK portal — each lawyer needs their own software token"

must_haves:
  truths:
    - "User can authenticate with beA via software token in the browser"
    - "User can view beA inbox with received messages and their status"
    - "User can send beA messages with document attachments (ANWALT role only)"
    - "User can acknowledge receipt (eEB) with one click on incoming Zustellungen"
    - "User can view Pruefprotokoll for any beA message"
    - "Safe-IDs are managed on Kontakt records and auto-pulled when composing"
    - "XJustiz attachments are parsed and rendered as structured readable views"
    - "beA messages are auto-assigned to Akten via Aktenzeichen/Gerichtsbezug matching"
    - "Helena scans stored beA messages for deadlines and parties"
  artifacts:
    - path: "src/lib/bea/client.ts"
      provides: "bea.expert API wrapper for browser-side calls"
      exports: ["beaClient"]
    - path: "src/lib/xjustiz/parser.ts"
      provides: "XJustiz XML parser extracting Grunddaten, Beteiligte, Instanzen, Termine"
      exports: ["parseXJustiz"]
    - path: "src/app/(dashboard)/bea/page.tsx"
      provides: "beA inbox/outbox page replacing stub"
    - path: "src/components/bea/bea-compose.tsx"
      provides: "beA message compose form with SAFE-ID lookup"
    - path: "src/components/bea/xjustiz-viewer.tsx"
      provides: "Structured viewer for parsed XJustiz data"
  key_links:
    - from: "src/components/bea/bea-inbox.tsx"
      to: "src/lib/bea/client.ts"
      via: "browser-side API calls with session keys"
      pattern: "beaClient\\."
    - from: "src/app/api/bea/messages/route.ts"
      to: "prisma.beaNachricht"
      via: "persist fetched messages to database"
      pattern: "prisma\\.beaNachricht\\.create"
    - from: "src/app/api/bea/messages/route.ts"
      to: "ai-scan queue"
      via: "trigger Helena scan after message stored"
      pattern: "aiScanQueue\\.add"
---

<objective>
Build the beA (besonderes elektronisches Anwaltspostfach) integration: browser-side authentication via bea.expert JS library, inbox/outbox with message list and detail views, message sending with SAFE-ID lookup and document attachments, one-click eEB acknowledgment, Pruefprotokoll viewer, XJustiz XML parser with structured inline viewer, auto-assignment to Akten, and Helena scan integration.

Purpose: Attorneys can send and receive legally required electronic court messages directly within the application, with automated case assignment and AI scanning.
Output: Full beA section in sidebar with inbox, outbox, compose, eEB, Pruefprotokoll, XJustiz viewer, and Helena integration.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md
@.planning/phases/06-ai-features-bea/06-01-SUMMARY.md
@.planning/phases/06-ai-features-bea/06-03-SUMMARY.md

# Existing beA stub and model
@src/app/(dashboard)/bea/page.tsx
@prisma/schema.prisma

# Helena scan integration
@src/lib/ai/scan-processor.ts

# Versand gate for send restrictions
@src/lib/versand-gate.ts

# Kontakt model with beaSafeId
@src/app/api/kontakte/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema Changes + bea.expert Client + XJustiz Parser + Auto-Assignment Logic</name>
  <files>
    prisma/schema.prisma
    src/lib/bea/client.ts
    src/lib/bea/session.ts
    src/lib/bea/auto-assign.ts
    src/lib/xjustiz/parser.ts
  </files>
  <action>
1. Update `prisma/schema.prisma` BeaNachricht model — add fields:
   - `eebStatus String?` // AUSSTEHEND | BESTAETIGT | NICHT_ERFORDERLICH
   - `eebDatum DateTime?`
   - `xjustizData Json?` // Parsed XJustiz content for quick rendering
   - `safeIdAbsender String?`
   - `safeIdEmpfaenger String?`
   Run `npx prisma db push`.

2. Install `fast-xml-parser`: `npm install fast-xml-parser`.

3. Create `src/lib/bea/client.ts` ("use client" — browser-only module):
   - beA client wrapper that encapsulates bea.expert REST API calls.
   - Since bea.expert requires browser-side authentication (crypto operations with software token), this module runs ONLY in the browser.
   - Functions (all return Promises, all require sessionKeys from login):
     a) `beaLogin(softwareToken: File, pin: string)`: Initiates browser-side login. Uses bea.expert JS library for token processing and session key derivation. Returns session context.
     b) `beaGetPostboxes(session)`: Call PostboxOverview. Returns [{safeId, name, type}].
     c) `beaGetFolders(session, safeId)`: Call FolderOverview. Returns folder tree.
     d) `beaGetMessages(session, safeId, folderId)`: Paginated message list.
     e) `beaGetMessage(session, messageId)`: Full message with decrypted content.
     f) `beaSendMessage(session, {recipientSafeId, subject, body, attachments[]})`: Send message.
     g) `beaSendEeb(session, messageId, date)`: Acknowledge receipt via eEBanswer.
     h) `beaGetPruefprotokoll(session, messageId)`: Get verification protocol.
   - Error handling: Wrap each call in try-catch, return structured errors. Handle session expiry gracefully.
   - Note: Since bea.expert JS library may need to be loaded from CDN or bundled, use dynamic import pattern. If library unavailable, show "beA-Bibliothek konnte nicht geladen werden" error.

4. Create `src/lib/bea/session.ts` ("use client"):
   - React context for beA session state.
   - `BeaSessionProvider`: Manages session keys in memory (NOT localStorage — security sensitive).
   - `useBeaSession()`: Hook returning {isAuthenticated, session, login, logout, error}.
   - Session timeout: auto-logout after 30 minutes of inactivity.
   - Login state persists only in memory — refreshing the page requires re-authentication.

5. Create `src/lib/bea/auto-assign.ts` (server-side):
   - `autoAssignToAkte(nachricht: {betreff, absender, inhalt, safeIdAbsender})`: Attempts to match a beA message to an Akte.
   - Matching strategies (in priority order):
     a) Aktenzeichen regex in betreff or inhalt: Match known Aktenzeichen patterns from existing Akten.
     b) SAFE-ID match: Look up safeIdAbsender in Kontakt.beaSafeId, find Akten where that Kontakt is a Beteiligter.
     c) Court reference matching: Extract Gerichtsaktenzeichen from betreff, match against Akte.gerichtsAktenzeichen.
   - Returns: {akteId: string | null, confidence: 'SICHER' | 'WAHRSCHEINLICH' | 'UNSICHER', reason: string}.
   - If confidence is SICHER, auto-assign. If WAHRSCHEINLICH, suggest with confirmation. If UNSICHER, leave unassigned.

6. Create `src/lib/xjustiz/parser.ts`:
   - `parseXJustiz(xmlString: string)`: Parse XJustiz XML using fast-xml-parser with namespace awareness.
   - Configure parser: `{ ignoreAttributes: false, attributeNamePrefix: "@_", removeNSPrefix: true }`.
   - Extract and return typed object:
     ```typescript
     interface XJustizData {
       version: string; // Detected XJustiz version
       grunddaten?: {
         aktenzeichen?: string;
         verfahrensgegenstand?: string;
         gericht?: string;
         eingangsdatum?: string;
       };
       beteiligte: Array<{
         name: string;
         rolle: string;
         anschrift?: string;
         safeId?: string;
       }>;
       instanzen: Array<{
         gericht: string;
         aktenzeichen: string;
         beginn?: string;
         ende?: string;
       }>;
       termine: Array<{
         art: string;
         datum: string;
         ort?: string;
         bemerkung?: string;
       }>;
     }
     ```
   - Handle XJustiz versions 3.4.1 through 3.5.1. Use flexible parsing that doesn't break on unknown elements.
   - Return raw data structure — rendering handled by viewer component.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Verify BeaNachricht schema changes applied. Check XJustiz parser handles sample XML input.</manual>
  </verify>
  <done>BeaNachricht model extended with eEB and XJustiz fields. bea.expert client wrapper handles all API calls with browser-side session management. XJustiz parser extracts Grunddaten, Beteiligte, Instanzen, Termine from XML. Auto-assignment logic matches beA messages to Akten via Aktenzeichen, SAFE-ID, and court reference.</done>
</task>

<task type="auto">
  <name>Task 2: beA Inbox/Outbox UI + Message Detail + Compose + eEB + Pruefprotokoll + XJustiz Viewer</name>
  <files>
    src/app/(dashboard)/bea/page.tsx
    src/app/(dashboard)/bea/[id]/page.tsx
    src/app/(dashboard)/bea/compose/page.tsx
    src/app/api/bea/messages/route.ts
    src/app/api/bea/messages/[id]/route.ts
    src/app/api/bea/messages/[id]/eeb/route.ts
    src/app/api/bea/auto-assign/route.ts
    src/components/bea/bea-inbox.tsx
    src/components/bea/bea-message-detail.tsx
    src/components/bea/bea-compose.tsx
    src/components/bea/xjustiz-viewer.tsx
    src/components/bea/pruefprotokoll-viewer.tsx
    src/components/bea/eeb-button.tsx
  </files>
  <action>
1. Create `GET/POST /api/bea/messages/route.ts`:
   - GET: List BeaNachricht from database. Filter by status (EINGANG/GESENDET), akteId, search term. Paginated. Includes akte relation.
   - POST: Store a new beA message fetched from bea.expert into database. Body: full message data from client.
     - Run auto-assign: call autoAssignToAkte(). If SICHER, set akteId. If WAHRSCHEINLICH, set akteId but add flag for confirmation.
     - If XJustiz attachment detected (MIME type or filename pattern), parse via parseXJustiz() and store in xjustizData field.
     - Trigger Helena ai-scan: add to ai-scan queue with type='bea'.
   - Auth check on all operations.

2. Create `GET/PATCH /api/bea/messages/[id]/route.ts`:
   - GET: Return single BeaNachricht with full content. Auth check.
   - PATCH: Update akteId (manual assignment), status (GELESEN, ZUGEORDNET), eebStatus.

3. Create `POST /api/bea/messages/[id]/eeb/route.ts`:
   - Auth check: session.user.role must be ANWALT (per CONTEXT: "nur Anwalt").
   - Calls bea.expert eEBanswer via browser (this route validates and records — actual eEB call happens client-side).
   - Updates BeaNachricht: eebStatus='BESTAETIGT', eebDatum=now().
   - Returns success with timestamp.

4. Create `POST /api/bea/auto-assign/route.ts`:
   - Manually trigger auto-assignment for a message.
   - Body: {nachrichtId}.
   - Calls autoAssignToAkte(), updates BeaNachricht.akteId.
   - Returns assignment result with confidence.

5. Replace `src/app/(dashboard)/bea/page.tsx` (currently a stub):
   - Wrap with BeaSessionProvider.
   - If not authenticated: Show beA login dialog with software token file input + PIN field + "Anmelden" button.
   - If authenticated: Show BeaInbox component with tabs (Posteingang | Postausgang).
   - "Neue Nachricht" button (only visible to ANWALT role).
   - Session status indicator: "Verbunden als {safeId}" or "Sitzung abgelaufen".

6. Create `src/components/bea/bea-inbox.tsx` ("use client"):
   - Two data sources: Fresh messages from bea.expert API (via beaGetMessages), and stored messages from GET /api/bea/messages.
   - Sync flow: On page load, fetch from bea.expert, diff against stored, POST new ones to /api/bea/messages.
   - Message list table: Status icon, Betreff, Absender/Empfaenger, Akte badge (if assigned, otherwise "Nicht zugeordnet" warning), Datum.
   - Click to navigate to /bea/[id].
   - Status indicators: EINGANG (blue), GELESEN (gray), ZUGEORDNET (green), GESENDET (purple), FEHLER (red).
   - "Zuordnen" quick-action button for unassigned messages (opens Akte selector dialog).

7. Create `src/app/(dashboard)/bea/[id]/page.tsx` + `src/components/bea/bea-message-detail.tsx`:
   - Server component fetching BeaNachricht from database.
   - Detail view: Header (Absender, Empfaenger with SAFE-IDs, Datum, Betreff), Body content, Attachments list.
   - Akte assignment section: Current Akte or "Nicht zugeordnet" with assign button.
   - eEB section: If incoming Zustellung, show EebButton component.
   - Pruefprotokoll button: "Pruefprotokoll anzeigen" -> fetches and shows PruefprotokollViewer.
   - XJustiz viewer: If xjustizData exists on the message, render XJustizViewer inline.
   - Helena suggestions: If Helena has suggestions for this message (FRIST_ERKANNT etc.), show them as inline cards.

8. Create `src/components/bea/eeb-button.tsx` ("use client"):
   - "Empfangsbekenntnis bestaetigen" button. Only shown for incoming Zustellungen where eebStatus != 'BESTAETIGT'.
   - On click: Calls beaSendEeb() via bea.expert client (browser-side), then POST /api/bea/messages/[id]/eeb to record.
   - Loading state during processing. Success: Green check + date. Error: Toast with error message.
   - RBAC: Only rendered if user.role === 'ANWALT'.

9. Create `src/components/bea/pruefprotokoll-viewer.tsx`:
   - Receives pruefprotokoll Json data.
   - Renders as structured table: Pruefschritt, Ergebnis (success/fail icon), Details, Zeitstempel.
   - Collapsible by default — "Pruefprotokoll anzeigen" button expands.

10. Create `src/components/bea/xjustiz-viewer.tsx`:
    - Receives parsed XJustizData object.
    - Renders sections: Grunddaten (key-value table), Beteiligte (list with roles and addresses), Instanzen (timeline), Termine (list with dates).
    - Collapsible sections. German labels.
    - Handle missing data gracefully — only show sections that have data.

11. Create `src/app/(dashboard)/bea/compose/page.tsx` + `src/components/bea/bea-compose.tsx`:
    - RBAC: Only ANWALT can access. Redirect others with error.
    - Form fields: Empfaenger (SAFE-ID input with autocomplete from Kontakte where beaSafeId is set), Betreff, Inhalt (textarea), Akte selector (optional, for reference).
    - Document attachments: Picker from DMS. Only FREIGEGEBEN documents allowed (enforce via versand-gate pattern).
    - "Senden" button: Calls beaSendMessage() via browser client, then stores sent message in DB via POST /api/bea/messages.
    - No Freigabe-Workflow for beA (per CONTEXT: "Direkt senden, nur Anwalt").
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Navigate to /bea -- login dialog appears. After login (with test token if available), inbox shows messages. Message detail shows eEB button and Pruefprotokoll. XJustiz content renders as structured view.</manual>
  </verify>
  <done>beA section fully functional: browser-side authentication with software token, inbox/outbox with message list and status indicators, message detail with content and attachments, eEB one-click acknowledgment (ANWALT only), Pruefprotokoll viewer, XJustiz inline viewer, auto-assignment to Akten, compose form with SAFE-ID lookup and document attachments, Helena scan integration for stored messages.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify beA Integration End-to-End</name>
  <files>src/app/(dashboard)/bea/page.tsx</files>
  <action>
Human verification checkpoint for the complete beA integration: authentication, inbox, message detail, compose, eEB, Pruefprotokoll, XJustiz viewer, auto-assignment, Helena scan. This checkpoint verifies the browser-side authentication flow works with the bea.expert library.

Steps to verify:
1. Navigate to /bea — login dialog should appear with software token upload and PIN input
2. If bea.expert test account available: Upload software token, enter PIN, verify "Verbunden als {safeId}" appears
3. If no test account: Verify the login UI renders correctly, error handling works for invalid credentials
4. Navigate to /bea message detail — verify eEB button, Pruefprotokoll button, XJustiz viewer render
5. Navigate to /bea/compose — verify SAFE-ID autocomplete from Kontakte, document attachment picker
6. Verify non-ANWALT users cannot access compose or send eEB (RBAC check)

Resume signal: Type "approved" or describe issues to fix.
  </action>
  <verify>Manual visual inspection of /bea page, message detail, compose form, and RBAC enforcement</verify>
  <done>beA integration verified end-to-end: login dialog, inbox rendering, message detail with eEB/Pruefprotokoll/XJustiz, compose with SAFE-ID, RBAC enforcement confirmed.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. BeaNachricht model has eebStatus, eebDatum, xjustizData, safeIdAbsender, safeIdEmpfaenger fields
3. /bea page renders login dialog, then inbox after authentication
4. Messages are auto-assigned to Akten with confidence levels
5. eEB button sends acknowledgment and records timestamp
6. Pruefprotokoll renders as structured table
7. XJustiz XML parsed and displayed as readable sections
8. Compose form enforces ANWALT RBAC and FREIGEGEBEN document requirement
9. Helena scans stored beA messages (trigger visible in ai-scan queue)
</verification>

<success_criteria>
- beA authentication works in browser via software token
- Inbox displays received messages with status indicators
- Messages auto-assigned to correct Akten (via Aktenzeichen, SAFE-ID, court reference)
- eEB acknowledgment is one-click for ANWALT users
- Pruefprotokoll is viewable on demand per message
- XJustiz attachments render as structured, readable views
- beA messages trigger Helena AI scanning
- Compose form uses SAFE-ID from Kontakte and only allows FREIGEGEBEN documents
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-04-SUMMARY.md`
</output>
