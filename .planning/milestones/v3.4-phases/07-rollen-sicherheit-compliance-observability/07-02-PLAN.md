---
phase: 07-rollen-sicherheit-compliance-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/audit-trail/route.ts
  - src/app/api/admin/audit-trail/export/route.ts
  - src/app/(dashboard)/admin/audit-trail/page.tsx
  - src/components/audit/audit-timeline.tsx
  - src/components/audit/audit-export-dialog.tsx
  - src/components/audit/audit-dashboard-widget.tsx
  - src/app/(dashboard)/admin/system/page.tsx
  - src/app/(dashboard)/admin/layout.tsx
  - src/lib/audit.ts
  - src/app/api/dsgvo/anonymize/route.ts
  - src/app/api/dsgvo/auskunft/route.ts
  - src/app/(dashboard)/admin/dsgvo/page.tsx
  - src/lib/dsgvo/anonymize.ts
  - src/lib/dsgvo/auskunft.ts
  - src/app/api/health/route.ts
  - src/lib/health/checks.ts
  - src/lib/health/alerts.ts
autonomous: true
requirements:
  - REQ-RS-004
  - REQ-RS-005
  - REQ-RS-006

must_haves:
  truths:
    - "Admin can view system-wide Audit-Trail as timeline/activity stream with filtering by user, Akte, action type, and date range"
    - "Audit-Trail shows Vorher/Nachher diffs for changed fields"
    - "Per-Akte audit history is visible on the case detail page Historie tab"
    - "Admin can export Audit-Trail as CSV and PDF"
    - "Admin dashboard shows last 5-10 audit activities as a widget"
    - "DSGVO anonymization replaces personal data with 'Geloeschter Mandant' (never deletes)"
    - "Auskunftsrecht PDF export generates complete personal data report per Kontakt"
    - "10-year retention period enforced before anonymization is allowed"
    - "Health checks cover all Docker services including Ollama and Stirling-PDF"
    - "Public /api/health returns basic status; detailed info requires admin auth"
    - "Email alert sent to admins when a service goes unhealthy (with cooldown)"
  artifacts:
    - path: "src/app/(dashboard)/admin/audit-trail/page.tsx"
      provides: "System-wide audit trail timeline page"
    - path: "src/components/audit/audit-timeline.tsx"
      provides: "Reusable timeline component for audit events"
    - path: "src/app/api/admin/audit-trail/route.ts"
      provides: "Audit trail API with cursor pagination and filtering"
      exports: ["GET"]
    - path: "src/lib/dsgvo/anonymize.ts"
      provides: "Anonymization logic for Kontakt and related records"
    - path: "src/lib/dsgvo/auskunft.ts"
      provides: "Auskunftsrecht PDF generation"
    - path: "src/app/api/health/route.ts"
      provides: "Extended health check endpoint with auth-gated details"
      exports: ["GET"]
    - path: "src/lib/health/alerts.ts"
      provides: "Email alert on service failure with cooldown"
  key_links:
    - from: "src/app/(dashboard)/admin/audit-trail/page.tsx"
      to: "/api/admin/audit-trail"
      via: "fetch with cursor pagination"
      pattern: "api/admin/audit-trail"
    - from: "src/components/audit/audit-timeline.tsx"
      to: "src/lib/audit.ts"
      via: "AuditLog type and event label mapping"
      pattern: "AKTION_LABELS"
    - from: "src/lib/dsgvo/anonymize.ts"
      to: "prisma/schema.prisma"
      via: "Prisma transaction to anonymize Kontakt + related records"
      pattern: "prisma\\.\\$transaction"
    - from: "src/app/api/health/route.ts"
      to: "src/lib/health/checks.ts"
      via: "Promise.all for parallel service checks"
      pattern: "checkOllama|checkStirlingPdf"
---

<objective>
Build the Audit-Trail UI (system-wide timeline + per-Akte enhancement + dashboard widget + export), implement DSGVO compliance (anonymization workflow + Auskunftsrecht PDF export), and harden observability (extended health checks for all Docker services + auth-gated health endpoint + email alerts on failure).

Purpose: Compliance and operational visibility -- administrators need full audit history for regulatory requirements (BRAO/GoBD 10-year retention), DSGVO compliance for data subject rights, and health monitoring to ensure system reliability.
Output: Admin audit trail page, DSGVO admin page, extended health checks, email alerting.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-CONTEXT.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-RESEARCH.md

Key existing files to reference:
@src/lib/audit.ts (existing logAuditEvent with computeChanges, 45+ event types)
@src/app/api/akten/[id]/historie/route.ts (existing per-Akte audit API with cursor pagination)
@src/app/api/health/route.ts (existing 6-service health checks with Promise.all)
@src/app/(dashboard)/admin/system/page.tsx (existing admin system health page)
@src/lib/logger.ts (existing Pino logger config)
@src/lib/email/send.ts (existing email sending infrastructure)
@prisma/schema.prisma (AuditLog model already has userId, akteId, aktion, details, createdAt)
</context>

<tasks>

<task type="auto">
  <name>Task 1: System-wide Audit-Trail timeline + per-Akte enhancement + dashboard widget + export</name>
  <files>
    src/app/api/admin/audit-trail/route.ts
    src/app/api/admin/audit-trail/export/route.ts
    src/app/(dashboard)/admin/audit-trail/page.tsx
    src/components/audit/audit-timeline.tsx
    src/components/audit/audit-export-dialog.tsx
    src/components/audit/audit-dashboard-widget.tsx
    src/app/(dashboard)/admin/system/page.tsx
    src/app/(dashboard)/admin/layout.tsx
    src/lib/audit.ts
  </files>
  <action>
**1. Audit-Trail API (src/app/api/admin/audit-trail/route.ts):**

Create GET endpoint (ADMIN only) with cursor-based pagination:
- Query params: `take` (default 50, max 100), `cursor`, `userId`, `akteId`, `aktion`, `von` (date), `bis` (date), `search` (text search in details JSON)
- Include user relation (name, avatarUrl, role) and akte relation (aktenzeichen, kurzrubrum)
- Return `{ items, nextCursor, hasMore }`
- Group by date on the client side (Heute, Gestern, DD. MMMM YYYY)
- Use existing cursor-based pagination pattern from `/api/akten/[id]/historie/route.ts`

**2. Audit-Trail Export API (src/app/api/admin/audit-trail/export/route.ts):**

Create GET endpoint (ADMIN only) with `format` param (csv or pdf):
- Same filter params as audit-trail route (but no pagination -- export all matching)
- CSV: Generate with columns: Zeitpunkt, Benutzer, Rolle, Aktion, Akte, Details
- PDF: Use pdf-lib (already installed, patterns from Fristenzettel and invoice PDF) to generate A4 portrait with header "Audit-Trail Export" and date range, tabular layout
- Stream response with appropriate Content-Type and Content-Disposition headers
- Limit to max 10,000 entries per export to prevent memory issues

**3. Audit Timeline Component (src/components/audit/audit-timeline.tsx):**

Create reusable timeline component (used in both system-wide page and per-Akte tab):
- Timeline/Activity Stream format (per user decision: NOT a table, like GitHub activity feed)
- Each entry shows: user avatar (circle), user name, action label in German, Akte link (if applicable), timestamp (relative for today, absolute otherwise)
- Vorher/Nachher diff display for changed fields (per user decision): show a small card with field name, old value (red/strikethrough), new value (green) -- use existing `computeChanges()` from audit.ts
- Date group headers: "Heute", "Gestern", "DD. MMMM YYYY" (use date-fns format with 'de' locale)
- Security markers: highlight failed login events and unusual access patterns with red badge (per user decision)
- "Mehr laden" button at bottom for cursor-based pagination
- Compact mode prop for dashboard widget (fewer details, no diffs)

Create a mapping object `AKTION_LABELS` in audit.ts that translates action enums to German human-readable labels:
- AKTE_ERSTELLT -> "hat Akte erstellt"
- AKTE_AKTUALISIERT -> "hat Akte aktualisiert"
- DOKUMENT_HOCHGELADEN -> "hat Dokument hochgeladen"
- LOGIN_FEHLGESCHLAGEN -> "Fehlgeschlagener Login-Versuch" (security, red marker)
- ZUGRIFF_VERWEIGERT -> "Zugriff verweigert" (security, red marker)
- ADMIN_OVERRIDE_ERSTELLT -> "hat Admin-Zugriff uebernommen"
- DSGVO_ANONYMISIERT -> "hat personenbezogene Daten anonymisiert"
- etc. for all 45+ existing event types

**4. System-wide Audit Trail Page (src/app/(dashboard)/admin/audit-trail/page.tsx):**

Create admin page at /admin/audit-trail:
- Filter bar at top: User dropdown, Akte search, Action type dropdown, Date range picker (von/bis), Search text input
- Filter state stored in URL search params for bookmarkability
- AuditTimeline component below filters
- Export button (CSV/PDF) opens dialog with format selection and date range
- Add Audit-Trail link to admin sub-navigation in admin layout

**5. Enhance Per-Akte Historie Tab:**

The existing `/api/akten/[id]/historie/route.ts` already provides audit data. Ensure the existing Akte detail page Historie tab uses the new AuditTimeline component for consistent rendering. If currently using a different format, refactor to use AuditTimeline with `akteId` filter.

**6. Dashboard Audit Widget (src/components/audit/audit-dashboard-widget.tsx):**

Create compact widget showing last 5 audit events:
- Reuse AuditTimeline in compact mode (no diffs, shorter labels)
- "Alle anzeigen" link to /admin/audit-trail
- Add to admin system page (src/app/(dashboard)/admin/system/page.tsx) as a card

**7. Extend Audit Logging:**

In src/lib/audit.ts, add new event types if not already present:
- `AKTE_GEOEFFNET` -- for read-access logging (per user decision: all events including read access)
- `DOKUMENT_ANGESEHEN` -- document view events
- `LOGIN_FEHLGESCHLAGEN` -- failed login attempts
- `ZUGRIFF_VERWEIGERT` -- access denial events
- `ADMIN_OVERRIDE_ERSTELLT` / `ADMIN_OVERRIDE_ENTFERNT`
- `DSGVO_ANONYMISIERT`
- `DSGVO_AUSKUNFT_EXPORTIERT`

In src/lib/auth.ts (NextAuth authorize callback), add logging for failed login attempts with IP address if available.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>
      1. Navigate to /admin/audit-trail -- verify timeline format with user avatars and date grouping
      2. Apply filters (user, date range) -- verify results update
      3. Click export CSV -- verify file downloads with correct data
      4. Check admin system page for audit widget
    </manual>
  </verify>
  <done>
    - /api/admin/audit-trail returns cursor-paginated audit events with user and akte relations
    - /api/admin/audit-trail/export generates CSV and PDF exports
    - AuditTimeline component renders events in timeline/activity stream format with avatars, German labels, date groups, and Vorher/Nachher diffs
    - System-wide audit trail page at /admin/audit-trail with filtering and export
    - Dashboard audit widget on admin system page showing last 5 events
    - Per-Akte Historie uses AuditTimeline for consistent rendering
    - AKTION_LABELS mapping covers all 45+ event types
    - New event types added (AKTE_GEOEFFNET, LOGIN_FEHLGESCHLAGEN, etc.)
    - Failed login logging in auth.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: DSGVO compliance + extended health checks + email alerts</name>
  <files>
    src/lib/dsgvo/anonymize.ts
    src/lib/dsgvo/auskunft.ts
    src/app/api/dsgvo/anonymize/route.ts
    src/app/api/dsgvo/auskunft/route.ts
    src/app/(dashboard)/admin/dsgvo/page.tsx
    src/app/api/health/route.ts
    src/lib/health/checks.ts
    src/lib/health/alerts.ts
  </files>
  <action>
**1. Anonymization Library (src/lib/dsgvo/anonymize.ts):**

Create anonymization function that runs in a Prisma transaction (per user decision: NEVER delete, always anonymize):

```typescript
export async function anonymizeKontakt(kontaktId: string, adminUserId: string, grund: string)
```

Field-by-field strategy:
- Kontakt: vorname -> "Geloeschter", nachname -> "Mandant" (or "Kontakt"), firma -> "Anonymisiert"
- Null out: email, telefon, mobilnummer, fax, geburtsdatum, geburtsname, geburtsort, geburtsland, beruf, branche, steuernr, beaSafeId
- Keep: id (referential integrity), typ (NATUERLICH/JURISTISCH), createdAt
- Set: anonymisiertAm = now(), anonymisiertVon = adminUserId
- Adressen: null out strasse, hausnummer, plz, ort, land
- Bankverbindung: null out iban, bic, kontoinhaber, bankname
- AuditLog details JSON: scan for name patterns in details field and replace with "Anonymisiert" (use regex on JSON string)

Enforce 10-year retention period (per user decision):
- Calculate earliest allowed anonymization date from Kontakt.createdAt + 10 years
- If current date < earliest allowed date, reject with error: "Aufbewahrungspflicht: Anonymisierung erst ab {date} moeglich"
- Admin can override with explicit confirmation flag

Add dry-run mode: `anonymizeKontakt(kontaktId, adminUserId, grund, { dryRun: true })` returns list of fields/records that would be anonymized without actually doing it.

**2. Auskunftsrecht PDF Export (src/lib/dsgvo/auskunft.ts):**

Create function to generate complete personal data report per Kontakt:

```typescript
export async function generateAuskunftPdf(kontaktId: string): Promise<Buffer>
```

Using pdf-lib (already installed, patterns from Fristenzettel/invoice):
- Header: "Datenauskunft gemaess Art. 15 DSGVO"
- Sections:
  1. Kontaktdaten (name, email, phone, address)
  2. Akten (list of all Akten where this Kontakt is Beteiligter, with aktenzeichen and role)
  3. Dokumente (list of documents in those Akten)
  4. E-Mail-Korrespondenz (emails mentioning this Kontakt)
  5. Kalendereintraege (entries linked to Akten of this Kontakt)
  6. Buchungen (financial entries from Aktenkonto)
- Footer: Generation date, responsible admin

**3. DSGVO API Routes:**

Create `src/app/api/dsgvo/anonymize/route.ts`:
- POST (ADMIN only): Accept kontaktId, grund, optional dryRun and forceOverrideRetention flags
- Validate retention period (10 years)
- In dry-run mode: return list of what would be anonymized
- In real mode: call anonymizeKontakt(), log DSGVO_ANONYMISIERT audit event

Create `src/app/api/dsgvo/auskunft/route.ts`:
- GET (ADMIN only): Accept kontaktId query param
- Generate PDF with generateAuskunftPdf()
- Log DSGVO_AUSKUNFT_EXPORTIERT audit event
- Return PDF with Content-Type: application/pdf and Content-Disposition: attachment

**4. DSGVO Admin Page (src/app/(dashboard)/admin/dsgvo/page.tsx):**

Create admin page at /admin/dsgvo:
- Section "Auskunftsrecht (Art. 15 DSGVO)":
  - Search for Kontakt by name/email
  - "PDF generieren" button that downloads the Auskunft PDF
- Section "Loeschkonzept / Anonymisierung":
  - Search for Kontakt
  - Show retention status: "Aufbewahrungsfrist bis {date}" with progress indicator
  - "Vorschau" button for dry-run (shows what would be anonymized)
  - "Anonymisieren" button with confirmation dialog including Grund (reason) textarea
  - If within retention period: show warning, require explicit override checkbox
- Section "Anonymisierte Kontakte":
  - List of already anonymized Kontakte with timestamp and admin who performed it
- Add DSGVO link to admin sub-navigation

**5. Extended Health Checks (src/lib/health/checks.ts):**

Create new health check functions to supplement existing ones:

```typescript
export async function checkOllama(): Promise<ServiceStatus>
export async function checkStirlingPdf(): Promise<ServiceStatus>
```

- Ollama: fetch `${OLLAMA_URL}/` with 3-second timeout
- Stirling-PDF: fetch `${STIRLING_PDF_URL}/api/v1/info/status` with 3-second timeout
- Each returns `{ name, status: "healthy"|"unhealthy"|"degraded", latency, error? }`

**6. Health Endpoint Auth Gating (src/app/api/health/route.ts):**

Extend existing health route:
- Without auth (public): return basic status `{ status: "ok"|"degraded"|"down" }` -- this is used by Docker healthcheck, must remain unauthenticated
- With admin auth (authenticated): return detailed per-service status with latency, error messages, versions
- Add Ollama and Stirling-PDF to the Promise.all() parallel check array
- Maintain existing check functions (PostgreSQL, Redis, MinIO, Meilisearch, OnlyOffice, Worker)

**7. Email Alerts on Service Failure (src/lib/health/alerts.ts):**

Create health alert system:
- Function `checkAndAlertHealthStatus()` that runs health checks and sends email to all ADMIN users if any service goes unhealthy
- Cooldown: 60-minute cooldown per service to prevent email spam (store last alert timestamp in memory or Redis)
- Email template: "Service {name} ist nicht erreichbar seit {time}. Fehler: {error}"
- Use existing `sendEmail()` from `src/lib/email/send.ts`
- This function should be callable from the health endpoint (triggered on admin page load) or from a periodic check (optional BullMQ cron)

**8. Update Admin System Page:**

In `src/app/(dashboard)/admin/system/page.tsx`:
- Add Ollama and Stirling-PDF service cards to the existing health dashboard
- Ensure the Statusampel (traffic light) pattern is consistent with existing services
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>
      1. Navigate to /admin/dsgvo -- verify Auskunft PDF download and anonymization workflow
      2. Test /api/health without auth -- verify basic status only
      3. Test /api/health with admin session -- verify detailed per-service info
      4. Check admin system page for Ollama/Stirling-PDF status cards
    </manual>
  </verify>
  <done>
    - anonymizeKontakt() atomically anonymizes all PII in Prisma transaction (never deletes)
    - 10-year retention period enforced with admin override option
    - Dry-run mode shows what would be anonymized before executing
    - Auskunftsrecht PDF contains all stored personal data per Kontakt
    - /api/dsgvo/anonymize POST endpoint with audit logging
    - /api/dsgvo/auskunft GET endpoint returns PDF download
    - DSGVO admin page with search, Auskunft, and anonymization workflows
    - Health checks include Ollama and Stirling-PDF (total 8+ services)
    - Public /api/health returns basic status, admin auth returns detailed info
    - Email alerts sent to admins on service failure with 60-minute cooldown
    - Admin system page shows all service status cards
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes without errors
2. Audit trail timeline renders in activity stream format (not table)
3. Audit trail export generates valid CSV and PDF files
4. DSGVO anonymization replaces PII fields (not deletes records)
5. Auskunftsrecht PDF contains all personal data sections
6. /api/health responds without auth (basic) and with admin auth (detailed)
7. Health checks include at least 8 services
</verification>

<success_criteria>
- Admin can view, filter, and export the system-wide Audit-Trail
- Audit-Trail shows Vorher/Nachher diffs and security markers
- DSGVO anonymization works with 10-year retention check
- Auskunftsrecht PDF is comprehensive per Kontakt
- All Docker services are monitored via health checks
- Email alerts fire on service failure with spam prevention
</success_criteria>

<output>
After completion, create `.planning/phases/07-rollen-sicherheit-compliance-observability/07-02-SUMMARY.md`
</output>
