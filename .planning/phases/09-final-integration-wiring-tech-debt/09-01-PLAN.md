---
phase: 09-final-integration-wiring-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/email/types.ts
  - src/app/api/email-send/route.ts
  - src/lib/email/smtp/send-processor.ts
  - src/app/api/bea/messages/route.ts
  - src/worker.ts
  - src/lib/email/imap/sync.ts
  - src/components/ki/chat-input.tsx
  - src/components/dokumente/document-detail.tsx
  - src/app/api/akten/[id]/historie/route.ts
autonomous: true
requirements:
  - REQ-EM-006
  - REQ-BA-002
  - REQ-DV-010
  - REQ-KI-001
  - REQ-DV-005

must_haves:
  truths:
    - "Documents attached to sent emails transition from FREIGEGEBEN to VERSENDET after successful SMTP send"
    - "Documents attached to sent beA messages transition from FREIGEGEBEN to VERSENDET after successful creation with status GESENDET"
    - "Browser clients viewing an Akte receive document:embedding-complete Socket.IO event when embedding finishes"
    - "syncNewMessages dead code no longer exists in src/lib/email/imap/sync.ts"
    - "chat-input.tsx drag-drop shows a toast notification instead of alert()"
    - "Document detail page displays an audit history section with relevant document events"
  artifacts:
    - path: "src/lib/email/types.ts"
      provides: "Extended EmailSendJob type with dmsDocumentIds field"
      contains: "dmsDocumentIds"
    - path: "src/lib/email/smtp/send-processor.ts"
      provides: "markDokumenteVersendet call after successful SMTP send"
      contains: "markDokumenteVersendet"
    - path: "src/app/api/bea/messages/route.ts"
      provides: "markDokumenteVersendet call after GESENDET beA message creation"
      contains: "markDokumenteVersendet"
    - path: "src/worker.ts"
      provides: "document:embedding-complete Socket.IO event emission"
      contains: "document:embedding-complete"
    - path: "src/components/dokumente/document-detail.tsx"
      provides: "DocumentHistorie section after Versionsverlauf"
      contains: "Historie"
  key_links:
    - from: "src/app/api/email-send/route.ts"
      to: "src/lib/email/smtp/send-processor.ts"
      via: "dmsDocumentIds passed through EmailSendJob in BullMQ queue"
      pattern: "dmsDocumentIds.*dmsIds"
    - from: "src/lib/email/smtp/send-processor.ts"
      to: "src/lib/versand-gate.ts"
      via: "import and call markDokumenteVersendet"
      pattern: "markDokumenteVersendet\\(job\\.data\\.dmsDocumentIds"
    - from: "src/app/api/bea/messages/route.ts"
      to: "src/lib/versand-gate.ts"
      via: "import and call markDokumenteVersendet"
      pattern: "markDokumenteVersendet\\(data\\.dokumentIds"
    - from: "src/worker.ts"
      to: "browser via Socket.IO"
      via: "socketEmitter.to(akte room).emit embedding-complete"
      pattern: "emit\\(\"document:embedding-complete\""
---

<objective>
Wire markDokumenteVersendet() after successful email/beA sends so documents transition to VERSENDET, emit document:embedding-complete Socket.IO events from the embedding worker, and resolve all tech debt items from the 6th audit (dead code, alert stub, missing UI section).

Purpose: Close the final 2 integration gaps (INT-B01, INT-B02) and 5 tech debt items to complete the milestone.
Output: All 7 changes applied across 8-9 files, completing Phase 9.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-final-integration-wiring-tech-debt/09-RESEARCH.md
@src/lib/versand-gate.ts
@src/lib/email/types.ts
@src/lib/email/smtp/send-processor.ts
@src/app/api/email-send/route.ts
@src/app/api/bea/messages/route.ts
@src/worker.ts
@src/lib/email/imap/sync.ts
@src/components/ki/chat-input.tsx
@src/components/dokumente/document-detail.tsx
@src/app/api/akten/[id]/historie/route.ts
@src/components/audit/audit-timeline.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire markDokumenteVersendet after email/beA send + embedding Socket.IO event</name>
  <files>
    src/lib/email/types.ts
    src/app/api/email-send/route.ts
    src/lib/email/smtp/send-processor.ts
    src/app/api/bea/messages/route.ts
    src/worker.ts
  </files>
  <action>
    This task wires three integration gaps (INT-B01 email, INT-B01 beA, INT-B02 embedding).

    **1. Extend EmailSendJob type (src/lib/email/types.ts)**

    Add an optional `dmsDocumentIds` field to the `EmailSendJob` interface (currently at lines 97-101):

    ```typescript
    export interface EmailSendJob {
      emailNachrichtId: string;
      kontoId: string;
      userId: string;
      dmsDocumentIds?: string[]; // DMS document IDs for VERSENDET marking after successful send
    }
    ```

    **2. Pass DMS IDs through when enqueuing (src/app/api/email-send/route.ts)**

    In the POST handler, the `dmsIds` array is already extracted at line 69-71 for the Versand-Gate check. Pass it through to the BullMQ job data. Change the `emailSendQueue.add()` call (lines 137-150) to include `dmsDocumentIds: dmsIds`:

    ```typescript
    const job = await emailSendQueue.add(
      "send-email",
      {
        emailNachrichtId: email.id,
        kontoId: data.kontoId,
        userId: session.user.id,
        dmsDocumentIds: dmsIds, // Pass DMS doc IDs for VERSENDET marking
      },
      {
        delay,
        jobId: `send-${email.id}`,
        removeOnComplete: { age: 86_400 },
        removeOnFail: { age: 604_800 },
      }
    );
    ```

    **3. Call markDokumenteVersendet after SMTP send (src/lib/email/smtp/send-processor.ts)**

    Add import at the top:
    ```typescript
    import { markDokumenteVersendet } from "@/lib/versand-gate";
    ```

    After the successful status update to GESENDET (after line 123, before `return { status: "GESENDET" }`), add:
    ```typescript
    // Mark DMS documents as VERSENDET after confirmed send
    if (job.data.dmsDocumentIds && job.data.dmsDocumentIds.length > 0) {
      try {
        await markDokumenteVersendet(job.data.dmsDocumentIds);
        log.info(
          { emailNachrichtId, docCount: job.data.dmsDocumentIds.length },
          "Marked DMS documents as VERSENDET"
        );
      } catch (err) {
        // Non-fatal: document status update failure should not fail the email send
        log.warn({ err, emailNachrichtId }, "Failed to mark documents as VERSENDET");
      }
    }
    ```

    IMPORTANT: This goes AFTER the `prisma.emailNachricht.update({ sendeStatus: "GESENDET" })` (line 116-123) and BEFORE the `return` statement (line 125). It is inside the try block but wrapped in its own try-catch so a failure does not cause the email send to throw.

    **4. Call markDokumenteVersendet after beA GESENDET creation (src/app/api/bea/messages/route.ts)**

    `markDokumenteVersendet` is NOT currently imported in this file. The file already imports `checkDokumenteFreigegeben` from `@/lib/versand-gate` (line 8). Update that import to also import `markDokumenteVersendet`:
    ```typescript
    import { checkDokumenteFreigegeben, markDokumenteVersendet } from "@/lib/versand-gate";
    ```

    After the `prisma.beaNachricht.create()` call (line 170-194) and BEFORE the AI scan trigger (line 197), add:
    ```typescript
    // Mark DMS documents as VERSENDET after confirmed beA send
    if (data.status === "GESENDET" && data.dokumentIds && data.dokumentIds.length > 0) {
      try {
        await markDokumenteVersendet(data.dokumentIds);
      } catch {
        // Non-fatal: document status update failure should not fail beA message creation
      }
    }
    ```

    **5. Emit document:embedding-complete from embedding worker (src/worker.ts)**

    Replace the current `embeddingWorker.on("completed", ...)` handler (lines 355-361) with the full Socket.IO emission pattern (matching the OCR completion pattern at lines 229-257):

    ```typescript
    embeddingWorker.on("completed", (job) => {
      if (!job) return;
      log.info(
        { jobId: job.id, dokumentId: job.data.dokumentId },
        "Embedding job completed"
      );

      const embeddingPayload = {
        dokumentId: job.data.dokumentId,
        akteId: job.data.akteId,
        status: "ABGESCHLOSSEN",
      };

      socketEmitter
        .to(`akte:${job.data.akteId}`)
        .emit("document:embedding-complete", embeddingPayload);

      // Also emit to user room for global toast
      prisma.dokument
        .findUnique({
          where: { id: job.data.dokumentId },
          select: { createdById: true },
        })
        .then((doc) => {
          if (doc?.createdById) {
            socketEmitter
              .to(`user:${doc.createdById}`)
              .emit("document:embedding-complete", embeddingPayload);
          }
        })
        .catch((err) => {
          log.warn(
            { err, dokumentId: job.data.dokumentId },
            "Failed to look up user for embedding notification"
          );
        });
    });
    ```

    The `socketEmitter`, `prisma`, and `log` variables are already available in scope in worker.ts. The `EmbeddingJobData` type (from `src/lib/ocr/types.ts`) includes `dokumentId` and `akteId` fields.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -40</automated>
    <manual>Verify: 1) EmailSendJob has dmsDocumentIds field, 2) email-send route passes dmsIds to queue, 3) send-processor imports and calls markDokumenteVersendet, 4) bea/messages route imports and calls markDokumenteVersendet, 5) worker.ts embeddingWorker.on("completed") emits document:embedding-complete</manual>
  </verify>
  <done>
    - EmailSendJob type has optional dmsDocumentIds field
    - POST /api/email-send passes dmsIds to BullMQ job data
    - emailSendProcessor calls markDokumenteVersendet() after GESENDET status, wrapped in non-fatal try-catch
    - POST /api/bea/messages calls markDokumenteVersendet() after creating GESENDET BeaNachricht, wrapped in non-fatal try-catch
    - embeddingWorker.on("completed") emits document:embedding-complete to akte room and user room via socketEmitter
  </done>
</task>

<task type="auto">
  <name>Task 2: Tech debt cleanup â€” dead code, alert stub, document audit history</name>
  <files>
    src/lib/email/imap/sync.ts
    src/components/ki/chat-input.tsx
    src/components/dokumente/document-detail.tsx
    src/app/api/akten/[id]/historie/route.ts
  </files>
  <action>
    This task addresses 4 tech debt items from the 6th audit. The 5th item (PDFRawStream.of TS error) is verified as a false alarm by the research and will be confirmed by the tsc --noEmit check in Task 1's verify step.

    **1. Remove syncNewMessages dead code (src/lib/email/imap/sync.ts)**

    Delete lines 275-309: the JSDoc comment and the entire `syncNewMessages()` function. This function is never imported anywhere (connection-manager.ts calls `syncMailbox` directly at line 111). Verify no imports reference it with a grep first. Keep `initialSync()` which starts at line 311 (it IS used).

    The function to delete starts with:
    ```typescript
    /**
     * Incremental sync: fetch only new messages since the last known UID.
     */
    export async function syncNewMessages(
    ```
    and ends at line 309 with `};`.

    **2. Replace drag-drop alert with toast (src/components/ki/chat-input.tsx)**

    Add `import { toast } from "sonner";` to the imports at the top of the file (the project uses sonner for toasts, as confirmed by usage in notification-provider.tsx, notification-center.tsx, akte-email-tab.tsx).

    Replace the `handleDrop` callback (lines 124-131) from:
    ```typescript
    const handleDrop = useCallback((e: React.DragEvent) => {
      e.preventDefault();
      setIsDragOver(false);
      // Stub: show info about document processing
      alert(
        "Dokument wird verarbeitet, bitte warten... (Diese Funktion wird in einer spaeteren Version vollstaendig implementiert.)"
      );
    }, []);
    ```

    To:
    ```typescript
    const handleDrop = useCallback((e: React.DragEvent) => {
      e.preventDefault();
      setIsDragOver(false);
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        toast.info(
          "Dokument-Upload in den Chat wird in einer spaeteren Version unterstuetzt.",
          { description: `${files.length} Datei(en) abgelegt` }
        );
      }
    }, []);
    ```

    **3. Add dokumentId filter to historie API (src/app/api/akten/[id]/historie/route.ts)**

    After the `aktion` filter block (lines 22-25), add a `dokumentId` filter using Prisma JSON path filtering:

    ```typescript
    const dokumentId = searchParams.get("dokumentId");
    if (dokumentId) {
      where.details = { path: ["dokumentId"], equals: dokumentId };
    }
    ```

    This allows the document detail page to fetch only audit logs related to a specific document efficiently, without over-fetching all Akte audit logs.

    **4. Add Historie section to document detail page (src/components/dokumente/document-detail.tsx)**

    Add to the imports at the top:
    ```typescript
    import { AuditTimeline, type AuditItem } from "@/components/audit/audit-timeline";
    import { History } from "lucide-react";
    ```
    (Add `History` to the existing lucide-react import).

    After the Versionsverlauf section (after line 512 closing `</section>`), add a new Historie section:
    ```tsx
    {/* Audit history */}
    <section>
      <h3 className="text-xs font-medium text-slate-400 uppercase tracking-wider mb-3">
        Historie
      </h3>
      <DocumentHistorie
        dokumentId={dokument.id}
        akteId={dokument.akte.id}
      />
    </section>
    ```

    Add a `DocumentHistorie` component inside the same file (before the `MetadataRow` component at line 522):

    ```tsx
    function DocumentHistorie({ dokumentId, akteId }: { dokumentId: string; akteId: string }) {
      const [items, setItems] = useState<AuditItem[]>([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetch(
          `/api/akten/${akteId}/historie?dokumentId=${dokumentId}&aktion=DOKUMENT_HOCHGELADEN,DOKUMENT_GELOESCHT,DOKUMENT_STATUS_GEAENDERT,DOKUMENT_ANGESEHEN&take=20`
        )
          .then((res) => res.json())
          .then((data) => {
            setItems(data.items ?? []);
          })
          .catch(() => {
            setItems([]);
          })
          .finally(() => setLoading(false));
      }, [dokumentId, akteId]);

      if (loading) {
        return (
          <div className="flex items-center gap-2 py-3 text-xs text-slate-400">
            <Loader2 className="w-3.5 h-3.5 animate-spin" />
            Historie wird geladen...
          </div>
        );
      }

      if (items.length === 0) {
        return (
          <p className="text-xs text-slate-400 py-2">Keine Eintraege vorhanden</p>
        );
      }

      return <AuditTimeline items={items} hasMore={false} compact showAkteLink={false} />;
    }
    ```

    Note: `Loader2` is already imported from lucide-react. `useState` and `useEffect` are already imported from React.

    **5. PDFRawStream.of TypeScript note**

    The research confirms this is a false alarm: the code correctly uses `PDFRawStream.of()` (not `PDFStream.of()`) and `npx tsc --noEmit` produces no error. No code change needed. Document this resolution in the SUMMARY.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -40</automated>
    <manual>Verify: 1) syncNewMessages is gone from sync.ts, 2) chat-input.tsx uses toast.info instead of alert(), 3) document-detail.tsx has a Historie section below Versionsverlauf, 4) /api/akten/[id]/historie supports dokumentId query param</manual>
  </verify>
  <done>
    - syncNewMessages() function removed from src/lib/email/imap/sync.ts (no exports broken)
    - chat-input.tsx drag-drop handler uses sonner toast.info instead of alert()
    - /api/akten/[id]/historie route supports ?dokumentId= query param with Prisma JSON path filter
    - Document detail page has a "Historie" section after "Versionsverlauf" showing document-specific audit events via AuditTimeline component in compact mode
    - e-rechnung.ts PDFRawStream.of confirmed as non-issue (tsc --noEmit clean)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors (confirms all TypeScript is valid including new imports/types)
2. grep confirms `markDokumenteVersendet` is imported and called in both send-processor.ts and bea/messages/route.ts
3. grep confirms `document:embedding-complete` is emitted in worker.ts
4. grep confirms `syncNewMessages` no longer exists in the codebase
5. grep confirms `alert(` no longer appears in chat-input.tsx
6. grep confirms `DocumentHistorie` component exists in document-detail.tsx
</verification>

<success_criteria>
- Documents attached to sent emails/beA messages transition FREIGEGEBEN -> VERSENDET
- Embedding completion triggers Socket.IO event to akte and user rooms
- No dead code (syncNewMessages) remains
- No alert() stubs remain in chat-input.tsx
- Document detail page shows audit history for the specific document
- TypeScript builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/09-final-integration-wiring-tech-debt/09-01-SUMMARY.md`
</output>
