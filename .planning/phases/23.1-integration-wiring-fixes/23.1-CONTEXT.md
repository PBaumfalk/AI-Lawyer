# Phase 23.1: Integration Wiring Fixes - Context

**Gathered:** 2026-02-27
**Status:** Ready for planning

<domain>
## Phase Boundary

Close two specific cross-phase integration gaps found by the v0.2 milestone audit:
1. Wire `notifyDraftCreated` in `update-akte-rag.ts` — the 6th and final write-tool site (DRFT-06)
2. Enable multi-turn Schriftsatz Rueckfragen — route user answers back to resume the pipeline (ORCH-04)

No new features. No UI redesign. Just connect existing modules that are orphaned.

</domain>

<decisions>
## Implementation Decisions

### DRFT-06: Notification Wiring
- Copy the existing `notifyDraftCreated` pattern from the other 5 write-tool sites
- Import `notifyDraftCreated` from `draft-notification.ts` in `update-akte-rag.ts`
- Call fire-and-forget after `helenaDraft.create`, same as `create-draft-dokument.ts` etc.

### ORCH-04: Multi-Turn Rueckfragen Flow

#### Answer Experience
- User answers in free text in the existing Helena chat — no structured forms, no modals
- Keeps the conversational German tone Helena already uses
- One Rueckfrage at a time (slot-filler already works this way)

#### State Persistence
- Store pending `slotState` + `intentState` on the conversation state (extend HelenaMemory or use a dedicated `pendingPipeline` field)
- Session-scoped: cleared when user sends an unrelated message or starts a new Schriftsatz request
- No hard timeout — pending state lives as long as the conversation stays on the same Akte

#### Resume Mechanism
- When pipeline returns `needs_input`: save `slotState`, `intentState`, `akteId` to conversation state
- On next user message in the same Akte conversation: detect pending pipeline state
- Re-invoke `runSchriftsatzPipeline` with saved state + new user message as `userSlotValues` source
- The pipeline already accepts `userSlotValues` — the fix is routing them through the agent layer
- LLM parses free-text answers into slot values before re-invoking (the intent is already known)

#### Edge Cases
- "Weiss ich nicht" — already handled by slot-filler with `{{PLATZHALTER}}` markers
- Multiple answers at once — LLM should extract all applicable slot values from a single message
- Cancel — user says "abbrechen" or similar → clear pending state, acknowledge cancellation
- Navigate away — pending state persists per-Akte, user can come back and continue

### Claude's Discretion
- Exact implementation of the pending state storage (HelenaMemory field vs separate mechanism)
- How to detect "unrelated message" that clears pending state
- LLM prompt design for parsing free-text answers into slot values
- Error handling if pipeline resume fails

</decisions>

<specifics>
## Specific Ideas

No specific requirements — user deferred all decisions to Claude's judgment. Apply codebase patterns consistently.

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 23.1-integration-wiring-fixes*
*Context gathered: 2026-02-27*
