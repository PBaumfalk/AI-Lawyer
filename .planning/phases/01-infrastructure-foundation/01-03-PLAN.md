---
phase: 01-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/api/admin/jobs/[[...path]]/route.ts
  - src/app/(dashboard)/admin/jobs/page.tsx
  - src/app/(dashboard)/admin/layout.tsx
  - src/app/(dashboard)/admin/system/page.tsx
  - src/app/(dashboard)/admin/settings/page.tsx
  - src/app/api/settings/route.ts
  - src/app/api/admin/logs/route.ts
  - src/lib/settings/service.ts
  - src/lib/settings/defaults.ts
  - src/components/layout/sidebar.tsx
autonomous: true
requirements:
  - REQ-IF-001
  - REQ-IF-002

must_haves:
  truths:
    - "Admin can view job queue status (pending/active/completed/failed counts) via /admin/jobs page"
    - "Admin can view system health status of all services on /admin/system page"
    - "Admin can view last 200 log lines on /admin/system page with filtering by level and source"
    - "Admin can modify runtime settings on /admin/settings page without restart"
    - "Runtime setting changes propagate to the worker within seconds via Redis pub/sub"
    - "Non-admin users cannot access /admin/* pages"
  artifacts:
    - path: "src/app/(dashboard)/admin/jobs/page.tsx"
      provides: "Bull Board embedded job monitoring page"
      min_lines: 20
    - path: "src/app/api/admin/jobs/[[...path]]/route.ts"
      provides: "Bull Board API via Hono catch-all route"
      exports: ["GET", "POST", "PUT"]
    - path: "src/app/(dashboard)/admin/system/page.tsx"
      provides: "System health indicators + log viewer"
      min_lines: 80
    - path: "src/app/(dashboard)/admin/settings/page.tsx"
      provides: "Runtime settings management UI"
      min_lines: 60
    - path: "src/lib/settings/service.ts"
      provides: "SystemSetting CRUD + Redis pub/sub propagation"
      exports: ["getSetting", "updateSetting", "getAllSettings"]
    - path: "src/lib/settings/defaults.ts"
      provides: "Default runtime setting definitions"
      exports: ["DEFAULT_SETTINGS"]
  key_links:
    - from: "src/app/api/admin/jobs/[[...path]]/route.ts"
      to: "src/lib/queue/queues.ts"
      via: "imports ALL_QUEUES for Bull Board auto-discovery"
      pattern: "ALL_QUEUES"
    - from: "src/app/(dashboard)/admin/system/page.tsx"
      to: "src/app/api/health/route.ts"
      via: "fetches /api/health for service status display"
      pattern: "api/health"
    - from: "src/lib/settings/service.ts"
      to: "Redis pub/sub"
      via: "publishes settings:changed on update, subscriber is in src/worker.ts (Plan 01-01)"
      pattern: "settings:changed"
    - from: "src/app/(dashboard)/admin/layout.tsx"
      to: "auth session"
      via: "checks ADMIN role, redirects non-admins"
      pattern: "role.*ADMIN"
---

<objective>
Build the three admin pages: Bull Board job monitor (/admin/jobs), system health dashboard with log viewer (/admin/system), and runtime settings management (/admin/settings). All admin pages are ADMIN-role-only with consistent layout and navigation.

Purpose: Operational visibility is critical for a law firm application where missed deadlines have legal consequences. Admins need to see job queue health, system service status, and adjust runtime behavior without restarting Docker containers. The settings page serves as the foundation for all future configurable behavior.

Output: Three admin pages with corresponding API routes, settings service with Redis pub/sub propagation, admin layout with role-based access control.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md
@.planning/phases/01-infrastructure-foundation/01-CONTEXT.md
@.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md

@src/lib/redis.ts
@src/lib/logger.ts
@src/lib/queue/queues.ts
@src/lib/auth.ts
@src/lib/db.ts
@src/app/(dashboard)/layout.tsx
@src/app/api/health/route.ts
@src/components/layout/sidebar.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout, Bull Board job monitor, and settings service</name>
  <files>
    src/app/(dashboard)/admin/layout.tsx
    src/app/api/admin/jobs/[[...path]]/route.ts
    src/app/(dashboard)/admin/jobs/page.tsx
    src/lib/settings/service.ts
    src/lib/settings/defaults.ts
    src/app/api/settings/route.ts
  </files>
  <action>
    1. Create `src/app/(dashboard)/admin/layout.tsx` — Admin route layout with RBAC:
       - Server component that checks auth session
       - If user role is NOT "ADMIN": redirect to /dashboard with error (or return 403 page)
       - Render children with an admin sub-navigation bar at the top:
         - Links: "Job-Monitor" (/admin/jobs), "System" (/admin/system), "Einstellungen" (/admin/settings)
         - Use shadcn/ui Tabs or a simple nav bar with active state highlighting
       - Apply consistent padding and max-width for admin pages

    2. Create `src/app/api/admin/jobs/[[...path]]/route.ts` — Bull Board via Hono:
       - Per user decision: use @bull-board/hono adapter (NOT Express — lighter, integrates with Next.js App Router)
       - Import `HonoAdapter` from @bull-board/hono
       - Import `createBullBoard` from @bull-board/api
       - Import `BullMQAdapter` from @bull-board/api/bullMQAdapter
       - Import `ALL_QUEUES` from lib/queue/queues (auto-discovery per user decision)
       - Set base path: `/api/admin/jobs`
       - Create Bull Board with BullMQAdapter for each queue in ALL_QUEUES
       - Register plugin on Hono app
       - Export GET, POST, PUT handlers via `handle(app)` from hono/vercel
       - NOTE: If the @bull-board/hono adapter causes issues (Research Open Question #2), fall back to:
         - Option A: Embed Bull Board in an iframe on the admin page, serving from a route in server.ts
         - Option B: Use raw @bull-board/api to build a custom JSON API, render own UI
         - Try Hono approach FIRST.

    3. Create `src/app/(dashboard)/admin/jobs/page.tsx` — Bull Board embedded page:
       - Per user decision: dedicated /admin/jobs page with full job explorer
       - Client component that either:
         - Embeds Bull Board UI in an iframe pointing to /api/admin/jobs
         - Or renders Bull Board inline if the Hono adapter serves proper HTML
       - Show page title: "Job-Monitor"
       - Show queue summary cards above Bull Board: for each queue, display name + counts (pending/active/completed/failed)
         - Fetch counts from Bull Board API or directly from BullMQ Queue.getJobCounts()
       - Per user decision: shows all job states with payload inspection, logs, timing

    4. Create `src/lib/settings/defaults.ts` — Default runtime settings:
       - Export `DEFAULT_SETTINGS` array with shape: `{ key: string; value: string; type: "string"|"number"|"boolean"|"json"; category: string; label: string }`
       - Categories and defaults:
         - **worker** category:
           - `worker.concurrency`: "5", number, "Worker-Parallelitaet"
           - `worker.retryLimit`: "3", number, "Maximale Wiederholungen"
         - **logging** category:
           - `log.level`: "info", string, "Log-Level" (options: trace, debug, info, warn, error, fatal)
         - **notifications** category:
           - `notifications.sound.default`: "false", boolean, "Standard-Benachrichtigungston"
           - `notifications.retention.days`: "30", number, "Aufbewahrung Benachrichtigungen (Tage)"
         - **system** category:
           - `system.maintenance`: "false", boolean, "Wartungsmodus"

    5. Create `src/lib/settings/service.ts` — Settings CRUD + Redis pub/sub:
       - Export `getSetting(key: string): Promise<string | null>`:
         - Query SystemSetting by key, return value or null
       - Export `getSettingTyped<T>(key: string, defaultValue: T): Promise<T>`:
         - Get setting, parse based on type field (number → parseInt, boolean → "true" === value, json → JSON.parse)
         - Return defaultValue if not found
       - Export `getAllSettings(): Promise<SystemSetting[]>`:
         - Query all settings ordered by category, then key
       - Export `updateSetting(key: string, value: string): Promise<void>`:
         - Upsert SystemSetting in DB
         - Publish to Redis channel `settings:changed` with `{ key, value }`
         - Per user decision: propagated immediately via Redis pub/sub — worker picks up within seconds
       - Export `initializeDefaults(): Promise<void>`:
         - For each DEFAULT_SETTING: upsert only if key does not exist (preserve user overrides)
         - Called at app startup
       - Use createRedisConnection for pub/sub (one-off connection, quit after publish)

    6. Create `src/app/api/settings/route.ts` — Settings REST API:
       - GET handler: requires auth + ADMIN role
         - Returns all settings grouped by category
       - PUT handler: requires auth + ADMIN role
         - Body: `{ key: string, value: string }`
         - Validate key exists in DEFAULT_SETTINGS (no arbitrary keys)
         - Call updateSetting(key, value)
         - Return updated setting
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Navigate to /admin/jobs — should show Bull Board UI or queue summary. Non-admin users should be redirected.</manual>
  </verify>
  <done>
    - Admin layout enforces ADMIN role with redirect for unauthorized users
    - Admin sub-navigation links to jobs, system, settings pages
    - Bull Board embedded via Hono adapter at /api/admin/jobs with auto-discovered queues
    - /admin/jobs page shows queue summary cards + Bull Board UI
    - Settings service handles CRUD with Redis pub/sub for live propagation
    - Default settings initialized for worker, logging, notifications, system categories
    - GET/PUT /api/settings endpoints work with ADMIN auth
  </done>
</task>

<task type="auto">
  <name>Task 2: Create system health page with log viewer and update sidebar navigation</name>
  <files>
    src/app/(dashboard)/admin/system/page.tsx
    src/app/(dashboard)/admin/settings/page.tsx
    src/app/api/admin/logs/route.ts
    src/components/layout/sidebar.tsx
  </files>
  <action>
    1. Create `src/app/api/admin/logs/route.ts` — Log reader API:
       - GET handler: requires auth + ADMIN role
       - Query params: `lines` (default 200), `level` (filter: INFO/WARN/ERROR or "all"), `source` (filter: "app"/"worker" or "all")
       - Read log file(s) from LOG_FILE_PATH env var (or default /var/log/ai-lawyer/)
         - In development: read from stdout might not work. Provide fallback: if file doesn't exist, return empty array with message "Log-Datei nicht gefunden. Logs sind nur in der Produktionsumgebung verfuegbar."
       - Parse JSON log lines (pino format), filter by level and module (source)
       - Return last N lines as JSON array: `[{ timestamp, level, module, message, ...context }]`
       - Sort: newest first

    2. Create `src/app/(dashboard)/admin/system/page.tsx` — System health + log viewer:
       - Per user decision: /admin/system page showing service health indicators + system status
       - **Health section** (top):
         - Fetch from /api/health on load and with auto-refresh toggle (default: every 30s)
         - Display each service as a card/row:
           - Service name (PostgreSQL, Redis, MinIO, Meilisearch, OnlyOffice, Worker)
           - Status indicator: green dot for healthy, red dot for unhealthy
           - Latency in ms
           - Last checked timestamp
         - Overall status banner: "Alle Systeme betriebsbereit" (green) or "Eingeschraenkter Betrieb" (amber/red)
         - Show uptime from health response
       - **Log viewer section** (below):
         - Per user decision: last 200 lines, filterable by level (INFO/WARN/ERROR) and source (app/worker)
         - Dropdown filters for level and source
         - Auto-refresh toggle (default: off)
         - Log lines rendered in a monospace-font scrollable container
         - Each line shows: timestamp (formatted), level (color-coded: INFO=blue, WARN=amber, ERROR=red), source badge, message
         - Newest at top
       - Use shadcn/ui Card, Badge, Select, Switch, ScrollArea, Table

    3. Create `src/app/(dashboard)/admin/settings/page.tsx` — Runtime settings management:
       - Per user decision: /admin/settings page as foundation for all future settings
       - Fetch settings from GET /api/settings
       - Group settings by category with section headers (German labels):
         - "Worker" → worker.concurrency, worker.retryLimit
         - "Logging" → log.level
         - "Benachrichtigungen" → notifications.sound.default, notifications.retention.days
         - "System" → system.maintenance
       - Each setting rendered as a form field based on type:
         - string: text input (or select for known options like log.level)
         - number: number input with min/max
         - boolean: switch toggle
         - json: textarea with JSON validation
       - Save button per setting or per section — calls PUT /api/settings
       - Show success toast on save: "Einstellung gespeichert"
       - Show info text: "Aenderungen werden sofort wirksam, kein Neustart erforderlich."
       - Use shadcn/ui Card, Input, Switch, Select, Button, Label

    4. Update `src/components/layout/sidebar.tsx` — Add admin navigation:
       - Add a new section "Administration" at the bottom of the sidebar navigation
       - Only visible when user role is ADMIN
       - Links:
         - "Job-Monitor" → /admin/jobs (icon: lucide-react Activity or ListChecks)
         - "System" → /admin/system (icon: lucide-react Server or Monitor)
         - "Einstellungen" → /admin/settings (icon: lucide-react Settings)
       - Use the existing sidebar styling pattern
       - Add a separator above the admin section
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>
      1. Log in as ADMIN, check sidebar shows Administration section
      2. Navigate to /admin/system — health cards should show service statuses
      3. Navigate to /admin/settings — change log level, verify toast confirmation
      4. Non-admin users should NOT see admin sidebar links and cannot access /admin/* pages
    </manual>
  </verify>
  <done>
    - /admin/system shows health status cards for all services with color-coded indicators and latency
    - /admin/system log viewer shows last 200 lines filterable by level and source with auto-refresh toggle
    - /admin/settings shows all runtime settings grouped by category with appropriate input types
    - Settings changes save successfully with toast confirmation and immediate propagation via Redis pub/sub
    - Sidebar has "Administration" section visible only to ADMIN users with links to all three admin pages
    - All UI text in German ("Alle Systeme betriebsbereit", "Einstellung gespeichert", "Log-Level", etc.)
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/jobs as ADMIN — Bull Board shows queue list with job counts
2. Navigate to /admin/system — all service health cards display with green/red indicators
3. Log viewer shows recent log entries, filtering by level and source works
4. Navigate to /admin/settings — change worker.concurrency setting, confirm toast appears
5. Non-admin user navigating to /admin/* is redirected to /dashboard
6. Sidebar shows "Administration" section only for ADMIN role users
7. Auto-refresh on /admin/system updates health data every 30 seconds
</verification>

<success_criteria>
- Bull Board job explorer works at /admin/jobs with auto-discovered queues
- System health page shows real-time status of all Docker services
- Log viewer displays structured logs with filtering capabilities
- Runtime settings are modifiable without restart and propagate via Redis pub/sub
- All admin pages enforce ADMIN role access
- Sidebar navigation updated with admin section (ADMIN-only visibility)
- All user-facing text in German
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-03-SUMMARY.md`
</output>
