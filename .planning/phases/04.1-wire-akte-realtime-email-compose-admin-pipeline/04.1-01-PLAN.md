---
phase: 04.1-wire-akte-realtime-email-compose-admin-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/akten/akte-socket-bridge.tsx
  - src/app/(dashboard)/akten/[id]/page.tsx
  - src/worker.ts
  - src/components/email/compose-fab.tsx
  - src/app/(dashboard)/email/layout.tsx
  - src/app/(dashboard)/admin/pipeline/page.tsx
  - src/app/(dashboard)/admin/layout.tsx
  - src/components/layout/sidebar.tsx
autonomous: true
requirements:
  - REQ-DV-004
  - REQ-DV-005
  - REQ-EM-006

must_haves:
  truths:
    - "When a user views an Akte page, Socket.IO joins the akte:{akteId} room, enabling real-time OCR events to reach the browser"
    - "OCR completion and failure triggers a global sonner toast notification with clickable navigation and retry action"
    - "Neue E-Mail FAB button is visible on all email pages and opens the compose popup via ComposeManager"
    - "Admin pipeline dashboard at /admin/pipeline displays OCR/embedding queue stats with auto-refresh and per-job retry"
  artifacts:
    - path: "src/components/akten/akte-socket-bridge.tsx"
      provides: "Socket.IO akte room join/leave lifecycle + global OCR toast bridge"
      min_lines: 40
    - path: "src/components/email/compose-fab.tsx"
      provides: "Floating action button for new email composition"
      min_lines: 15
    - path: "src/app/(dashboard)/admin/pipeline/page.tsx"
      provides: "Admin pipeline dashboard with queue stats and retry"
      min_lines: 80
  key_links:
    - from: "src/components/akten/akte-socket-bridge.tsx"
      to: "socket.io rooms.ts"
      via: "socket.emit('join:akte', akteId) on mount"
      pattern: "socket\\.emit.*join:akte"
    - from: "src/components/akten/akte-socket-bridge.tsx"
      to: "sonner toast"
      via: "socket.on('document:ocr-complete') triggers toast.success/toast.error"
      pattern: "socket\\.on.*document:ocr-complete"
    - from: "src/components/email/compose-fab.tsx"
      to: "compose-manager.tsx"
      via: "useComposeManager().openCompose() on click"
      pattern: "openCompose"
    - from: "src/app/(dashboard)/admin/pipeline/page.tsx"
      to: "/api/admin/pipeline"
      via: "fetch with polling interval"
      pattern: "fetch.*api/admin/pipeline"
---

<objective>
Wire the three remaining cross-phase integration gaps from the v3.4 audit: (1) Socket.IO akte room join/leave so OCR status events from the worker reach the browser with global toast notifications, (2) "Neue E-Mail" FAB button on email pages calling ComposeManager.openCompose(), and (3) admin pipeline dashboard page at /admin/pipeline displaying queue stats with auto-refresh and per-job retry.

Purpose: Close INT-004 (critical), INT-005 (medium), INT-006 (low) integration gaps so OCR real-time updates, email compose initiation, and pipeline monitoring all function end-to-end.
Output: 3 new components, 5 modified files, all wiring complete.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-wire-akte-realtime-email-compose-admin-pipeline/04.1-RESEARCH.md

# Prior phase context (relevant for wiring patterns)
@.planning/phases/03.1-wire-email-realtime-compose/03.1-01-SUMMARY.md
@.planning/phases/04-document-pipeline-ocr-rag-ingestion/04-01-SUMMARY.md

# Key files to read before implementing
@src/lib/socket/rooms.ts
@src/worker.ts
@src/components/providers/upload-provider.tsx
@src/components/email/inbox-layout.tsx
@src/components/email/compose-manager.tsx
@src/app/api/admin/pipeline/route.ts
@src/app/(dashboard)/admin/layout.tsx
@src/components/layout/sidebar.tsx
@src/app/(dashboard)/akten/[id]/page.tsx
@src/app/(dashboard)/email/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Socket.IO akte room join/leave + global OCR toast notifications</name>
  <files>
    src/components/akten/akte-socket-bridge.tsx
    src/app/(dashboard)/akten/[id]/page.tsx
    src/worker.ts
  </files>
  <action>
Create `src/components/akten/akte-socket-bridge.tsx` as a "use client" component that:

1. Accepts `akteId: string` prop
2. Uses `useSocket()` from `@/components/socket-provider` (import the hook — check existing usage in inbox-layout.tsx for exact import path)
3. Uses `useRouter()` from `next/navigation` for toast click navigation
4. On mount: emits `socket.emit("join:akte", akteId)` when socket is connected. On cleanup: emits `socket.emit("leave:akte", akteId)`. Follow the EXACT pattern from `src/components/email/inbox-layout.tsx` lines 29-38 (the mailbox room join/leave useEffect).
5. In a SEPARATE useEffect (different dependency array — depends only on `socket`, not `isConnected`): listens for `document:ocr-complete` events globally. The handler checks:
   - If `data.status === "ABGESCHLOSSEN"`: shows `toast.success("OCR abgeschlossen: " + data.fileName, { action: { label: "Anzeigen", onClick: () => router.push("/akten/" + data.akteId + "/dokumente/" + data.dokumentId) } })`. Per user decision: auto-dismiss (sonner default is fine).
   - If `data.status === "FEHLGESCHLAGEN"`: shows `toast.error("OCR fehlgeschlagen: " + data.fileName, { action: { label: "Wiederholen", onClick: () => fetch("/api/dokumente/" + data.dokumentId + "/ocr", { method: "POST" }) } })`.
   - Import `toast` from `sonner`.
6. Cleanup: `socket.off("document:ocr-complete", handler)` in the cleanup function.
7. The component renders `null` (invisible bridge component).

Modify `src/app/(dashboard)/akten/[id]/page.tsx`:
- Import `AkteSocketBridge` from `@/components/akten/akte-socket-bridge`
- Render `<AkteSocketBridge akteId={id} />` inside the page JSX (after the header or at the top of the return). The page is a server component, so the bridge runs as a client component child — this is fine (server can render client children).

Modify `src/worker.ts`:
- Find the `document:ocr-complete` emission (around line 234, where `socketEmitter.to("akte:${job.data.akteId}").emit("document:ocr-complete", {...})` is called).
- Extend the event payload to include `fileName` and `akteId` in BOTH the success and failure emissions. The data is already available in `job.data.akteId` and the document name should be in `job.data.fileName` or `job.data.name`. Check the job data shape — if filename is stored differently, look up the document via the existing Prisma call in the processor.
- ALSO emit the event to `user:{userId}` room (not just `akte:{akteId}`) so that OCR toasts fire globally even when the user navigates away from the Akte page. The userId should be available from `job.data.userId` or looked up from the document's `createdById`. Check the job data and existing code to find the user. Emit to BOTH rooms: `akte:{akteId}` (for upload panel) and `user:{userId}` (for global toast).
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && grep -q "join:akte" src/components/akten/akte-socket-bridge.tsx && grep -q "document:ocr-complete" src/components/akten/akte-socket-bridge.tsx && grep -q "AkteSocketBridge" src/app/\(dashboard\)/akten/\[id\]/page.tsx && grep -q "fileName" src/worker.ts && echo "PASS"</automated>
    <manual>Verify that the akte-socket-bridge.tsx follows the exact mailbox room join/leave pattern from inbox-layout.tsx, toast messages match the German text from user decisions, and worker.ts emits to both akte and user rooms.</manual>
  </verify>
  <done>
    - AkteSocketBridge component joins akte:{akteId} room on mount, leaves on unmount
    - OCR success toast shows "OCR abgeschlossen: {filename}" with clickable "Anzeigen" link
    - OCR failure toast shows "OCR fehlgeschlagen: {filename}" with "Wiederholen" retry action
    - Worker emits document:ocr-complete with fileName and akteId to both akte:{akteId} and user:{userId} rooms
    - Bridge is rendered on the Akte detail page
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Neue E-Mail FAB button on email pages</name>
  <files>
    src/components/email/compose-fab.tsx
    src/app/(dashboard)/email/layout.tsx
  </files>
  <action>
Create `src/components/email/compose-fab.tsx` as a "use client" component:

1. Import `useComposeManager` from `@/components/email/compose-manager` (verify exact export path)
2. Import `Pencil` (or `Edit`) icon from `lucide-react`
3. Destructure `const { openCompose } = useComposeManager()`
4. Render a fixed-position FAB button in the bottom-right corner:
   - Position: `fixed bottom-6 right-6` (per user decision: Gmail-style FAB in bottom-right corner)
   - Z-index: `z-[80]` (between upload panel z-50 and minimized compose tabs z-[85], per research pitfall #3)
   - Styling: `flex items-center gap-2 px-4 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl shadow-lg hover:shadow-xl transition-all`
   - Content: `<Pencil className="w-5 h-5" />` + `<span className="font-medium">Neue E-Mail</span>` (per user decision: pen/edit icon + "Neue E-Mail" text label)
   - onClick: calls `openCompose()` (per user decision: multiple concurrent compose windows allowed — ComposeManager already handles this)
5. On small screens, consider hiding the text label and showing only the icon: add `hidden sm:inline` to the span for responsive behavior (Claude's discretion on responsive behavior).

Modify `src/app/(dashboard)/email/layout.tsx`:
- Import `ComposeFab` from `@/components/email/compose-fab`
- Render `<ComposeFab />` inside the layout, AFTER the children but within the ComposeManager provider boundary. The email layout already wraps children with ComposeManager (confirmed from Phase 3.1 summary), so the FAB will have access to the context.
- The FAB must be visible on ALL email-related pages (inbox, sent, drafts, email detail) per user decision. Since the email layout wraps all email routes, placing it here covers all pages.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && grep -q "openCompose" src/components/email/compose-fab.tsx && grep -q "Neue E-Mail" src/components/email/compose-fab.tsx && grep -q "ComposeFab" src/app/\(dashboard\)/email/layout.tsx && echo "PASS"</automated>
    <manual>Verify FAB has z-[80], uses brand-600 colors, renders Pencil icon + "Neue E-Mail" text, and is placed inside ComposeManager provider boundary in email layout.</manual>
  </verify>
  <done>
    - ComposeFab component renders Gmail-style floating action button with pen icon and "Neue E-Mail" label
    - Clicking FAB calls openCompose() which opens compose popup via ComposeManager
    - FAB is visible on all email pages (inbox, sent, drafts, detail) via email layout placement
    - Z-index z-[80] prevents conflicts with upload panel and compose popups
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin pipeline dashboard page with navigation link</name>
  <files>
    src/app/(dashboard)/admin/pipeline/page.tsx
    src/app/(dashboard)/admin/layout.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
Create `src/app/(dashboard)/admin/pipeline/page.tsx` as a "use client" page:

1. Add `export const dynamic = "force-dynamic"` to prevent static generation during build.
2. State: `pipelineData` (fetched from `/api/admin/pipeline`), `loading`, `autoRefresh` (default: true), `retrying` (set of job IDs currently being retried).
3. Fetch function `fetchPipelineStats`: calls `GET /api/admin/pipeline`, parses the JSON response. The response shape (confirmed from research) is:
   ```
   { queues: { ocr: { waiting, active, completed, failed, delayed }, embedding: {...}, preview: {...} },
     failedDocuments: [{ id, name, mimeType, ocrFehler, ocrVersuche, akteId, updatedAt, akte }],
     statusDistribution: { AUSSTEHEND: N, ABGESCHLOSSEN: N, FEHLGESCHLAGEN: N, ... } }
   ```
4. useEffect: fetch on mount. useEffect with autoRefresh: `setInterval(fetchPipelineStats, 15000)` (15 seconds — within user-specified 10-30s range). Follow the polling pattern from `admin/system/page.tsx`.
5. Layout (per user decision: dedicated admin page):
   - Page header: "Pipeline-Dashboard" with auto-refresh toggle (Switch component from shadcn) and manual refresh button (RefreshCw icon).
   - **Queue cards row**: 3 cards side-by-side (OCR, Embedding, Preview) showing counts: wartend (waiting), aktiv (active), abgeschlossen (completed), fehlgeschlagen (failed). Use Card/CardHeader/CardTitle/CardContent from shadcn. Color-code failed count in red if > 0.
   - **Status distribution section**: Simple badges or bar showing AUSSTEHEND, IN_VERARBEITUNG, ABGESCHLOSSEN, FEHLGESCHLAGEN counts from statusDistribution.
   - **Failed documents table** (per user decision: recent jobs table with status and timestamps): Table rows with columns: Dokument (name), Fehler (ocrFehler), Versuche (ocrVersuche), Akte (akte.aktenzeichen), Aktualisiert (updatedAt formatted), Aktion (retry button).
   - **Retry button** per failed row (per user decision): Calls `POST /api/dokumente/${id}/ocr` to re-trigger OCR. Show loading spinner while retrying. On success, refetch pipeline stats.
   - **Bulk retry button** (retry all failed): Calls `POST /api/admin/pipeline` with body `{ action: "retry-all-failed" }`. Show loading state.
6. Import icons from lucide-react: RefreshCw, AlertCircle, CheckCircle2, Clock, Loader2.
7. German UI labels throughout (Wartend, Aktiv, Abgeschlossen, Fehlgeschlagen, Wiederholen, Alle wiederholen).

Modify `src/app/(dashboard)/admin/layout.tsx`:
- Add `{ name: "Pipeline", href: "/admin/pipeline" }` to the `adminNavigation` array (after "Einstellungen" or after "System" — place it logically).

Modify `src/components/layout/sidebar.tsx`:
- Find the `adminNavigation` array and add `{ name: "Pipeline", href: "/admin/pipeline", icon: Activity }` (Activity is already imported from lucide-react in this file — verify; if not, import it, or use a suitable icon like `Workflow` or `Cpu`).
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && grep -q "Pipeline" src/app/\(dashboard\)/admin/layout.tsx && grep -q "Pipeline" src/components/layout/sidebar.tsx && grep -q "api/admin/pipeline" src/app/\(dashboard\)/admin/pipeline/page.tsx && grep -q "retry-all-failed" src/app/\(dashboard\)/admin/pipeline/page.tsx && echo "PASS"</automated>
    <manual>Verify the pipeline page has queue cards for OCR/Embedding/Preview, a failed documents table with per-row retry, auto-refresh toggle, and German labels. Confirm navigation link appears in both admin layout and sidebar.</manual>
  </verify>
  <done>
    - Admin pipeline dashboard at /admin/pipeline shows queue counts per queue (OCR, embedding, preview) with card layout
    - Failed documents table displays document name, error, retry count, Akte, and timestamp
    - Per-row retry button triggers OCR reprocessing via POST /api/dokumente/{id}/ocr
    - Bulk "Alle wiederholen" button calls POST /api/admin/pipeline with retry-all-failed action
    - Auto-refresh polls every 15 seconds with toggle to disable
    - "Pipeline" navigation link added to admin layout sub-nav and sidebar adminNavigation
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "join:akte" src/components/akten/akte-socket-bridge.tsx` — confirms room join
2. `grep -rn "document:ocr-complete" src/components/akten/akte-socket-bridge.tsx` — confirms OCR listener
3. `grep -rn "AkteSocketBridge" src/app/\(dashboard\)/akten/\[id\]/page.tsx` — confirms bridge rendered on Akte page
4. `grep -rn "fileName" src/worker.ts | grep "ocr-complete\|emit"` — confirms extended payload
5. `grep -rn "openCompose" src/components/email/compose-fab.tsx` — confirms FAB wiring
6. `grep -rn "ComposeFab" src/app/\(dashboard\)/email/layout.tsx` — confirms FAB in email layout
7. `grep -rn "Pipeline" src/app/\(dashboard\)/admin/layout.tsx src/components/layout/sidebar.tsx` — confirms navigation
8. `test -f src/app/\(dashboard\)/admin/pipeline/page.tsx` — confirms page exists
</verification>

<success_criteria>
- Socket.IO akte room lifecycle is wired: join on mount, leave on unmount, following the mailbox room pattern
- Global OCR toasts fire via sonner when worker completes/fails OCR processing, even when user is not viewing the Akte
- Neue E-Mail FAB is visible on all email pages and opens compose popup via ComposeManager
- Admin pipeline dashboard displays live queue stats with auto-refresh and per-job + bulk retry
- All navigation links point to /admin/pipeline in both admin layout and sidebar
- No new npm dependencies required
- No new API endpoints created (all existing)
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-wire-akte-realtime-email-compose-admin-pipeline/04.1-01-SUMMARY.md`
</output>
