---
phase: 03-email-client
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/app/(dashboard)/email/page.tsx
  - src/app/(dashboard)/email/layout.tsx
  - src/components/email/inbox-layout.tsx
  - src/components/email/folder-tree.tsx
  - src/components/email/email-list.tsx
  - src/components/email/email-list-row.tsx
  - src/components/email/email-detail.tsx
  - src/components/email/email-html-body.tsx
  - src/components/email/email-actions-bar.tsx
  - src/components/email/email-filters.tsx
  - src/components/email/email-empty-state.tsx
  - src/components/ui/resizable.tsx
  - src/hooks/use-email-store.ts
  - src/hooks/use-keyboard-shortcuts.ts
autonomous: true
requirements:
  - REQ-EM-003
  - REQ-EM-004

must_haves:
  truths:
    - "User sees a three-pane layout: folder tree (left), email list (center), email detail (right)"
    - "All three panes are resizable via draggable dividers with positions saved per user"
    - "Folder tree shows all mailboxes with collapsible IMAP folders and unread counts"
    - "Email list shows virtualized rows with sender, subject, date, preview snippet, Veraktung badge, attachment icon"
    - "Email list supports infinite scroll with cursor-based pagination"
    - "Filter bar filters emails by status (Alle/Veraktet/Unveraktet), Akte, Verantwortlicher, and unread toggle"
    - "Email detail pane renders sanitized HTML body safely with XSS protection"
    - "Attachment strip below email header shows file icons, name, size with download links"
    - "Action bar in detail pane shows Antworten, Allen antworten, Weiterleiten, Verakten, Ticket erstellen, Archivieren, Spam, Loeschen"
    - "Gmail-style keyboard shortcuts work: J/K navigate, R reply, A reply all, F forward, V verakten, E archive"
  artifacts:
    - path: "src/components/email/inbox-layout.tsx"
      provides: "Three-pane resizable layout shell"
      min_lines: 40
    - path: "src/components/email/folder-tree.tsx"
      provides: "Mailbox and folder navigation with unread counts"
      min_lines: 60
    - path: "src/components/email/email-list.tsx"
      provides: "Virtualized email list with infinite scroll"
      min_lines: 80
    - path: "src/components/email/email-detail.tsx"
      provides: "Email detail view with header, body, attachments"
      min_lines: 100
    - path: "src/components/email/email-html-body.tsx"
      provides: "Sanitized HTML email rendering with DOMPurify"
      min_lines: 20
  key_links:
    - from: "src/components/email/inbox-layout.tsx"
      to: "src/components/email/folder-tree.tsx"
      via: "Left panel renders FolderTree"
      pattern: "<FolderTree"
    - from: "src/components/email/inbox-layout.tsx"
      to: "src/components/email/email-list.tsx"
      via: "Center panel renders EmailList"
      pattern: "<EmailList"
    - from: "src/components/email/inbox-layout.tsx"
      to: "src/components/email/email-detail.tsx"
      via: "Right panel renders EmailDetail"
      pattern: "<EmailDetail"
    - from: "src/components/email/email-list.tsx"
      to: "/api/emails"
      via: "Fetches email list from API with filters and pagination"
      pattern: "fetch.*api/emails"
    - from: "src/components/email/email-detail.tsx"
      to: "/api/emails/[id]"
      via: "Fetches full email detail from API"
      pattern: "fetch.*api/emails/"
---

<objective>
Build the complete Inbox UI: three-pane resizable layout (folder tree, email list, detail pane), virtualized email list with infinite scroll, email detail view with sanitized HTML rendering and attachment strip, folder tree with unread counts, filter bar, sort options, bulk action checkboxes, and Gmail-style keyboard shortcuts.

Purpose: This plan creates the primary daily workflow UI where law firm staff spend most of their time reading and managing emails. The three-pane layout with keyboard shortcuts enables fast email triage.
Output: Full-featured Inbox page at /email with three resizable panes, virtualized list, HTML detail rendering, and keyboard navigation.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-client/03-CONTEXT.md
@.planning/phases/03-email-client/03-RESEARCH.md
@.planning/phases/03-email-client/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create three-pane resizable layout, folder tree component, and shadcn Resizable wrapper</name>
  <files>
    src/app/(dashboard)/email/layout.tsx
    src/app/(dashboard)/email/page.tsx
    src/components/email/inbox-layout.tsx
    src/components/email/folder-tree.tsx
    src/components/email/email-empty-state.tsx
    src/components/ui/resizable.tsx
    src/hooks/use-email-store.ts
  </files>
  <action>
Create `src/components/ui/resizable.tsx`:
- shadcn/ui wrapper around react-resizable-panels. Export `ResizablePanel`, `ResizablePanelGroup`, `ResizableHandle`. Follow shadcn pattern from ui.shadcn.com/docs/components/radix/resizable.
- Handle styling: thin resize handle (w-1) with hover highlight using brand color.

Create `src/hooks/use-email-store.ts`:
- Client-side state management hook for the email inbox. Uses useState/useCallback. Track:
  - `selectedKontoId` — active mailbox
  - `selectedOrdnerId` — active folder
  - `selectedEmailId` — currently viewed email
  - `filters` — { gelesen, veraktet, akteId, verantwortlichId, search, sort }
  - `checkedEmailIds` — Set of checked email IDs for bulk actions
- Functions: `selectFolder(kontoId, ordnerId)`, `selectEmail(emailId)`, `toggleCheck(emailId)`, `toggleCheckRange(fromId, toId)` (shift+click range select), `clearChecked()`, `updateFilters(partial)`.
- Persist selectedKontoId and selectedOrdnerId to localStorage for session continuity.

Create `src/app/(dashboard)/email/layout.tsx`:
- Email-specific layout that removes outer padding from the dashboard. Set `h-[calc(100vh-4rem)]` for full-height email view (subtracting header height). No extra margins.

Replace `src/app/(dashboard)/email/page.tsx`:
- Server component that renders InboxLayout. Pass initial data: user session, user's accessible mailbox IDs.
- Mark as `export const dynamic = "force-dynamic"`.

Create `src/components/email/inbox-layout.tsx`:
- "use client" component using ResizablePanelGroup from react-resizable-panels.
- Three panels: FolderTree (defaultSize=20, minSize=15, maxSize=30), EmailList (defaultSize=35, minSize=25), EmailDetail (defaultSize=45, minSize=30).
- `autoSaveId="email-inbox-layout"` for localStorage persistence of panel sizes per user decision.
- Pass email store state down to children via props (not context — keep simple).

Create `src/components/email/folder-tree.tsx`:
- "use client" component. Fetches folder data from `GET /api/email-folders?kontoId=all`.
- Renders grouped by mailbox: each EmailKonto is a collapsible section header showing mailbox name (e.g. "Kanzlei Hauptpostfach", "p.baumfalk@kanzlei.de").
- Under each mailbox: IMAP folders in tree structure. Special folders first (INBOX, Sent, Drafts, Trash, Junk, Archive) with appropriate lucide-react icons (Inbox, Send, FileEdit, Trash2, ShieldBan, Archive), then custom folders alphabetically.
- Each folder row shows: icon, name, unread count badge (only if >0, rounded pill in brand color).
- Click selects folder, updates emailStore.
- Real-time unread count updates via Socket.IO (listen for `email:folder-update` event).
- If no mailboxes configured: show empty state prompting admin to add a mailbox.

Create `src/components/email/email-empty-state.tsx`:
- Empty state component. If no mailbox configured → "Kein E-Mail-Konto eingerichtet" with button to settings (admin only). If mailbox configured but empty → "Keine neuen E-Mails" with last sync time.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Navigate to /email in the browser, verify three-pane layout renders with resize handles and folder tree shows mailbox structure</manual>
  </verify>
  <done>Three-pane resizable layout renders at /email with folder tree (left), email list area (center), detail area (right). Panels are resizable with draggable dividers and sizes persist in localStorage. Folder tree shows mailboxes with collapsible IMAP folders and unread count badges. Empty states display appropriate messages.</done>
</task>

<task type="auto">
  <name>Task 2: Create virtualized email list with filters, email detail view with sanitized HTML and attachments, keyboard shortcuts</name>
  <files>
    src/components/email/email-list.tsx
    src/components/email/email-list-row.tsx
    src/components/email/email-filters.tsx
    src/components/email/email-detail.tsx
    src/components/email/email-html-body.tsx
    src/components/email/email-actions-bar.tsx
    src/hooks/use-keyboard-shortcuts.ts
  </files>
  <action>
Create `src/components/email/email-filters.tsx`:
- "use client" component. Renders above the email list.
- Filter bar with: Status dropdown (Alle/Veraktet/Unveraktet), Akte typeahead dropdown (fetches from /api/akten), Verantwortlicher dropdown (fetches from /api/users), "Nur ungelesene" toggle button.
- Search input in list header for full-text search (debounced 300ms).
- Sort dropdown: Datum (default), Absender, Betreff, Akte.
- All filter changes call emailStore.updateFilters().

Create `src/components/email/email-list.tsx`:
- "use client" component using `useVirtualizer` from @tanstack/react-virtual.
- Fetches from `GET /api/emails` with current filters, kontoId, ordnerId from emailStore.
- Cursor-based infinite scroll: when virtualizer scrolls near bottom (overscan 10), fetch next page.
- Each row rendered by EmailListRow.
- Checkbox column for bulk actions with shift+click range select.
- Loading skeleton during initial fetch (3-4 gray shimmer rows).
- Show bulk action bar at top when any checkboxes selected: "X ausgewaehlt" with Verakten, Als gelesen, Loeschen buttons.

Create `src/components/email/email-list-row.tsx`:
- "use client" component rendering a single email row.
- Layout: checkbox | sender avatar/initial | sender name + subject + preview snippet | date/time | attachment icon | Veraktung badge.
- Sender: bold if ungelesen. Subject on first line, preview snippet (first ~80 chars of inhaltText) in muted color on second line.
- Date: relative if today ("14:23"), date if this year ("23. Feb"), full date if older ("23.02.2025"). Use date-fns format with German locale.
- Attachment paperclip icon (lucide Paperclip) if anhaengeCount > 0.
- Veraktung badge: if veraktet, show Aktenzeichen in small badge with light background tint (brand color at 10% opacity).
- Priority indicator: red exclamation for "hoch" priority (from X-Priority header).
- Click selects email (emailStore.selectEmail). Active email highlighted with brand-50 background.
- Hover: show quick-action icons (mark read, archive, delete) on right side.

Create `src/components/email/email-detail.tsx`:
- "use client" component. Fetches full email from `GET /api/emails/{id}` when selectedEmailId changes.
- Auto-mark as read: when email loads and gelesen=false, call `PATCH /api/emails/{id}/read`.
- Header section: subject (large), from (name + email), to/cc (collapsible if multiple), date (full format).
- Render EmailActionsBar below header.
- Render EmailHtmlBody for email content.
- Render attachment strip below header: horizontal strip with file type icons (lucide FileText, Image, FileSpreadsheet etc. based on mimeType), filename (truncated), size (formatted), click to download via presigned URL. PDF/image hover preview as tooltip.
- Loading skeleton while fetching.
- If no email selected: show centered placeholder "Waehlen Sie eine E-Mail aus".

Create `src/components/email/email-html-body.tsx`:
- "use client" component. Takes html string prop.
- Sanitize client-side with DOMPurify before rendering via dangerouslySetInnerHTML.
- CSS containment: wrapper div with `overflow: hidden`, `max-width: 100%`, prose styling.
- Add CSS reset inside email container to prevent email styles from bleeding out.
- Handle plain-text emails: wrap in <pre> with monospace font if no HTML body.

Create `src/components/email/email-actions-bar.tsx`:
- "use client" component with action buttons:
  - Antworten (Reply, lucide Reply icon)
  - Allen antworten (Reply All, lucide ReplyAll icon)
  - Weiterleiten (Forward, lucide Forward icon)
  - Verakten (case assignment, lucide FolderInput icon) — opens veraktung panel (Plan 04)
  - Ticket erstellen (lucide Ticket icon) — creates ticket from email (Plan 04)
  - Archivieren (lucide Archive icon) — moves to Archive folder
  - Spam (lucide ShieldBan icon) — moves to Junk folder
  - Loeschen (lucide Trash2 icon) — soft delete with 5s undo toast
- Veraktungs-Empfehlung banner: if email is not veraktet and user clicks Reply/Forward, show yellow banner "Diese E-Mail ist nicht veraktet — Jetzt verakten?" with quick-action button. Per locked user decision.
- Delete action: call DELETE /api/emails/{id}, show "E-Mail geloescht — Rueckgaengig" toast via sonner with 5s timeout, then hide email from list.
- Archive/Spam: call POST /api/emails/bulk with action and emailId.
- Reply/ReplyAll/Forward buttons emit events that will be consumed by the compose system (Plan 03). For now, use callback props that the parent can wire up.

Create `src/hooks/use-keyboard-shortcuts.ts`:
- Gmail-style keyboard shortcut hook. Uses useEffect with keydown listener on document.
- Shortcuts: J (next email), K (previous email), R (reply), A (reply all), F (forward), V (verakten), E (archive), # or Delete (delete), Enter (open selected), Escape (deselect/close).
- Only active when focus is not in an input/textarea element.
- Register shortcuts in the Command Palette (Cmd+K) via existing CommandPalette integration.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Navigate to /email, verify email list renders with virtualized rows, clicking an email shows detail with HTML body and attachments, keyboard shortcuts J/K navigate between emails</manual>
  </verify>
  <done>Virtualized email list renders with infinite scroll, sender/subject/date/preview/badges per row. Filter bar filters by status/akte/verantwortlicher/unread. Email detail shows sanitized HTML body with attachment download strip. Action bar has all 8 buttons. Gmail-style keyboard shortcuts work for navigation and actions. Bulk actions work via checkboxes.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. /email page renders three-pane resizable layout
3. Folder tree shows mailbox folders with unread counts
4. Email list virtualizes rows with correct data (sender, subject, date, preview, badges)
5. Email detail renders sanitized HTML safely
6. Keyboard shortcuts J/K navigate, R/A/F trigger reply/all/forward callbacks
7. Filter bar filters work (status, akte, verantwortlicher, unread)
8. Bulk actions (checkbox + shift-click range) work
</verification>

<success_criteria>
- Three-pane inbox layout renders correctly with resizable dividers
- Email list virtualizes 1000+ rows at 60fps
- HTML email bodies render safely without XSS
- All filter and sort options work
- Keyboard shortcuts functional
- TypeScript compilation passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-client/03-02-SUMMARY.md`
</output>
