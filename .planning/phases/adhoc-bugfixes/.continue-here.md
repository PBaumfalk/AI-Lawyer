---
phase: adhoc-bugfixes
task: ongoing
total_tasks: n/a
status: in_progress
last_updated: 2026-02-27T08:32:03.233Z
---

<current_state>
Ad-hoc session: Helena "denkt nach" Reasoning UI + multiple bugfixes. OnlyOffice Editor hängt bei "Editor wird geladen..." — das ist der nächste offene Bug (Screenshot vom User).
</current_state>

<completed_work>

- feat: "Helena denkt nach" collapsible reasoning UI (parseThinking for `<think>` tags, auto-expand/collapse, ChevronRight icon, violet border styling) — `src/components/ki/chat-messages.tsx`
- fix: System-Prompt Denkprozess-Instruktion vor Daten-Blöcke verschoben (war am Ende, blockierte Aktenkontext) — `src/app/api/ki-chat/route.ts`
- fix: Doppelte Nachrichten-Rendering wenn Modell keine `<think>`-Tags hat (redundanter Fallback-Block entfernt) — `src/components/ki/chat-messages.tsx`
- feat: LFM2-spezifische Sampling-Parameter (temperature=0.3, topK=50, minP=0.15, repeatPenalty=1.05) — `src/app/api/ki-chat/route.ts` + `src/lib/ai/provider.ts`
- fix: Raw SQL `"Dokument"` → `"dokumente"` (@@map Tabellenname) — ROOT CAUSE für fehlenden Aktenkontext — `src/app/api/ki-chat/route.ts`
- fix: DOCX-Vorschau Polling + klickbarer "Vorschau als PDF" Button — `src/components/dokumente/document-detail.tsx`
- fix: Polling-Endlosschleife behoben (dokument aus useEffect deps entfernt, needsPreviewPoll boolean) — `src/components/dokumente/document-detail.tsx`
- Debug-Sessions resolved: helena-no-akte-context, helena-slow-responses, ocr-pdf-preview-broken
</completed_work>

<remaining_work>

- BUG: OnlyOffice Editor zeigt "Editor wird geladen..." Dauerschleife (Screenshot vorhanden). Betrifft DOCX-Bearbeitung. Mögliche Ursachen: OnlyOffice Docs Server nicht erreichbar, JWT/Token-Konfiguration, documentServerUrl falsch, oder Callback-URL-Problem.
- Debug-Logs in ki-chat/route.ts (akteId-Logging) können entfernt werden — nur temporär für Debugging
- LFM2-Modell: funktioniert mit Sampling-Params besser, aber insgesamt schwächer als qwen3.5 für Helena. User sollte evaluieren ob LFM2 oder qwen3.5 produktiv genutzt wird.
</remaining_work>

<decisions_made>

- `<think>`-Tag-Parsing im Frontend statt Backend — keine Streaming-Änderungen nötig, Parser arbeitet auf dem content-String
- Denkprozess-Instruktion nach "Quellen & Fakten" platziert (vor Modi-Sektionen), damit Akte-Kontext und Quellen-Blöcke NACH den Hard Limits kommen
- LFM2-Erkennung via `modelName.startsWith("lfm")` für automatische Sampling-Parameter
- Polling-Intervall 3s für DOCX-Vorschau, gesteuert durch abgeleiteten Boolean statt dokument-Objekt
</decisions_made>

<blockers>
- OnlyOffice Editor lädt nicht — nächster zu untersuchender Bug
</blockers>

<context>
Session war primär Feature-Arbeit (Reasoning UI) die in Bugfixing eskalierte. Der "Dokument"-Tabellennamen-Bug war der Root Cause für den fehlenden Aktenkontext seit langem. OnlyOffice-Problem ist unabhängig davon — vermutlich Docker/Netzwerk/Config-Issue. MEMORY.md hat OnlyOffice-Hinweise (JWT, documentServerUrl, ALLOW_PRIVATE_IP_ADDRESS).
</context>

<next_action>
Start with: OnlyOffice Editor "wird geladen" debuggen. Check: docker compose logs onlyoffice, Browser-Konsole für JS-Fehler, documentServerUrl in der OnlyOffice-Komponente, JWT-Konfiguration (JWT_ENABLED, ONLYOFFICE_SECRET). Siehe MEMORY.md für bekannte OnlyOffice-Gotchas.
</next_action>
