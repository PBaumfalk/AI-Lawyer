---
phase: 02.1-wire-frist-reminder-pipeline
plan: 01
subsystem: worker
tags: [bullmq, nodemailer, cron, notifications, email, deduplication, fristen]

# Dependency graph
requires:
  - phase: 02-deadline-calculation-document-templates
    provides: "processFristReminders processor, queue definitions, settings infrastructure, notification service"
provides:
  - "Live frist-reminder BullMQ worker processing jobs from frist-reminder queue"
  - "Daily cron at 06:00 Europe/Berlin (configurable via SystemSettings)"
  - "Dual-channel delivery: in-app notification + SMTP email"
  - "Deduplication preventing duplicate reminders per day"
  - "Weekend/holiday shift to preceding Friday"
  - "Catch-up for missed reminders after downtime"
  - "Consolidated queue registry (single source of truth)"
  - "Email transport helper (sendEmail, isEmailConfigured)"
  - "Fristen default settings (scan_zeit, email_enabled, max_retry_age_days)"
affects: [admin-monitoring, kanzlei-einstellungen, notifications]

# Tech tracking
tech-stack:
  added: [nodemailer@7.0.13, "@types/nodemailer"]
  patterns: [dual-channel-notification, deduplication-via-db, weekend-holiday-shift, catch-up-scan]

key-files:
  created:
    - src/lib/email/send.ts
  modified:
    - src/lib/queue/queues.ts
    - src/lib/queues.ts
    - src/worker.ts
    - src/workers/processors/frist-reminder.ts
    - src/lib/settings/defaults.ts
    - .env.example

key-decisions:
  - "nodemailer v7.0.13 (not v8) for next-auth peer dependency compatibility"
  - "Deduplication via Notification table query (no new DB model needed)"
  - "Lazy transporter creation in email/send.ts (no connection at import time)"
  - "kurzrubrum (not rubrum) in Akte reference per actual Prisma schema"

patterns-established:
  - "Dual-channel notification: in-app first (fast, local), then email (best-effort, never throws)"
  - "Deduplication via DB query on Notification.data JSON path before every send"
  - "Weekend/holiday shift: shouldFireToday() checks preceding business day"
  - "Settings-driven cron: read from SystemSettings at startup, reschedule on settings:changed"

requirements-completed: [REQ-FK-003]

# Metrics
duration: 5min
completed: 2026-02-24
---

# Phase 2.1 Plan 01: Wire Frist-Reminder Pipeline Summary

**BullMQ frist-reminder worker with daily cron, dual-channel delivery (in-app + email), deduplication, weekend/holiday shift, and catch-up after downtime**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-24T12:04:54Z
- **Completed:** 2026-02-24T12:10:07Z
- **Tasks:** 3
- **Files modified:** 8

## Accomplishments
- Consolidated dual queue registry files into single source of truth (src/lib/queue/queues.ts)
- Frist-reminder processor enhanced with deduplication, dual-channel delivery, weekend/Feiertag shift, and catch-up
- Worker.ts wired with async startup calling initializeDefaults() + registerFristReminderJob()
- Admin-configurable scan time with live reschedule via settings:changed Redis pub/sub
- Email transport helper with graceful failure handling (never throws, returns boolean)

## Task Commits

Each task was committed atomically:

1. **Task 1: Consolidate queue registry, add email transport, add settings defaults** - `e3bc5e8` (feat)
2. **Task 2: Enhance frist-reminder processor with dedup, dual-channel, weekend shift, catch-up** - `ef236da` (feat)
3. **Task 3: Register frist-reminder worker in worker.ts, wire startup init, settings reschedule** - `fda01a2` (feat)

## Files Created/Modified
- `src/lib/queue/queues.ts` - Consolidated queue registry with fristReminderQueue, ALL_QUEUES, registerFristReminderJob()
- `src/lib/queues.ts` - Gutted to thin re-export for backward compatibility
- `src/lib/email/send.ts` - Nodemailer SMTP transport wrapper with sendEmail() and isEmailConfigured()
- `src/lib/settings/defaults.ts` - Added fristen.scan_zeit, fristen.email_enabled, fristen.max_retry_age_days defaults
- `src/workers/processors/frist-reminder.ts` - Enhanced with deduplication, dual-channel, weekend shift, catch-up, Akte reference
- `src/worker.ts` - Registered fristReminderWorker, async startup, settings:changed handler
- `.env.example` - Added SMTP_HOST, SMTP_PORT, SMTP_SECURE, SMTP_USER, SMTP_PASS, SMTP_FROM
- `package.json` - Added nodemailer ^7.0.7, @types/nodemailer

## Decisions Made
- Used nodemailer v7.0.13 instead of v8 to satisfy next-auth peer dependency (v8 conflicted)
- Deduplication implemented via Notification table JSON path query rather than adding new DB table
- Lazy transporter creation avoids SMTP connection at import time (only connects on first send)
- Used kurzrubrum (actual Prisma field name) instead of rubrum in Akte references
- Catch-up respects max_retry_age_days for email but always sends in-app (in-app is free/fast)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] nodemailer v8 peer dependency conflict**
- **Found during:** Task 1 (npm install nodemailer)
- **Issue:** nodemailer v8 conflicted with next-auth peer dependency requiring ^7.0.7
- **Fix:** Installed nodemailer@^7.0.7 instead
- **Files modified:** package.json, package-lock.json
- **Verification:** npm install succeeded, TypeScript compilation passes
- **Committed in:** e3bc5e8 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Minor version adjustment, no functional impact. nodemailer v7 API is identical for our use case.

## Issues Encountered
- Pre-existing TSC error in `.next/types/app/api/ordner-schemata/route.ts` (generated file, unrelated to our changes) -- confirmed pre-existing via git stash test

## User Setup Required

SMTP configuration is optional. Without it, only in-app notifications are sent. To enable email delivery:
- Set `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM` in `.env`
- See `.env.example` for documentation

## Next Phase Readiness
- Frist-reminder pipeline is fully wired and ready for runtime
- Email delivery works when SMTP is configured; gracefully degrades when not
- Admin can configure scan time via Kanzlei-Einstellungen (fristen.scan_zeit)
- Ready for Phase 2.2 or further feature development

---
*Phase: 02.1-wire-frist-reminder-pipeline*
*Completed: 2026-02-24*
