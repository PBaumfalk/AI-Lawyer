---
phase: 03.1-wire-email-realtime-compose
verified: 2026-02-24T16:00:00Z
status: passed
score: 7/7 must-haves verified
re_verification: false
---

# Phase 3.1: Wire Email Real-Time + Compose Verification Report

**Phase Goal:** Real-time email notifications arrive in the browser via Socket.IO (mailbox room wiring), compose preview shows the email signature, and ComposeManager is available app-wide for compose-from-anywhere — closing all 3 integration gaps and 2 broken E2E flows from the v3.4 audit.
**Verified:** 2026-02-24T16:00:00Z
**Status:** passed
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Socket.IO clients join `mailbox:{kontoId}` room when viewing email — rooms.ts handles `join:mailbox` and `leave:mailbox` events | VERIFIED | `src/lib/socket/rooms.ts` lines 49-62: both handlers exist, follow exact `join:akte`/`leave:akte` pattern, with input validation and `socket.join()`/`socket.leave()` calls |
| 2 | When IMAP connection-manager emits `email:folder-update` to `mailbox:{kontoId}` room, browser clients in that room receive the event | VERIFIED | connection-manager.ts lines 126-132 emits to `mailbox:{kontoId}`; inbox-layout.tsx lines 41-58 bridges `socket.on("email:folder-update")` to `window.dispatchEvent(new CustomEvent("email:folder-update"))` |
| 3 | folder-tree.tsx unread badge updates in real-time without page refresh when new email arrives | VERIFIED | folder-tree.tsx lines 136-160 listens for `window` CustomEvent `email:folder-update` and calls `setKonten()` to update unread counts in React state; bridge in inbox-layout.tsx dispatches to window — chain is complete |
| 4 | GET /api/email-signature?kontoId= returns rendered signature HTML by calling getSignatureForUser() | VERIFIED | `src/app/api/email-signature/route.ts` exports `GET`, validates session (401) and kontoId param (400), calls `getSignatureForUser(session.user.id, kontoId)`, returns `{ signature }` JSON |
| 5 | compose-popup.tsx signature preview shows the user's personalized signature from the email-signature API | VERIFIED | compose-popup.tsx lines 121-140: `useEffect` fetches `/api/email-signature?kontoId=${kontoId}` on kontoId change, inserts returned HTML into editor via `editorRef.current.insertHTML()` |
| 6 | ComposeManager provider is mounted in the email layout so useComposeManager() returns a working openCompose function | VERIFIED | `src/app/(dashboard)/email/layout.tsx` has `"use client"`, imports `ComposeManager`, wraps `{children}` with `<ComposeManager>`; ComposeManager exports `useComposeManager()` hook backed by real `useState` |
| 7 | Room cleanup: leaving email pages emits leave:mailbox; switching kontoId leaves old room before joining new one | VERIFIED | inbox-layout.tsx lines 29-38: `useEffect` cleanup function emits `leave:mailbox` for the captured `kontoId`; dependency array `[socket, isConnected, emailStore.selectedKontoId]` ensures the effect re-runs on kontoId change, leaving the old room before joining the new one |

**Score:** 7/7 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/lib/socket/rooms.ts` | Socket.IO room handlers for mailbox rooms containing `join:mailbox` | VERIFIED | File exists, 70 lines, substantive — both `join:mailbox` and `leave:mailbox` handlers present inside `io.on("connection")` callback, JSDoc updated to include `mailbox:{kontoId}` convention |
| `src/components/email/inbox-layout.tsx` | Socket-to-CustomEvent bridge and mailbox room join/leave lifecycle, containing `join:mailbox` | VERIFIED | File exists, 182 lines, substantive — two separate `useEffect` blocks: one for room lifecycle (lines 29-38), one for event bridge (lines 41-58); `useSocket` imported and used |
| `src/app/api/email-signature/route.ts` | GET endpoint returning rendered email signature HTML, exporting `GET` | VERIFIED | File created, 37 lines, substantive — exports `GET`, validates auth and kontoId, calls `getSignatureForUser()`, proper error status codes |
| `src/app/(dashboard)/email/layout.tsx` | Email layout wrapping children with ComposeManager provider, containing `ComposeManager` | VERIFIED | File exists, 22 lines, substantive — `"use client"` directive present, imports `ComposeManager`, children are wrapped in `<ComposeManager>` |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `src/lib/socket/rooms.ts` | `src/lib/email/imap/connection-manager.ts` | Client joins `mailbox:{kontoId}` room that connection-manager already emits to | WIRED | connection-manager.ts line 127 emits to `mailbox:${konto.id}`; rooms.ts adds clients to that exact room name via `socket.join(`mailbox:${kontoId}`)` |
| `src/components/email/inbox-layout.tsx` | `src/components/email/folder-tree.tsx` | Bridge dispatches window CustomEvent `email:folder-update` that folder-tree already listens for | WIRED | inbox-layout.tsx line 50 dispatches `new CustomEvent("email:folder-update", { detail: data })`; folder-tree.tsx lines 150-153 listens via `window.addEventListener("email:folder-update", handleFolderUpdate)` and calls `setKonten()` — confirmed single dispatch point, no duplication |
| `src/app/api/email-signature/route.ts` | `src/lib/email/signature.ts` | Calls `getSignatureForUser()` which loads template and renders with user data | WIRED | route.ts line 27: `const signature = await getSignatureForUser(session.user.id, kontoId)`; `getSignatureForUser` (signature.ts line 38) does full Prisma query for EmailKonto.signaturVorlage and User profile, renders HTML |
| `src/app/(dashboard)/email/layout.tsx` | `src/components/email/compose-manager.tsx` | Wraps children with ComposeManager context provider | WIRED | layout.tsx line 3 imports `{ ComposeManager }` from compose-manager; lines 16-20 wrap children in `<ComposeManager>...</ComposeManager>`; compose-manager.tsx exports `ComposeManager` and `useComposeManager()` backed by real context |

---

### Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|-------------|-------------|--------|----------|
| REQ-IF-003 | 03.1-01-PLAN | Custom server.ts + Socket.IO WebSocket on same port | SATISFIED | Socket.IO rooms infrastructure (rooms.ts) now includes mailbox room handlers. The `mailbox:{kontoId}` gap is closed — browsers can join the room and receive `email:folder-update` events. |
| REQ-EM-001 | 03.1-01-PLAN | IMAP-Sync with Real-Time (IMAP IDLE) for incoming emails | SATISFIED | End-to-end pipeline verified: IMAP IDLE (idle-handler + connection-manager) emits socket event to `mailbox:{kontoId}` room; inbox-layout bridges to CustomEvent; folder-tree updates unread badge. |
| REQ-EM-003 | 03.1-01-PLAN | Inbox page (List, Pagination, Filter) | SATISFIED | Folder-tree unread badge now updates in real-time via the Socket.IO bridge. Inbox UI (inbox-layout, email-list, folder-tree) was already built; this phase closes the real-time gap. |
| REQ-EM-006 | 03.1-01-PLAN | Compose-View (An, CC, BCC, Betreff, Rich-Text, Akte, Attachments from DMS) | SATISFIED | Two sub-gaps closed: (1) `/api/email-signature` route created — compose-popup.tsx now fetches and inserts signature HTML instead of getting 404; (2) `ComposeManager` mounted in email layout — `useComposeManager()` returns real context with working `openCompose`. |

**Orphaned requirements check:** REQUIREMENTS.md traceability table maps all four IDs to Phase 3 as "Complete". No additional IDs are mapped specifically to Phase 3.1 that are not covered in the PLAN.

---

### Anti-Patterns Found

No anti-patterns detected.

| File | Pattern | Severity | Result |
|------|---------|----------|--------|
| `src/lib/socket/rooms.ts` | TODO/FIXME/placeholder scan | — | None found |
| `src/app/api/email-signature/route.ts` | TODO/FIXME/placeholder, empty return, console.log stub | — | `console.error` present at line 30 — this is proper error logging, not a stub |
| `src/components/email/inbox-layout.tsx` | TODO/FIXME/placeholder, empty handler scan | — | None found |
| `src/app/(dashboard)/email/layout.tsx` | TODO/FIXME/placeholder scan | — | None found |

**Notable observation (info, not a blocker):** `compose-popup.tsx` line 86 sets `handleVeraktungComplete` callback body as empty — `// The simplest approach: the email detail will refetch on its own`. This is a pre-existing pattern from Phase 3, not introduced in this phase, and does not affect any of the 7 truths being verified.

---

### Human Verification Required

The following items cannot be verified programmatically and should be tested by a human in the running application:

#### 1. Real-Time Folder Badge Update

**Test:** Open the email inbox while monitoring the network tab. With a connected IMAP account, trigger an incoming email (send from external account). Observe the folder-tree sidebar.
**Expected:** The INBOX unread badge increments within 1-2 seconds without any page refresh or manual action.
**Why human:** Requires a live IMAP connection, running Socket.IO server with Redis, and actual email delivery. Cannot verify socket event flow end-to-end from static file analysis alone.

#### 2. Compose Signature Preview

**Test:** Open a compose window from any email page. Observe the editor body immediately after the compose popup opens.
**Expected:** The editor contains the user's configured email signature below two blank lines. If no signature is configured on the EmailKonto, the editor is empty (no error shown).
**Why human:** Requires a configured EmailKonto with a `signaturVorlage` template and a logged-in user. The code path is verified but the rendered HTML depends on DB data.

#### 3. useComposeManager from Non-Compose Component

**Test:** Navigate to the email inbox page. If any button triggers `useComposeManager().openCompose()` (e.g., a "Compose" button in the inbox toolbar), click it.
**Expected:** A compose popup opens. This verifies that `useComposeManager()` returns the real context (not the default no-op) because `ComposeManager` is now mounted in the layout.
**Why human:** Requires runtime context resolution — static analysis confirms the provider is mounted but cannot confirm React context propagation at runtime.

---

### Gaps Summary

No gaps. All 7 must-have truths are verified, all 4 artifacts pass levels 1 (exists), 2 (substantive), and 3 (wired), all 4 key links are confirmed WIRED against actual code, and all 4 requirement IDs are satisfied.

The phase closed three integration gaps from the v3.4 audit exactly as planned:
- **INT-001** (critical): Socket.IO mailbox room join/leave handlers added to rooms.ts; inbox-layout.tsx joins the room on mount and bridges socket events to folder-tree via window CustomEvent.
- **INT-002** (medium): `/api/email-signature` route created and correctly delegates to `getSignatureForUser()` from lib/email/signature.ts; compose-popup already fetched this endpoint and now receives real data.
- **INT-003** (low): `ComposeManager` provider mounted in email layout as a client component; `useComposeManager()` now returns working `openCompose` from any email page.

---

_Verified: 2026-02-24T16:00:00Z_
_Verifier: Claude (gsd-verifier)_
