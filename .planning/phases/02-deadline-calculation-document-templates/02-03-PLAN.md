---
phase: 02-deadline-calculation-document-templates
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/onlyoffice.ts
  - src/app/api/onlyoffice/callback/route.ts
  - src/app/api/onlyoffice/config/[dokumentId]/route.ts
  - src/app/api/onlyoffice/convert/route.ts
  - src/app/api/dokumente/[id]/versionen/route.ts
  - src/app/api/dokumente/[id]/versionen/[versionId]/restore/route.ts
  - src/app/api/dokumente/[id]/status/route.ts
  - src/components/dokumente/onlyoffice-editor.tsx
  - prisma/schema.prisma
autonomous: true
requirements:
  - REQ-DV-010
  - REQ-DV-011

must_haves:
  truths:
    - "Document key is stable per version (format: {dokumentId}_v{version}), enabling co-editing where multiple users share the same editing session"
    - "After save (callback status 2), version increments in DB so next open gets a fresh session"
    - "Forcesave (callback status 6) saves content but does NOT increment version (session continues)"
    - "Track Changes are enabled and visible -- attorney can see marked changes, accept/reject"
    - "Comments workflow works -- discussion threads, resolvable, answerable"
    - "Auto-save fires every 30 seconds via forcesave: true"
    - "Document versioning creates auto-version on close, supports named manual snapshots, and old versions are viewable + restorable (restore creates new version)"
    - "Conversion API endpoint converts DOCX to PDF via OnlyOffice"
    - "Document status workflow enforces Entwurf -> In Pruefung -> Freigegeben -> Versendet transitions with Schreibschutz after Freigegeben"
  artifacts:
    - path: "src/lib/onlyoffice.ts"
      provides: "Enhanced buildEditorConfig with stable key, Track Changes, Comments, forcesave"
      exports: ["buildEditorConfig", "signPayload", "generateDocumentKey", "rewriteOnlyOfficeUrl"]
    - path: "src/app/api/onlyoffice/callback/route.ts"
      provides: "Enhanced callback handler with version increment on status 2, no increment on status 6"
      exports: ["POST"]
    - path: "src/app/api/onlyoffice/config/[dokumentId]/route.ts"
      provides: "Enhanced config endpoint using version-based key"
      exports: ["GET"]
    - path: "src/app/api/onlyoffice/convert/route.ts"
      provides: "DOCX to PDF conversion endpoint"
      exports: ["POST"]
    - path: "src/app/api/dokumente/[id]/versionen/route.ts"
      provides: "Version history list and named snapshot creation"
      exports: ["GET", "POST"]
    - path: "src/app/api/dokumente/[id]/versionen/[versionId]/restore/route.ts"
      provides: "Version restore endpoint (creates new version)"
      exports: ["POST"]
    - path: "src/app/api/dokumente/[id]/status/route.ts"
      provides: "Document status transition endpoint with RBAC"
      exports: ["PATCH"]
    - path: "src/components/dokumente/onlyoffice-editor.tsx"
      provides: "Enhanced editor component with Track Changes UI, versioning controls"
      min_lines: 60
  key_links:
    - from: "src/app/api/onlyoffice/config/[dokumentId]/route.ts"
      to: "src/lib/onlyoffice.ts"
      via: "buildEditorConfig with version from DB"
      pattern: "buildEditorConfig.*version"
    - from: "src/app/api/onlyoffice/callback/route.ts"
      to: "prisma.dokument"
      via: "version increment on status 2"
      pattern: "version.*increment.*1"
    - from: "src/app/api/onlyoffice/convert/route.ts"
      to: "ONLYOFFICE_INTERNAL_URL/converter"
      via: "HTTP POST to OnlyOffice Conversion API"
      pattern: "converter"
    - from: "src/app/api/dokumente/[id]/status/route.ts"
      to: "src/lib/onlyoffice.ts"
      via: "buildEditorConfig with mode=view for Freigegeben documents"
      pattern: "mode.*view"
---

<objective>
Rebuild the OnlyOffice integration for stable save/load, co-editing, Track Changes, Comments, and versioning by fixing the document.key strategy and enhancing the callback handler. Add DOCX-to-PDF conversion endpoint. Implement Dokument-Status-Workflow (Entwurf -> In Pruefung -> Freigegeben -> Versendet) with Schreibschutz enforcement.

Purpose: The current implementation uses `Date.now()` in document.key, breaking co-editing (each user gets a separate session). This rebuild ensures reliable document editing as the foundation for the template system, Briefkopf application, and PDF export in Plan 02-04. The status workflow enforces legal document approval processes.

Output: Enhanced onlyoffice.ts library, fixed callback handler with version management, conversion API endpoint, status transition endpoint, and enhanced editor component.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md

@src/lib/onlyoffice.ts
@src/app/api/onlyoffice/callback/route.ts
@src/app/api/onlyoffice/config/[dokumentId]/route.ts
@src/components/dokumente/onlyoffice-editor.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stable Document Key + Enhanced Callback Handler + Versioning Schema + Dokument-Status-Workflow</name>
  <files>
    prisma/schema.prisma,
    src/lib/onlyoffice.ts,
    src/app/api/onlyoffice/callback/route.ts,
    src/app/api/onlyoffice/config/[dokumentId]/route.ts,
    src/app/api/dokumente/[id]/status/route.ts
  </files>
  <action>
    **1. Schema Enhancement (prisma/schema.prisma):**
    Add to `Dokument` model:
    - Ensure `version Int @default(1)` exists (already present).
    - Add `DokumentVersion` model for version history:
      ```
      model DokumentVersion {
        id          String   @id @default(cuid())
        dokumentId  String
        dokument    Dokument @relation(fields: [dokumentId], references: [id], onDelete: Cascade)
        version     Int
        dateipfad   String   // MinIO path to this version's file
        groesse     Int
        name        String?  // Named snapshot label (null = auto-version)
        createdById String
        createdBy   User     @relation(fields: [createdById], references: [id])
        createdAt   DateTime @default(now())
        @@unique([dokumentId, version])
        @@index([dokumentId])
        @@map("dokument_versionen")
      }
      ```
    - Add `versionen DokumentVersion[]` relation on Dokument model.
    - Add `DokumentStatus` enum if not present: ENTWURF, IN_PRUEFUNG, FREIGEGEBEN, VERSENDET.
    - Add `dokumentStatus DokumentStatus @default(ENTWURF)` to Dokument model (or enhance existing status field).
    - Add `freigegebenVonId String?` and `freigegebenAm DateTime?` to Dokument model for tracking who approved.
    Run `npx prisma db push`.

    **2. Stable Key Generation (src/lib/onlyoffice.ts):**
    Add `generateDocumentKey(dokumentId: string, version: number): string` function:
    - Returns `${dokumentId}_v${version}` (stable per document+version, changes only after save).
    - This is the CRITICAL fix: same key = same editing session = co-editing works.

    Update `buildEditorConfig()`:
    - Accept `version: number` and `dokumentStatus: string` as required parameters (no more Date.now()).
    - Use `generateDocumentKey(dokumentId, version)` for document.key.
    - **Schreibschutz enforcement (per locked decision):** If `dokumentStatus` is "FREIGEGEBEN" or "VERSENDET", force `mode: "view"` and `permissions.edit: false` regardless of requested mode. This ensures read-only after Freigabe.
    - Enable Track Changes in customization:
      ```typescript
      customization: {
        autosave: true,
        comments: true,
        compactHeader: false,
        forcesave: true,  // Periodic saves every ~30 seconds
        review: {
          showReviewChanges: true,
          reviewDisplay: "markup",
          trackChanges: true,
        },
      }
      ```
    - Set `document.permissions`:
      ```typescript
      permissions: {
        comment: true,
        download: true,
        edit: mode === "edit",
        review: true,        // Enable Track Changes
        print: true,
      }
      ```

    **3. Enhanced Callback Handler (src/app/api/onlyoffice/callback/route.ts):**
    Fix the callback handler for correct version lifecycle:

    Status 2 (document ready for saving, all editors closed):
    - Download document from `url` in callback body.
    - Create DokumentVersion record (snapshot of previous version before overwrite).
    - Upload new content to MinIO at existing dateipfad.
    - Increment `version` in Dokument table: `version: { increment: 1 }`.
    - Update `groesse`, `updatedAt`.
    - KEY: Next editor open will use new version -> new key -> fresh session.

    Status 6 (forcesave, periodic auto-save):
    - Download and upload to MinIO (save current content).
    - Do NOT increment version (session is still active, key must stay same for co-editing).
    - Do NOT create DokumentVersion (intermediate saves, not snapshots).

    Status 1 (document being edited):
    - Return `{ error: 0 }` (acknowledge, no action needed).

    Status 4 (document closed with no changes):
    - Return `{ error: 0 }` (acknowledge, no action needed).

    Handle error cases gracefully. Log all callback statuses for debugging.

    **4. Enhanced Config Endpoint (src/app/api/onlyoffice/config/[dokumentId]/route.ts):**
    - Load Dokument from DB including `version` and `dokumentStatus`.
    - Call `buildEditorConfig({ ..., version: dokument.version, dokumentStatus: dokument.dokumentStatus })`.
    - Return config with stable key.
    - Add optional `?mode=view` query param for read-only access (Track Changes visible but not editable).
    - Schreibschutz: If document status is FREIGEGEBEN or VERSENDET, always return view-mode config regardless of requested mode.

    **5. Dokument-Status Transition API (src/app/api/dokumente/[id]/status/route.ts):**
    PATCH endpoint accepting `{ status: DokumentStatus }`.
    Enforces valid transitions per locked decision:
    - ENTWURF -> IN_PRUEFUNG: any user with edit access.
    - IN_PRUEFUNG -> FREIGEGEBEN: **only ANWALT or ADMIN** role (per locked decision "Freigabe only by Anwalt"). Sets freigegebenVonId and freigegebenAm.
    - FREIGEGEBEN -> VERSENDET: any user with edit access.
    - FREIGEGEBEN -> ENTWURF: **only ANWALT or ADMIN** (revert Freigabe, per locked decision "Nur Anwalt kann zurueck auf In Bearbeitung setzen"). Clears freigegebenVonId/Am.
    - All other transitions rejected with 400 error.
    Log every transition to audit trail (who, when, from status, to status).
    After transitioning to FREIGEGEBEN, any active OnlyOffice editing sessions will see the document as read-only on next config refresh.
  </action>
  <verify>
    <automated>npx prisma validate && npx tsc --noEmit src/lib/onlyoffice.ts src/app/api/onlyoffice/callback/route.ts src/app/api/dokumente/[id]/status/route.ts</automated>
    <manual>Open a document in OnlyOffice, verify stable key in editor config, make edits, close, reopen and verify content persisted with new version. Test status transitions and verify Schreibschutz after Freigabe.</manual>
  </verify>
  <done>Document key format is {dokumentId}_v{version}. Callback status 2 increments version and creates DokumentVersion snapshot. Status 6 saves without incrementing. Track Changes and Comments enabled in editor config. Co-editing works (same key for same document+version). DokumentStatus enum and transition API enforce Entwurf -> In Pruefung -> Freigegeben -> Versendet workflow. Schreibschutz is enforced after Freigegeben (view-only in OnlyOffice).</done>
</task>

<task type="auto">
  <name>Task 2: Conversion API + Enhanced Editor Component + Version History</name>
  <files>
    src/app/api/onlyoffice/convert/route.ts,
    src/app/api/dokumente/[id]/versionen/route.ts,
    src/app/api/dokumente/[id]/versionen/[versionId]/restore/route.ts,
    src/components/dokumente/onlyoffice-editor.tsx
  </files>
  <action>
    **1. Conversion API (src/app/api/onlyoffice/convert/route.ts):**
    POST endpoint accepting `{ dokumentId, outputType?: 'pdf' | 'docx' | 'odt' }` (default: 'pdf').
    - Load Dokument from DB.
    - Generate download URL for the document (presigned MinIO URL or internal URL).
    - Call OnlyOffice Conversion API: POST to `${ONLYOFFICE_INTERNAL_URL}/converter` with:
      ```json
      {
        "filetype": "docx",
        "key": "convert_{dokumentId}_{timestamp}",
        "outputtype": "pdf",
        "title": "{document.name}",
        "url": "{downloadUrl}"
      }
      ```
    - Sign payload with JWT if OnlyOffice JWT is enabled (use `signPayload()` from onlyoffice.ts).
    - Use `rewriteOnlyOfficeUrl()` for the returned fileUrl (per project memory: OnlyOffice callbacks return internal Docker URLs).
    - Download the converted PDF and return as response with correct Content-Type + Content-Disposition headers.
    - Handle async conversion (poll if `endConvert` is false).
    Auth: any authenticated user with access to the document.

    **2. Version History API (src/app/api/dokumente/[id]/versionen/route.ts):**
    GET: List all DokumentVersion records for a document, ordered by version DESC. Include createdBy user name, snapshot name, createdAt.
    POST: Create named snapshot. Body: `{ name: string }`. Creates DokumentVersion with current document content and the given name.

    **3. Version Restore API (src/app/api/dokumente/[id]/versionen/[versionId]/restore/route.ts):**
    POST: Restore a previous version.
    - Does NOT overwrite history. Instead:
      1. Creates new DokumentVersion snapshot of current state.
      2. Copies the old version's file content to the document's dateipfad.
      3. Increments document version number.
    - This ensures restore creates a new version, old versions preserved (per user decision).

    **4. Enhanced Editor Component (src/components/dokumente/onlyoffice-editor.tsx):**
    Enhance the existing OnlyOffice editor component:
    - Use `@onlyoffice/document-editor-react` (already installed, per project memory: use the React component, NOT manual DocEditor creation).
    - `documentServerUrl` as required prop (per project memory).
    - Events via props (`events_onDocumentReady`, `events_onError`, etc.) -- NOT in config.events (per project memory: Object.assign overwrites).
    - Add version history panel: Button "Versionen" opens a sidebar/dropdown listing all DokumentVersion records. Each entry shows version number, name (if named), createdBy, createdAt. "Wiederherstellen" button calls restore API.
    - Add "Snapshot erstellen" button for named manual snapshots.
    - Track Changes toolbar integration: Show current review mode indicator (markup/simple/final).
    - Connection status indicator: Show "Verbunden" / "Offline" badge. On disconnect, display warning "Offline -- Aenderungen werden gespeichert wenn Verbindung wiederhergestellt" (per user decision).
    - Add "Als PDF exportieren" button that calls the conversion API and triggers download.
    - **Dokument-Status indicator:** Show current status badge (Entwurf/In Pruefung/Freigegeben/Versendet) in the editor header. If status is FREIGEGEBEN or VERSENDET, show prominent "Schreibgeschuetzt" banner. Add status transition buttons based on current status and user role.
    - Proper cleanup on unmount (destroy editor instance).
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Open document in OnlyOffice, use Track Changes, add Comment, export as PDF, view version history, create named snapshot, restore old version. Test status transitions from editor UI.</manual>
  </verify>
  <done>Conversion API converts DOCX to PDF via OnlyOffice. Version history API provides list/create/restore. Editor component shows version panel, Track Changes controls, connection status, PDF export button, and Dokument-Status indicator with transition buttons. Restore creates new version (old preserved). Schreibschutz banner visible for Freigegeben/Versendet documents.</done>
</task>

</tasks>

<verification>
```bash
# Schema validates
npx prisma validate

# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build

# Conversion endpoint accessible
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3000/api/onlyoffice/convert -H "Content-Type: application/json" -d '{"dokumentId":"test"}'
```
</verification>

<success_criteria>
- Document key format is `{dokumentId}_v{version}` -- no more Date.now()
- Two users opening the same document share the same editing session (co-editing)
- Save (status 2) increments version, forcesave (status 6) does not
- Track Changes enabled and visible in editor
- Comments workflow functional (create, reply, resolve)
- Auto-save every ~30 seconds via forcesave
- DokumentVersion history tracks all versions
- Named manual snapshots possible
- Version restore creates new version (non-destructive)
- DOCX-to-PDF conversion works via OnlyOffice Conversion API
- Dokument-Status-Workflow enforces Entwurf -> In Pruefung -> Freigegeben -> Versendet transitions
- Schreibschutz (read-only) enforced after Freigegeben -- only Anwalt can revert
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-03-SUMMARY.md`
</output>
