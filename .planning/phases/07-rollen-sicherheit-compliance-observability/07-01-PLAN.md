---
phase: 07-rollen-sicherheit-compliance-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/
  - src/lib/rbac.ts
  - src/middleware.ts
  - src/components/layout/sidebar.tsx
  - src/app/api/akten/route.ts
  - src/app/api/akten/[id]/route.ts
  - src/app/api/akten/[id]/dokumente/route.ts
  - src/app/api/akten/[id]/dokumente/aus-vorlage/route.ts
  - src/app/api/akten/[id]/dokumente/neu/route.ts
  - src/app/api/akten/[id]/beteiligte/route.ts
  - src/app/api/akten/[id]/historie/route.ts
  - src/app/api/akten/[id]/conflict-check/route.ts
  - src/app/api/kalender/route.ts
  - src/app/api/kalender/[id]/route.ts
  - src/app/api/dokumente/[id]/route.ts
  - src/app/api/dokumente/[id]/pdf/route.ts
  - src/app/api/dokumente/search/route.ts
  - src/app/api/dokumente/reindex/route.ts
  - src/app/api/vorlagen/route.ts
  - src/app/api/vorlagen/neu/route.ts
  - src/app/api/vorlagen/platzhalter/route.ts
  - src/app/api/tickets/route.ts
  - src/app/api/ki-entwuerfe/route.ts
  - src/app/api/kontakte/route.ts
  - src/app/api/users/route.ts
  - src/app/api/admin/dezernate/route.ts
  - src/app/api/admin/dezernate/[id]/route.ts
  - src/app/api/admin/rollen/route.ts
  - src/app/(dashboard)/admin/dezernate/page.tsx
  - src/app/(dashboard)/admin/rollen/page.tsx
  - src/components/admin/dezernat-dialog.tsx
  - src/app/api/bea/route.ts
  - src/app/api/bea/messages/route.ts
  - src/app/api/search/route.ts
  - src/app/api/openclaw/process/route.ts
autonomous: true
requirements:
  - REQ-RS-001
  - REQ-RS-002
  - REQ-RS-003

must_haves:
  truths:
    - "Users can only see and access Akten they are assigned to (directly, via Dezernat, or via Admin-Override)"
    - "Unauthorized Akte access returns 404 (not 403) to hide existence"
    - "SEKRETARIAT users cannot Freigeben or Loeschen documents/Akten"
    - "PRAKTIKANT users can only read and create Entwuerfe on assigned Akten, cannot use KI or beA"
    - "ADMIN can explicitly override access to any Akte via 'Zugriff uebernehmen' button"
    - "Sidebar hides navigation items based on user role (PRAKTIKANT sees no Einstellungen/Admin/KI/beA)"
    - "Admin can manage Dezernate (create, edit, assign members, assign Akten) in Einstellungen"
    - "Admin can view Rollen-Matrix and per-user permission overview"
  artifacts:
    - path: "src/lib/rbac.ts"
      provides: "RBAC helper functions and permission matrix"
      exports: ["requireAuth", "requireRole", "requireAkteAccess", "buildAkteAccessFilter", "PERMISSIONS", "requirePermission"]
    - path: "prisma/schema.prisma"
      provides: "Dezernat and AdminOverride models"
      contains: "model Dezernat"
    - path: "src/app/api/admin/dezernate/route.ts"
      provides: "Dezernat CRUD API"
      exports: ["GET", "POST"]
    - path: "src/app/(dashboard)/admin/dezernate/page.tsx"
      provides: "Dezernat management UI"
    - path: "src/app/(dashboard)/admin/rollen/page.tsx"
      provides: "Rollen-Matrix and per-user permission overview"
  key_links:
    - from: "src/app/api/akten/route.ts"
      to: "src/lib/rbac.ts"
      via: "buildAkteAccessFilter() in GET handler"
      pattern: "buildAkteAccessFilter"
    - from: "src/app/api/akten/[id]/route.ts"
      to: "src/lib/rbac.ts"
      via: "requireAkteAccess() in GET/PUT/DELETE handlers"
      pattern: "requireAkteAccess"
    - from: "src/components/layout/sidebar.tsx"
      to: "src/lib/rbac.ts"
      via: "PERMISSIONS constant for role-based nav filtering"
      pattern: "PERMISSIONS\\["
    - from: "src/app/api/admin/dezernate/route.ts"
      to: "prisma/schema.prisma"
      via: "Dezernat CRUD operations"
      pattern: "prisma\\.dezernat\\."
---

<objective>
Implement fine-grained RBAC enforcement across the entire application: Dezernat-based group access for Akten, role-specific permission restrictions (SEKRETARIAT cannot Freigeben/Loeschen, PRAKTIKANT read-only + Entwuerfe), Admin-Override with audit logging, and role-based sidebar navigation filtering.

Purpose: Security hardening -- ensure no user can access cases or perform actions beyond their authorized scope. This is the foundational security layer that all other Phase 7 work depends on conceptually.
Output: RBAC helper library, Dezernat/AdminOverride schema entities, all Akte-related API routes enforcing access checks, role-filtered sidebar, Dezernat management UI, Rollen-Matrix page.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-CONTEXT.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-RESEARCH.md

Key existing files to reference:
@src/lib/auth.ts (NextAuth config with JWT session carrying role)
@src/lib/audit.ts (logAuditEvent used in 25+ routes)
@src/middleware.ts (existing auth middleware)
@src/components/layout/sidebar.tsx (existing sidebar with ADMIN check)
@src/app/api/akten/route.ts (existing Akten list endpoint)
@src/app/api/akten/[id]/route.ts (existing Akte detail endpoint)
@src/app/api/dokumente/[id]/route.ts (existing FREIGABE_ROLES pattern)
@prisma/schema.prisma (current schema)
@src/app/(dashboard)/admin/layout.tsx (existing admin layout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dezernat/AdminOverride schema + RBAC helper library + middleware + sidebar filtering</name>
  <files>
    prisma/schema.prisma
    src/lib/rbac.ts
    src/middleware.ts
    src/components/layout/sidebar.tsx
  </files>
  <action>
**1. Prisma Schema Changes (prisma/schema.prisma):**

Add Dezernat model as real DB entity (NOT tag-based, per user decision):
```prisma
model Dezernat {
  id           String   @id @default(cuid())
  name         String
  beschreibung String?
  kanzleiId    String?
  kanzlei      Kanzlei? @relation(fields: [kanzleiId], references: [id])
  mitglieder   User[]   @relation("DezernatMitglieder")
  akten        Akte[]   @relation("DezernatAkten")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("dezernate")
}
```

Add AdminOverride model for explicit admin access override (per user decision: explicit button, NOT automatic):
```prisma
model AdminOverride {
  id         String    @id @default(cuid())
  adminId    String
  admin      User      @relation("AdminOverrides", fields: [adminId], references: [id])
  akteId     String
  akte       Akte      @relation(fields: [akteId], references: [id])
  grund      String
  gueltigBis DateTime?
  createdAt  DateTime  @default(now())

  @@unique([adminId, akteId])
  @@index([akteId])
  @@map("admin_overrides")
}
```

Add to Kontakt model: `anonymisiertAm DateTime?` and `anonymisiertVon String?` fields (needed for Plan 02 DSGVO).

Add relations to existing models:
- User: `dezernate Dezernat[] @relation("DezernatMitglieder")` and `adminOverrides AdminOverride[] @relation("AdminOverrides")`
- Akte: `dezernate Dezernat[] @relation("DezernatAkten")` and `adminOverrides AdminOverride[]`

Run `npx prisma migrate dev --name add-dezernat-rbac` to create migration.

**2. RBAC Helper Library (src/lib/rbac.ts):**

Create `src/lib/rbac.ts` with:

a) `PERMISSIONS` constant -- code-defined, NOT configurable (per user decision: fixed matrix, no feature flags):
```typescript
export const PERMISSIONS: Record<UserRole, {
  canFreigeben: boolean;
  canLoeschen: boolean;
  canSendBeA: boolean;
  canReadBeA: boolean;
  canUseKI: boolean;
  canAccessAdmin: boolean;
  canAccessEinstellungen: boolean;
  canCreateAkte: boolean;
  canEditAkte: boolean;
}> = {
  ADMIN: { canFreigeben: true, canLoeschen: true, canSendBeA: true, canReadBeA: true, canUseKI: true, canAccessAdmin: true, canAccessEinstellungen: true, canCreateAkte: true, canEditAkte: true },
  ANWALT: { canFreigeben: true, canLoeschen: true, canSendBeA: true, canReadBeA: true, canUseKI: true, canAccessAdmin: false, canAccessEinstellungen: true, canCreateAkte: true, canEditAkte: true },
  SACHBEARBEITER: { canFreigeben: true, canLoeschen: true, canSendBeA: false, canReadBeA: true, canUseKI: true, canAccessAdmin: false, canAccessEinstellungen: true, canCreateAkte: true, canEditAkte: true },
  SEKRETARIAT: { canFreigeben: false, canLoeschen: false, canSendBeA: false, canReadBeA: true, canUseKI: true, canAccessAdmin: false, canAccessEinstellungen: false, canCreateAkte: true, canEditAkte: true },
  PRAKTIKANT: { canFreigeben: false, canLoeschen: false, canSendBeA: false, canReadBeA: false, canUseKI: false, canAccessAdmin: false, canAccessEinstellungen: false, canCreateAkte: false, canEditAkte: false },
};
```

b) `requireAuth()` -- returns authenticated session or 401 error response.

c) `requireRole(...roles: UserRole[])` -- checks session role against allowed roles, returns 403 on mismatch. For critical role changes, query the database to get current role (user decision: permission changes take effect immediately, not after re-login). Use a simple approach: check DB role for write operations, trust JWT for read operations.

d) `requirePermission(permission: keyof typeof PERMISSIONS.ADMIN)` -- checks specific permission from PERMISSIONS matrix.

e) `requireAkteAccess(akteId: string, options?: { requireEdit?: boolean })` -- multi-path access check:
   - ADMIN: check AdminOverride table for explicit override, else full access
   - Others: check personal assignment (anwaltId, sachbearbeiterId) OR Dezernat membership
   - Returns 404 (NOT 403) on unauthorized access (per user decision: hide existence)
   - When `requireEdit: true`, PRAKTIKANT is rejected (read-only)

f) `buildAkteAccessFilter(userId: string, role: UserRole)` -- returns Prisma `where` clause fragment for list queries:
   - ADMIN: empty filter (sees all)
   - Others: `{ OR: [{ anwaltId: userId }, { sachbearbeiterId: userId }, { dezernate: { some: { mitglieder: { some: { id: userId } } } } }] }`

g) Helper type exports for use in components.

**3. Middleware Update (src/middleware.ts):**

Extend existing middleware to extract role from JWT and add to headers for downstream use. The existing middleware already checks authentication. No route-level RBAC in middleware (per research: too coarse for per-resource checks, use helper functions in route handlers instead).

**4. Sidebar Role Filtering (src/components/layout/sidebar.tsx):**

Extend existing sidebar navigation array to include role visibility rules. Use `PERMISSIONS` from rbac.ts via session:

- Add `hideForRoles?: UserRole[]` or `requiredPermission?: string` to each nav item
- PRAKTIKANT: hide Einstellungen, Admin, Helena/KI-Chat, beA, KI-Entwuerfe
- SEKRETARIAT: hide Einstellungen (per research recommendation), Admin
- Use `useSession()` hook (already available) to get role and filter items client-side
- This is UX only -- server-side enforcement happens in API routes (per anti-pattern guidance)
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx prisma validate && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Check that prisma/schema.prisma has Dezernat and AdminOverride models, src/lib/rbac.ts exports all required functions, sidebar hides items per role</manual>
  </verify>
  <done>
    - Dezernat and AdminOverride models exist in schema.prisma with proper relations to User and Akte
    - Migration created and applied
    - src/lib/rbac.ts exports PERMISSIONS, requireAuth, requireRole, requirePermission, requireAkteAccess, buildAkteAccessFilter
    - requireAkteAccess returns 404 (not 403) for unauthorized access
    - buildAkteAccessFilter returns proper Prisma WHERE clause for list filtering
    - Sidebar navigation items are filtered by role (PRAKTIKANT cannot see KI/beA/Einstellungen/Admin)
    - TypeScript compilation passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Retrofit API routes with RBAC + Dezernat admin UI + Rollen-Matrix page</name>
  <files>
    src/app/api/akten/route.ts
    src/app/api/akten/[id]/route.ts
    src/app/api/akten/[id]/dokumente/route.ts
    src/app/api/akten/[id]/dokumente/aus-vorlage/route.ts
    src/app/api/akten/[id]/dokumente/neu/route.ts
    src/app/api/akten/[id]/beteiligte/route.ts
    src/app/api/akten/[id]/historie/route.ts
    src/app/api/akten/[id]/conflict-check/route.ts
    src/app/api/kalender/route.ts
    src/app/api/kalender/[id]/route.ts
    src/app/api/dokumente/[id]/route.ts
    src/app/api/dokumente/[id]/pdf/route.ts
    src/app/api/dokumente/search/route.ts
    src/app/api/dokumente/reindex/route.ts
    src/app/api/vorlagen/route.ts
    src/app/api/vorlagen/neu/route.ts
    src/app/api/vorlagen/platzhalter/route.ts
    src/app/api/tickets/route.ts
    src/app/api/ki-entwuerfe/route.ts
    src/app/api/kontakte/route.ts
    src/app/api/users/route.ts
    src/app/api/admin/dezernate/route.ts
    src/app/api/admin/dezernate/[id]/route.ts
    src/app/api/admin/rollen/route.ts
    src/app/(dashboard)/admin/dezernate/page.tsx
    src/app/(dashboard)/admin/rollen/page.tsx
    src/components/admin/dezernat-dialog.tsx
    src/app/api/bea/route.ts
    src/app/api/bea/messages/route.ts
    src/app/api/search/route.ts
    src/app/api/openclaw/process/route.ts
  </files>
  <action>
**1. Retrofit ALL Akte-Related API Routes:**

For every API route that handles Akte data, apply the RBAC helpers from rbac.ts:

a) **List endpoints** (GET /api/akten, GET /api/search, GET /api/dokumente/search):
   - Replace plain `prisma.akte.findMany()` with `buildAkteAccessFilter()` injected into the WHERE clause
   - This ensures users only see Akten they have access to (per user decision: no lock icons, no visibility of restricted items)

b) **Detail endpoints** (GET/PUT/DELETE /api/akten/[id], all /api/akten/[id]/* sub-routes):
   - Replace existing `prisma.akte.findUnique()` with `requireAkteAccess(akteId)` as the FIRST call
   - For write operations (PUT, DELETE, POST sub-resources): add `requireAkteAccess(akteId, { requireEdit: true })` to reject PRAKTIKANT
   - For DELETE operations: add `requirePermission("canLoeschen")` to reject SEKRETARIAT and PRAKTIKANT

c) **Document status changes** (PATCH /api/dokumente/[id]):
   - Existing FREIGABE_ROLES pattern already partially enforces this
   - Update to use `requirePermission("canFreigeben")` -- this ensures SEKRETARIAT is excluded (per user decision)
   - For DELETE: add `requirePermission("canLoeschen")`

d) **beA routes** (/api/bea/*):
   - Read endpoints: `requirePermission("canReadBeA")` -- SACHBEARBEITER+ can read, PRAKTIKANT blocked
   - Send/eEB endpoints: `requirePermission("canSendBeA")` -- only ANWALT+ can send

e) **KI routes** (/api/ki-entwuerfe/*, /api/openclaw/process):
   - Add `requirePermission("canUseKI")` -- PRAKTIKANT blocked

f) **Admin-only routes** (/api/users, /api/admin/*, /api/dokumente/reindex):
   - Add `requireRole("ADMIN")` at handler start

g) **Kalender routes** (/api/kalender):
   - Filter list by Akten the user has access to (join through akte relation)
   - Detail: check Akte access via the linked akteId

h) **Kontakte routes** (/api/kontakte):
   - No Akte-level restriction (contacts are shared), but require authentication

Important: For ALL write operations across the app, PRAKTIKANT can ONLY create Entwuerfe (documents with status ENTWURF, calendar entries with status ENTWURF). Reject any other write attempt.

Log audit events for access denials using existing `logAuditEvent()` with new event type `ZUGRIFF_VERWEIGERT`.

**2. Admin Override API + Integration:**

Create `src/app/api/admin/override/route.ts`:
- POST: Admin creates override for specific Akte (requires grund/reason), logged in AuditLog with `ADMIN_OVERRIDE_ERSTELLT`
- DELETE: Admin revokes override, logged with `ADMIN_OVERRIDE_ENTFERNT`
- GET: List active overrides for current admin

In `requireAkteAccess()`, check AdminOverride table for ADMIN role users who don't have direct/Dezernat access.

**3. Dezernat Management API + UI:**

Create `src/app/api/admin/dezernate/route.ts`:
- GET: List all Dezernate with member count and Akten count (ADMIN only)
- POST: Create new Dezernat with name, beschreibung (ADMIN only)

Create `src/app/api/admin/dezernate/[id]/route.ts`:
- GET: Dezernat detail with members and Akten lists
- PATCH: Update name/beschreibung, add/remove members, add/remove Akten
- DELETE: Delete Dezernat (only if no Akten assigned)

Create `src/app/(dashboard)/admin/dezernate/page.tsx`:
- List of Dezernate as cards with member avatars and Akten count
- Create/Edit dialog (`src/components/admin/dezernat-dialog.tsx`) with:
  - Name and description fields
  - User multi-select for members
  - Akte multi-select for assignment
- Delete with confirmation

Add Dezernate link to admin sub-navigation in existing admin layout.

**4. Rollen-Matrix + Per-User Permission Overview:**

Create `src/app/api/admin/rollen/route.ts`:
- GET: Returns PERMISSIONS matrix and list of users with their roles and accessible Akten (with access source: direkt, Dezernat, Admin-Override)

Create `src/app/(dashboard)/admin/rollen/page.tsx`:
- Rollen-Matrix table: rows = roles (ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT, PRAKTIKANT), columns = permissions (Freigeben, Loeschen, beA senden, beA lesen, KI, Admin, Einstellungen, Akte erstellen, Akte bearbeiten)
- Read-only display with checkmark/x icons (per user decision: permissions are code-defined, not configurable)
- Per-User section below: select a user from dropdown, shows all accessible Akten with access source tag (direkt/Dezernat/Admin-Override)

Add Rollen link to admin sub-navigation.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>
      1. As PRAKTIKANT user, verify /api/akten returns only assigned Akten (404 for others)
      2. As SEKRETARIAT user, verify Freigeben button is not available on documents
      3. As ADMIN, verify Dezernate page shows CRUD operations
      4. Verify Rollen-Matrix displays correct permission table
    </manual>
  </verify>
  <done>
    - All Akte list endpoints use buildAkteAccessFilter() -- unauthorized Akten are invisible
    - All Akte detail endpoints use requireAkteAccess() -- unauthorized access returns 404
    - Document Freigeben uses requirePermission("canFreigeben") -- SEKRETARIAT excluded
    - Document/Akte delete uses requirePermission("canLoeschen") -- SEKRETARIAT/PRAKTIKANT excluded
    - beA send uses requirePermission("canSendBeA") -- only ANWALT+
    - KI features use requirePermission("canUseKI") -- PRAKTIKANT excluded
    - Admin-Override CRUD works with audit logging
    - Dezernat management page at /admin/dezernate with full CRUD
    - Rollen-Matrix read-only table at /admin/rollen
    - Per-User permission overview shows accessible Akten with access source
    - TypeScript compilation passes
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes without errors
2. Prisma validation: `npx prisma validate` passes
3. Schema has Dezernat and AdminOverride models with correct relations
4. src/lib/rbac.ts exists and exports all required functions
5. Sidebar hides navigation items based on role
6. At least 30 API routes import and use rbac.ts helpers
7. Admin pages exist for Dezernate and Rollen
</verification>

<success_criteria>
- Akten access is enforced via personal assignment, Dezernat membership, or Admin-Override
- Unauthorized Akte access returns 404 (existence hidden)
- SEKRETARIAT cannot Freigeben or Loeschen
- PRAKTIKANT can only read and create Entwuerfe on assigned Akten
- Admin can manage Dezernate and view Rollen-Matrix
- Permission changes take effect immediately (DB role check for writes)
</success_criteria>

<output>
After completion, create `.planning/phases/07-rollen-sicherheit-compliance-observability/07-01-SUMMARY.md`
</output>
