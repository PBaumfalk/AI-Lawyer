---
phase: 02-deadline-calculation-document-templates
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/fristen/types.ts
  - src/lib/fristen/feiertage.ts
  - src/lib/fristen/rechner.ts
  - src/lib/fristen/vorfrist.ts
  - src/lib/fristen/presets.ts
  - src/lib/fristen/rechner.test.ts
  - src/lib/fristen/index.ts
autonomous: true
requirements:
  - REQ-FK-001
  - REQ-FK-002

must_haves:
  truths:
    - "berechneFrist() correctly calculates Ereignisfrist end dates (event day NOT counted per Section 187 Abs. 1)"
    - "berechneFrist() correctly calculates Beginnfrist end dates (start day IS counted per Section 187 Abs. 2)"
    - "Month-end overflow is handled correctly (Jan 31 + 1 month = Feb 28, not Mar 3)"
    - "Section 193 shifts deadlines past weekends and Bundesland-specific holidays to next business day"
    - "All 16 Bundeslaender holiday calendars work correctly via feiertagejs"
    - "Backward calculation (Fristende to latest Zustellungstermin) returns correct result"
    - "Vorfristen are calculated based on Kalendertage and shifted to previous Arbeitstag if on weekend/holiday"
    - "Halbfrist is automatically computed for deadlines > 2 weeks"
    - "More than 50 unit tests pass covering all edge cases"
  artifacts:
    - path: "src/lib/fristen/types.ts"
      provides: "FristInput, FristErgebnis, BundeslandCode, FristArt, FristDauer types"
      exports: ["FristInput", "FristErgebnis", "BundeslandCode", "FristArt", "FristDauer", "VerschiebungsGrund", "VorfristDatum"]
    - path: "src/lib/fristen/rechner.ts"
      provides: "Pure berechneFrist(), berechneFristRueckwaerts(), isGeschaeftstag(), naechsterGeschaeftstag() functions"
      exports: ["berechneFrist", "berechneFristRueckwaerts", "isGeschaeftstag", "naechsterGeschaeftstag", "vorherigerGeschaeftstag"]
    - path: "src/lib/fristen/feiertage.ts"
      provides: "feiertagejs wrapper with Bundesland config"
      exports: ["istFeiertag", "getFeiertage", "getFeiertagName"]
    - path: "src/lib/fristen/vorfrist.ts"
      provides: "Vorfrist calculation and Halbfrist logic"
      exports: ["berechneVorfristen", "berechneHalbfrist"]
    - path: "src/lib/fristen/presets.ts"
      provides: "Default Fristen-Presets data (Berufungsfrist, Klagefrist, etc.)"
      exports: ["DEFAULT_FRISTEN_PRESETS"]
    - path: "src/lib/fristen/rechner.test.ts"
      provides: ">50 unit tests for FristenRechner"
      min_lines: 400
  key_links:
    - from: "src/lib/fristen/rechner.ts"
      to: "src/lib/fristen/feiertage.ts"
      via: "import istFeiertag, getFeiertagName"
      pattern: "import.*from.*feiertage"
    - from: "src/lib/fristen/rechner.ts"
      to: "date-fns"
      via: "addDays, addWeeks, addMonths, addYears, isSaturday, isSunday"
      pattern: "import.*from.*date-fns"
    - from: "src/lib/fristen/vorfrist.ts"
      to: "src/lib/fristen/rechner.ts"
      via: "uses vorherigerGeschaeftstag for shifting Vorfristen"
      pattern: "import.*vorherigerGeschaeftstag"
---

<objective>
Build the FristenRechner as a pure, side-effect-free function library implementing BGB Sections 187-193 German legal deadline calculation, with exhaustive TDD coverage (>50 unit tests).

Purpose: This is the highest-risk component in the entire application (Haftungsrisiko #1). Incorrect deadline calculations can lead to missed court deadlines and professional liability. TDD ensures correctness before any UI/API integration. The pure-function design allows reuse across UI, API, worker, and batch contexts.

Output: `src/lib/fristen/` directory with types, calculator, holiday wrapper, Vorfrist logic, presets, and comprehensive test suite.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md

@src/lib/vorlagen.ts
</context>

<feature>
  <name>FristenRechner Pure Function Library</name>
  <files>
    src/lib/fristen/types.ts,
    src/lib/fristen/feiertage.ts,
    src/lib/fristen/rechner.ts,
    src/lib/fristen/vorfrist.ts,
    src/lib/fristen/presets.ts,
    src/lib/fristen/rechner.test.ts,
    src/lib/fristen/index.ts
  </files>
  <behavior>
    BGB Section 187-193 deadline calculation as pure functions:

    **Ereignisfrist (Section 187 Abs. 1):**
    - Event day NOT counted. Frist starts next day.
    - berechneFrist({ zustellungsdatum: 2026-03-15, fristArt: 'EREIGNISFRIST', dauer: { monate: 1 }, bundesland: 'NW', section193: true }) -> endDatum: 2026-04-15

    **Beginnfrist (Section 187 Abs. 2):**
    - Start day IS counted (begins at 00:00).
    - berechneFrist({ zustellungsdatum: 2026-03-15, fristArt: 'BEGINNFRIST', dauer: { monate: 1 }, bundesland: 'NW', section193: true }) -> endDatum: 2026-04-14

    **Month-end overflow (Section 188 Abs. 3):**
    - Jan 31 + 1 month = Feb 28 (not Mar 3)
    - Jan 30 + 1 month = Feb 28 in non-leap year
    - Jan 29 + 1 month = Feb 28 in non-leap year, Feb 29 in leap year

    **Section 193 weekend/holiday extension:**
    - If deadline falls on Saturday/Sunday/Feiertag, shift to NEXT business day
    - Track each shift reason (Samstag, Sonntag, Feiertag name)
    - Return both rohEndDatum (before shift) and endDatum (after shift)

    **Bundesland-specific holidays (feiertagejs):**
    - All 16 Bundeslaender supported: BW, BY, BE, BB, HB, HE, HH, MV, NI, NW, RP, SL, SN, ST, SH, TH
    - Fronleichnam only in BW, BY, HE, NW, RP, SL (not all)
    - isGeschaeftstag(date, bundesland) -> boolean

    **Backward calculation:**
    - berechneFristRueckwaerts({ fristende: 2026-04-15, fristArt: 'EREIGNISFRIST', dauer: { monate: 1 }, bundesland: 'NW' }) -> spaetesterZustellungstermin: 2026-03-15

    **Vorfristen:**
    - berechneVorfristen(endDatum, [7, 3, 1], bundesland) -> array of dates
    - Each Vorfrist based on Kalendertage from endDatum
    - If Vorfrist falls on weekend/holiday, shift to PREVIOUS Arbeitstag (not next!)

    **Halbfrist:**
    - berechneHalbfrist(startDatum, endDatum, bundesland) -> Date or null
    - Only calculated for deadlines > 2 weeks (14 days)
    - Shifted to previous Arbeitstag if on weekend/holiday

    **Presets:**
    - DEFAULT_FRISTEN_PRESETS: Array of common German legal deadline presets
    - Each: name, fristArt, dauer, istNotfrist, defaultVorfristen, kategorie
    - Examples: Berufungsfrist (1 Monat, Notfrist), Berufungsbegruendungsfrist (2 Monate), Klagefrist (1 Monat), Widerspruchsfrist (2 Wochen), etc.
  </behavior>
  <implementation>
    1. Install feiertagejs: `npm install feiertagejs`
    2. Create src/lib/fristen/types.ts with all TypeScript types
    3. Create src/lib/fristen/feiertage.ts as thin wrapper around feiertagejs
    4. Create src/lib/fristen/rechner.ts with berechneFrist() and berechneFristRueckwaerts()
       - Use date-fns (already installed) for ALL date arithmetic -- NEVER native Date methods
       - Use feiertagejs for holiday lookup
       - Pure functions only -- no DB, no side effects, no imports from app layer
    5. Create src/lib/fristen/vorfrist.ts with berechneVorfristen() and berechneHalbfrist()
    6. Create src/lib/fristen/presets.ts with DEFAULT_FRISTEN_PRESETS array
    7. Create src/lib/fristen/index.ts barrel export

    TDD cycle:
    RED: Write test -> expect berechneFrist({...}).endDatum toBe specificDate -> test FAILS
    GREEN: Implement minimal code to pass -> test PASSES
    REFACTOR: Clean up, extract helpers -> tests still PASS

    Test categories (must cover ALL):
    - Ereignisfrist basic: days, weeks, months, years
    - Beginnfrist basic: days, weeks, months, years
    - Month-end overflow: Jan 31+1mo, Feb 28+1mo, Mar 31+1mo, Dec 31+1mo
    - Leap year: Feb 28+1yr in/out of leap year, Feb 29+1yr
    - Section 193 shift: Saturday, Sunday, Feiertag, multi-day shift (Fri->Mon over holiday)
    - Section 193 NOT applied: section193=false -> no shift
    - Bundesland holidays: NW vs BY Fronleichnam, regional-only holidays
    - Backward calculation: inverse of forward for all types
    - Vorfristen: correct dates, weekend shift to PREVIOUS day
    - Halbfrist: > 2 weeks computed, <= 2 weeks returns null
    - Edge cases: year boundary, Dec 31, Jan 1, Easter-dependent holidays
    - Combined: month-end + holiday shift, long durations (6 months, 1 year)

    Anti-patterns to avoid (per RESEARCH.md):
    - NEVER use native Date.setMonth() or Date arithmetic
    - NEVER hardcode holiday lists
    - NEVER apply Section 193 unconditionally
    - NEVER shift Vorfristen FORWARD (must go BACKWARD to previous business day)
  </implementation>
</feature>

<verification>
```bash
# Run the FristenRechner test suite
npx vitest run src/lib/fristen/rechner.test.ts --reporter=verbose

# Verify >50 tests exist
npx vitest run src/lib/fristen/rechner.test.ts 2>&1 | grep -E "Tests|passed|failed"

# Verify TypeScript compiles
npx tsc --noEmit src/lib/fristen/index.ts
```
</verification>

<success_criteria>
- >50 unit tests pass covering Ereignisfrist, Beginnfrist, month-end overflow, leap years, Section 193, all 16 Bundeslaender, backward calculation, Vorfristen, and Halbfrist
- Zero test failures
- All functions are pure (no DB, no side effects, no process.env reads)
- feiertagejs installed and used for all holiday lookups
- date-fns used for ALL date arithmetic (no native Date methods)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-01-SUMMARY.md`
</output>
