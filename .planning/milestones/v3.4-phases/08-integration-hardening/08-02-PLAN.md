---
phase: 08-integration-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/finanzen/rechnungen/route.ts
  - src/app/api/finanzen/rechnungen/[id]/route.ts
  - src/app/api/finanzen/aktenkonto/route.ts
  - src/app/api/finanzen/aktenkonto/[akteId]/route.ts
  - src/app/api/finanzen/zeiterfassung/route.ts
  - src/app/api/finanzen/buchungsperioden/route.ts
  - src/app/api/finanzen/kostenstellen/route.ts
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/finanzen/page.tsx
autonomous: true
requirements:
  - REQ-FI-003
  - REQ-FI-005
  - REQ-FI-006

must_haves:
  truths:
    - "Finance API routes enforce Akte-level access -- SACHBEARBEITER/SEKRETARIAT only see financial data for their assigned Akten"
    - "ADMIN sees kanzlei-wide financial data; ANWALT with canSeeKanzleiFinanzen=true sees kanzlei-wide; other ANWALT sees only own Akten"
    - "Dashboard Prisma queries are user-scoped -- non-ADMIN users only see counts for accessible Akten"
    - "Finance KPI cards display correct values -- API response keys match frontend consumption"
    - "SEKRETARIAT/SACHBEARBEITER see only operative KPIs; ANWALT/ADMIN see all KPIs including Gesamtumsatz"
  artifacts:
    - path: "src/app/api/finanzen/rechnungen/route.ts"
      provides: "GET with buildAkteAccessFilter on akte relation"
      contains: "buildAkteAccessFilter"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "User-scoped Prisma queries with access filter"
      contains: "buildAkteAccessFilter"
    - path: "src/app/(dashboard)/finanzen/page.tsx"
      provides: "Role-based KPI visibility and corrected data keys"
      contains: "canSeeKanzleiFinanzen"
  key_links:
    - from: "src/app/api/finanzen/rechnungen/route.ts"
      to: "src/lib/rbac.ts"
      via: "import buildAkteAccessFilter"
      pattern: "buildAkteAccessFilter"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/lib/rbac.ts"
      via: "import buildAkteAccessFilter"
      pattern: "buildAkteAccessFilter"
    - from: "src/app/api/finanzen/rechnungen/route.ts"
      to: "prisma.user"
      via: "canSeeKanzleiFinanzen lookup"
      pattern: "canSeeKanzleiFinanzen"
    - from: "src/app/(dashboard)/finanzen/page.tsx"
      to: "src/app/api/finanzen/rechnungen/route.ts"
      via: "fetch reads stats keys from API response"
      pattern: "stats|summary"
---

<objective>
Wire buildAkteAccessFilter into all finance and dashboard routes, fix finance KPI key mismatches, and enforce role-based KPI visibility.

Purpose: Close RBAC enforcement gaps on finance/dashboard routes (INT-A01, INT-A03) and fix broken finance KPI display (INT-A05).
Output: Finance routes with Akte-level access, dashboard with user-scoped queries, correct KPI display with role-based visibility.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-hardening/08-CONTEXT.md
@.planning/phases/08-integration-hardening/08-RESEARCH.md
@.planning/phases/08-integration-hardening/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire buildAkteAccessFilter to all finance routes</name>
  <files>
    src/app/api/finanzen/rechnungen/route.ts
    src/app/api/finanzen/rechnungen/[id]/route.ts
    src/app/api/finanzen/aktenkonto/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/route.ts
    src/app/api/finanzen/zeiterfassung/route.ts
    src/app/api/finanzen/buchungsperioden/route.ts
    src/app/api/finanzen/kostenstellen/route.ts
  </files>
  <action>
    **Finance route RBAC pattern (apply to each route):**

    For every finance GET (list) route, add Akte-level access filtering:
    ```typescript
    import { requireAuth, buildAkteAccessFilter } from "@/lib/rbac";
    import { prisma } from "@/lib/db";

    // At the start of GET handler:
    const authResult = await requireAuth();
    if (authResult.error) return authResult.error;
    const { session } = authResult;

    // Determine scope
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: { canSeeKanzleiFinanzen: true },
    });
    const showKanzleiweit = session.user.role === "ADMIN" ||
      (session.user.role === "ANWALT" && user?.canSeeKanzleiFinanzen);
    const akteFilter = showKanzleiweit ? {} : buildAkteAccessFilter(session.user.id, session.user.role);

    // Apply to queries (for models with akte relation):
    // where: { akte: akteFilter, ...otherFilters }
    // For aggregate/count queries, reuse same where clause
    ```

    **Apply to specific routes:**
    1. `src/app/api/finanzen/rechnungen/route.ts` GET: Add `where: { akte: akteFilter }` to findMany + count + aggregate. POST: Verify user has access to the referenced Akte before creating invoice.
    2. `src/app/api/finanzen/rechnungen/[id]/route.ts` GET/PATCH/DELETE: Look up the invoice's akteId, then call `requireAkteAccess(akteId)` for single-record endpoints.
    3. `src/app/api/finanzen/aktenkonto/route.ts` GET: Add `where: { akte: akteFilter }` to cross-case aktenkonto queries. Also add fremdgeldAlerts to the response if missing.
    4. `src/app/api/finanzen/aktenkonto/[akteId]/route.ts`: Ensure it uses `requireAkteAccess(akteId)`.
    5. `src/app/api/finanzen/zeiterfassung/route.ts`: If listing time entries across Akten, add akte access filter. If per-Akte, use requireAkteAccess.
    6. `src/app/api/finanzen/buchungsperioden/route.ts`: This is ADMIN-only (period locking). Verify it uses `requireRole("ADMIN")`.
    7. `src/app/api/finanzen/kostenstellen/route.ts`: ADMIN-only for write operations. Read may need filtering -- check the query scope and add filter if it returns Akte-linked data.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>
      1. Grep for "buildAkteAccessFilter" in finance routes -- should appear in rechnungen/route.ts, aktenkonto/route.ts, zeiterfassung/route.ts
      2. Grep for "canSeeKanzleiFinanzen" in finance routes -- should appear in list endpoints
    </manual>
  </verify>
  <done>
    - All finance list routes use buildAkteAccessFilter for Akte-level access filtering
    - canSeeKanzleiFinanzen controls whether ANWALT gets kanzlei-wide or personal view
    - Finance detail routes (single invoice, single aktenkonto) use requireAkteAccess
    - Aggregate/count queries reuse same where clause as list queries
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard RBAC + Finance KPI key fix + role-based KPI visibility</name>
  <files>
    src/app/(dashboard)/dashboard/page.tsx
    src/app/(dashboard)/finanzen/page.tsx
  </files>
  <action>
    **Dashboard RBAC in `src/app/(dashboard)/dashboard/page.tsx`:**
    The dashboard is a server component calling Prisma directly. Add access filtering:
    ```typescript
    import { auth } from "@/lib/auth";
    import { buildAkteAccessFilter } from "@/lib/rbac";

    const session = await auth();
    const accessFilter = buildAkteAccessFilter(session.user.id, session.user.role);

    // Apply to ALL Prisma queries in the page:
    // prisma.akte.count({ where: { status: "OFFEN", ...accessFilter } })
    // prisma.kalenderEintrag.count({ where: { akte: accessFilter, ... } })
    // prisma.rechnung.count({ where: { akte: accessFilter, ... } })
    // etc.
    ```

    **Finance KPI key alignment in `src/app/(dashboard)/finanzen/page.tsx`:**
    Read both the frontend page and the API response to identify mismatches.
    Per RESEARCH.md, the known mismatches are:
    - Frontend reads `invoiceData.stats` but API returns `invoiceData.summary` -> either rename the API response key to `stats` OR update the frontend to read `summary`
    - Frontend reads `stats.gesamtUmsatz` but API has no gesamtUmsatz field -> add gesamtUmsatz calculation to the rechnungen API summary (sum of all BEZAHLT invoices' nettoBetrag)
    - Frontend reads `stats.ueberfaellig` but API returns `summary.ueberfaelligCount` -> align the key names
    - Frontend reads `aktenkontoData.fremdgeldAlerts` but cross-case API has no fremdgeldAlerts -> add fremdgeld alert data to the cross-case aktenkonto GET response

    **Preferred approach:** Fix the API to match what the frontend expects. This is less risky than changing the frontend.

    **Role-based KPI visibility in `src/app/(dashboard)/finanzen/page.tsx`:**
    - SEKRETARIAT + SACHBEARBEITER: only show operative KPIs (offene Rechnungen count, ueberfaellige Rechnungen count, Fremdgeld-Saldo)
    - ANWALT + ADMIN: show all KPIs including Gesamtumsatz, Gewinn, Honorarvolumen
    - Use the session role to conditionally render KPI cards. The session is available via `auth()` in server components.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>
      1. Grep for "buildAkteAccessFilter" in dashboard/page.tsx -- should appear
      2. Verify finanzen/page.tsx conditionally renders KPI cards based on session.user.role
      3. Verify the API response keys for rechnungen GET match what finanzen/page.tsx reads
    </manual>
  </verify>
  <done>
    - Dashboard page queries are user-scoped with buildAkteAccessFilter
    - Finance KPI cards show correct data (API response keys match frontend)
    - SEKRETARIAT/SACHBEARBEITER see only operative KPIs, ANWALT/ADMIN see all KPIs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes cleanly (or with only pre-existing errors)
2. `grep -r "buildAkteAccessFilter" src/app/api/finanzen/ src/app/\(dashboard\)/dashboard/` shows the filter is used in all finance list routes and dashboard
3. Finance overview page renders KPI cards conditionally based on role
4. API response keys match what finanzen/page.tsx reads
</verification>

<success_criteria>
- Every finance list route applies buildAkteAccessFilter -- users cannot see financial data for Akten they lack access to
- canSeeKanzleiFinanzen controls ANWALT kanzlei-wide finance visibility
- Dashboard counts are user-scoped
- Finance KPI cards display correct data with proper role-based visibility
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-hardening/08-02-SUMMARY.md`
</output>
