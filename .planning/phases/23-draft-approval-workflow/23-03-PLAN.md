---
phase: 23-draft-approval-workflow
plan: 03
type: execute
wave: 3
depends_on: [23-01, 23-02]
files_modified:
  - src/lib/helena/tools/_write/create-draft-dokument.ts
  - src/lib/helena/tools/_write/create-draft-frist.ts
  - src/lib/helena/tools/_write/create-notiz.ts
  - src/lib/helena/tools/_write/create-draft-zeiterfassung.ts
  - src/lib/helena/schriftsatz/index.ts
autonomous: true
requirements: [DRFT-06]

must_haves:
  truths:
    - "Every HelenaDraft creation (all 4 tool executors and the Schriftsatz pipeline) calls notifyDraftCreated() after prisma.helenaDraft.create() succeeds"
    - "notifyDraftCreated receives the created draft object and the Akte's anwaltId/verantwortlichId for recipient resolution"
    - "The Akte is loaded (or its anwaltId is resolved) before calling notifyDraftCreated in each call site"
    - "Socket.IO notification is reachable at runtime -- draft-notification.ts is imported and invoked from all 5 draft creation sites"
  artifacts:
    - path: "src/lib/helena/tools/_write/create-draft-dokument.ts"
      provides: "notifyDraftCreated call after helenaDraft.create"
      contains: "notifyDraftCreated"
    - path: "src/lib/helena/tools/_write/create-draft-frist.ts"
      provides: "notifyDraftCreated call after helenaDraft.create"
      contains: "notifyDraftCreated"
    - path: "src/lib/helena/tools/_write/create-notiz.ts"
      provides: "notifyDraftCreated call after helenaDraft.create"
      contains: "notifyDraftCreated"
    - path: "src/lib/helena/tools/_write/create-draft-zeiterfassung.ts"
      provides: "notifyDraftCreated call after helenaDraft.create"
      contains: "notifyDraftCreated"
    - path: "src/lib/helena/schriftsatz/index.ts"
      provides: "notifyDraftCreated call after helenaDraft.create in Stage 6"
      contains: "notifyDraftCreated"
  key_links:
    - from: "src/lib/helena/tools/_write/create-draft-dokument.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
    - from: "src/lib/helena/tools/_write/create-draft-frist.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
    - from: "src/lib/helena/tools/_write/create-notiz.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
    - from: "src/lib/helena/tools/_write/create-draft-zeiterfassung.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
    - from: "src/lib/helena/schriftsatz/index.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
---

<objective>
Wire notifyDraftCreated() from draft-notification.ts into all 5 HelenaDraft creation sites so that Socket.IO notifications actually fire at runtime when Helena creates a new draft.

Purpose: DRFT-06 requires Socket.IO notification to the responsible user when Helena creates a draft. The notification helper exists (draft-notification.ts) but is orphaned -- never imported or called. This plan connects the existing helper to every draft creation call site.

Output: All 5 files that create HelenaDraft records now import and call notifyDraftCreated() after a successful prisma.helenaDraft.create(), making the notification pipeline reachable at runtime.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-draft-approval-workflow/23-RESEARCH.md
@.planning/phases/23-draft-approval-workflow/23-VERIFICATION.md

<interfaces>
<!-- Key types and contracts needed by the executor -->

From src/lib/helena/draft-notification.ts (created in 23-02, currently orphaned):
```typescript
export async function notifyDraftCreated(draft: {
  id: string;
  akteId: string;
  userId: string;
  typ: string;
  titel: string;
}, akteAnwaltId: string | null): Promise<void>;

export async function notifyDraftRevision(draft: {
  id: string;
  akteId: string;
  userId: string;
  typ: string;
  titel: string;
  parentDraftId: string;
}, akteAnwaltId: string | null): Promise<void>;
```

From src/lib/helena/tools/types.ts (ToolContext):
```typescript
export interface ToolContext {
  prisma: ExtendedPrismaClient;
  userId: string;
  userRole: UserRole;
  akteId: string | null;
  akteAccessFilter: Record<string, unknown>;
  helenaUserId: string;
  cache: ToolCache;
  abortSignal?: AbortSignal;
}
```

From src/lib/helena/schriftsatz/index.ts (SchriftsatzPipelineOptions):
```typescript
export interface SchriftsatzPipelineOptions {
  prisma: ExtendedPrismaClient;
  userId: string;
  userRole: UserRole;
  userName: string;
  akteId: string;
  message: string;
  userSlotValues?: Partial<SlotValues>;
  abortSignal?: AbortSignal;
  onStepUpdate?: (step: { stage: string; detail: string }) => void;
}
```

From prisma/schema.prisma (Akte model, relevant fields):
```prisma
model Akte {
  id                 String  @id @default(cuid())
  anwaltId           String?
  verantwortlichId   String?
}
```

Akte has `anwaltId` (nullable) and `verantwortlichId` (nullable). Either can be used as the "responsible user" for notifications. Priority: anwaltId first, then verantwortlichId as fallback.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire notifyDraftCreated into all 4 tool executors</name>
  <files>
    src/lib/helena/tools/_write/create-draft-dokument.ts
    src/lib/helena/tools/_write/create-draft-frist.ts
    src/lib/helena/tools/_write/create-notiz.ts
    src/lib/helena/tools/_write/create-draft-zeiterfassung.ts
  </files>
  <action>
For each of the 4 tool executor files, apply the same pattern:

**1. Add the import at the top of each file (after existing imports):**

```typescript
import { notifyDraftCreated } from "@/lib/helena/draft-notification";
```

**2. After the `ctx.prisma.helenaDraft.create()` call succeeds and before the return statement, add the notification call:**

```typescript
// Resolve Akte owner for notification recipients
const akte = await ctx.prisma.akte.findUnique({
  where: { id: targetAkteId },
  select: { anwaltId: true, verantwortlichId: true },
});
const akteAnwaltId = akte?.anwaltId ?? akte?.verantwortlichId ?? null;

// Fire-and-forget: notification failure must not fail the tool
notifyDraftCreated(
  { id: draft.id, akteId: targetAkteId, userId: ctx.userId, typ: draft.typ, titel: draft.titel },
  akteAnwaltId,
).catch(() => {});
```

**IMPORTANT NOTES:**
- The notification call MUST be fire-and-forget (`.catch(() => {})`) -- a notification failure must never cause the tool execution to fail. The tool must still return the successful draft creation result.
- Do NOT `await` the notifyDraftCreated call. The tool execution result should return immediately after draft creation. The notification is a side effect.
- The Akte query uses `findUnique` with minimal `select` to avoid loading unnecessary data.
- `draft.typ` is available from the create result object. For create-notiz.ts and create-draft-zeiterfassung.ts where `typ` is set as a string literal `"NOTIZ"`, use the string directly (or use `draft.typ`).
- `draft.titel` is also on the create result. Use `draft.titel`.

**File-by-file specifics:**

**create-draft-dokument.ts (line ~43-53):**
- After `const draft = await ctx.prisma.helenaDraft.create(...)` (currently line 43-53)
- Before `return { data: { draftId: draft.id, ... } }` (currently line 55-63)
- Insert the Akte lookup and notifyDraftCreated call

**create-draft-frist.ts (line ~57-71):**
- After `const draft = await ctx.prisma.helenaDraft.create(...)` (currently line 57-71)
- Before `return { data: { draftId: draft.id, ... } }` (currently line 73-83)
- Insert the Akte lookup and notifyDraftCreated call

**create-notiz.ts (line ~41-49):**
- After `const draft = await ctx.prisma.helenaDraft.create(...)` (currently line 41-49)
- Before `return { data: { draftId: draft.id, ... } }` (currently line 51-58)
- Insert the Akte lookup and notifyDraftCreated call

**create-draft-zeiterfassung.ts (line ~57-71):**
- After `const draft = await ctx.prisma.helenaDraft.create(...)` (currently line 57-71)
- Before `return { data: { draftId: draft.id, ... } }` (currently line 73-83)
- Insert the Akte lookup and notifyDraftCreated call
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - All 4 tool executor files import notifyDraftCreated from @/lib/helena/draft-notification
    - Each file calls notifyDraftCreated after helenaDraft.create with fire-and-forget pattern
    - Each file resolves akteAnwaltId by loading akte.anwaltId/verantwortlichId before the notification call
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire notifyDraftCreated into Schriftsatz pipeline Stage 6</name>
  <files>
    src/lib/helena/schriftsatz/index.ts
  </files>
  <action>
**1. Add the import at the top of the file (after existing imports, before the Types section):**

```typescript
import { notifyDraftCreated } from "@/lib/helena/draft-notification";
```

**2. In the `runSchriftsatzPipeline` function, after the `prisma.helenaDraft.create()` call in Stage 6 (currently lines 275-285), before the return statement (currently line 287), add the notification call:**

```typescript
// Resolve Akte owner for notification recipients
const akte = await prisma.akte.findUnique({
  where: { id: akteId },
  select: { anwaltId: true, verantwortlichId: true },
});
const akteAnwaltId = akte?.anwaltId ?? akte?.verantwortlichId ?? null;

// Fire-and-forget: notification failure must not fail the pipeline
notifyDraftCreated(
  { id: draft.id, akteId, userId, typ: "DOKUMENT", titel: draft.titel },
  akteAnwaltId,
).catch(() => {});
```

**IMPORTANT NOTES:**
- The notification call MUST be fire-and-forget (`.catch(() => {})`) -- the Schriftsatz pipeline must not fail due to notification delivery issues.
- `akteId` and `userId` are already destructured from `options` at the top of the function (line 158-165).
- `draft.titel` is the title set during create (`Schriftsatz: ${klageartDef.label} -- ${intent.stadium}`).
- `typ` is always `"DOKUMENT"` for the Schriftsatz pipeline (line 279).
- Do NOT `await` the notification. The pipeline result should be returned without waiting for notification delivery.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - src/lib/helena/schriftsatz/index.ts imports notifyDraftCreated from @/lib/helena/draft-notification
    - Stage 6 calls notifyDraftCreated after helenaDraft.create with fire-and-forget pattern
    - Akte owner is resolved from akte.anwaltId/verantwortlichId
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- no TypeScript errors from new imports or function calls
2. `grep -r "notifyDraftCreated" src/lib/helena/tools/_write/` returns 4 matches (one per tool executor file)
3. `grep -r "notifyDraftCreated" src/lib/helena/schriftsatz/index.ts` returns 1 match (Stage 6)
4. `grep -r "import.*notifyDraftCreated.*draft-notification" src/` returns exactly 5 matches (4 tools + 1 pipeline)
5. No `await notifyDraftCreated` anywhere -- all calls use fire-and-forget pattern with `.catch(() => {})`
6. All 5 files resolve `akteAnwaltId` via `prisma.akte.findUnique` before the notification call
</verification>

<success_criteria>
- Socket.IO notification fires to triggering user + Akte owner when Helena creates any draft (DRFT-06)
- All 5 HelenaDraft creation sites (4 tool executors + Schriftsatz pipeline) invoke notifyDraftCreated
- Notification failures are silently caught -- they never cause tool execution or pipeline failure
- draft-notification.ts is no longer orphaned -- it has 5 active callers at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/23-draft-approval-workflow/23-03-SUMMARY.md`
</output>
