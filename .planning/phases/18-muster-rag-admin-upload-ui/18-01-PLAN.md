---
phase: 18-muster-rag-admin-upload-ui
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/muster/seed-amtliche.ts
  - src/lib/muster/ingestion.ts
autonomous: true
requirements: [ARBW-01, ARBW-04]

must_haves:
  truths:
    - "muster_chunks DB table has isKanzleiEigen (muster) and kanzleiEigen (muster_chunks) columns after migration"
    - "searchMusterChunks() applies 1.3x score multiplier to kanzleiEigen=true results and returns them ranked first"
    - "seedAmtlicheFormulare() inserts 6 amtliche Formulare with {{PLATZHALTER}} into muster_chunks on first worker boot — idempotent via SystemSetting version key"
    - "insertMusterChunks() chunks + embeds a Muster file and writes to muster_chunks with kanzleiEigen propagated from parent Muster"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "isKanzleiEigen on Muster, kanzleiEigen on MusterChunk"
      contains: "isKanzleiEigen Boolean"
    - path: "src/lib/muster/seed-amtliche.ts"
      provides: "AMTLICHE_MUSTER constant + seedAmtlicheFormulare()"
      exports: ["AMTLICHE_MUSTER", "seedAmtlicheFormulare"]
    - path: "src/lib/muster/ingestion.ts"
      provides: "extractMusterFullText, insertMusterChunks, searchMusterChunks"
      exports: ["extractMusterFullText", "insertMusterChunks", "searchMusterChunks", "MusterChunkResult"]
  key_links:
    - from: "src/lib/muster/ingestion.ts:insertMusterChunks"
      to: "prisma.muster_chunks"
      via: "$executeRaw INSERT with kanzleiEigen from parent Muster.isKanzleiEigen"
      pattern: "muster.isKanzleiEigen"
    - from: "src/lib/muster/ingestion.ts:searchMusterChunks"
      to: "muster_chunks"
      via: "$queryRaw cosine similarity with 1.3x kanzleiEigen boost"
      pattern: "KANZLEI_BOOST.*kanzleiEigen"
    - from: "src/lib/muster/seed-amtliche.ts:seedAmtlicheFormulare"
      to: "SystemSetting muster.amtliche_seed_version"
      via: "getSetting idempotency guard before insert"
      pattern: "muster.amtliche_seed_version"
---

<objective>
Lay the muster_chunks infrastructure: Prisma schema migration adding isKanzleiEigen/kanzleiEigen fields, the muster library (extractMusterFullText, insertMusterChunks, searchMusterChunks with 1.3x kanzlei boost), and seed 6 amtliche Arbeitsrecht Formulare with normalized {{PLATZHALTER}}.

Purpose: Plan 02 (Admin UI + ingestion processor) and Plan 03 (Chain F) both depend on the schema migration and the ingestion.ts exports. Building the library and migration first keeps downstream plans unblocked.

Output: prisma/schema.prisma migrated, src/lib/muster/seed-amtliche.ts, src/lib/muster/ingestion.ts
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From prisma/schema.prisma (current Muster — MISSING isKanzleiEigen):
```prisma
model Muster {
  id           String          @id @default(cuid())
  name         String
  kategorie    String
  beschreibung String?         @db.Text
  minioKey     String
  mimeType     String
  nerStatus    MusterNerStatus @default(PENDING_NER)
  uploadedById String
  uploadedBy   User            @relation("MusterUploads", fields: [uploadedById], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  chunks       MusterChunk[]

  @@index([nerStatus])
  @@map("muster")
}

model MusterChunk {
  id            String    @id @default(cuid())
  musterId      String
  muster        Muster    @relation(fields: [musterId], references: [id], onDelete: Cascade)
  chunkIndex    Int
  content       String    @db.Text
  parentContent String?   @db.Text
  embedding     Unsupported("vector(1024)")?
  modelVersion  String
  createdAt     DateTime  @default(now())

  @@unique([musterId, chunkIndex])
  @@index([musterId])
  @@map("muster_chunks")
}
```

From src/lib/embedding/chunker.ts:
```typescript
export async function chunkDocumentParentChild(text: string): Promise<{
  parent: { content: string };
  children: { content: string; index: number }[];
}[]>
```

From src/lib/embedding/embedder.ts:
```typescript
export const MODEL_VERSION = `${EMBEDDING_MODEL}@1.0`;
export async function generateEmbedding(text: string): Promise<number[]>
```

From src/lib/storage.ts:
```typescript
export async function getFileStream(key: string): Promise<SdkStreamMixin>
export async function uploadFile(key: string, body: Buffer, contentType: string, size: number): Promise<void>
```

From src/lib/ocr/stirling-client.ts:
```typescript
export async function convertToPdf(buffer: Buffer, filename: string): Promise<Buffer>
```

From Phase 14 pattern (getSetting/updateSetting for SHA cache — same for seed version):
```typescript
import { getSetting, updateSetting } from "@/lib/settings";
// Returns string | null
const val = await getSetting("muster.amtliche_seed_version");
await updateSetting("muster.amtliche_seed_version", "v0.1");
```

From src/lib/urteile/ingestion.ts (pattern to mirror for searchMusterChunks):
```typescript
export interface UrteilChunkResult {
  id: string;
  urteilId: string;
  content: string;
  // ...
  score: number;
}
export async function searchUrteilChunks(
  queryEmbedding: number[],
  opts: { limit?: number; minScore?: number }
): Promise<UrteilChunkResult[]>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration — add isKanzleiEigen to Muster and kanzleiEigen to MusterChunk</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two boolean fields to the existing models in prisma/schema.prisma:

In model Muster, add after the nerStatus line:
  `isKanzleiEigen Boolean @default(false)  // true = uploaded via /admin/muster; false = seeded amtliche`

In model MusterChunk, add after the modelVersion line:
  `kanzleiEigen  Boolean   @default(false)  // Propagated from parent Muster.isKanzleiEigen at insert time`

After editing the schema file, run:
  `npx prisma migrate dev --name add_muster_kanzlei_eigen`

This creates prisma/migrations/[timestamp]_add_muster_kanzlei_eigen/migration.sql with:
  ALTER TABLE "muster" ADD COLUMN "isKanzleiEigen" BOOLEAN NOT NULL DEFAULT false;
  ALTER TABLE "muster_chunks" ADD COLUMN "kanzleiEigen" BOOLEAN NOT NULL DEFAULT false;

Then regenerate the Prisma client:
  `npx prisma generate`

IMPORTANT: Do NOT run `prisma db push` — use `migrate dev` to create the tracked migration file.
  </action>
  <verify>
    <automated>grep -c "isKanzleiEigen" /Users/patrickbaumfalk/Projekte/AI-Lawyer/prisma/schema.prisma && grep -c "kanzleiEigen" /Users/patrickbaumfalk/Projekte/AI-Lawyer/prisma/schema.prisma && ls /Users/patrickbaumfalk/Projekte/AI-Lawyer/prisma/migrations/ | grep add_muster_kanzlei_eigen</automated>
  </verify>
  <done>schema.prisma has both fields; migration file exists in prisma/migrations/; `npx prisma generate` exits 0; `npx tsc --noEmit` exits 0</done>
</task>

<task type="auto">
  <name>Task 2: Create src/lib/muster/seed-amtliche.ts and src/lib/muster/ingestion.ts</name>
  <files>
    src/lib/muster/seed-amtliche.ts
    src/lib/muster/ingestion.ts
  </files>
  <action>
Create the directory `src/lib/muster/` and two files:

**src/lib/muster/seed-amtliche.ts**

Export `AmtlichesMusterDefinition` interface and `AMTLICHE_MUSTER` constant with 6 hardcoded German Arbeitsrecht form templates. Also export `seedAmtlicheFormulare()` which:
1. Checks `getSetting("muster.amtliche_seed_version")` — if value equals `"v0.1"`, return early (idempotent)
2. Creates a synthetic system-user Muster row per amtliches Muster via `prisma.muster.create` with `isKanzleiEigen: false`, `nerStatus: "INDEXED"`, `uploadedById` = first ADMIN user in DB (or create a system placeholder)
3. Calls `insertMusterChunks(muster.id)` from ingestion.ts for each
4. After all seeded successfully, calls `updateSetting("muster.amtliche_seed_version", "v0.1")`

The 6 amtliche Muster templates (content must include normalized {{PLATZHALTER}}):
1. `name: "Klageschrift Kündigungsschutzklage"`, `kategorie: "Klage"`, `rechtsgebiet: "Arbeitsrecht"` — full KSchG § 1 Klageschrift structure with RUBRUM, ANTRÄGE (3 counts), BEGRÜNDUNG (Parteien, Kündigung, Unwirksamkeit sections)
2. `name: "Abmahnungsschreiben"`, `kategorie: "Schreiben"`, `rechtsgebiet: "Arbeitsrecht"` — formal warning letter with Sachverhaltsdarstellung, Rüge, Kündigungsandrohung
3. `name: "Aufhebungsvertrag"`, `kategorie: "Vertrag"`, `rechtsgebiet: "Arbeitsrecht"` — termination agreement with Beendigungsdatum, Abfindungsregelung, Freistellung
4. `name: "Antrag auf einstweilige Verfügung (Weiterbeschäftigung)"`, `kategorie: "Antrag"`, `rechtsgebiet: "Arbeitsrecht"` — urgent interim relief motion
5. `name: "Klage auf Zeugniserteilung"`, `kategorie: "Klage"`, `rechtsgebiet: "Arbeitsrecht"` — claim for employment reference letter
6. `name: "Widerspruch gegen Abmahnung"`, `kategorie: "Schreiben"`, `rechtsgebiet: "Arbeitsrecht"` — formal objection to employer warning

For the `uploadedById` on seeded amtliche Muster, the cleanest approach: query `prisma.user.findFirst({ where: { role: "ADMIN" } })`. If no ADMIN exists (fresh DB), throw with a clear message "seedAmtlicheFormulare: no ADMIN user found — create an admin user first".

Note: `seedAmtlicheFormulare()` is called in worker.ts startup in Plan 02. For now, just export the function.

---

**src/lib/muster/ingestion.ts**

Implement and export:

```typescript
export interface MusterChunkResult {
  id: string;
  musterId: string;
  content: string;
  parentContent: string | null;
  musterName: string;
  kategorie: string;
  kanzleiEigen: boolean;
  score: number; // After 1.3x boost applied for kanzleiEigen=true
}
```

`extractMusterFullText(minioKey: string, mimeType: string): Promise<string>`
- Gets the MinIO stream via `getFileStream(minioKey)` from `@/lib/storage`
- Converts stream to Buffer via the same streamToBuffer() helper pattern as ocr.processor.ts (handle SdkStreamMixin.transformToByteArray + AsyncIterable<Buffer> fallback)
- DOCX (application/vnd.openxmlformats-officedocument.wordprocessingml.document OR application/msword): `convertToPdf(buffer, "muster.docx")` then `pdfParse(pdfBuffer)`
- PDF (application/pdf): `pdfParse(buffer)` directly
- Fallback: `buffer.toString("utf-8")`
- Returns extracted text string; throws if result.trim().length < 10

`insertMusterChunks(musterId: string): Promise<{ inserted: number }>`
- Loads Muster from DB with `select: { minioKey, mimeType, isKanzleiEigen }`
- Calls `extractMusterFullText()` to get plain text
- Calls `chunkDocumentParentChild(text)` from `@/lib/embedding/chunker`
- Deletes existing chunks: `prisma.$executeRaw\`DELETE FROM muster_chunks WHERE "musterId" = ${musterId}\``
- Loops over parent/child groups: embeds each child with `generateEmbedding(child.content)`, inserts via `$executeRaw` with `kanzleiEigen = muster.isKanzleiEigen`
- INSERT columns: id (gen_random_uuid()), musterId, chunkIndex, content, parentContent, embedding (pgvector.toSql(embedding)::vector), modelVersion (MODEL_VERSION), kanzleiEigen, createdAt (NOW())
- Returns `{ inserted: count }`

`searchMusterChunks(queryEmbedding: number[], opts?: { limit?: number; minScore?: number }): Promise<MusterChunkResult[]>`
- Default: limit=5, minScore=0.0
- Fetches `limit * 3` candidates via `$queryRaw` cosine similarity on muster_chunks JOIN muster
- Query: SELECT mc.id, mc.musterId, mc.content, mc.parentContent, m.name AS musterName, m.kategorie, mc.kanzleiEigen, 1 - (mc.embedding <=> ${vectorSql}::vector) AS rawScore FROM muster_chunks mc JOIN muster m ON m.id = mc.musterId WHERE mc.embedding IS NOT NULL AND m.nerStatus = 'INDEXED' ORDER BY mc.embedding <=> ${vectorSql}::vector ASC LIMIT ${fetchLimit}
- Post-query: apply `const KANZLEI_BOOST = 1.3` multiplier: `score = rawScore * (kanzleiEigen ? KANZLEI_BOOST : 1.0)`
- Filter by minScore, sort descending, slice to limit
- Returns MusterChunkResult[]

Use `import pgvector from "pgvector"` (already in project from urteile/gesetze ingestion).
Use `import pdfParse from "pdf-parse"` (already in package.json as ^2.4.5).
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -20 && grep -l "seedAmtlicheFormulare\|insertMusterChunks\|searchMusterChunks\|MusterChunkResult" src/lib/muster/ingestion.ts src/lib/muster/seed-amtliche.ts</automated>
  </verify>
  <done>Both files exist; `npx tsc --noEmit` exits 0; ingestion.ts exports MusterChunkResult, extractMusterFullText, insertMusterChunks, searchMusterChunks; seed-amtliche.ts exports AMTLICHE_MUSTER (6 entries) and seedAmtlicheFormulare</done>
</task>

</tasks>

<verification>
- `grep "isKanzleiEigen" prisma/schema.prisma` — found in Muster model
- `grep "kanzleiEigen" prisma/schema.prisma` — found in MusterChunk model
- `ls prisma/migrations/ | grep add_muster_kanzlei_eigen` — migration file exists
- `npx tsc --noEmit` — exits 0
- `grep "KANZLEI_BOOST" src/lib/muster/ingestion.ts` — 1.3x boost present
- `grep -c "{{" src/lib/muster/seed-amtliche.ts` — at least 30 placeholder occurrences across 6 templates
- `grep "seedAmtlicheFormulare\|muster.amtliche_seed_version" src/lib/muster/seed-amtliche.ts` — idempotency guard present
</verification>

<success_criteria>
- prisma/schema.prisma contains `isKanzleiEigen Boolean @default(false)` on Muster and `kanzleiEigen Boolean @default(false)` on MusterChunk
- Migration file exists in prisma/migrations/[timestamp]_add_muster_kanzlei_eigen/
- src/lib/muster/ingestion.ts exports MusterChunkResult interface, extractMusterFullText, insertMusterChunks, searchMusterChunks with 1.3x kanzlei boost
- src/lib/muster/seed-amtliche.ts exports AMTLICHE_MUSTER (6 Arbeitsrecht forms with {{PLATZHALTER}}) and seedAmtlicheFormulare (idempotent via SystemSetting)
- TypeScript clean (tsc --noEmit exits 0)
</success_criteria>

<output>
After completion, create `.planning/phases/18-muster-rag-admin-upload-ui/18-01-SUMMARY.md`
</output>
