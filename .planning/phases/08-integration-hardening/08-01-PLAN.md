---
phase: 08-integration-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql
  - src/lib/rbac.ts
  - src/components/layout/sidebar.tsx
  - src/app/api/admin/rollen/route.ts
  - src/app/api/ki-entwuerfe/route.ts
  - src/app/api/finanzen/aktenkonto/[akteId]/route.ts
  - src/app/api/dokumente/[id]/route.ts
  - src/app/api/akten/route.ts
  - src/app/api/akten/[id]/dokumente/route.ts
  - src/app/api/finanzen/rechnungen/route.ts
  - src/app/api/finanzen/rechnungen/[id]/route.ts
  - src/app/api/finanzen/aktenkonto/route.ts
  - src/app/api/finanzen/zeiterfassung/route.ts
  - src/app/api/finanzen/buchungsperioden/route.ts
  - src/app/api/finanzen/kostenstellen/route.ts
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/finanzen/page.tsx
  - src/app/(dashboard)/admin/benutzer/page.tsx
autonomous: true
requirements:
  - REQ-RS-001
  - REQ-RS-002
  - REQ-RS-003
  - REQ-FI-003
  - REQ-FI-005
  - REQ-FI-006

must_haves:
  truths:
    - "PRAKTIKANT role no longer exists in the system -- Prisma schema has only 4 UserRole values (ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT)"
    - "Finance API routes enforce Akte-level access -- SACHBEARBEITER/SEKRETARIAT only see financial data for their assigned Akten"
    - "ADMIN sees kanzlei-wide financial data; ANWALT with canSeeKanzleiFinanzen=true sees kanzlei-wide; other ANWALT sees only own Akten"
    - "Dashboard Prisma queries are user-scoped -- non-ADMIN users only see counts for accessible Akten"
    - "Finance KPI cards display correct values -- API response keys match frontend consumption"
    - "SEKRETARIAT/SACHBEARBEITER see only operative KPIs; ANWALT/ADMIN see all KPIs including Gesamtumsatz"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "UserRole enum without PRAKTIKANT; User.canSeeKanzleiFinanzen Boolean field"
      contains: "canSeeKanzleiFinanzen"
    - path: "prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql"
      provides: "Safe migration: UPDATE PRAKTIKANT users, ALTER enum, ADD column"
    - path: "src/lib/rbac.ts"
      provides: "PERMISSIONS without PRAKTIKANT entry; ROLE_LABELS with 4 roles"
    - path: "src/app/api/finanzen/rechnungen/route.ts"
      provides: "GET with buildAkteAccessFilter on akte relation"
      contains: "buildAkteAccessFilter"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "User-scoped Prisma queries with access filter"
      contains: "buildAkteAccessFilter"
  key_links:
    - from: "src/app/api/finanzen/rechnungen/route.ts"
      to: "src/lib/rbac.ts"
      via: "import buildAkteAccessFilter"
      pattern: "buildAkteAccessFilter"
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/lib/rbac.ts"
      via: "import buildAkteAccessFilter"
      pattern: "buildAkteAccessFilter"
    - from: "src/app/api/finanzen/rechnungen/route.ts"
      to: "prisma.user"
      via: "canSeeKanzleiFinanzen lookup"
      pattern: "canSeeKanzleiFinanzen"
---

<objective>
Remove the PRAKTIKANT role entirely, add canSeeKanzleiFinanzen to User model, wire buildAkteAccessFilter into all finance and dashboard routes, fix finance KPI key mismatches, and enforce role-based KPI visibility.

Purpose: Close RBAC enforcement gaps on finance/dashboard routes (INT-A01, INT-A03) and simplify the role model from 5 to 4 roles per user decision.
Output: Prisma migration, updated RBAC helpers, finance routes with Akte-level access, dashboard with user-scoped queries, correct KPI display.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-hardening/08-CONTEXT.md
@.planning/phases/08-integration-hardening/08-RESEARCH.md
@.planning/phases/07-rollen-sicherheit-compliance-observability/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove PRAKTIKANT role + add canSeeKanzleiFinanzen field + clean all references</name>
  <files>
    prisma/schema.prisma
    prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql
    src/lib/rbac.ts
    src/components/layout/sidebar.tsx
    src/app/api/admin/rollen/route.ts
    src/app/api/ki-entwuerfe/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/route.ts
    src/app/api/dokumente/[id]/route.ts
    src/app/api/akten/route.ts
    src/app/api/akten/[id]/dokumente/route.ts
    src/app/(dashboard)/admin/benutzer/page.tsx
  </files>
  <action>
    **Prisma schema changes:**
    1. In `prisma/schema.prisma`, remove `PRAKTIKANT` from the `UserRole` enum (keep ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT).
    2. Add `canSeeKanzleiFinanzen Boolean @default(false)` field to the `User` model.

    **Create migration SQL manually** (database not running) at `prisma/migrations/20260225120000_remove_praktikant_add_kanzleifinanz/migration.sql`:
    ```sql
    -- Step 1: Convert any PRAKTIKANT users to SACHBEARBEITER (must happen BEFORE enum value removal)
    UPDATE "User" SET "role" = 'SACHBEARBEITER' WHERE "role" = 'PRAKTIKANT';

    -- Step 2: Remove PRAKTIKANT from UserRole enum
    -- Create new enum type, migrate column, drop old
    CREATE TYPE "UserRole_new" AS ENUM ('ADMIN', 'ANWALT', 'SACHBEARBEITER', 'SEKRETARIAT');
    ALTER TABLE "User" ALTER COLUMN "role" TYPE "UserRole_new" USING ("role"::text::"UserRole_new");
    ALTER TYPE "UserRole" RENAME TO "UserRole_old";
    ALTER TYPE "UserRole_new" RENAME TO "UserRole";
    DROP TYPE "UserRole_old";

    -- Step 3: Add canSeeKanzleiFinanzen field
    ALTER TABLE "User" ADD COLUMN "canSeeKanzleiFinanzen" BOOLEAN NOT NULL DEFAULT false;
    ```

    **RBAC cleanup in `src/lib/rbac.ts`:**
    1. Remove the `PRAKTIKANT` entry from the `PERMISSIONS` constant (the entire PRAKTIKANT key and its permission object).
    2. Remove `PRAKTIKANT` from `ROLE_LABELS` map.
    3. In `requireAkteAccess()`, remove any PRAKTIKANT-specific check/comment.
    4. In `buildAkteAccessFilter()`, remove PRAKTIKANT-specific handling if any.

    **Sidebar cleanup in `src/components/layout/sidebar.tsx`:**
    1. Remove all `hideForRoles: ["PRAKTIKANT"]` arrays from nav items. If a nav item ONLY hid for PRAKTIKANT, remove the `hideForRoles` property entirely. If it hid for both PRAKTIKANT and SEKRETARIAT, keep `hideForRoles: ["SEKRETARIAT"]`.

    **API route PRAKTIKANT reference removal:**
    - `src/app/api/admin/rollen/route.ts`: Remove PRAKTIKANT from the roles array.
    - `src/app/api/ki-entwuerfe/route.ts`: Remove the PRAKTIKANT-specific block/check. Per user decision, KI is open to all logged-in users.
    - `src/app/api/finanzen/aktenkonto/[akteId]/route.ts`: Remove PRAKTIKANT read-only check. Replace with standard `requireAkteAccess(akteId)` if not already using it.
    - `src/app/api/dokumente/[id]/route.ts`: Remove/update PRAKTIKANT-blocking comment.
    - `src/app/api/akten/route.ts`: Remove PRAKTIKANT cannot-create check.
    - `src/app/api/akten/[id]/dokumente/route.ts`: Remove PRAKTIKANT blocked-from-uploads check.
    - Do NOT touch beA routes in this task (Plan 02 handles those).

    **Admin UI for canSeeKanzleiFinanzen:**
    - If a user management page exists at `src/app/(dashboard)/admin/benutzer/page.tsx` or similar, add a checkbox "Kanzleiweite Finanzen" that is only visible when the user's role is ANWALT. The checkbox toggles the `canSeeKanzleiFinanzen` field via a PATCH to the user endpoint.
    - If no user management page exists, add the field to the admin rollen page or create a minimal toggle in the existing user detail/edit flow.

    Run `npx prisma validate` to confirm schema is valid.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx prisma validate && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>Grep for "PRAKTIKANT" across the codebase -- should only appear in migration SQL and git history, not in active TypeScript code</manual>
  </verify>
  <done>
    - UserRole enum has exactly 4 values: ADMIN, ANWALT, SACHBEARBEITER, SEKRETARIAT
    - canSeeKanzleiFinanzen field exists on User model with default false
    - Migration SQL safely converts PRAKTIKANT users before removing enum value
    - No PRAKTIKANT references remain in rbac.ts, sidebar, or API routes (except beA routes handled in Plan 02)
    - RBAC PERMISSIONS constant has 4 role entries, not 5
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire buildAkteAccessFilter to finance/dashboard routes + fix KPI keys + role-based KPI visibility</name>
  <files>
    src/app/api/finanzen/rechnungen/route.ts
    src/app/api/finanzen/rechnungen/[id]/route.ts
    src/app/api/finanzen/aktenkonto/route.ts
    src/app/api/finanzen/aktenkonto/[akteId]/route.ts
    src/app/api/finanzen/zeiterfassung/route.ts
    src/app/api/finanzen/buchungsperioden/route.ts
    src/app/api/finanzen/kostenstellen/route.ts
    src/app/(dashboard)/dashboard/page.tsx
    src/app/(dashboard)/finanzen/page.tsx
  </files>
  <action>
    **Finance route RBAC pattern (apply to each route):**

    For every finance GET (list) route, add Akte-level access filtering:
    ```typescript
    import { requireAuth, buildAkteAccessFilter } from "@/lib/rbac";
    import { prisma } from "@/lib/db";

    // At the start of GET handler:
    const authResult = await requireAuth();
    if (authResult.error) return authResult.error;
    const { session } = authResult;

    // Determine scope
    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: { canSeeKanzleiFinanzen: true },
    });
    const showKanzleiweit = session.user.role === "ADMIN" ||
      (session.user.role === "ANWALT" && user?.canSeeKanzleiFinanzen);
    const akteFilter = showKanzleiweit ? {} : buildAkteAccessFilter(session.user.id, session.user.role);

    // Apply to queries (for models with akte relation):
    // where: { akte: akteFilter, ...otherFilters }
    // For aggregate/count queries, reuse same where clause
    ```

    **Apply to specific routes:**
    1. `src/app/api/finanzen/rechnungen/route.ts` GET: Add `where: { akte: akteFilter }` to findMany + count + aggregate. POST: Verify user has access to the referenced Akte before creating invoice.
    2. `src/app/api/finanzen/rechnungen/[id]/route.ts` GET/PATCH/DELETE: Look up the invoice's akteId, then call `requireAkteAccess(akteId)` for single-record endpoints.
    3. `src/app/api/finanzen/aktenkonto/route.ts` GET: Add `where: { akte: akteFilter }` to cross-case aktenkonto queries. Also add fremdgeldAlerts to the response if missing.
    4. `src/app/api/finanzen/aktenkonto/[akteId]/route.ts`: Already has per-Akte access (PRAKTIKANT check removed in Task 1). Ensure it uses `requireAkteAccess(akteId)`.
    5. `src/app/api/finanzen/zeiterfassung/route.ts`: If listing time entries across Akten, add akte access filter. If per-Akte, use requireAkteAccess.
    6. `src/app/api/finanzen/buchungsperioden/route.ts`: This is ADMIN-only (period locking). Verify it uses `requireRole("ADMIN")`.
    7. `src/app/api/finanzen/kostenstellen/route.ts`: ADMIN-only for write operations. Read may need filtering -- check the query scope and add filter if it returns Akte-linked data.

    **Dashboard RBAC in `src/app/(dashboard)/dashboard/page.tsx`:**
    The dashboard is a server component calling Prisma directly. Add access filtering:
    ```typescript
    import { auth } from "@/lib/auth";
    import { buildAkteAccessFilter } from "@/lib/rbac";

    const session = await auth();
    const accessFilter = buildAkteAccessFilter(session.user.id, session.user.role);

    // Apply to ALL Prisma queries in the page:
    // prisma.akte.count({ where: { status: "OFFEN", ...accessFilter } })
    // prisma.kalenderEintrag.count({ where: { akte: accessFilter, ... } })
    // prisma.rechnung.count({ where: { akte: accessFilter, ... } })
    // etc.
    ```

    **Finance KPI key alignment in `src/app/(dashboard)/finanzen/page.tsx`:**
    Read both the frontend page and the API response to identify mismatches.
    Per RESEARCH.md, the known mismatches are:
    - Frontend reads `invoiceData.stats` but API returns `invoiceData.summary` -> either rename the API response key to `stats` OR update the frontend to read `summary`
    - Frontend reads `stats.gesamtUmsatz` but API has no gesamtUmsatz field -> add gesamtUmsatz calculation to the rechnungen API summary (sum of all BEZAHLT invoices' nettoBetrag)
    - Frontend reads `stats.ueberfaellig` but API returns `summary.ueberfaelligCount` -> align the key names
    - Frontend reads `aktenkontoData.fremdgeldAlerts` but cross-case API has no fremdgeldAlerts -> add fremdgeld alert data to the cross-case aktenkonto GET response

    **Preferred approach:** Fix the API to match what the frontend expects. This is less risky than changing the frontend.

    **Role-based KPI visibility in `src/app/(dashboard)/finanzen/page.tsx`:**
    - SEKRETARIAT + SACHBEARBEITER: only show operative KPIs (offene Rechnungen count, ueberfaellige Rechnungen count, Fremdgeld-Saldo)
    - ANWALT + ADMIN: show all KPIs including Gesamtumsatz, Gewinn, Honorarvolumen
    - Use the session role to conditionally render KPI cards. The session is available via `auth()` in server components.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -50</automated>
    <manual>
      1. Grep for "buildAkteAccessFilter" in finance routes -- should appear in rechnungen/route.ts, aktenkonto/route.ts, zeiterfassung/route.ts, and dashboard/page.tsx
      2. Verify finanzen/page.tsx conditionally renders KPI cards based on session.user.role
      3. Verify the API response keys for rechnungen GET match what finanzen/page.tsx reads
    </manual>
  </verify>
  <done>
    - All finance list routes use buildAkteAccessFilter for Akte-level access filtering
    - canSeeKanzleiFinanzen controls whether ANWALT gets kanzlei-wide or personal view
    - Dashboard page queries are user-scoped with buildAkteAccessFilter
    - Finance KPI cards show correct data (API response keys match frontend)
    - SEKRETARIAT/SACHBEARBEITER see only operative KPIs, ANWALT/ADMIN see all KPIs
    - Finance detail routes (single invoice, single aktenkonto) use requireAkteAccess
  </done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes with updated schema (no PRAKTIKANT, has canSeeKanzleiFinanzen)
2. `npx tsc --noEmit` passes cleanly (or with only pre-existing errors)
3. `grep -r "PRAKTIKANT" src/ --include="*.ts" --include="*.tsx"` returns zero results
4. `grep -r "buildAkteAccessFilter" src/app/api/finanzen/ src/app/\(dashboard\)/dashboard/` shows the filter is used in all finance list routes and dashboard
5. Finance overview page renders KPI cards conditionally based on role
</verification>

<success_criteria>
- PRAKTIKANT role fully removed from codebase (schema, rbac, API routes, sidebar)
- canSeeKanzleiFinanzen field on User model controls ANWALT kanzlei-wide finance visibility
- Every finance list route applies buildAkteAccessFilter -- users cannot see financial data for Akten they lack access to
- Dashboard counts are user-scoped
- Finance KPI cards display correct data with proper role-based visibility
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-hardening/08-01-SUMMARY.md`
</output>
