---
phase: 06-ai-features-bea
plan: 03
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - prisma/schema.prisma
  - src/lib/ai/scan-processor.ts
  - src/lib/ai/briefing-processor.ts
  - src/lib/ai/proactive-processor.ts
  - src/lib/ai/deadline-extractor.ts
  - src/lib/ai/party-extractor.ts
  - src/worker.ts
  - src/lib/queue/processors/embedding.processor.ts
  - src/lib/email/smtp/send-processor.ts
  - src/app/api/helena/suggestions/route.ts
  - src/app/api/helena/suggestions/[id]/route.ts
  - src/app/(dashboard)/ki-chat/helena-tab.tsx
  - src/components/ki/helena-feed.tsx
  - src/components/ki/suggestion-card.tsx
  - src/components/email/email-detail-view.tsx
  - src/components/notifications/notification-provider.tsx
autonomous: true
requirements:
  - REQ-KI-004
  - REQ-KI-005
  - REQ-KI-006
  - REQ-KI-008
  - REQ-KI-011

must_haves:
  truths:
    - "New documents trigger automatic AI scanning after embedding completes"
    - "New emails trigger automatic AI scanning after sync"
    - "Helena extracts deadlines from Schriftsaetze and creates ENTWURF KalenderEintrag"
    - "Helena recognizes parties from documents and suggests Beteiligte additions"
    - "Helena suggestions appear in a card-based feed with Uebernehmen/Ablehnen/Bearbeiten actions"
    - "Helena suggestions create notifications in the notification bell"
    - "Proactive scanning automatically pauses when monthly token budget reaches 100%"
    - "AI scan is idempotent: max 1 result per document+type per day, retry max 2, ai:error on failure"
    - "Proactive scanning pauses at 100% budget (chat stays on)"
    - "Email detail view shows 'KI-Antwort verfuegbar' banner when Helena has a suggestion"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "HelenaSuggestion model"
      contains: "model HelenaSuggestion"
    - path: "src/lib/ai/scan-processor.ts"
      provides: "BullMQ processor for AI document/email scanning"
      exports: ["processScan"]
    - path: "src/lib/ai/deadline-extractor.ts"
      provides: "Structured deadline extraction from text"
      exports: ["extractDeadlines"]
    - path: "src/lib/ai/party-extractor.ts"
      provides: "Structured party extraction from text"
      exports: ["extractParties"]
    - path: "src/components/ki/helena-feed.tsx"
      provides: "Card-based suggestions feed component"
    - path: "src/app/api/helena/suggestions/route.ts"
      provides: "Suggestions CRUD API"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/lib/queue/processors/embedding.processor.ts"
      to: "ai-scan queue"
      via: "BullMQ add job after embedding completes"
      pattern: "aiScanQueue\\.add"
    - from: "src/lib/email/smtp/send-processor.ts"
      to: "ai-scan queue"
      via: "BullMQ add job after new email synced"
      pattern: "aiScanQueue\\.add"
    - from: "src/lib/ai/scan-processor.ts"
      to: "src/lib/ai/provider.ts"
      via: "getModel() + generateObject() for structured extraction"
      pattern: "generateObject.*getModel"
    - from: "src/lib/ai/scan-processor.ts"
      to: "prisma.helenaSuggestion"
      via: "create suggestion records"
      pattern: "prisma\\.helenaSuggestion\\.create"
---

<objective>
Build Helena's proactive AI agent: event-driven scanning of new documents and emails for deadline recognition, party extraction, and response draft suggestions. Card-based suggestions feed with accept/reject/edit actions. Daily morning briefing. Token budget enforcement.

Purpose: Helena proactively assists attorneys by scanning incoming work and suggesting actions, functioning like a digital Rechtsanwaltsfachangestellte.
Output: Working AI scan pipeline, suggestion feed, deadline/party extractors, budget enforcement, notification integration.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md
@.planning/phases/06-ai-features-bea/06-01-SUMMARY.md

# AI provider (from Plan 01)
@src/lib/ai/provider.ts
@src/lib/ai/token-tracker.ts

# Existing worker and queues
@src/worker.ts
@src/lib/queue/processors/embedding.processor.ts

# Notification system
@src/lib/notifications/service.ts
@src/lib/notifications/types.ts

# Email sync
@src/lib/queue/processors/email-sync.processor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: HelenaSuggestion Schema + Deadline/Party Extractors + AI Scan Processor + Worker Wiring</name>
  <files>
    prisma/schema.prisma
    src/lib/ai/scan-processor.ts
    src/lib/ai/deadline-extractor.ts
    src/lib/ai/party-extractor.ts
    src/lib/ai/briefing-processor.ts
    src/lib/ai/proactive-processor.ts
    src/worker.ts
    src/lib/queue/processors/embedding.processor.ts
    src/lib/email/smtp/send-processor.ts
  </files>
  <action>
1. Add `HelenaSuggestion` model to `prisma/schema.prisma`:
   ```
   model HelenaSuggestion {
     id          String    @id @default(cuid())
     userId      String    // Target user (Verantwortlicher of the Akte)
     akteId      String?
     dokumentId  String?   // Source document that triggered this
     emailId     String?   // Source email that triggered this
     typ         String    // FRIST_ERKANNT | ANTWORT_ENTWURF | BETEILIGTE_ERKANNT | DOKUMENT_KLASSIFIZIERT | TERMIN_VORSCHLAG | HINWEIS | BRIEFING
     titel       String
     inhalt      String    @db.Text
     quellen     Json?     // [{dokumentId, name, passage}]
     status      String    @default("NEU") // NEU | UEBERNOMMEN | ABGELEHNT | BEARBEITET
     feedback    String?   // POSITIV | NEGATIV (Daumen hoch/runter)
     linkedId    String?   // ID of created entity when accepted (KalenderEintrag, Kontakt, etc.)
     retryCount  Int       @default(0)
     errorMsg    String?
     createdAt   DateTime  @default(now())
     readAt      DateTime?
     user        User      @relation(fields: [userId], references: [id])
     akte        Akte?     @relation(fields: [akteId], references: [id])
     @@index([userId, status, createdAt])
     @@index([akteId, typ, createdAt])
   }
   ```
   Add `helenaSuggestions HelenaSuggestion[]` to User and Akte models.
   Run `npx prisma db push`.

2. Create `src/lib/ai/deadline-extractor.ts`:
   - `extractDeadlines(text: string, metadata?: {dokumentName, akteId})`: Uses AI SDK generateObject() with getModel() and a zod schema:
     ```typescript
     z.object({
       deadlines: z.array(z.object({
         beschreibung: z.string(),
         fristtyp: z.enum(['EREIGNISFRIST', 'BEGINNFRIST', 'UNBESTIMMT']),
         datum: z.string().nullable(), // ISO date if found
         dauer: z.string().nullable(), // e.g., "2 Wochen", "1 Monat"
         gesetzlicheGrundlage: z.string().nullable(), // e.g., "SS 276 ZPO"
         confidence: z.number().min(0).max(1),
         quellenStelle: z.string(), // excerpt where deadline was found
       }))
     })
     ```
   - German system prompt: "Extrahiere alle Fristen und Termine aus dem folgenden juristischen Text. Suche nach Mustern wie 'Frist von X Wochen', 'bis zum DD.MM.YYYY', 'innerhalb von X Tagen', Rechtsmittelfristen, Stellungnahmefristen, etc."
   - Filter results by confidence >= 0.6.
   - Track tokens via wrapWithTracking with funktion='SCAN'.

3. Create `src/lib/ai/party-extractor.ts`:
   - `extractParties(text: string, metadata?: {dokumentName, akteId})`: Uses generateObject() with schema:
     ```typescript
     z.object({
       parties: z.array(z.object({
         name: z.string(),
         rolle: z.enum(['KLAEGER', 'BEKLAGTER', 'ZEUGE', 'RICHTER', 'ANWALT', 'SACHVERSTAENDIGER', 'BEHOERDE', 'SONSTIG']),
         typ: z.enum(['NATUERLICH', 'JURISTISCH']),
         adresse: z.string().nullable(),
         aktenzeichen: z.string().nullable(), // court case number if mentioned
         confidence: z.number().min(0).max(1),
       }))
     })
     ```
   - German system prompt for party extraction from legal text.
   - Filter by confidence >= 0.6.

4. Create `src/lib/ai/scan-processor.ts`:
   - `processScan(job: Job)`: BullMQ processor for 'ai-scan' queue.
   - Job data: `{type: 'document'|'email'|'bea', id: string, akteId: string, content: string, metadata: {...}}`.
   - Idempotency check (REQ-KI-011): Before processing, query HelenaSuggestion for same (dokumentId/emailId, typ, date=today). Skip if exists. SQL: `WHERE dokumentId = ? AND typ = ? AND createdAt >= today_start`.
   - Budget check: Call checkBudget(). If paused, skip scan (log and return).
   - Processing pipeline:
     a) Extract deadlines via extractDeadlines(). For each high-confidence deadline: create HelenaSuggestion with typ='FRIST_ERKANNT', create ENTWURF KalenderEintrag (typ='FRIST', title=beschreibung, faelligAm=datum if parseable, akteId).
     b) Extract parties via extractParties(). For each: create HelenaSuggestion with typ='BETEILIGTE_ERKANNT'.
     c) If type='email': Generate response draft suggestion via generateText(). Create HelenaSuggestion with typ='ANTWORT_ENTWURF', inhalt=draft.
   - Error handling: On failure, increment retryCount. If retryCount >= 2, mark with errorMsg. Don't re-throw (mark as failed, don't block queue).
   - Create notification via createNotification() for each new suggestion (type: 'ai_suggestion', data: {suggestionId, typ, titel}).

5. Create `src/lib/ai/briefing-processor.ts`:
   - `processBriefing(job: Job)`: BullMQ processor for 'ai-briefing' queue.
   - Job data: `{userId: string}`.
   - Query: Today's due Fristen (faelligAm = today), unanswered emails (last 24h, unveraktet), stale Akten (no activity in 7 days with open items).
   - Generate briefing text via generateText() with structured summary.
   - Create HelenaSuggestion with typ='BRIEFING', titel="Ihr Tagesbriefing", inhalt=briefing text.
   - Create notification.

6. Create `src/lib/ai/proactive-processor.ts`:
   - `processProactive(job: Job)`: BullMQ processor for 'ai-proactive' queue.
   - Scans all active Akten (status=OFFEN). For each, check: missing Fristen, stale cases (no activity 14+ days), pending unanswered emails.
   - Creates HelenaSuggestion with typ='HINWEIS' for actionable findings.
   - Batch processing: max 20 Akten per run. Budget check before each.

7. Update `src/worker.ts`:
   - Register three new BullMQ workers:
     a) 'ai-scan' queue with processScan, concurrency: 1 (AI calls are sequential).
     b) 'ai-briefing' queue with processBriefing, concurrency: 1.
     c) 'ai-proactive' queue with processProactive, concurrency: 1.
   - Register repeatable jobs:
     a) ai-proactive: cron from ai.scan_interval setting (default every 4h).
     b) ai-briefing: daily at ai.briefing_time (default 07:00), only if ai.briefing_enabled.
   - Add to ALL_QUEUES for admin monitoring.
   - Add graceful shutdown for new workers.

8. Update `src/lib/queue/processors/embedding.processor.ts`:
   - After successful embedding completion, add job to 'ai-scan' queue: `{type: 'document', id: dokumentId, akteId, content: concatenated chunk texts, metadata: {dokumentName}}`.
   - Only enqueue if ai.scan_enabled setting is true.

9. Update `src/lib/email/smtp/send-processor.ts` (contains `emailSyncProcessor`):
   - After successfully storing a new inbound email (the point where a new Email record is created in the database), add a job to the 'ai-scan' queue: `aiScanQueue.add('scan-email', {type: 'email', id: emailId, akteId: email.akteId, content: email.textBody || email.htmlBody, metadata: {betreff: email.betreff, absender: email.absender}})`.
   - Only enqueue if ai.scan_enabled setting is true (read via getSettingTyped('ai.scan_enabled')).
   - Import the ai-scan queue from the queue registry.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Verify HelenaSuggestion model in schema. Check worker.ts registers ai-scan, ai-briefing, ai-proactive queues. Check embedding processor triggers ai-scan after completion.</manual>
  </verify>
  <done>HelenaSuggestion model created. Deadline and party extractors use AI SDK generateObject with typed schemas. AI scan processor handles document/email/beA scanning with idempotency (max 1 per doc+type per day, retry max 2). Briefing and proactive processors registered in worker with cron schedules. Embedding completion triggers AI scan. Budget enforcement pauses scanning at 100%.</done>
</task>

<task type="auto">
  <name>Task 2: Helena Suggestions Feed UI + API + Email Banner + Notification Integration</name>
  <files>
    src/app/api/helena/suggestions/route.ts
    src/app/api/helena/suggestions/[id]/route.ts
    src/app/(dashboard)/ki-chat/helena-tab.tsx
    src/components/ki/helena-feed.tsx
    src/components/ki/suggestion-card.tsx
    src/components/email/email-detail-view.tsx
    src/components/notifications/notification-provider.tsx
  </files>
  <action>
1. Create `GET /api/helena/suggestions/route.ts`:
   - Auth check. Return suggestions for current user.
   - Query params: status (NEU|UEBERNOMMEN|ABGELEHNT|BEARBEITET, default NEU), akteId (optional), typ (optional), limit (default 50), cursor (for pagination).
   - Order by createdAt DESC.
   - Include akte relation (id, aktenzeichen, beschreibung) for display.

2. Create `GET/PATCH /api/helena/suggestions/[id]/route.ts`:
   - GET: Return single suggestion with full inhalt. Auth check: user owns suggestion.
   - PATCH: Update status (NEU -> UEBERNOMMEN/ABGELEHNT/BEARBEITET), feedback (POSITIV/NEGATIV), readAt.
     - When status='UEBERNOMMEN':
       - If typ='FRIST_ERKANNT': Find the linked ENTWURF KalenderEintrag and mark as active (remove ENTWURF status). Return the KalenderEintrag id.
       - If typ='BETEILIGTE_ERKANNT': Create Beteiligter record from suggestion data. Return beteiligter id.
       - If typ='ANTWORT_ENTWURF': Create ChatNachricht as draft. Return draft id.
       - Store linkedId on the suggestion.
     - When status='ABGELEHNT': Just update status. Track for future prompt tuning.

3. Create `src/components/ki/suggestion-card.tsx` ("use client"):
   - Card component for a single Helena suggestion.
   - Layout: Left icon (per typ: Calendar for FRIST_ERKANNT, Users for BETEILIGTE_ERKANNT, Mail for ANTWORT_ENTWURF, FileText for DOKUMENT_KLASSIFIZIERT, Lightbulb for HINWEIS, Sun for BRIEFING).
   - Content: titel (bold), inhalt preview (max 3 lines, expandable), Akte badge link, relative time.
   - Actions row: "Uebernehmen" (green button), "Ablehnen" (red outline), "Bearbeiten" (blue outline).
   - Feedback: Daumen hoch/runter icons (ThumbsUp, ThumbsDown from lucide-react). PATCH /api/helena/suggestions/[id] with feedback.
   - Status badge: NEU (blue pulse), UEBERNOMMEN (green), ABGELEHNT (gray strikethrough), BEARBEITET (amber).
   - Clicking "Uebernehmen" calls PATCH with status='UEBERNOMMEN', shows success toast with link to created entity.

4. Create `src/components/ki/helena-feed.tsx` ("use client"):
   - Fetches suggestions from GET /api/helena/suggestions.
   - Filter bar: Status tabs (Neu | Uebernommen | Abgelehnt | Alle), Akte filter dropdown, Typ filter.
   - Renders list of SuggestionCards.
   - Empty state: "Helena hat noch keine Vorschlaege. Neue Dokumente und E-Mails werden automatisch analysiert."
   - Skeleton loading state.
   - Pagination: "Mehr laden" button at bottom.

5. Create `src/app/(dashboard)/ki-chat/helena-tab.tsx`:
   - Integrate HelenaFeed into the /ki-chat page as a tab or section.
   - The /ki-chat page should have two modes: "Chat" (default) and "Vorschlaege" (Helena feed).
   - Tab bar at top of chat area: "Chat" | "Vorschlaege ({count})".
   - Count badge shows number of NEU suggestions.

6. Update `src/components/email/email-detail-view.tsx`:
   - Add "KI-Antwort verfuegbar" banner at top of email detail.
   - Fetch: GET /api/helena/suggestions?emailId={currentEmailId}&typ=ANTWORT_ENTWURF&status=NEU.
   - If suggestions exist: Show blue banner with Helena icon: "Helena hat einen Antwort-Entwurf erstellt" + "Anzeigen" button.
   - "Anzeigen" button expands to show the draft content inline, with "Uebernehmen" / "Ablehnen" actions.
   - If no suggestions: don't show banner.

7. Update notification integration:
   - The scan-processor already creates notifications via createNotification().
   - Ensure notification type 'ai_suggestion' is handled in `src/components/notifications/notification-provider.tsx`:
     - Toast message: "Helena: {titel}" with link to /ki-chat (Vorschlaege tab).
     - Icon: Sparkles icon for AI suggestions.
   - Add 'ai_suggestion' to notification types in `src/lib/notifications/types.ts` if not present.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Navigate to /ki-chat, switch to Vorschlaege tab -- suggestion cards render. Click Uebernehmen on a FRIST_ERKANNT suggestion -- calendar entry gets activated. Email detail shows KI-Antwort banner when draft exists.</manual>
  </verify>
  <done>Helena suggestions feed with card-based UI, filter tabs, Akte filter, action buttons (Uebernehmen/Ablehnen/Bearbeiten), feedback (Daumen hoch/runter). Email detail shows KI-Antwort banner. Notification bell shows AI suggestion notifications. Accept actions create real entities (KalenderEintrag, Beteiligter, Draft).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. HelenaSuggestion model in Prisma schema with correct fields and indexes
3. Worker registers ai-scan, ai-briefing, ai-proactive queues
4. Embedding completion triggers ai-scan job
5. Deadline extractor produces typed output via generateObject
6. Party extractor produces typed output via generateObject
7. Suggestions API returns paginated results
8. Suggestion cards render with actions in /ki-chat Vorschlaege tab
9. Accepting a FRIST_ERKANNT suggestion activates the linked KalenderEintrag
10. Email detail shows KI-Antwort banner for emails with draft suggestions
</verification>

<success_criteria>
- New documents automatically scanned after embedding with deadlines and parties extracted
- New emails automatically scanned with response drafts generated
- Helena suggestions appear in card-based feed with actionable buttons
- Accepting suggestions creates real entities (Fristen, Beteiligte, Drafts)
- Idempotency enforced: max 1 scan per document+type per day
- Token budget enforcement: scanning pauses at 100%, chat stays on
- Daily briefing generated when enabled
- Email detail shows inline KI-Antwort banner
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-03-SUMMARY.md`
</output>
