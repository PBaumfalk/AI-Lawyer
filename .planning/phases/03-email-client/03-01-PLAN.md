---
phase: 03-email-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/email/crypto.ts
  - src/lib/email/imap/connection-manager.ts
  - src/lib/email/imap/sync.ts
  - src/lib/email/imap/idle-handler.ts
  - src/lib/email/imap/folder-sync.ts
  - src/lib/email/imap/parser.ts
  - src/lib/email/sanitize.ts
  - src/lib/email/threading.ts
  - src/lib/email/types.ts
  - src/lib/email/smtp/transport-factory.ts
  - src/lib/email/smtp/send-processor.ts
  - src/lib/queue/queues.ts
  - src/worker.ts
  - src/app/api/email-konten/route.ts
  - src/app/api/email-konten/[id]/route.ts
  - src/app/api/email-konten/[id]/test/route.ts
  - src/app/api/emails/route.ts
  - src/app/api/emails/[id]/route.ts
  - src/app/api/emails/[id]/read/route.ts
  - src/app/api/emails/bulk/route.ts
  - src/app/api/email-folders/route.ts
  - src/app/api/email-folders/[id]/route.ts
  - src/app/api/email-send/route.ts
  - docker-compose.yml
  - package.json
  - .env.example
autonomous: true
requirements:
  - REQ-EM-001
  - REQ-EM-002

user_setup:
  - service: IMAP/SMTP email server
    why: "Email receiving and sending requires a mail server"
    env_vars:
      - name: EMAIL_ENCRYPTION_KEY
        source: "Generate a random 32+ character string for AES-256 credential encryption"

must_haves:
  truths:
    - "New Prisma models (EmailKonto, EmailOrdner, EmailNachricht, EmailAnhang, EmailVeraktung) exist and database schema is pushed"
    - "IMAP connection manager connects to a configured mailbox and enters IDLE mode in the worker process"
    - "Initial email sync downloads existing emails from an IMAP server into the local database"
    - "IMAP IDLE detects new emails arriving on the server and triggers incremental sync"
    - "Reconnection with exponential backoff recovers from dropped IMAP connections"
    - "Email API routes return emails with pagination, filtering, and detail view"
    - "Mailbox configuration CRUD allows admins to add/edit/delete email accounts"
    - "SMTP send queue accepts outgoing emails with 10-second undo delay"
    - "Email credentials are encrypted at rest with AES-256-GCM"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "EmailKonto, EmailOrdner, EmailNachricht, EmailAnhang, EmailVeraktung, EmailKontoZuweisung models"
      contains: "model EmailKonto"
    - path: "src/lib/email/imap/connection-manager.ts"
      provides: "IMAP connection lifecycle management"
      exports: ["startImapConnection", "stopImapConnection", "stopAllConnections"]
    - path: "src/lib/email/imap/sync.ts"
      provides: "Initial and incremental email sync"
      exports: ["syncMailbox", "syncNewMessages"]
    - path: "src/lib/email/crypto.ts"
      provides: "AES-256-GCM credential encryption"
      exports: ["encryptCredential", "decryptCredential"]
    - path: "src/app/api/emails/route.ts"
      provides: "Email list with pagination and filters"
      exports: ["GET"]
    - path: "src/app/api/email-konten/route.ts"
      provides: "Mailbox configuration CRUD"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/worker.ts"
      to: "src/lib/email/imap/connection-manager.ts"
      via: "startImapConnections() called at worker startup"
      pattern: "startImapConnections"
    - from: "src/lib/email/imap/connection-manager.ts"
      to: "src/lib/email/imap/sync.ts"
      via: "IDLE exists event triggers syncNewMessages()"
      pattern: "syncNewMessages"
    - from: "src/lib/email/imap/sync.ts"
      to: "prisma.emailNachricht.create"
      via: "Parsed emails stored in database"
      pattern: "prisma\\.emailNachricht\\.create"
    - from: "src/app/api/email-send/route.ts"
      to: "src/lib/queue/queues.ts"
      via: "BullMQ emailSendQueue.add() with delay"
      pattern: "emailSendQueue\\.add"
---

<objective>
Build the complete email backend: Prisma schema expansion with 6 new models, IMAP connection manager with IDLE and reconnection in the worker process, initial + incremental email sync, email CRUD API routes, mailbox configuration API, SMTP send queue, and AES-256-GCM credential encryption.

Purpose: This plan creates the entire data layer and worker-side IMAP engine that all email UI features depend on. Without this foundation, no emails can be received, stored, or sent.
Output: Working IMAP sync that stores emails in PostgreSQL, API routes for email and mailbox CRUD, SMTP send queue via BullMQ.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-client/03-CONTEXT.md
@.planning/phases/03-email-client/03-RESEARCH.md
@.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md
@.planning/phases/01-infrastructure-foundation/01-02-SUMMARY.md
@.planning/phases/02.1-wire-frist-reminder-pipeline/02.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, expand Prisma schema with email models, create credential encryption and email types</name>
  <files>
    package.json
    prisma/schema.prisma
    src/lib/email/crypto.ts
    src/lib/email/types.ts
    src/lib/email/sanitize.ts
    src/lib/email/threading.ts
    .env.example
  </files>
  <action>
Install npm dependencies:
```bash
npm install imapflow mailparser sanitize-html dompurify @tanstack/react-virtual react-resizable-panels @tiptap/react @tiptap/pm @tiptap/starter-kit @tiptap/extension-link @tiptap/extension-image @tiptap/extension-table @tiptap/extension-placeholder @tiptap/extension-color @tiptap/extension-text-style
npm install -D @types/sanitize-html @types/dompurify @types/mailparser
```

Expand `prisma/schema.prisma` with these new models (per 03-RESEARCH.md Prisma Schema Changes section):
- `EmailKonto` — mailbox configuration (IMAP/SMTP host/port/credentials, authTyp, istKanzlei, aktiv, initialSync, syncStatus, fehlerLog, softDeleteTage). Include `signaturVorlage String? @db.Text` for kanzlei-wide HTML signature template and `signaturPlaceholders Json?` for user field definitions.
- `EmailKontoZuweisung` — user-to-mailbox assignment (unique [kontoId, userId])
- `EmailOrdner` — synced IMAP folders (kontoId, name, pfad, spezialTyp, ungeleseneAnzahl, gesamtAnzahl, sortierung)
- `EmailNachricht` — full email message model replacing the basic EmailMessage. Keep the existing EmailMessage model temporarily for backward compat but add all new fields to EmailNachricht: emailKontoId, emailOrdnerId, imapUid, imapFolder, messageId (unique), inReplyTo, references (String[]), threadId, richtung, betreff, absender, absenderName, empfaenger, cc, bcc, inhalt (@db.Text), inhaltText (@db.Text), empfangenAm, gesendetAm, gelesen, flagged, prioritaet, groesse, veraktet, verantwortlichId (relation to User), geloescht, geloeschtAm, sendeStatus, geplanterVersand, sendeFehler, ticketId (relation to Ticket). Include compound indexes per 03-RESEARCH.md.
- `EmailAnhang` — attachment metadata with MinIO storage key, contentId for inline images
- `EmailVeraktung` — audit trail for case assignment (emailNachrichtId, akteId, userId, notiz, anhaengeKopiert, dmsOrdner, aufgehoben, aufgehobenAm)

Add `EmailRichtung` enum if not already present (EINGEHEND, AUSGEHEND).

Add necessary relations:
- User model: add `emailKontoZuweisungen EmailKontoZuweisung[]`, `verantwortlichEmails EmailNachricht[] @relation("EmailVerantwortlicher")`, `emailVeraktungen EmailVeraktung[]`
- Akte model: add `emailVeraktungen EmailVeraktung[]`
- Ticket model: update emails relation to include EmailNachricht

Run `npx prisma db push` to apply schema changes.

Create `src/lib/email/crypto.ts`:
- `encryptCredential(plaintext: string): string` — AES-256-GCM with scryptSync key derivation from `EMAIL_ENCRYPTION_KEY` env var. Store as `iv:authTag:ciphertext` hex-encoded.
- `decryptCredential(stored: string): string` — reverse operation.
- Use Node.js built-in `node:crypto` only. See 03-RESEARCH.md Pattern 2 for exact implementation.

Create `src/lib/email/types.ts`:
- Shared TypeScript types for the email domain: `EmailKontoConfig`, `ParsedEmail`, `SyncResult`, `ImapConnectionState`, `EmailSendJob`, `EmailFilters`.

Create `src/lib/email/sanitize.ts`:
- `sanitizeEmailHtml(rawHtml: string): string` — server-side sanitization using sanitize-html with email-specific allowed tags (img, style, span, div, table, font, hr, center) and attributes. Block scripts, iframes, objects. Rewrite links with rel="noopener noreferrer" target="_blank". See 03-RESEARCH.md Pattern 4.

Create `src/lib/email/threading.ts`:
- `findThreadId(email)` — determine thread ID from References > In-Reply-To > null. See 03-RESEARCH.md Pattern 3.
- `normalizeSubject(subject: string): string` — strip Re:, Fwd:, AW:, WG:, Antwort:, Weiterleitung: prefixes for German clients.

Add to `.env.example`:
- `EMAIL_ENCRYPTION_KEY` — random 32+ char string for AES-256 credential encryption
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx prisma validate && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify schema.prisma contains model EmailKonto, EmailNachricht, EmailAnhang, EmailVeraktung, EmailOrdner, EmailKontoZuweisung</manual>
  </verify>
  <done>All 6 email Prisma models exist with correct fields/relations/indexes. crypto.ts exports encryptCredential/decryptCredential. sanitize.ts exports sanitizeEmailHtml. threading.ts exports findThreadId/normalizeSubject. All npm dependencies installed. TypeScript compiles clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create IMAP connection manager, sync engine, IDLE handler, folder sync, and email parser in the worker process</name>
  <files>
    src/lib/email/imap/connection-manager.ts
    src/lib/email/imap/sync.ts
    src/lib/email/imap/idle-handler.ts
    src/lib/email/imap/folder-sync.ts
    src/lib/email/imap/parser.ts
    src/lib/email/smtp/transport-factory.ts
    src/lib/email/smtp/send-processor.ts
    src/lib/queue/queues.ts
    src/worker.ts
    docker-compose.yml
  </files>
  <action>
Create `src/lib/email/imap/connection-manager.ts`:
- `ManagedConnection` interface: kontoId, client (ImapFlow), reconnectTimer, failCount.
- `connections` Map for all active connections.
- `startImapConnection(konto)` — create new ImapFlow instance (CRITICAL: always new instance, never reuse after close). Set auth based on authTyp (password vs accessToken). Set `maxIdleTime: 300_000` (5 min). Connect, open INBOX, let ImapFlow auto-IDLE.
- `on("exists")` event: log new message count, call `syncNewMessages()` for incremental sync, emit Socket.IO notification to `mailbox:{kontoId}` room.
- `on("close")` event: call `scheduleReconnect()` with exponential backoff (5s base, 5min max). After 3 consecutive failures, notify admin via `createNotification()`.
- `stopImapConnection(kontoId)` — logout and cleanup.
- `stopAllConnections()` — for graceful shutdown.
- `startImapConnections()` — query all active EmailKonto from DB, start connections for each. Called at worker startup.
- Use `createLogger("imap:manager")` from existing pino logger.
- Use `decryptCredential()` to get passwords before connecting.
- Use `getSocketEmitter()` from `src/lib/socket/emitter.ts` for real-time notifications.

Create `src/lib/email/imap/sync.ts`:
- `syncMailbox(client, kontoId, folder, since?)` — fetch all messages (using `client.fetchAll()` to avoid deadlock — see 03-RESEARCH.md anti-patterns), check existing by UID, download full message source via `client.download()` (streaming, not buffering), parse with `simpleParser` from mailparser, store in DB with `prisma.emailNachricht.create()`. Sanitize HTML via `sanitizeEmailHtml()` before storing. Store attachments in MinIO via `uploadFile()` (skip >25MB). Create EmailAnhang records.
- `syncNewMessages(kontoId, folder)` — incremental sync, fetches only UIDs newer than last known.
- `initialSync(kontoId, strategy)` — based on EmailKonto.initialSync: "NUR_NEUE" (IDLE only), "30_TAGE" (since 30 days ago), "ALLES" (all messages). Update EmailKonto.letzterSync and syncStatus.
- Use threading.ts `findThreadId()` to compute threadId for each message.

Create `src/lib/email/imap/idle-handler.ts`:
- Helper to manage IDLE lifecycle. Periodic NOOP heartbeat every 4 minutes to detect dead connections.
- `startIdleMonitoring(managed)` — set up heartbeat interval.
- `stopIdleMonitoring(managed)` — clear interval.

Create `src/lib/email/imap/folder-sync.ts`:
- `syncFolders(client, kontoId)` — list IMAP folders via `client.list()`, detect special folders (INBOX, Sent, Drafts, Trash, Junk, Archive) by name patterns and SPECIAL-USE flags, create/update EmailOrdner records.
- `createImapFolder(client, kontoId, path)` — create folder on IMAP server + DB.
- `renameImapFolder(client, kontoId, oldPath, newPath)` — rename on IMAP + DB.
- `deleteImapFolder(client, kontoId, path)` — delete on IMAP + DB.

Create `src/lib/email/imap/parser.ts`:
- `parseRawEmail(stream)` — wraps mailparser `simpleParser`, extracts headers, body (HTML + text), attachments metadata, returns `ParsedEmail` type.

Create `src/lib/email/smtp/transport-factory.ts`:
- `createSmtpTransport(konto)` — create nodemailer transport per EmailKonto using decrypted credentials. Lazy creation (one transporter per kontoId, cached). Handle both password and OAuth2 auth.

Create `src/lib/email/smtp/send-processor.ts`:
- BullMQ processor for `email-send` queue. Loads EmailNachricht by id, gets sender EmailKonto, creates transport, sends via nodemailer with proper From/To/CC/BCC/Subject/HTML. Updates sendeStatus to "GESENDET" on success, "FEHLGESCHLAGEN" on error. Stores sent email in IMAP Sent folder via APPEND.
- Handle signature injection: load kanzlei signature template from EmailKonto, replace {{placeholders}} with sending user's profile fields, append to email body.

Update `src/lib/queue/queues.ts`:
- Add `emailSendQueue` with custom backoff and job options (attempts: 3, removeOnComplete after 1 day, removeOnFail after 7 days).
- Add `emailSyncQueue` for on-demand sync jobs.
- Add both to `ALL_QUEUES` array for Bull Board visibility.

Update `src/worker.ts`:
- Import and call `startImapConnections()` in worker startup (after initializeDefaults).
- Register `emailSendProcessor` as BullMQ Worker for `email-send` queue.
- Register `emailSyncProcessor` for `email-sync` queue (handles on-demand sync requests).
- Add `stopAllConnections()` to graceful shutdown handler.

Update `docker-compose.yml`:
- Add LanguageTool as optional service with profiles: ["full"]. Image: `erikvl87/languagetool:latest`, port 8010, with German language data volume. This is optional and won't block other functionality.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Check that src/worker.ts imports and calls startImapConnections, registers emailSendWorker, and calls stopAllConnections on shutdown</manual>
  </verify>
  <done>IMAP connection manager connects to mailboxes with IDLE, reconnects on failure with exponential backoff. Sync engine downloads emails from IMAP into EmailNachricht with attachments in MinIO. SMTP send processor sends emails via BullMQ queue with 10-second delay support. All queues registered in ALL_QUEUES. Worker startup initializes IMAP connections and graceful shutdown closes them.</done>
</task>

<task type="auto">
  <name>Task 3: Create email CRUD, mailbox configuration, folder management, and email-send API routes</name>
  <files>
    src/app/api/email-konten/route.ts
    src/app/api/email-konten/[id]/route.ts
    src/app/api/email-konten/[id]/test/route.ts
    src/app/api/email-konten/[id]/zuweisungen/route.ts
    src/app/api/emails/route.ts
    src/app/api/emails/[id]/route.ts
    src/app/api/emails/[id]/read/route.ts
    src/app/api/emails/bulk/route.ts
    src/app/api/email-folders/route.ts
    src/app/api/email-folders/[id]/route.ts
    src/app/api/email-send/route.ts
  </files>
  <action>
Create `src/app/api/email-konten/route.ts`:
- GET: List all EmailKonto (ADMIN: all; others: only assigned mailboxes). Return id, name, emailAdresse, istKanzlei, aktiv, syncStatus, letzterSync, fehlerLog. Never return passwortEnc or oauthTokens.
- POST (ADMIN only): Create new EmailKonto. Validate with Zod schema: name, imapHost, imapPort, imapSecure, smtpHost, smtpPort, smtpSecure, emailAdresse, benutzername, passwort (encrypted before storing), authTyp, istKanzlei, initialSync. Encrypt password with `encryptCredential()`. Trigger initial folder sync after creation.

Create `src/app/api/email-konten/[id]/route.ts`:
- GET (ADMIN only): Return full EmailKonto details (without decrypted password).
- PATCH (ADMIN only): Update EmailKonto fields. Re-encrypt password if changed. If IMAP settings changed, restart IMAP connection.
- DELETE (ADMIN only): Soft-deactivate mailbox (set aktiv=false, stop IMAP connection). Hard delete only if no emails associated.

Create `src/app/api/email-konten/[id]/test/route.ts`:
- POST (ADMIN only): Test IMAP + SMTP connection. Create temporary ImapFlow instance, attempt connect + login + list mailboxes. Create temporary nodemailer transport, attempt verify(). Return success/failure with detailed error messages. Decrypt stored password for test.

Create `src/app/api/email-konten/[id]/zuweisungen/route.ts`:
- GET (ADMIN only): List user assignments for a mailbox.
- POST (ADMIN only): Assign user to mailbox. Validate user exists.
- DELETE (ADMIN only): Remove user assignment.

Create `src/app/api/emails/route.ts`:
- GET: List EmailNachricht with cursor-based pagination (cursor=lastId, limit=50 default). Filter by: kontoId, ordnerId (folder), gelesen (boolean), veraktet (boolean), akteId (via EmailVeraktung), verantwortlichId, geloescht (default false), search (betreff/absender full-text). Sort by: empfangenAm (default desc), absender, betreff. Return email list with: id, betreff, absender, absenderName, empfangenAm, gelesen, flagged, veraktet, prioritaet, groesse, preview (first 80 chars of inhaltText), anhaengeCount, veraktung badge (aktenzeichen if veraktet). Only return emails from mailboxes the user has access to.

Create `src/app/api/emails/[id]/route.ts`:
- GET: Return full email detail including inhalt (HTML body), inhaltText, all headers, attachments list with presigned MinIO download URLs. Verify user has access to this email's mailbox.
- DELETE: Soft-delete email (set geloescht=true, geloeschtAm). Move to IMAP Trash folder in background. Return 204.

Create `src/app/api/emails/[id]/read/route.ts`:
- PATCH: Mark email as read (gelesen=true). Set \\Seen flag on IMAP server in background. Return 200.

Create `src/app/api/emails/bulk/route.ts`:
- POST: Bulk actions on multiple email IDs. Actions: markRead, markUnread, delete, archive (move to Archive folder), spam (move to Junk folder), move (to specified folder). Validate all email IDs belong to user's accessible mailboxes. Execute IMAP flag/move operations via background job.

Create `src/app/api/email-folders/route.ts`:
- GET: List all EmailOrdner for a given kontoId, grouped by konto. Include ungeleseneAnzahl and gesamtAnzahl.
- POST: Create new IMAP folder (calls `createImapFolder()`). Requires kontoId and name.

Create `src/app/api/email-folders/[id]/route.ts`:
- PATCH: Rename folder (calls `renameImapFolder()`).
- DELETE: Delete folder (calls `deleteImapFolder()`). Only custom folders, not special folders.

Create `src/app/api/email-send/route.ts`:
- POST: Queue an outgoing email. Accept: kontoId (sender mailbox), empfaenger, cc, bcc, betreff, inhalt (HTML from TipTap), akteId (optional), anhaenge (file IDs from DMS or uploaded attachments), prioritaet, lesebestaetigung (boolean for Disposition-Notification-To), geplanterVersand (optional DateTime for scheduled send). Create EmailNachricht with richtung=AUSGEHEND, sendeStatus="GEPLANT" or "WIRD_GESENDET". Add to emailSendQueue with delay: 10_000ms for immediate (undo window) or calculated delay for scheduled. Return email ID and job ID (for cancellation/undo).
- DELETE: Cancel a queued send by removing the BullMQ job (undo). Only works if job hasn't started processing. Update sendeStatus back to "ENTWURF".

All API routes follow existing patterns: `auth()` check at top, Zod schema validation, German error messages, `Response.json()` returns.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify all API routes exist: GET /api/emails, GET /api/emails/[id], POST /api/email-konten, POST /api/email-send</manual>
  </verify>
  <done>All email API routes exist and compile. Emails can be listed with pagination/filters, viewed in detail with attachment URLs, marked read, bulk-actioned, and deleted. Mailbox accounts can be created/edited/tested/deleted by admins. Outgoing emails can be queued with undo support. All routes enforce mailbox access control.</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes — schema is valid
2. `npx tsc --noEmit` compiles without errors
3. All 6 new Prisma models exist: EmailKonto, EmailOrdner, EmailNachricht, EmailAnhang, EmailVeraktung, EmailKontoZuweisung
4. Worker.ts imports and calls startImapConnections() at startup
5. emailSendQueue and emailSyncQueue appear in ALL_QUEUES
6. API routes exist at: /api/emails, /api/emails/[id], /api/email-konten, /api/email-konten/[id], /api/email-konten/[id]/test, /api/email-send, /api/email-folders
</verification>

<success_criteria>
- All Prisma models created and database schema pushed
- IMAP connection manager handles connect, IDLE, reconnect lifecycle
- Email sync downloads and parses IMAP messages into PostgreSQL
- SMTP send processor sends emails via BullMQ queue
- All CRUD API routes compile and enforce access control
- Credential encryption works with AES-256-GCM
- TypeScript compilation passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-client/03-01-SUMMARY.md`
</output>
