---
phase: 23.1-integration-wiring-fixes
plan: 02
subsystem: api
tags: [prisma, schriftsatz, multi-turn, llm, ki-chat, rueckfragen]

# Dependency graph
requires:
  - phase: 22-deterministic-schriftsatz-orchestrator
    provides: "Schriftsatz pipeline (runSchriftsatzPipeline, isSchriftsatzIntent, slot-filler, schemas)"
provides:
  - "PendingSchriftsatz Prisma model with @@unique([userId, akteId])"
  - "pending-pipeline.ts CRUD service (save/load/clear with 7-day TTL)"
  - "answer-parser.ts LLM-based intent classification and slot extraction"
  - "ki-chat route Schriftsatz pipeline routing before RAG chains"
  - "JSON response type discriminator (schriftsatz_rueckfrage, schriftsatz_complete, schriftsatz_error, schriftsatz_conflict)"
affects: [frontend-chat-ui, helena-agent]

# Tech tracking
tech-stack:
  added: []
  patterns: ["lazy TTL check on read", "JSON response type discriminator for pipeline vs streaming", "upsert per-user-per-Akte state"]

key-files:
  created:
    - prisma/migrations/20260227234525_add_pending_schriftsatz/migration.sql
    - src/lib/helena/schriftsatz/pending-pipeline.ts
    - src/lib/helena/schriftsatz/answer-parser.ts
  modified:
    - prisma/schema.prisma
    - src/lib/helena/schriftsatz/index.ts
    - src/app/api/ki-chat/route.ts

key-decisions:
  - "Re-use existing session from auth() call for userRole/userName instead of calling auth() again"
  - "Array.from(new Set(...)) instead of spread to avoid downlevelIteration TS issue"
  - "Manual migration SQL file since DB not available locally for prisma migrate dev"

patterns-established:
  - "JSON type discriminator for Schriftsatz pipeline responses in ki-chat (schriftsatz_rueckfrage/complete/error/conflict)"
  - "Lazy TTL check with auto-delete on read for PendingSchriftsatz records"
  - "Fast keyword check for cancel intent (no LLM round-trip for abbrechen/stop/cancel)"

requirements-completed: [ORCH-04]

# Metrics
duration: 4min
completed: 2026-02-27
---

# Phase 23.1 Plan 02: Multi-Turn Schriftsatz Rueckfragen Summary

**PendingSchriftsatz DB model + CRUD service + LLM answer parser + ki-chat route integration for multi-turn Schriftsatz pipeline with 5-round cap and PLATZHALTER fallback**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-27T22:44:07Z
- **Completed:** 2026-02-27T22:48:45Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- PendingSchriftsatz Prisma model with @@unique([userId, akteId]) for one pending pipeline per user per Akte
- CRUD service with save/load/clear operations and lazy 7-day TTL cleanup
- LLM-based answer classification (answer/correction/cancel/unrelated) with fast keyword shortcut for cancel
- LLM-based slot value extraction from free-text answers
- ki-chat route integration: checks pending state before RAG, routes new intents to pipeline
- Conflict detection when user sends new Schriftsatz request while one is pending
- Round cap at MAX_ROUNDS=5 creates fallback draft with PLATZHALTER markers

## Task Commits

Each task was committed atomically:

1. **Task 1: Add PendingSchriftsatz model and run migration** - `39717c8` (feat)
2. **Task 2: Create pending-pipeline CRUD service + answer-parser + wire ki-chat route** - `baf143d` (feat)

## Files Created/Modified
- `prisma/schema.prisma` - Added PendingSchriftsatz model + reverse relations on User and Akte
- `prisma/migrations/20260227234525_add_pending_schriftsatz/migration.sql` - Migration SQL for pending_schriftsaetze table
- `src/lib/helena/schriftsatz/pending-pipeline.ts` - CRUD service for PendingSchriftsatz (save, load with TTL check, clear)
- `src/lib/helena/schriftsatz/answer-parser.ts` - LLM-based intent classification and slot extraction
- `src/lib/helena/schriftsatz/index.ts` - Re-exports for pending-pipeline and answer-parser modules
- `src/app/api/ki-chat/route.ts` - Schriftsatz pipeline routing before RAG chains

## Decisions Made
- Re-used existing `session` from `auth()` call at line 177 for userRole/userName extraction instead of calling `auth()` again (saves redundant auth check)
- Used `Array.from(new Set(...))` instead of spread operator to avoid TypeScript `downlevelIteration` issue
- Created manual migration SQL file since PostgreSQL DB was not available locally for `prisma migrate dev`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed Set spread TypeScript error**
- **Found during:** Task 2 (ki-chat route wiring)
- **Issue:** `[...new Set([...missingKeys, intent.correctedSlotKey])]` triggers TS2802 without `downlevelIteration`
- **Fix:** Changed to `Array.from(new Set([...missingKeys, intent.correctedSlotKey]))`
- **Files modified:** src/app/api/ki-chat/route.ts
- **Verification:** `npx tsc --noEmit` passes
- **Committed in:** baf143d (Task 2 commit)

**2. [Rule 3 - Blocking] Created manual migration SQL**
- **Found during:** Task 1 (migration)
- **Issue:** `npx prisma migrate dev` fails with P1001 (database not reachable at localhost:5432)
- **Fix:** Created migration directory and SQL file manually, ran `npx prisma generate` for client generation
- **Files modified:** prisma/migrations/20260227234525_add_pending_schriftsatz/migration.sql
- **Verification:** Prisma client generated with 807 PendingSchriftsatz type references
- **Committed in:** 39717c8 (Task 1 commit)

---

**Total deviations:** 2 auto-fixed (1 bug, 1 blocking)
**Impact on plan:** Both fixes necessary for compilation and local development. No scope creep.

## Issues Encountered
- Database not available locally -- migration SQL created manually. Migration will be applied on next `npx prisma migrate deploy`.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Multi-turn Rueckfragen infrastructure complete
- Frontend needs to handle new JSON response types (schriftsatz_rueckfrage, schriftsatz_complete, schriftsatz_error, schriftsatz_conflict) -- covered by Phase 23.1 Plan 03 or future frontend work
- Migration needs to be applied when database is available

---
*Phase: 23.1-integration-wiring-fixes*
*Completed: 2026-02-27*
