---
milestone: v0.1
milestone_name: Helena RAG
audited: 2026-02-27T12:45:00Z
status: gaps_found
scores:
  requirements: 15/16
  phases: 7/7
  integration: 15/16
  flows: 4/5
gaps:
  requirements:
    - id: "ARBW-02"
      status: "partial"
      phase: "Phase 18"
      claimed_by_plans: ["18-02-PLAN.md"]
      completed_by_plans: ["18-02-SUMMARY.md"]
      verification_status: "passed"
      evidence: "Phase verification marked ARBW-02 SATISFIED. Integration checker found critical wiring defect: src/app/api/admin/muster/[id]/route.ts DELETE and PATCH handlers use sync `params: { id: string }` pattern — in Next.js 15 App Router, params is a Promise. `params.id` on a Promise evaluates to `undefined`. Every DELETE returns 404 (Muster not found). Every PATCH (retry NER) returns 404. Upload flow is WIRED and working. Delete and retry-NER are functionally broken."
  integration:
    - "src/app/api/admin/muster/[id]/route.ts: DELETE + PATCH — `params` not awaited, `id` is always `undefined` → 404 on every request. Fix: `const { id } = await params;` in both handlers."
  flows:
    - "Admin Muster Flow (DELETE): Broken — 'Löschen' button always returns 404"
    - "Admin Muster Flow (PATCH/retry-NER): Broken — 'Erneut prüfen' button always returns 404"
tech_debt:
  - phase: 16-pii-filter
    items:
      - "Dead code: processUrteilNer() in ner-pii.processor.ts lines 152–166 is dispatched from processNerPiiJob() but never enqueued by Phase 17. Phase 17 uses runNerFilter() inline instead. File comment contradicts dead code existence."
      - "Acceptance test (16-03): Live Ollama run deferred to human. Test infrastructure complete; requires running Ollama instance to execute."
  - phase: 18-muster-rag-admin-upload-ui
    items:
      - "NER queue has attempts:1 — on Ollama timeout, job fails permanently. Admin must manually click 'Erneut prüfen'. No automatic retry. Documented but a UX friction point."
  - phase: adhoc-bugfixes
    items:
      - "OnlyOffice Editor 'wird geladen...' Dauerschleife — outstanding bug, not in v0.1 scope but unresolved."
      - "Debug logs in ki-chat/route.ts (akteId-Logging) — temporary debugging artifacts to remove."
      - "LFM2 vs qwen3.5 model evaluation pending — LFM2 weaker than qwen3.5 for Helena, user decision required."
---

# Milestone v0.1 Helena RAG — Audit Report

**Audited:** 2026-02-27
**Status:** ⚠ GAPS FOUND
**Score:** 15/16 requirements satisfied | 7/7 phases passed | 4/5 E2E flows complete

---

## Milestone Goal

Helena mit drei Wissensquellen ausstatten (Gesetze, Urteile, Schriftsatzmuster) und die RAG-Pipeline durch Hybrid Search, Parent-Child Chunking und Cross-Encoder Reranking auf NotebookLM-Qualität heben.

---

## Phase Verification Summary

All 7 milestone phases carry `status: passed` from phase-level verification.

| Phase | Name | Status | Requirements Verified |
|-------|------|--------|----------------------|
| 12 | RAG Schema Foundation | ✅ passed | RAGQ-02 |
| 13 | Hybrid Search + Reranking | ✅ passed | RAGQ-01, RAGQ-03 |
| 14 | Gesetze-RAG | ✅ passed | GESETZ-01, GESETZ-02, GESETZ-03 |
| 15 | Normen-Verknüpfung in Akte | ✅ passed | GESETZ-04 |
| 16 | PII-Filter | ✅ passed | URTEIL-03, ARBW-03 |
| 17 | Urteile-RAG | ✅ passed | URTEIL-01, URTEIL-02, URTEIL-04 |
| 18 | Muster-RAG + Admin Upload UI | ✅ passed | ARBW-01, ARBW-02, ARBW-03, ARBW-04, ARBW-05 |

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration Check | Final Status |
|--------|-------------|-----------------|---------------------|-----------------|-------------------|--------------|
| RAGQ-01 | Hybrid Search RRF (k=60), N=50 | SATISFIED | listed (13-01, 13-02, 13-03) | [x] Complete | WIRED — hybridSearch() in ki-chat Chain B, bm25Limit:50, vectorLimit:50, RRF k=60 per spec | **satisfied** |
| RAGQ-02 | Parent-Child Chunking (500T child, 2000T parent) | SATISFIED | **missing** (12-01 has no requirements_completed field) | [x] Complete | WIRED — ChunkType enum used by hybrid-search.ts, chunkDocumentParentChild(), parent content lookup confirmed | **satisfied** (doc gap only — implementation verified) |
| RAGQ-03 | Cross-Encoder Reranking, fallback at P95>3s | SATISFIED | listed (13-01, 13-02, 13-03) | [x] Complete | WIRED — rerankWithOllama(3000ms timeout), fallback to RRF order on any error | **satisfied** |
| GESETZ-01 | Bundesgesetze in law_chunks, HNSW index | SATISFIED | listed (14-01) | [x] Complete | WIRED — upsertLawChunks(), HNSW index in manual_rag_hnsw_indexes.sql | **satisfied** |
| GESETZ-02 | Daily BullMQ cron 02:00 Europe/Berlin, encoding smoke | SATISFIED | listed (14-01, 14-02) | [x] Complete | WIRED — gesetzeSyncQueue, registerGesetzeSyncJob("0 2 * * *"), encodingSmokePassed() integrated | **satisfied** |
| GESETZ-03 | Helena retrieves Top-5 Normen, "nicht amtlich" disclaimer | SATISFIED | listed (14-03) | [x] Complete | WIRED — ki-chat Chain D, searchLawChunks(limit:5, minScore:0.6), GESETZE-QUELLEN block with disclaimer | **satisfied** |
| GESETZ-04 | §§ pinned to Akte, search modal, chip-list, Helena system context | SATISFIED | listed (15-01, 15-02, 15-03) | [x] Complete | WIRED — NormenSection chip-list + search modal, ki-chat Chain A injects PINNED NORMEN above GESETZE-QUELLEN | **satisfied** |
| URTEIL-01 | urteil_chunks, 7 BMJ RSS feeds, HNSW index | SATISFIED | listed (17-01) | [x] Complete | WIRED — BMJ_RSS_FEEDS has 7 courts, ingestUrteilItem pipeline, HNSW via Phase 12 schema | **satisfied** |
| URTEIL-02 | Daily incremental BAG RSS update | SATISFIED | listed (17-02) | [x] Complete | WIRED — urteileSyncQueue, registerUrteileSyncJob("0 3 * * *"), GUID cache for incremental updates | **satisfied** |
| URTEIL-03 | NER PII filter, institution whitelist, pii_geprueft=true | SATISFIED | listed (16-03) | [x] Complete | WIRED — runNerFilter() inline in ingestUrteilItem(); double gate: inline before INSERT + searchUrteilChunks() filters piiFiltered=true | **satisfied** |
| URTEIL-04 | Helena cites Urteile with Gericht+AZ+Datum+Quellenlink, no LLM-generated AZ | SATISFIED | listed (17-03) | [x] Complete | WIRED — searchUrteilChunks() filters null aktenzeichen; ki-chat injects gericht, aktenzeichen, datum, sourceUrl from DB; "erfinde kein AZ" instruction in prompt | **satisfied** |
| ARBW-01 | Amtliche Formulare in muster_chunks, normalized placeholders | SATISFIED | listed (18-01) | [x] Complete | WIRED — seedAmtlicheFormulare() at worker startup, insertMusterChunks() with content bypass for hardcoded templates | **satisfied** |
| ARBW-02 | Admin UI /admin/muster, DOCX/PDF upload, NER status column | SATISFIED (phase) | listed (18-02) | [x] Complete | **PARTIAL** — Upload + NER status display wired. DELETE and PATCH (retry-NER) broken: params not awaited → id=undefined → 404 on every request | **partial** ⚠ |
| ARBW-03 | PII anonymization, state machine PENDING_NER→INDEXED/REJECTED | SATISFIED | listed (16-03, 18-02) | [x] Complete | WIRED — nerPiiQueue → processMusterNer() → INDEXED or REJECTED_PII_DETECTED; reset to PENDING_NER on error; no bypass path | **satisfied** |
| ARBW-04 | Kanzlei-eigene Muster retrieval boost | SATISFIED | listed (18-01) | [x] Complete | WIRED — KANZLEI_BOOST=1.3 applied in searchMusterChunks() post-query before sort | **satisfied** |
| ARBW-05 | Helena creates Schriftsatz-Entwürfe with {{PLATZHALTER}}, always ENTWURF | SATISFIED | listed (18-03) | [x] Complete | WIRED — ki-chat Chain F, searchMusterChunks(limit:5, minScore:0.55), MUSTER-QUELLEN block, RUBRUM/ANTRÄGE/BEGRÜNDUNG structure, ENTWURF warning in prompt | **satisfied** |

**Coverage:** 15/16 satisfied | 1/16 partial gap (ARBW-02) | 0 orphaned | 0 unsatisfied

---

## Integration Check Results

### Cross-Phase Wiring

**All 6 ki-chat Chains confirmed wired and running in parallel:**

| Chain | Source | Requirement | Status |
|-------|--------|-------------|--------|
| Chain A — Pinned Normen | Phase 15 → Phase 12 AkteNorm | GESETZ-04 | ✅ Wired, highest system prompt priority |
| Chain B — Hybrid Search | Phase 13 hybridSearch() | RAGQ-01, RAGQ-03 | ✅ Wired, shared queryEmbedding |
| Chain D — Gesetze | Phase 14 searchLawChunks() | GESETZ-03 | ✅ Wired, limit:5, minScore:0.6 |
| Chain E — Urteile | Phase 17 searchUrteilChunks() | URTEIL-04 | ✅ Wired, "nicht amtlich" + Quellenlink |
| Chain F — Muster | Phase 18 searchMusterChunks() | ARBW-05 | ✅ Wired, kanzlei boost applied |

**PII Gate Integrity:** ✅ Double gate confirmed for Urteile (inline in ingestUrteilItem + query-time piiFiltered=true filter) and complete state machine for Muster (PENDING_NER → NER_RUNNING → INDEXED/REJECTED_PII_DETECTED via nerPiiQueue).

**Schema Dependencies:** ✅ All phases 13–18 correctly consume Phase 12 schema (ChunkType enum, MusterNerStatus enum, law_chunks/urteil_chunks/muster/muster_chunks/akte_normen tables, HNSW indexes).

### Integration Defects

#### DEFECT 1 — ARBW-02 BROKEN (High Priority — Gap)

**File:** `src/app/api/admin/muster/[id]/route.ts` lines 33, 44 (DELETE), lines 87, 96 (PATCH)

**Root cause:** Both `DELETE` and `PATCH` handlers declare `{ params }: { params: { id: string } }` (synchronous pattern). In Next.js 15 App Router, `params` is a `Promise<{ id: string }>`. Accessing `.id` on the unresolved Promise returns `undefined`. Every lookup `prisma.muster.findUnique({ where: { id: undefined } })` returns null → HTTP 404.

**Impact:**
- Admin "Löschen" button: always 404 — Muster cannot be deleted from UI
- Admin "Erneut prüfen" button: always 404 — NER retry cannot be triggered from UI
- Upload flow: UNAFFECTED (uses POST /api/admin/muster — no [id] param)
- NER status display: UNAFFECTED (GET /api/admin/muster — no [id] param)

**Fix (2-line change per handler):**
```typescript
// Change handler signature from:
{ params }: { params: { id: string } }
const { id } = params;

// To:
{ params }: { params: Promise<{ id: string }> }
const { id } = await params;
```

#### DEFECT 2 — Dead Code (Low Priority — Tech Debt)

**File:** `src/lib/queue/processors/ner-pii.processor.ts` lines 152–166

`processUrteilNer()` is defined in the BullMQ processor but never enqueued. Phase 17 uses `runNerFilter()` inline (correct approach). The dead function misleads future maintainers. Remove or clearly document as intentionally unreachable.

### E2E Flow Verification

| Flow | Steps | Status | Breaks At |
|------|-------|--------|-----------|
| Helena Gesetze-Antwort | User message → ki-chat Chain D → searchLawChunks() → GESETZE-QUELLEN injected → LLM answer with disclaimer | ✅ Complete | — |
| §§ an Akte pinnen | NormenSection search → POST /normen → AkteNorm row → ki-chat Chain A PINNED NORMEN → system prompt | ✅ Complete | — |
| Urteil-Frage mit Quellenangabe | ki-chat Chain E → searchUrteilChunks() → URTEILE-QUELLEN → Helena cites Gericht+AZ+Datum+Quellenlink | ✅ Complete | — |
| Kanzlei-Muster Upload + Indexierung | Admin upload → POST /api/admin/muster → MinIO → nerPiiQueue → INDEXED → musterIngestionQueue → muster_chunks → Helena Chain F | ✅ Complete | — |
| Admin Muster löschen | Admin "Löschen" → DELETE /api/admin/muster/[id] → (params not awaited) → id=undefined → 404 | ⚠ Broken | params resolution |
| Admin Muster NER retry | Admin "Erneut prüfen" → PATCH /api/admin/muster/[id] → (params not awaited) → id=undefined → 404 | ⚠ Broken | params resolution |

---

## Tech Debt Aggregation

### Phase 16 — PII-Filter
- Dead code: `processUrteilNer()` function in ner-pii.processor.ts — unreachable via any live code path
- Live Ollama acceptance test deferred to human — infrastructure complete (10 Urteil excerpts loaded), cannot run headlessly without Ollama instance

### Phase 18 — Muster-RAG
- NER queue `attempts:1` — Ollama timeout causes permanent job failure; admin must manually click "Erneut prüfen" to retry

### adhoc-bugfixes (outside v0.1 scope)
- OnlyOffice Editor "wird geladen..." Dauerschleife — unresolved, in separate context
- Debug akteId log in ki-chat/route.ts — temporary artifact
- LFM2 vs qwen3.5 model decision pending

---

## Gap Closure Required

### Priority 1 — Fix ARBW-02 (Critical, 2-line fix)

**File:** `src/app/api/admin/muster/[id]/route.ts`

Add `await` to params in DELETE and PATCH handlers. This restores delete and retry-NER functionality for the Admin Muster UI. Estimated effort: 5 minutes.

---

## Orphan Detection

**0 orphaned requirements.** All 16 v1 requirements appear in at least one VERIFICATION.md with SATISFIED status. No requirement in the REQUIREMENTS.md traceability table is absent from all phase verifications.

**1 SUMMARY frontmatter gap:** Phase 12 (12-01-SUMMARY.md) has no `requirements_completed` field. RAGQ-02 implementation is verified by Phase 12 VERIFICATION.md and by the integration check. This is a documentation gap, not an implementation gap. Mark as `satisfied` after manual verification.

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd-audit-milestone)_
_Integration checker: Claude (gsd-integration-checker)_
