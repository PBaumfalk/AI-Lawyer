---
phase: 10-docker-build-fix
task: 2
total_tasks: 2
status: in_progress
last_updated: 2026-02-25T19:21:34.282Z
---

<current_state>
Phase 10 execution: Plan 10-01 is COMPLETE. Plan 10-02 is in progress at Task 2 (checkpoint: human-verify Docker stack).

The Docker image builds successfully. Migrations run, seed works. But the app container crashes on startup. Latest fix (use standalone server.js instead of custom dist-server/index.js) has been committed but NOT yet tested in Docker.

The user needs to run: `docker compose build app && docker compose up -d` to test the latest fix.
</current_state>

<completed_work>

### Plan 10-01 (Wave 1) - COMPLETE
- Task 1: Fixed pino logger to be build-safe (NEXT_PHASE check, return undefined transport during build)
- Task 2: Hardened next.config.mjs (experimental.serverComponentsExternalPackages for Next.js 14.2.x), Dockerfile, .dockerignore
- Health route made dynamic (force-dynamic) to prevent static generation timeout
- SUMMARY.md created, commits: 6ae3119, eb2ed49, a14b6ec

### Plan 10-02 (Wave 2) - IN PROGRESS
- Task 1: docker-entrypoint.sh hardened (prisma migrate deploy, conditional seed) - DONE, commit ffd2767
- Fixed multiple Docker runtime issues:
  - `serverExternalPackages` -> `experimental.serverComponentsExternalPackages` (Next.js 14.2.x) - commit 78170d9
  - Migration SQL: DROP DEFAULT before enum type swap - commit 9120aa6
  - Squashed ALL migrations to fresh baseline (27 enums, 38 tables, ~100 columns were missing) - commit bed4567
  - Externalized pino in esbuild, added __dirname polyfill - commit b67e326
  - Added pino + all transport deps to Dockerfile runner stage - commit bed4567, 0a6c9d8
  - Switched CMD from dist-server/index.js to standalone server.js - commit be3f97f
</completed_work>

<remaining_work>

- Test latest Docker fix (standalone server.js) - `docker compose build app && docker compose up -d`
- If app starts: verify all 8 services healthy, login works at localhost:3000
- If app crashes: debug the next error (likely related to standalone server config or missing modules)
- Task 2 checkpoint: user must type "approved" after verifying Docker stack
- After checkpoint: spawn continuation agent to create SUMMARY.md and update STATE.md/ROADMAP.md
- Phase verification (gsd-verifier agent)
- Phase completion (roadmap update, state advance)
</remaining_work>

<decisions_made>

- Squashed all migrations into single baseline instead of writing incremental ALTER TABLE statements (pre-production, no data to preserve)
- Externalized pino+transports in esbuild because pino spawns worker threads that need separate module files
- Switched Docker CMD to Next.js standalone server.js because custom server.ts calls next() which loads webpack (not available in standalone)
- Socket.IO integration deferred for Docker (standalone server doesn't include it; can be added later)
- Used experimental.serverComponentsExternalPackages (not top-level serverExternalPackages) because project uses Next.js 14.2.x
</decisions_made>

<blockers>
- Docker app startup: last tested state crashed because custom server tried to load webpack via next(). Fix committed (use server.js) but not yet verified in Docker.
- The MODULE_TYPELESS_PACKAGE_JSON warning appears (ESM detection overhead) - cosmetic, not blocking.
- Worker container depends on app being healthy - will only start once app works.
</blockers>

<context>
The core problem was that the Prisma schema had been massively extended (financial module, contacts, email, tickets) across earlier phases without creating corresponding migrations. Combined with Docker-specific issues (pino transport resolution, ESM __dirname, Next.js standalone mode), this created a cascade of failures.

All code fixes are committed. The migration baseline is clean. The remaining work is purely Docker runtime verification.

Key files changed this session:
- src/lib/logger.ts (build-safe transport)
- next.config.mjs (experimental.serverComponentsExternalPackages)
- Dockerfile (pino deps, log dir, standalone CMD)
- .dockerignore (exclude .planning, dist-*)
- docker-entrypoint.sh (migrate deploy, conditional seed)
- scripts/build-server.ts + build-worker.ts (externalize pino, __dirname polyfill)
- prisma/migrations/ (fresh baseline)
- src/server.ts (console.error for startup diagnostics)
- src/app/api/health/route.ts (force-dynamic)
</context>

<next_action>
1. Run: `docker compose build app && docker compose up -d`
2. Check: `docker compose logs app --tail 30`
3. If standalone server.js works: verify login at localhost:3000, then continue with checkpoint approval flow
4. If it crashes: the error will now be visible via console.error. Common issues to check:
   - Missing node_modules in standalone (check require stack in error)
   - Port binding
   - .next directory path resolution
</next_action>
