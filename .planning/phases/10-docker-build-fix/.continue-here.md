---
phase: 10-docker-build-fix
task: 2
total_tasks: 2
status: in_progress
last_updated: 2026-02-25T20:21:08.783Z
---

<current_state>
Phase 10 Docker stack runs with 9 services healthy (app, worker, db, redis, minio, meilisearch, onlyoffice, stirling-pdf, ollama). Login works. Both Ollama models loaded (mistral:7b + blaifa/multilingual-e5-large-instruct). But the KI-Chat (Helena) has two remaining bugs that prevent it from working end-to-end.
</current_state>

<completed_work>

### Plan 10-01 (Wave 1) - COMPLETE
- Task 1: Fixed pino logger to be build-safe (NEXT_PHASE guard)
- Task 2: Hardened next.config.mjs, Dockerfile, .dockerignore
- Commits: 6ae3119, eb2ed49, a14b6ec

### Plan 10-02 (Wave 2) - IN PROGRESS
- Task 1: docker-entrypoint.sh hardened (migrate deploy, conditional seed) - DONE
- Fixed multiple Docker runtime issues across sessions:
  - date-fns missing in Dockerfile (pino-roll transitive dep) - commit bfac7b6
  - Healthcheck localhost->127.0.0.1 (Alpine IPv6) - commit bfac7b6
  - Ollama promoted from profiles:["ai"] to core service with healthcheck - commit 22cd6fe
  - Worker image rebuilt (was missing date-fns, hung silently) - commit 22cd6fe
  - Auto-pull mistral:7b AND embedding model on worker startup - commits ba42590, e0fbd74
  - Fixed ki-chat Prisma: user:{connect} instead of userId, NaN tokenCount - commit e0fbd74
- Task 2 (human verification): User confirmed Docker stack runs, login works
- BUT: KI-Chat still broken, needs fixes before phase can close
</completed_work>

<remaining_work>

### Bug 1: vector-store column name mismatch (BLOCKING for RAG)
- Error: `column dc.dokument_id does not exist` in raw SQL query
- File: `src/lib/embedding/vector-store.ts`
- The `document_chunks` table uses a different column name than the raw SQL expects
- Fix: Check Prisma schema for DocumentChunk model, find correct column name (likely `dokumentId` mapped to `dokument_id` or similar), update raw SQL

### Bug 2: ki-chat route.ts fix not in Docker image
- The Prisma fix (user:{connect} instead of userId) was committed AFTER the last `docker compose build`
- Need: `docker compose build app && docker compose up -d app` to deploy the fix
- Verify: Send a chat message, check `docker logs ailawyer-app` for no more "Conversation save failed"

### Performance concern (non-blocking)
- mistral:7b on MacBook CPU-only is very slow (~30-60s per response)
- User may want to switch to OpenAI/Anthropic via Einstellungen > KI
- Or use a smaller quantized model

### LanguageTool integration (DEFERRED to future phase)
- Currently `profiles: ["full"]` in docker-compose.yml
- User wants it as core service for both Editor AND KI-Entwuerfe
- Saved in MEMORY.md, not part of Phase 10 scope
</remaining_work>

<decisions_made>

- Ollama is a CORE service, not optional — user explicitly stated it's the reason the system was designed
- Both mistral:7b (chat) and blaifa/multilingual-e5-large-instruct (embeddings) are required models
- Worker entrypoint auto-pulls models on first start (loop over model list)
- Ollama healthcheck uses `ollama list` because curl is not available in the Ollama Docker image
- LanguageTool integration deferred — not Phase 10 scope but noted for future
</decisions_made>

<blockers>
- vector-store.ts raw SQL uses wrong column name — quick fix once correct name is identified from schema
- App Docker image is one commit behind — needs rebuild
</blockers>

<context>
Phase 10 was originally scoped as "Docker Build Fix" (make it build and run). The scope expanded because:
1. Worker was silently broken (date-fns)
2. Ollama was misconfigured as optional
3. KI-Chat had Prisma bugs and missing models

The Docker infrastructure is solid now. The remaining work is two small code fixes (vector-store column name + rebuild image). After that, Phase 10 can truly close.

User is hands-on and tests everything in the browser. They caught issues I missed (worker broken, Ollama not running, chat not working). Always verify thoroughly before marking complete.
</context>

<next_action>
1. Fix `src/lib/embedding/vector-store.ts` — check `prisma/schema.prisma` for DocumentChunk model column mapping, fix the raw SQL column name
2. `docker compose build app && docker compose up -d app` to deploy all fixes
3. Test chat in browser — should get a response from Helena (may be slow on CPU)
4. If chat works: write final 10-02-SUMMARY.md update, VERIFICATION update, commit, mark phase complete
</next_action>
