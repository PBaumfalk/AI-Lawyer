---
phase: 03.1-wire-email-realtime-compose
plan: 01
subsystem: email, realtime, api
tags: [socket.io, email, real-time, signature, compose, custom-events]

# Dependency graph
requires:
  - phase: 03-email-client
    provides: "Email IMAP connection-manager, folder-tree, compose-popup, compose-manager, inbox-layout"
  - phase: 01-infrastructure
    provides: "Socket.IO rooms.ts, socket-provider.tsx"
provides:
  - "Socket.IO mailbox:{kontoId} room handlers for real-time email updates"
  - "Socket-to-CustomEvent bridge for email:folder-update in inbox-layout"
  - "GET /api/email-signature?kontoId= route for compose signature preview"
  - "ComposeManager context provider mounted in email layout"
affects: [email-compose, email-realtime, email-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Socket.IO room join/leave lifecycle tied to React useEffect cleanup"
    - "Socket-to-CustomEvent bridge pattern for decoupled component updates"

key-files:
  created:
    - src/app/api/email-signature/route.ts
  modified:
    - src/lib/socket/rooms.ts
    - src/components/email/inbox-layout.tsx
    - src/app/(dashboard)/email/layout.tsx

key-decisions:
  - "Socket-to-CustomEvent bridge in inbox-layout (not folder-tree) to keep bridge in one place"
  - "Separate useEffects for room join/leave vs event bridge (different dependency arrays)"
  - "Email layout converted to client component for ComposeManager context (no server-only code lost)"

patterns-established:
  - "Mailbox room pattern: mailbox:{kontoId} joined/left dynamically, matching akte:{akteId} convention"
  - "Event bridge pattern: socket.on -> window.dispatchEvent(CustomEvent) for decoupled component updates"

requirements-completed: [REQ-IF-003, REQ-EM-001, REQ-EM-003, REQ-EM-006]

# Metrics
duration: 2min
completed: 2026-02-24
---

# Phase 3.1 Plan 01: Wire Email Real-Time + Compose Summary

**Socket.IO mailbox room handlers with event bridge to folder-tree, email-signature API route, and ComposeManager provider in email layout**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-24T15:31:08Z
- **Completed:** 2026-02-24T15:33:19Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Socket.IO clients can now join/leave mailbox:{kontoId} rooms for real-time email folder update events
- Email folder-update events from IMAP connection-manager now reach the browser via Socket.IO-to-CustomEvent bridge in inbox-layout
- GET /api/email-signature?kontoId= returns rendered signature HTML for compose preview
- ComposeManager provider mounted in email layout so useComposeManager() works from any email page

## Task Commits

Each task was committed atomically:

1. **Task 1: Add mailbox room handlers and email-signature API route** - `69a6406` (feat)
2. **Task 2: Wire Socket.IO mailbox room join/leave and event bridge** - `ff2d1d7` (feat)
3. **Task 3: Mount ComposeManager provider in email layout** - `e5b2962` (feat)

## Files Created/Modified
- `src/lib/socket/rooms.ts` - Added join:mailbox / leave:mailbox handlers and JSDoc update
- `src/app/api/email-signature/route.ts` - New GET endpoint calling getSignatureForUser() with auth/param validation
- `src/components/email/inbox-layout.tsx` - Socket room lifecycle and email:folder-update to CustomEvent bridge
- `src/app/(dashboard)/email/layout.tsx` - Converted to client component, wrapped children with ComposeManager

## Decisions Made
- Socket-to-CustomEvent bridge placed in inbox-layout.tsx (not folder-tree.tsx) to keep the bridge in exactly one place and prevent duplicate event dispatches
- Two separate useEffects: one for room join/leave lifecycle (depends on socket + isConnected + kontoId), one for event bridge (depends only on socket) -- different lifecycles require different dependency arrays
- Email layout converted to client component ("use client") since ComposeManager requires React context and the layout had no server-only code

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- INT-001 (real-time email updates), INT-002 (email signature API), INT-003 (ComposeManager mounting) all resolved
- The full Socket.IO -> browser -> folder-tree pipeline is now wired: IMAP connection-manager emits to mailbox:{kontoId} room -> inbox-layout bridges to CustomEvent -> folder-tree updates unread badges
- Ready for next phase of development

## Self-Check: PASSED

All 4 files verified present. All 3 task commits verified in git log.

---
*Phase: 03.1-wire-email-realtime-compose*
*Completed: 2026-02-24*
