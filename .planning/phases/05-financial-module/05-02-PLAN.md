---
phase: 05-financial-module
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - prisma/schema.prisma
  - src/lib/finance/invoice/types.ts
  - src/lib/finance/invoice/nummernkreis.ts
  - src/lib/finance/invoice/status-machine.ts
  - src/lib/finance/invoice/pdf-generator.ts
  - src/app/api/finanzen/rechnungen/route.ts
  - src/app/api/finanzen/rechnungen/[id]/route.ts
  - src/app/api/finanzen/rechnungen/[id]/pdf/route.ts
  - src/app/api/finanzen/rvg/route.ts
  - src/app/api/finanzen/rvg/[akteId]/route.ts
autonomous: true
requirements:
  - REQ-FI-003
  - REQ-FI-004

must_haves:
  truths:
    - "Prisma schema includes all new financial models (Nummernkreis, BankKonto, BankTransaktion, RvgBerechnung, Teilzahlung, Mahnung, Buchungsperiode, Kostenstelle, Taetigkeitskategorie, RecurringInvoiceTemplate) and expanded Rechnung/AktenKontoBuchung/Zeiterfassung models"
    - "Invoices can be created with all SS 14 UStG required fields and receive an atomic gap-free Rechnungsnummer"
    - "Invoice status flow enforces Entwurf -> Gestellt -> Bezahlt -> Storniert with logged transitions"
    - "Invoice PDF is generated with firm Briefkopf, itemized VV positions, USt breakdown, and Zahlungsziel"
    - "RVG calculation can be saved per Akte and converted to invoice via one-click transfer"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "All expanded financial models"
      contains: "model Nummernkreis"
    - path: "src/lib/finance/invoice/nummernkreis.ts"
      provides: "Atomic invoice number generation via PostgreSQL UPSERT"
      exports: ["getNextInvoiceNumber"]
    - path: "src/lib/finance/invoice/status-machine.ts"
      provides: "Invoice status flow with transition validation and logging"
      exports: ["transitionInvoiceStatus", "VALID_TRANSITIONS"]
    - path: "src/lib/finance/invoice/pdf-generator.ts"
      provides: "Invoice PDF generation with Briefkopf"
      exports: ["generateInvoicePdf"]
    - path: "src/app/api/finanzen/rechnungen/route.ts"
      provides: "Invoice CRUD (GET list, POST create)"
      exports: ["GET", "POST"]
    - path: "src/app/api/finanzen/rechnungen/[id]/route.ts"
      provides: "Single invoice operations (GET detail, PATCH update/transition)"
      exports: ["GET", "PATCH"]
  key_links:
    - from: "src/app/api/finanzen/rechnungen/route.ts"
      to: "src/lib/finance/invoice/nummernkreis.ts"
      via: "getNextInvoiceNumber called during invoice creation"
      pattern: "getNextInvoiceNumber"
    - from: "src/app/api/finanzen/rechnungen/[id]/route.ts"
      to: "src/lib/finance/invoice/status-machine.ts"
      via: "transitionInvoiceStatus for status changes"
      pattern: "transitionInvoiceStatus"
    - from: "src/app/api/finanzen/rechnungen/[id]/pdf/route.ts"
      to: "src/lib/finance/invoice/pdf-generator.ts"
      via: "generateInvoicePdf for PDF download"
      pattern: "generateInvoicePdf"
---

<objective>
Expand the Prisma schema with all new financial models, build the invoice system backend with atomic Nummernkreis, status flow engine, PDF generation with Briefkopf, and RVG-to-invoice transfer API.

Purpose: The invoice system is the revenue-generating core of the financial module. Every invoice must comply with SS 14 UStG and produce a professional PDF with the firm's letterhead. The atomic Nummernkreis prevents duplicate invoice numbers under concurrent access.

Output: Fully expanded Prisma schema for all Phase 5 models, working invoice CRUD API with PDF generation, and RVG calculation save/transfer endpoints.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-module/05-RESEARCH.md
@.planning/phases/05-financial-module/05-01-SUMMARY.md
@.planning/phases/02-deadline-calculation-document-templates/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma Schema Expansion + Invoice Backend Library</name>
  <files>
    prisma/schema.prisma
    src/lib/finance/invoice/types.ts
    src/lib/finance/invoice/nummernkreis.ts
    src/lib/finance/invoice/status-machine.ts
    src/lib/finance/invoice/pdf-generator.ts
  </files>
  <action>
    **1. Expand Prisma Schema** (prisma/schema.prisma):

    Add new enums:
    - `KontoTyp { GESCHAEFT ANDERKONTO }` for bank accounts
    - `MahnStufe { ERINNERUNG ERSTE_MAHNUNG ZWEITE_MAHNUNG DRITTE_MAHNUNG }` for dunning
    - `BuchungsperiodeStatus { OFFEN GESPERRT }` for period locking

    Expand existing `Rechnung` model with:
    - `empfaengerId String?` + relation to Kontakt (can differ from Mandant)
    - `positionen Json` — keep but document the typed structure: `{ vvNr?, beschreibung, menge, einzelpreis, ustSatz, betrag }[]`
    - `ustSummary Json?` — per-rate breakdown `{ satz: number, bemessungsgrundlage: number, betrag: number }[]`
    - `zahlungszielTage Int @default(14)` — separate from faelligAm
    - `stornoVon String?` — reference to original invoice for Stornierung
    - `korrekturVon String?` — reference for Korrekturrechnung
    - `dokumentId String?` — reference to generated PDF in DMS
    - `mahnStufe MahnStufe?`
    - `mahnDatum DateTime?`
    - `zustellart String? @default("EMAIL")`
    - `isRecurring Boolean @default(false)`
    - `isPkh Boolean @default(false)`
    - `rvgBerechnungId String?` — link back to source RVG calculation
    - `restBetrag Decimal? @db.Decimal(12, 2)` — remaining amount after partial payments
    - relation to `Teilzahlung[]`

    Expand existing `AktenKontoBuchung` model with:
    - `gebuchtVon String` + relation to User
    - `stornoVon String?` — for Storno chain
    - `stornoGrund String?`
    - `rechnungId String?` — link to invoice
    - `bankTransaktionId String?` — link to bank transaction
    - `dokumentId String?` — link to Beleg in DMS
    - `kostenstelle String?`
    - `konto KontoTyp @default(GESCHAEFT)`
    - `fremdgeldFrist DateTime?` — deadline for Fremdgeld forwarding
    - `periodeId String?` — link to Buchungsperiode

    Expand existing `Zeiterfassung` model with:
    - `startzeit DateTime?` — for running timer
    - `endzeit DateTime?`
    - `isRunning Boolean @default(false)`
    - `kategorie String?` — Taetigkeitskategorie reference
    - `abgerechnet Boolean @default(false)`
    - `rechnungId String?`

    Add new `Kanzlei` fields:
    - `defaultZahlungszielTage Int @default(14)`
    - `skr String @default("03")`
    - `defaultStundensatz Decimal? @db.Decimal(8, 2)`
    - `nummernkreisPattern String @default("RE-{YEAR}-{SEQ:4}")`
    - `stornoPattern String @default("GS-{YEAR}-{SEQ:4}")`

    Create new models:
    - `Nummernkreis { id, prefix, year Int, sequence Int @default(0), @@unique([prefix, year]), @@map("nummernkreise") }`
    - `Teilzahlung { id, rechnungId, betrag Decimal, zahlungsdatum DateTime, verwendungszweck String?, bankTransaktionId String?, createdAt, @@map("teilzahlungen") }`
    - `Mahnung { id, rechnungId, stufe MahnStufe, datum DateTime, dokumentId String?, gesendetAm DateTime?, createdAt, @@map("mahnungen") }`
    - `BankKonto { id, kanzleiId, name, iban String @unique, bic String?, typ KontoTyp, isDefault Boolean @default(false), createdAt, updatedAt, @@map("bank_konten") }`
    - `BankTransaktion { id, bankKontoId, buchungsdatum DateTime, wertstellung DateTime?, betrag Decimal, verwendungszweck String, absenderEmpfaenger String?, saldo Decimal?, importHash String @unique, zugeordnet Boolean @default(false), rechnungId String?, akteId String?, createdAt, @@map("bank_transaktionen") }`
    - `RvgBerechnung { id, akteId String?, userId, streitwert Decimal, positionen Json, ergebnis Json, auftragseingang DateTime, tabelleVersion String, createdAt, updatedAt, @@map("rvg_berechnungen") }`
    - `Buchungsperiode { id, kanzleiId, jahr Int, monat Int, status BuchungsperiodeStatus @default(OFFEN), gesperrtVon String?, gesperrtAm DateTime?, @@unique([kanzleiId, jahr, monat]), @@map("buchungsperioden") }`
    - `Kostenstelle { id, kanzleiId, name, beschreibung String?, sachkonto String?, aktiv Boolean @default(true), @@map("kostenstellen") }`
    - `Taetigkeitskategorie { id, kanzleiId, name, abrechenbar Boolean @default(true), aktiv Boolean @default(true), @@map("taetigkeitskategorien") }`
    - `RecurringInvoiceTemplate { id, akteId, mandantId String?, empfaengerId String?, positionen Json, intervallMonate Int @default(1), naechsteFaelligkeit DateTime, aktiv Boolean @default(true), createdAt, updatedAt, @@map("recurring_invoice_templates") }`
    - `FinanzEinstellung { id, kanzleiId, schluessel String, wert Json, updatedAt, @@unique([kanzleiId, schluessel]), @@map("finanz_einstellungen") }`

    Run `npx prisma db push` (or `npx prisma generate` if DB not running).

    **2. Invoice Types** (src/lib/finance/invoice/types.ts):
    - `InvoicePosition { vvNr?: string, beschreibung: string, menge: number, einzelpreis: number, ustSatz: number, betrag: number }`
    - `UstSummary { satz: number, bemessungsgrundlage: number, betrag: number }`
    - `InvoiceData` — full invoice data including Kanzlei info, Mandant/Empfaenger info, positions, totals
    - `StatusTransition { from: RechnungStatus, to: RechnungStatus, validatedBy?: string }`

    **3. Nummernkreis** (src/lib/finance/invoice/nummernkreis.ts):
    Use PostgreSQL UPSERT with RETURNING for atomic gap-free sequence:
    ```sql
    INSERT INTO nummernkreise (id, prefix, year, sequence)
    VALUES (gen_random_uuid(), $prefix, $year, 1)
    ON CONFLICT (prefix, year)
    DO UPDATE SET sequence = nummernkreise.sequence + 1
    RETURNING sequence
    ```
    Format with configurable pattern from Kanzlei.nummernkreisPattern.
    Export `getNextInvoiceNumber(tx: PrismaTransaction, prefix: string, year: number): Promise<string>`

    **4. Status Machine** (src/lib/finance/invoice/status-machine.ts):
    Valid transitions:
    - ENTWURF -> GESTELLT (locks Rechnungsdatum, sets faelligAm from zahlungszielTage)
    - GESTELLT -> BEZAHLT (sets bezahltAm)
    - GESTELLT -> STORNIERT (creates Stornorechnung with own GS-number)
    - GESTELLT -> MAHNUNG (tracks Mahnstufe)
    - ENTWURF -> STORNIERT (simple delete-equivalent)
    Each transition: validate, execute side effects, log via auditLog.

    **5. PDF Generator** (src/lib/finance/invoice/pdf-generator.ts):
    Use pdf-lib (already installed) to generate invoice PDF:
    - Load Briefkopf data from default Briefkopf
    - Header: Kanzlei logo + address block
    - Recipient: Empfaenger name + address
    - Invoice header: Rechnungsnummer, Datum, Aktenzeichen, Mandant
    - Position table: Nr, VV-Nr, Beschreibung, Menge, Einzelpreis, USt-Satz, Betrag
    - Subtotals: Netto, per USt-Satz breakdown, Brutto
    - Footer: SS 14 UStG info (Steuernummer, USt-IdNr), Bankverbindung (IBAN, BIC), Zahlungsziel
    Export `generateInvoicePdf(data: InvoiceData): Promise<Buffer>`
  </action>
  <verify>
    <automated>npx prisma generate && npx tsc --noEmit</automated>
    <manual>Check that prisma/schema.prisma contains all new models and expanded fields</manual>
  </verify>
  <done>
    Prisma schema has all 11+ new models and 3 expanded models. Invoice library files compile. Nummernkreis uses PostgreSQL UPSERT. Status machine enforces valid transitions. PDF generator produces invoice Buffer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Invoice + RVG API Routes</name>
  <files>
    src/app/api/finanzen/rechnungen/route.ts
    src/app/api/finanzen/rechnungen/[id]/route.ts
    src/app/api/finanzen/rechnungen/[id]/pdf/route.ts
    src/app/api/finanzen/rvg/route.ts
    src/app/api/finanzen/rvg/[akteId]/route.ts
  </files>
  <action>
    **1. Invoice List + Create** (src/app/api/finanzen/rechnungen/route.ts):
    - GET: List invoices with filters (status, akteId, mandantId, dateRange, ueberfaellig boolean). Include pagination (skip/take). Return with akte.aktenzeichen and mandant name. Summary stats at top: totalNetto, offeneForderungen, ueberfaellig count.
    - POST: Create invoice. Accept: akteId, empfaengerId?, positionen[], zahlungszielTage, notizen, isPkh, rvgBerechnungId?. Validate SS 14 UStG fields. Generate Rechnungsnummer via getNextInvoiceNumber() in a Prisma transaction. Calculate betragNetto, betragBrutto, ustSummary from positionen. Status = ENTWURF. Validate: akteId exists, Mandant assigned. Audit log.

    **2. Invoice Detail + Update** (src/app/api/finanzen/rechnungen/[id]/route.ts):
    - GET: Full invoice with akte, mandant, empfaenger, teilzahlungen, mahnungen. Calculate restBetrag.
    - PATCH: Two modes:
      a) Edit mode (status ENTWURF only): update positionen, notizen, zahlungszielTage, empfaengerId. Recalculate totals.
      b) Status transition mode: `{ action: "stellen" | "bezahlen" | "stornieren" }`. Use transitionInvoiceStatus(). Stornieren creates new Stornorechnung.
    - DELETE: Only if status ENTWURF. Soft-delete or hard-delete.

    **3. Invoice PDF** (src/app/api/finanzen/rechnungen/[id]/pdf/route.ts):
    - GET: Load invoice with full relations (Kanzlei, Mandant, Empfaenger, Akte). Call generateInvoicePdf(). Return PDF as response with `Content-Type: application/pdf` and `Content-Disposition: inline; filename="RE-2025-0001.pdf"`. Also upload to MinIO and link as dokumentId on invoice.

    **4. RVG Calculation API** (src/app/api/finanzen/rvg/route.ts):
    - POST: Accept { streitwert, auftragseingang?, positionen: [{ vvNr, rate?, gegenstandswert?, anzahlAuftraggeber? }], autoAnrechnung: true, autoAuslagen: true, autoUst: true }. Use RvgCalculator from Plan 01. Return full itemized result. Optionally save to RvgBerechnung if akteId provided.

    **5. RVG per Akte** (src/app/api/finanzen/rvg/[akteId]/route.ts):
    - GET: List saved RVG calculations for this Akte.
    - POST: Save a new calculation for this Akte. Accept same as /rvg POST but with akteId from path.
    - Include `uebernehmenAlsRechnung` field in response that provides the pre-filled invoice data ready for POST to /rechnungen.

    All routes: auth check via auth(), Zod validation, German error messages ("Nicht authentifiziert", "Rechnung nicht gefunden").
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Check all API route files exist and export GET/POST/PATCH handlers</manual>
  </verify>
  <done>
    Invoice CRUD API works with atomic Nummernkreis, status transitions with side effects, and PDF generation with Briefkopf. RVG calculation API saves per Akte and provides one-click transfer to invoice creation.
  </done>
</task>

</tasks>

<verification>
- `npx prisma generate` succeeds with all new models
- `npx tsc --noEmit` passes
- Invoice creation via POST produces a unique Rechnungsnummer
- Status transition from ENTWURF to GESTELLT locks Rechnungsdatum and sets faelligAm
- PDF generation returns valid PDF buffer with Briefkopf
- RVG calculation endpoint returns correct fees matching Plan 01 test values
</verification>

<success_criteria>
- All 11+ new Prisma models created and schema pushable
- Invoice POST returns invoice with atomic Rechnungsnummer (no duplicates under concurrent access)
- Status flow ENTWURF -> GESTELLT -> BEZAHLT works with audit logging
- Stornierung creates separate Stornorechnung with GS-number
- Invoice PDF includes firm letterhead, itemized positions, USt breakdown, and SS 14 UStG footer
- RVG calculation saved per Akte and transferable to invoice with one API call
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-module/05-02-SUMMARY.md`
</output>
