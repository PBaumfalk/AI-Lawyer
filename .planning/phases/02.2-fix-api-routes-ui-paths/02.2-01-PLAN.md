---
phase: 02.2-fix-api-routes-ui-paths
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/ordner-schemata/[id]/route.ts
  - src/app/api/ordner-schemata/route.ts
  - src/lib/ordner-schemata.ts
  - src/components/vorlagen/vorlagen-uebersicht.tsx
  - src/components/einstellungen/ordner-schemata-tab.tsx
autonomous: true
requirements:
  - REQ-DV-008
  - REQ-DV-009

must_haves:
  truths:
    - "PATCH /api/ordner-schemata/:id updates an Ordner-Schema and returns 200 with updated object"
    - "DELETE /api/ordner-schemata/:id deletes an Ordner-Schema and returns 204"
    - "Favorit toggle in vorlagen-uebersicht calls PATCH /api/vorlagen/:id with {action: 'favorite'} and uses optimistic update"
    - "next build succeeds without non-route-export error from ordner-schemata/route.ts"
    - "Delete confirmation uses AlertDialog instead of window.confirm"
  artifacts:
    - path: "src/app/api/ordner-schemata/[id]/route.ts"
      provides: "PATCH and DELETE handlers for individual Ordner-Schema"
      exports: ["PATCH", "DELETE"]
    - path: "src/lib/ordner-schemata.ts"
      provides: "getDefaultOrdnerForSachgebiet helper extracted from route.ts"
      exports: ["getDefaultOrdnerForSachgebiet"]
    - path: "src/app/api/ordner-schemata/route.ts"
      provides: "GET and POST only, no non-route exports"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/components/einstellungen/ordner-schemata-tab.tsx"
      to: "/api/ordner-schemata/:id"
      via: "fetch DELETE and PUT calls"
      pattern: "fetch.*ordner-schemata/"
    - from: "src/components/vorlagen/vorlagen-uebersicht.tsx"
      to: "/api/vorlagen/:id"
      via: "fetch PATCH with {action: 'favorite'}"
      pattern: "fetch.*api/vorlagen.*PATCH"
---

<objective>
Fix three broken flows: (1) Create /api/ordner-schemata/[id] route for PATCH/DELETE by individual ID, (2) Fix favorit toggle in vorlagen-uebersicht.tsx to call the correct PATCH /api/vorlagen/[id] endpoint with {action: "favorite"}, (3) Extract getDefaultOrdnerForSachgebiet from route.ts to fix build failure from non-route export. Enhance delete UX with AlertDialog confirmation and optimistic favorit toggle.

Purpose: Ordner-Schemata admin UI and template favoriting are currently broken (404s). Build fails due to non-route export.
Output: Working CRUD for Ordner-Schemata, working favorit toggle, passing next build.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/ordner-schemata/route.ts
@src/app/api/vorlagen/[id]/route.ts
@src/components/einstellungen/ordner-schemata-tab.tsx
@src/components/vorlagen/vorlagen-uebersicht.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /api/ordner-schemata/[id] route and extract helper</name>
  <files>
    src/app/api/ordner-schemata/[id]/route.ts
    src/app/api/ordner-schemata/route.ts
    src/lib/ordner-schemata.ts
  </files>
  <action>
1. Create `src/lib/ordner-schemata.ts` -- extract the `getDefaultOrdnerForSachgebiet` function from `src/app/api/ordner-schemata/route.ts`. It queries prisma.ordnerSchema for the standard schema by sachgebiet with global fallback. Keep the exact same logic. Export it as a named export.

2. Update `src/app/api/ordner-schemata/route.ts`:
   - Remove the `getDefaultOrdnerForSachgebiet` export and its comment block (lines 224-252). This fixes the build failure caused by non-route exports in App Router route files.
   - Remove the `PUT` and `DELETE` exports entirely -- these will live in the [id] route. Keep only `GET` and `POST`.
   - Add a re-export comment pointing to the new location: `// Helper moved to @/lib/ordner-schemata.ts`

3. Create `src/app/api/ordner-schemata/[id]/route.ts` with:
   - `PATCH` handler (per user decision -- use PATCH not PUT for partial updates):
     - Extract `id` from `params` (Next.js 15 pattern: `const { id } = await params;`)
     - Auth check via `auth()`, return 401 if unauthenticated
     - Parse JSON body, accept partial: `{ name?, sachgebiet?, ordner?, istStandard? }`
     - Validate: if `name` provided, must not be empty string -> return `{ error: "Validation failed", fields: { name: "Name darf nicht leer sein" } }` with 400
     - Find existing by id, return 404 if not found
     - Handle `istStandard` toggle: if setting to true, unset other defaults for same sachgebiet (same logic as current PUT in route.ts)
     - Update via `prisma.ordnerSchema.update()`, return 200 with `{ schema: updatedObject }`
   - `DELETE` handler:
     - Extract `id` from params
     - Auth check
     - Find existing, return 404 if not found
     - If `istStandard` is true, return 400 with `{ error: "Ein Standard-Schema kann nicht geloescht werden. Entfernen Sie zuerst den Standard-Status." }`
     - Delete via `prisma.ordnerSchema.delete()`, return 204 No Content (empty response per user decision)
   - Follow existing auth pattern: `import { auth } from "@/lib/auth"` and `import { prisma } from "@/lib/db"`
   - Use `NextRequest` and `NextResponse` from `next/server`

4. Check if `getDefaultOrdnerForSachgebiet` is imported anywhere else in the codebase. If so, update the import path from `@/app/api/ordner-schemata/route` to `@/lib/ordner-schemata`. (Based on grep, it is NOT imported elsewhere, so no import updates needed -- but verify at execution time.)
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Confirm route.ts has only GET and POST exports, [id]/route.ts has PATCH and DELETE, lib file has helper</manual>
  </verify>
  <done>
    - /api/ordner-schemata/[id] route exists with PATCH (200 + full object) and DELETE (204 no content)
    - getDefaultOrdnerForSachgebiet lives in src/lib/ordner-schemata.ts
    - /api/ordner-schemata/route.ts exports only GET and POST (no non-route exports)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix favorit toggle URL + optimistic update + delete confirmation dialog</name>
  <files>
    src/components/vorlagen/vorlagen-uebersicht.tsx
    src/components/einstellungen/ordner-schemata-tab.tsx
  </files>
  <action>
1. Fix `src/components/vorlagen/vorlagen-uebersicht.tsx` -- `handleToggleFavorite` function (line ~120):
   - CURRENT (broken): `fetch(/api/vorlagen/${vorlageId}/favorit, { method: "POST" })`
   - FIXED: `fetch(/api/vorlagen/${vorlageId}, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: "favorite" }) })`
   - Implement optimistic update per user decision:
     - Immediately update local state: `setVorlagen(prev => prev.map(v => v.id === vorlageId ? { ...v, isFavorit: !v.isFavorit } : v))`
     - On success: update from server response `data.vorlage.isFavorit`
     - On error: revert to previous state and show toast "Favorit konnte nicht gespeichert werden"
   - Favorited templates stay in place (no list reorder on toggle) -- this is already the case since the list is not re-sorted.

2. Fix `src/components/einstellungen/ordner-schemata-tab.tsx`:
   - Replace `window.confirm()` in `handleDelete` (line 115) with shadcn AlertDialog:
     - Import `AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger` from `@/components/ui/alert-dialog`
     - Add state: `const [deleteTarget, setDeleteTarget] = useState<OrdnerSchemaItem | null>(null)`
     - When trash icon clicked: set `deleteTarget` to the schema (opens dialog)
     - Dialog shows: "Ordner-Schema <strong>«{schema.name}»</strong> wirklich loeschen?"
     - Confirm button: calls DELETE endpoint, on success: toast "Schema geloescht" + close dialog + re-fetch
     - On error: parse error response body, show toast with reason (e.g. "Loeschen fehlgeschlagen: {error message}")
     - Cancel button: close dialog
   - Update `handleSetDefault` to use PATCH method instead of PUT (to match the new [id] route):
     - Change `method: "PUT"` to `method: "PATCH"` on line 132
   - Update `handleReset` loop (line 173): already uses correct pattern (DELETE to /api/ordner-schemata/${s.id})
   - Verify AlertDialog component exists; if not, generate with: `npx shadcn@latest add alert-dialog`
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>
      1. Open /vorlagen -- click heart icon on a template card, confirm no 404 in network tab
      2. Open /einstellungen (Ordner-Schemata tab) -- click delete on a schema, confirm AlertDialog appears
    </manual>
  </verify>
  <done>
    - Favorit toggle calls PATCH /api/vorlagen/[id] with {action: "favorite"} -- no more 404
    - Optimistic update: star fills/unfills instantly, reverts on error with toast
    - Delete confirmation uses AlertDialog with schema name, not window.confirm
    - handleSetDefault uses PATCH method matching the new route
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build passes and all three fixes work end-to-end</name>
  <files></files>
  <action>
1. Run `next build` to verify:
   - No "non-route export" error from ordner-schemata/route.ts
   - All pages compile without type errors
   - All API routes are detected correctly in the build output

2. If build fails, diagnose and fix:
   - If AlertDialog component missing: run `npx shadcn@latest add alert-dialog`
   - If import errors: fix paths
   - If type errors: fix types

3. Verify route structure:
   - `src/app/api/ordner-schemata/route.ts` exports only GET, POST
   - `src/app/api/ordner-schemata/[id]/route.ts` exports PATCH, DELETE
   - `src/app/api/vorlagen/[id]/route.ts` exports GET, PUT, PATCH, DELETE (unchanged)
   - `src/lib/ordner-schemata.ts` exports getDefaultOrdnerForSachgebiet
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx next build 2>&1 | tail -30</automated>
  </verify>
  <done>
    - `next build` completes successfully (exit code 0)
    - No non-route export warnings or errors
    - All API routes listed in build output
  </done>
</task>

</tasks>

<verification>
1. `npx next build` passes without errors
2. `npx tsc --noEmit` passes without type errors
3. API routes exist: GET/POST on /api/ordner-schemata, PATCH/DELETE on /api/ordner-schemata/[id]
4. No non-route exports in any route.ts file in the ordner-schemata directory
5. vorlagen-uebersicht.tsx calls PATCH /api/vorlagen/[id] (not POST /api/vorlagen/[id]/favorit)
</verification>

<success_criteria>
- PATCH /api/ordner-schemata/:id returns 200 with updated schema object
- DELETE /api/ordner-schemata/:id returns 204 for non-standard schemas, 400 for standard schemas
- Favorit toggle in Vorlagen overview calls correct endpoint, uses optimistic update with error revert
- Delete confirmation in Ordner-Schemata tab shows AlertDialog with schema name
- next build passes without non-route export errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-fix-api-routes-ui-paths/02.2-01-SUMMARY.md`
</output>
