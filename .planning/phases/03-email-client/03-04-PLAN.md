---
phase: 03-email-client
plan: 04
type: execute
wave: 3
depends_on:
  - 03-02
  - 03-03
files_modified:
  - src/components/email/veraktung-panel.tsx
  - src/lib/email/veraktung.ts
  - src/app/api/emails/[id]/veraktung/route.ts
  - src/app/api/emails/[id]/verantwortlicher/route.ts
  - src/app/api/emails/[id]/ticket/route.ts
  - src/app/(dashboard)/akten/[id]/emails/page.tsx
  - src/components/email/akte-email-tab.tsx
  - src/components/email/email-detail.tsx
  - src/components/email/inbox-layout.tsx
  - src/components/layout/sidebar.tsx
autonomous: true
requirements:
  - REQ-EM-005
  - REQ-EM-007
  - REQ-EM-008

must_haves:
  truths:
    - "User can assign an email to a case (Veraktung) via slide-over panel with auto-suggested Akte matching"
    - "Auto-suggest proposes top 3 Akten based on sender email (known Mandant/Gegenseite) and Aktenzeichen in subject"
    - "User can select which attachments to copy to DMS and choose target DMS folder"
    - "Veraktung is reversible with 'Veraktung aufheben' button"
    - "Multiple emails can be bulk-veraktet to the same Akte"
    - "User can create a Ticket from an email with pre-filled title, description, Akte, and contact"
    - "Akte detail page has E-Mails tab showing all veraktete emails for that case"
    - "Veraktungs-log is stored for audit and visible to Admin"
    - "Kanzlei mailbox supports per-email Verantwortlicher assignment"
    - "After veraktung, email is moved to 'Importierte Emails' IMAP folder"
  artifacts:
    - path: "src/components/email/veraktung-panel.tsx"
      provides: "Slide-over panel for email-to-case assignment"
      min_lines: 120
    - path: "src/lib/email/veraktung.ts"
      provides: "Auto-suggest logic and attachment copy to DMS"
      exports: ["suggestAktenForEmail", "verakteEmail", "hebeVeraktungAuf"]
    - path: "src/app/api/emails/[id]/veraktung/route.ts"
      provides: "Veraktung CRUD API"
      exports: ["POST", "DELETE"]
    - path: "src/app/api/emails/[id]/ticket/route.ts"
      provides: "Create ticket from email API"
      exports: ["POST"]
    - path: "src/components/email/akte-email-tab.tsx"
      provides: "Akte E-Mail tab with filtered email list"
      min_lines: 40
  key_links:
    - from: "src/components/email/veraktung-panel.tsx"
      to: "src/lib/email/veraktung.ts"
      via: "suggestAktenForEmail() for auto-suggestions"
      pattern: "suggestAktenForEmail"
    - from: "src/components/email/veraktung-panel.tsx"
      to: "/api/emails/[id]/veraktung"
      via: "POST to create Veraktung"
      pattern: "fetch.*veraktung"
    - from: "src/lib/email/veraktung.ts"
      to: "src/lib/storage.ts"
      via: "copyFile() to transfer attachments to DMS"
      pattern: "copyFile|uploadFile"
    - from: "src/components/email/akte-email-tab.tsx"
      to: "/api/emails"
      via: "GET with akteId filter"
      pattern: "fetch.*api/emails.*akteId"
---

<objective>
Build the Veraktung (email-to-case assignment) workflow with auto-suggest and attachment transfer, Ticket creation from email, Verantwortlicher assignment for Kanzlei mailbox, and the Akte E-Mail Tab -- completing the integration of email into the case management workflow.

Purpose: Veraktung is the primary daily workflow entry point per the project brief -- every email must be assigned to a case. This plan connects the email client to the case management core. The Akte E-Mail Tab gives attorneys a complete view of all case-related correspondence.
Output: Slide-over Veraktung panel with auto-suggest, Ticket-from-Email creation, Akte E-Mail tab, Verantwortlicher assignment.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-client/03-CONTEXT.md
@.planning/phases/03-email-client/03-RESEARCH.md
@.planning/phases/03-email-client/03-01-SUMMARY.md
@.planning/phases/03-email-client/03-02-SUMMARY.md
@.planning/phases/03-email-client/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Veraktung auto-suggest logic, slide-over panel, Veraktung API, and Verantwortlicher assignment</name>
  <files>
    src/lib/email/veraktung.ts
    src/components/email/veraktung-panel.tsx
    src/app/api/emails/[id]/veraktung/route.ts
    src/app/api/emails/[id]/verantwortlicher/route.ts
    src/components/email/email-detail.tsx
    src/components/email/inbox-layout.tsx
  </files>
  <action>
Create `src/lib/email/veraktung.ts`:
- `suggestAktenForEmail(email: { absender, betreff, empfaenger })` — auto-suggest top 3 Akten:
  1. Match sender email against Kontakt.email fields → find Beteiligter → find linked Akte (highest confidence)
  2. Match recipient email against known Kontakte (for outgoing emails)
  3. Regex match Aktenzeichen pattern in subject line (e.g., "123/2025" or "AZ: 123/2025")
  4. For replies to veraktete emails: find EmailNachricht with same threadId that is veraktet → suggest same Akte (highest priority per user decision)
  Return array of { akteId, aktenzeichen, kurzrubrum, confidence: "hoch" | "mittel" | "niedrig", reason: string }.

- `verakteEmail(params: { emailId, akteId, userId, anhangIds?, dmsOrdner?, notiz? })` — Create EmailVeraktung record. Set email.veraktet=true. Copy selected attachments from email MinIO path to DMS path (akte/{akteId}/Korrespondenz/ or specified folder) using storage.ts uploadFile/copyFile. Create Dokument records for copied attachments. Move email to "Importierte Emails" IMAP folder via background job. If outgoing email has Akte link, auto-verakten per user decision. Return the created EmailVeraktung.

- `hebeVeraktungAuf(veraktungId: string, userId: string)` — Reverse a Veraktung. Set aufgehoben=true, aufgehobenAm=now(). Note: DMS copies remain (per user decision: reversing only removes the link, not the copied files). Update email.veraktet based on remaining active Veraktungen (an email can be veraktet to multiple Akten).

Create `src/app/api/emails/[id]/veraktung/route.ts`:
- GET: List all Veraktungen for an email (including aufgehoben ones for audit). Include Akte details and user who veraktet.
- POST: Create new Veraktung. Accept: akteId, anhangIds (array of EmailAnhang IDs to copy), dmsOrdner (target folder, default "Korrespondenz"), notiz (optional context note). Call `verakteEmail()`. Log audit event via logAuditEvent(). Return created Veraktung with 201.
- DELETE: Reverse a Veraktung. Accept veraktungId in body. Call `hebeVeraktungAuf()`. Log audit event. Return 200.

Create `src/app/api/emails/[id]/verantwortlicher/route.ts`:
- PATCH: Assign Verantwortlicher to an email. Accept { userId }. Update EmailNachricht.verantwortlichId. Only for emails in Kanzlei mailboxes (istKanzlei=true). Return 200.

Create `src/components/email/veraktung-panel.tsx`:
- "use client" slide-over panel from the right (Sheet component from shadcn/ui).
- Opened when user clicks "Verakten" in action bar or "V" keyboard shortcut.
- Content sections:
  1. **Vorgeschlagene Akten** — auto-suggested Akten from suggestAktenForEmail(). Each suggestion shown as a card with Aktenzeichen, Kurzrubrum, confidence badge (hoch=green, mittel=amber, niedrig=gray), reason text. Click to select.
  2. **Akte suchen** — search input field to manually search Akten via /api/akten endpoint. Typeahead with results.
  3. **Anhaenge** — per-attachment checkboxes with filename and file size. All checked by default per user decision. Toggle individual attachments.
  4. **DMS-Ordner** — dropdown showing target Akte folder structure (fetched from OrdnerSchema). Default "Korrespondenz" per user decision.
  5. **Notiz** — free text textarea for context (e.g. "Vergleichsvorschlag eingegangen"). Per user decision.
  6. **Bestaetigen** button — calls POST /api/emails/[id]/veraktung.
- One-click quick veraktung: if auto-suggest has a "hoch" confidence result, show it prominently with "Mit einem Klick verakten" button.
- Support multi-Akte: after first veraktung, show "Weitere Akte zuordnen" option.
- Bulk veraktung: accept multiple emailIds prop for batch assignment.
- After successful veraktung: close panel, show success toast, update email in list with Veraktung badge.

Update `src/components/email/email-detail.tsx`:
- Wire "Verakten" button in action bar to open VeraktungPanel.
- If email is veraktet: show Veraktung info section below header (Aktenzeichen, linked Akte, date, who veraktet). Show "Veraktung aufheben" button.
- Wire Verantwortlicher assignment: show avatar/icon in header area for Kanzlei mailbox emails. Click opens user dropdown for quick assignment via PATCH /api/emails/[id]/verantwortlicher.

Update `src/components/email/inbox-layout.tsx`:
- Add state management for veraktung panel open/close.
- Pass veraktung panel open handler to email detail and action bar.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Click "Verakten" on an email, verify slide-over panel opens with auto-suggestions, attachment checkboxes, folder dropdown, and confirm button. Verify Veraktung badge appears after assignment.</manual>
  </verify>
  <done>Veraktung slide-over panel opens with auto-suggested Akten (sender match + Aktenzeichen regex + thread history), per-attachment checkbox selection, DMS folder dropdown, optional note field, and confirm button. One-click quick veraktung for high-confidence suggestions. Veraktung is reversible. Verantwortlicher can be assigned on Kanzlei mailbox emails. All operations create audit log entries.</done>
</task>

<task type="auto">
  <name>Task 2: Create Ticket-from-Email, Akte E-Mail Tab, sidebar navigation update</name>
  <files>
    src/app/api/emails/[id]/ticket/route.ts
    src/app/(dashboard)/akten/[id]/emails/page.tsx
    src/components/email/akte-email-tab.tsx
    src/components/email/email-detail.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
Create `src/app/api/emails/[id]/ticket/route.ts`:
- POST: Create a Ticket from an email. Per user decision: pre-fill from email fields.
  - titel = email.betreff
  - beschreibung = First 500 chars of email.inhaltText with "Aus E-Mail vom {date}" prefix
  - akteId = email's veraktet Akte if assigned (first EmailVeraktung.akteId), otherwise null
  - Link: set Ticket on EmailNachricht (ticketId relation)
  - Optional: accept overrides in request body for all fields (user can edit before saving per user decision).
- Validate auth and email access. Create Ticket, update EmailNachricht.ticketId. Log audit. Return created Ticket with 201.

Create `src/components/email/akte-email-tab.tsx`:
- "use client" component for the Akte detail page E-Mail tab (REQ-EM-008).
- Per user decision: "Filtered inbox-style list of all veraktete emails for this Akte (chronological, same row format as inbox)."
- Fetches from GET /api/emails?akteId={akteId}&veraktet=true, sorted by empfangenAm desc.
- Reuses EmailListRow component from Plan 02 for consistent row rendering.
- Click opens email detail in a slide-over (not navigating away from Akte page).
- Show Veraktung metadata: who veraktet, when, notiz if present.
- Show "Veraktung aufheben" action per row (calls DELETE /api/emails/[id]/veraktung).
- Empty state: "Keine E-Mails mit dieser Akte verknuepft."

Create `src/app/(dashboard)/akten/[id]/emails/page.tsx`:
- Page component for the /akten/[id]/emails route.
- Renders AkteEmailTab with akteId from params.
- Integrate into existing Akte detail page tab navigation (check existing tab pattern — likely uses URL segments for tab routing).

Update `src/components/layout/sidebar.tsx`:
- Add "E-Mail" navigation item to the sidebar. Use lucide Mail icon. Route to /email.
- Position in sidebar: after "Kalender" and before "Tickets" (follows logical workflow order: cases -> calendar -> email -> tickets).
- Plain link only — no dynamic unread count badge. Unread badge is deferred per "E-Mail sidebar navigation details" in CONTEXT.md deferred items.

Wire Ticket-from-Email button in email-detail.tsx action bar:
- "Ticket erstellen" button opens a dialog/sheet with pre-filled Ticket form.
- Form fields: Titel (pre-filled with Betreff), Beschreibung (pre-filled with email excerpt), Akte (pre-filled if veraktet), Prioritaet, Faellig am, Verantwortlicher.
- User can edit all fields before saving per user decision.
- Submit calls POST /api/emails/[id]/ticket. On success: close dialog, show success toast with link to created ticket.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Click "Ticket erstellen" on email, verify form opens with pre-filled data. Navigate to Akte detail, click E-Mail tab, verify veraktete emails are listed. Verify sidebar shows E-Mail link with unread badge.</manual>
  </verify>
  <done>Ticket-from-Email creates tickets with pre-filled title/description/Akte/contact from email data. Akte E-Mail Tab shows chronological list of all veraktete emails reusing inbox row format. Sidebar has "E-Mail" navigation item (plain link, no badge). All three features are connected to the API and the broader email workflow.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Veraktung panel opens with auto-suggestions and attachment selection
3. Veraktung creates EmailVeraktung record and copies attachments to DMS
4. Veraktung is reversible
5. Ticket-from-Email creates ticket with pre-filled data from email
6. Akte E-Mail Tab shows veraktete emails for the case
7. Sidebar shows E-Mail navigation link (plain, no badge)
8. Verantwortlicher assignment works on Kanzlei mailbox emails
</verification>

<success_criteria>
- Veraktung workflow complete: suggest -> select -> configure attachments -> confirm -> badge appears
- Auto-suggest finds Akten by sender, Aktenzeichen, and thread history
- Attachments are copied to DMS on veraktung
- Ticket-from-Email pre-fills correctly from email data
- Akte E-Mail Tab displays all veraktete emails chronologically
- Sidebar navigation updated with E-Mail link
- TypeScript compilation passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-client/03-04-SUMMARY.md`
</output>
