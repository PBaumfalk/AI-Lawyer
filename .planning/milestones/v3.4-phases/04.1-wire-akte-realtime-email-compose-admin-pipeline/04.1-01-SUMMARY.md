---
phase: 04.1-wire-akte-realtime-email-compose-admin-pipeline
plan: 01
subsystem: integration
tags: [socket.io, sonner, toast, compose, pipeline, admin, real-time]

# Dependency graph
requires:
  - phase: 04-document-pipeline-ocr-rag-ingestion
    provides: OCR worker, pipeline API, document processing queues
  - phase: 03.1-wire-email-realtime-compose
    provides: ComposeManager context, email layout, socket room patterns
  - phase: 01-infrastructure-foundation
    provides: Socket.IO rooms, worker infrastructure, admin layout
provides:
  - Socket.IO akte room join/leave lifecycle with global OCR toast notifications
  - Neue E-Mail FAB button on all email pages via ComposeManager
  - Admin pipeline dashboard at /admin/pipeline with queue stats, failed docs table, and retry
affects: [05-finance-time-tracking, 06-ai-agent-integration, 07-roles-security]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Socket bridge component pattern: invisible client component for room lifecycle + event bridging"
    - "Worker-to-user notification via dual room emission (akte + user rooms)"
    - "FAB button pattern: fixed-position z-layered button in layout for cross-page access"

key-files:
  created:
    - src/components/akten/akte-socket-bridge.tsx
    - src/components/email/compose-fab.tsx
    - src/app/(dashboard)/admin/pipeline/page.tsx
  modified:
    - src/app/(dashboard)/akten/[id]/page.tsx
    - src/worker.ts
    - src/app/(dashboard)/email/layout.tsx
    - src/app/(dashboard)/admin/layout.tsx
    - src/components/layout/sidebar.tsx

key-decisions:
  - "Worker emits to both akte:{akteId} and user:{userId} rooms for global toast reach"
  - "Prisma lookup in worker event handler for createdById (not in job data)"
  - "Workflow icon for Pipeline sidebar link to differentiate from Activity (Job-Monitor)"

patterns-established:
  - "AkteSocketBridge: invisible bridge component for akte room join/leave + event listeners"
  - "Dual-room worker emission: akte room for upload panel, user room for global notifications"

requirements-completed: [REQ-DV-004, REQ-DV-005, REQ-EM-006]

# Metrics
duration: 4min
completed: 2026-02-24
---

# Phase 4.1 Plan 01: Wire Akte Real-Time, Email Compose, Admin Pipeline Summary

**Socket.IO akte room lifecycle with global OCR toasts, Neue E-Mail FAB via ComposeManager, and admin pipeline dashboard with queue stats and per-job retry**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-24T17:59:29Z
- **Completed:** 2026-02-24T18:03:41Z
- **Tasks:** 3
- **Files modified:** 8

## Accomplishments
- AkteSocketBridge component wires akte room join/leave and OCR toast notifications (success + failure) via sonner
- Worker.ts extended to emit document:ocr-complete with fileName/akteId to both akte and user rooms
- ComposeFab renders Gmail-style floating action button on all email pages via email layout
- Admin pipeline dashboard displays OCR/Embedding/Preview queue stats with auto-refresh and per-job + bulk retry

## Task Commits

Each task was committed atomically:

1. **Task 1: Wire Socket.IO akte room join/leave + global OCR toast notifications** - `5202963` (feat)
2. **Task 2: Add Neue E-Mail FAB button on email pages** - `abbd05a` (feat)
3. **Task 3: Create admin pipeline dashboard page with navigation link** - `69255f7` (feat)

## Files Created/Modified
- `src/components/akten/akte-socket-bridge.tsx` - Socket.IO bridge for akte room lifecycle and OCR toast notifications
- `src/app/(dashboard)/akten/[id]/page.tsx` - Added AkteSocketBridge client component child
- `src/worker.ts` - Extended OCR event payloads with fileName/akteId, dual-room emission
- `src/components/email/compose-fab.tsx` - Gmail-style floating action button for new email composition
- `src/app/(dashboard)/email/layout.tsx` - Added ComposeFab inside ComposeManager provider
- `src/app/(dashboard)/admin/pipeline/page.tsx` - Pipeline dashboard with queue cards, status distribution, failed docs table
- `src/app/(dashboard)/admin/layout.tsx` - Added Pipeline navigation link
- `src/components/layout/sidebar.tsx` - Added Pipeline link with Workflow icon to admin section

## Decisions Made
- Worker emits to both `akte:{akteId}` and `user:{userId}` rooms so OCR toasts fire globally even when user navigates away from Akte page
- Used Prisma lookup in worker event handler for `createdById` since it is not in the OcrJobData type (avoids changing the job data interface)
- Used Workflow icon for Pipeline sidebar link to differentiate from Job-Monitor (which uses Activity icon)
- Z-index z-[80] for ComposeFab sits between upload panel (z-50) and minimized compose tabs (z-[85])

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All three integration gaps (INT-004, INT-005, INT-006) are closed
- OCR real-time notifications flow end-to-end from worker to browser
- Email compose initiation available from any email page
- Pipeline monitoring dashboard ready for admin use
- Ready for Phase 5 (Finance + Time Tracking) or subsequent phases

## Self-Check: PASSED

All created files exist. All commit hashes verified (5202963, abbd05a, 69255f7).

---
*Phase: 04.1-wire-akte-realtime-email-compose-admin-pipeline*
*Completed: 2026-02-24*
