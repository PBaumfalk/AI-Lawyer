---
phase: 02-deadline-calculation-document-templates
plan: 04
type: execute
wave: 2
depends_on:
  - 02-03
files_modified:
  - prisma/schema.prisma
  - src/lib/vorlagen.ts
  - src/lib/briefkopf.ts
  - src/app/api/vorlagen/route.ts
  - src/app/api/vorlagen/[id]/generieren/route.ts
  - src/app/api/vorlagen/[id]/route.ts
  - src/app/api/briefkopf/route.ts
  - src/app/api/briefkopf/[id]/route.ts
  - src/app/api/ordner-schemata/route.ts
  - src/app/(dashboard)/vorlagen/page.tsx
  - src/components/vorlagen/vorlagen-uebersicht.tsx
  - src/components/vorlagen/vorlagen-wizard.tsx
  - src/components/vorlagen/platzhalter-sidebar.tsx
  - src/components/briefkopf/briefkopf-editor.tsx
  - src/components/briefkopf/pdf-export-dialog.tsx
  - src/app/(dashboard)/einstellungen/page.tsx
  - src/components/einstellungen/vorlagen-tab.tsx
  - src/components/einstellungen/briefkopf-tab.tsx
  - src/components/einstellungen/ordner-schemata-tab.tsx
  - src/components/einstellungen/fristen-tab.tsx
autonomous: true
requirements:
  - REQ-DV-001
  - REQ-DV-002
  - REQ-DV-003
  - REQ-DV-008
  - REQ-DV-009

must_haves:
  truths:
    - "User can browse templates in card-based overview with categories, search, favorites, and Zuletzt verwendet section"
    - "User can generate a document via 4-step wizard: Select template -> Select Akte/Mandant -> Fill custom fields -> Preview + Confirm"
    - "Generated document has all placeholders auto-filled from case data (mandant.name, akte.aktenzeichen, gegner.name, etc.)"
    - "Briefkopf is applied to generated documents -- logo + firm name at top, contact details in right sidebar, minimal header on subsequent pages"
    - "User can export any DOCX document as PDF with Briefkopf via OnlyOffice Conversion API"
    - "Multiple Briefkoepfe are supported (per Standort/team), one marked as default"
    - "Ordner-Schemata can be configured per Rechtsgebiet and are applied when creating new Akten"
    - "Templates support conditional sections and loops via docxtemplater"
    - "Template versioning tracks all changes, old versions accessible"
    - "Freigabe workflow: anyone creates drafts, only Admin/Anwalt can freigeben"
  artifacts:
    - path: "src/lib/vorlagen.ts"
      provides: "Enhanced template engine with conditional sections, loops, custom fields, Briefkopf merge"
      exports: ["fillDocxTemplate", "resolvePlatzhalter", "extractPlatzhalterFromDocx", "applyBriefkopf"]
    - path: "src/lib/briefkopf.ts"
      provides: "Briefkopf DOCX header/footer manipulation and PDF export via OnlyOffice Conversion API"
      exports: ["applyBriefkopfToDocx", "convertToPdf"]
    - path: "src/app/api/vorlagen/[id]/generieren/route.ts"
      provides: "4-step template generation endpoint"
      exports: ["POST"]
    - path: "src/app/api/briefkopf/route.ts"
      provides: "Briefkopf CRUD API"
      exports: ["GET", "POST"]
    - path: "src/components/vorlagen/vorlagen-uebersicht.tsx"
      provides: "Card-based template browser with search, categories, favorites"
      min_lines: 100
    - path: "src/components/vorlagen/vorlagen-wizard.tsx"
      provides: "4-step document generation wizard"
      min_lines: 120
    - path: "src/components/briefkopf/pdf-export-dialog.tsx"
      provides: "PDF export dialog with Briefkopf selection, PDF/A option, watermark option"
      exports: ["PdfExportDialog"]
  key_links:
    - from: "src/app/api/vorlagen/[id]/generieren/route.ts"
      to: "src/lib/vorlagen.ts"
      via: "resolvePlatzhalter + fillDocxTemplate"
      pattern: "resolvePlatzhalter|fillDocxTemplate"
    - from: "src/app/api/vorlagen/[id]/generieren/route.ts"
      to: "src/lib/briefkopf.ts"
      via: "applyBriefkopfToDocx for letterhead application"
      pattern: "applyBriefkopf"
    - from: "src/components/briefkopf/pdf-export-dialog.tsx"
      to: "src/app/api/onlyoffice/convert/route.ts"
      via: "fetch POST /api/onlyoffice/convert for PDF generation"
      pattern: "api/onlyoffice/convert"
    - from: "src/components/vorlagen/vorlagen-wizard.tsx"
      to: "src/app/api/vorlagen/[id]/generieren/route.ts"
      via: "fetch POST to generate document from template"
      pattern: "api/vorlagen/.*/generieren"
---

<objective>
Build the Vorlagen-System (template browser, 4-step generation wizard, conditional sections, custom fields, versioning, Freigabe), Briefkopf management (multiple letterheads, structured form + OnlyOffice editing), PDF export with Briefkopf, Ordner-Schemata, and Kanzlei-Einstellungen tabs for Fristen/Vorlagen/Briefkopf/Ordner-Schemata.

Purpose: Attorneys need to quickly generate legally formatted documents from templates with auto-filled case data and firm letterhead. The card-based template overview, 4-step wizard, and PDF export make document creation a daily power tool. Ordner-Schemata ensure consistent case file organization. Kanzlei-Einstellungen centralizes all configuration.

Output: Template CRUD with versioning + Freigabe, generation wizard, Briefkopf management, PDF export, Ordner-Schemata, and settings tabs.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md
@.planning/phases/02-deadline-calculation-document-templates/02-03-SUMMARY.md

@src/lib/vorlagen.ts
@src/lib/onlyoffice.ts
@prisma/schema.prisma
@src/app/api/vorlagen/route.ts
@src/app/(dashboard)/einstellungen/page.tsx
@src/components/dokumente/onlyoffice-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema + Briefkopf API + Enhanced Vorlagen API + Generation Endpoint + Ordner-Schemata</name>
  <files>
    prisma/schema.prisma,
    src/lib/vorlagen.ts,
    src/lib/briefkopf.ts,
    src/app/api/vorlagen/route.ts,
    src/app/api/vorlagen/[id]/route.ts,
    src/app/api/vorlagen/[id]/generieren/route.ts,
    src/app/api/vorlagen/[id]/freigabe/route.ts,
    src/app/api/briefkopf/route.ts,
    src/app/api/briefkopf/[id]/route.ts,
    src/app/api/ordner-schemata/route.ts
  </files>
  <action>
    **1. Schema Changes (prisma/schema.prisma):**
    Enhance `DokumentVorlage` model:
    - Add `version Int @default(1)`
    - Add `tags String[]` for search/filter
    - Add `freigegeben Boolean @default(false)`
    - Add `freigegebenVonId String?` with optional User relation
    - Add `freigegebenAm DateTime?`
    - Add `customFelder Json?` -- stores array of `{ key: string, label: string, typ: 'TEXT'|'NUMBER'|'DATE'|'DROPDOWN', optionen?: string[] }`
    - Add `favoritenVon String[]` -- User IDs who favorited
    - Add `VorlageVersion` model for template version history (similar to DokumentVersion: id, vorlageId, version, dateipfad, createdById, createdAt)

    Add `Briefkopf` model:
    - id, name, dateipfad (MinIO path to DOCX), logoUrl (MinIO path to logo), kanzleiName, adresse, telefon, fax, email, website, steuernr, ustIdNr, iban, bic, bankName, braoInfo, istStandard Boolean @default(false), createdAt, updatedAt

    Add `OrdnerSchema` model:
    - id, name, sachgebiet (Sachgebiet? enum), ordner (String[]), istStandard Boolean @default(false), createdAt, updatedAt

    Run `npx prisma db push`.

    **2. Enhanced Vorlagen Library (src/lib/vorlagen.ts):**
    Keep existing `resolvePlatzhalter()`, `fillDocxTemplate()`, `extractPlatzhalterFromDocx()`, `createBlankDocx()`.
    Enhance `fillDocxTemplate()` to support:
    - Conditional sections: `{#if condition}...{/if}` and `{^if condition}...{/if}` (inverted)
    - Loops: `{#items}...{/items}` for arrays
    - Custom fields merged into the data object alongside case data
    Ensure docxtemplater is configured with `paragraphLoop: true, linebreaks: true, delimiters: { start: "{{", end: "}}" }`.

    **3. Briefkopf Library (src/lib/briefkopf.ts):**
    `applyBriefkopfToDocx(docxBuffer: Buffer, briefkopfBuffer: Buffer): Buffer`:
    - Uses PizZip to open both documents.
    - Copies header/footer XML parts from briefkopf DOCX to target DOCX.
    - Copies referenced media (images/logo) from briefkopf.
    - Updates relationships in `word/_rels/document.xml.rels`.
    - Updates `[Content_Types].xml` for new media.
    - Handles first-page-different header: full letterhead on first page, minimal on subsequent.
    - Returns merged DOCX as Buffer.
    - CRITICAL: Test with actual DOCX files. If PizZip manipulation proves too brittle for header/footer merge (per RESEARCH.md Open Question #3), fall back to full-template approach where Briefkopf is a complete DOCX template and content is injected into it.

    `convertToPdf(dokumentId: string): Promise<Buffer>`:
    - Load document from DB + MinIO.
    - Call OnlyOffice Conversion API (POST /converter) endpoint -- reuse the existing convert route logic or call it internally.
    - Return PDF buffer.

    **4. Enhanced Vorlagen API (src/app/api/vorlagen/route.ts):**
    GET: List templates with filtering by kategorie, tags, freigegeben. Include favoritenVon (check if current user favorited). Sort: favorites first, then "Zuletzt verwendet" (track in localStorage on client), then by kategorie.
    POST: Create template. Upload DOCX to MinIO. Extract placeholders. Set freigegeben=false (draft). Accept customFelder definition. Accept tags.

    **5. Vorlagen Detail API (src/app/api/vorlagen/[id]/route.ts):**
    GET: Single template with all fields.
    PUT: Update template. Upload new DOCX, increment version, create VorlageVersion snapshot of previous.
    DELETE: Soft-delete or hard-delete.
    PATCH (favorite): Toggle favorite for current user (add/remove userId from favoritenVon).

    **6. Freigabe API (src/app/api/vorlagen/[id]/freigabe/route.ts):**
    POST: Set freigegeben=true, freigegebenVonId=current user, freigegebenAm=now.
    Only ADMIN or ANWALT roles allowed (per user decision).
    DELETE: Revoke Freigabe (set freigegeben=false). Only ADMIN or ANWALT.

    **7. Generation Endpoint (src/app/api/vorlagen/[id]/generieren/route.ts):**
    POST body: `{ akteId: string, customFelderValues?: Record<string, string>, briefkopfId?: string, openInEditor?: boolean, targetOrdner?: string, dateiname?: string }`.
    Steps:
    1. Load template DOCX from MinIO.
    2. Load Akte with all Beteiligte, Anwalt, Kanzlei data (Prisma include).
    3. Call `resolvePlatzhalter(akteData)` to get all placeholder values.
    4. Merge customFelderValues into the data object.
    5. Call `fillDocxTemplate(templateBuffer, mergedData)`.
    6. If briefkopfId provided (or use default Briefkopf), call `applyBriefkopfToDocx(filledBuffer, briefkopfBuffer)`.
    7. Auto-generate filename: `{Aktenzeichen}_{VorlageTyp}_{Partei}_{Datum}` (per user decision, editable via dateiname param).
    8. Upload generated DOCX to MinIO in the Akte's folder (use targetOrdner or suggest based on template category).
    9. Create Dokument record in DB (linked to Akte, status ENTWURF, erstelltDurch="system").
    10. Return Dokument record. If openInEditor=true, also return OnlyOffice editor config for immediate editing.

    **8. Briefkopf API (src/app/api/briefkopf/route.ts + [id]/route.ts):**
    GET: List all Briefkoepfe. Mark which is default.
    POST: Create Briefkopf. Upload logo to MinIO. If structured form: create DOCX with header/footer from form data. If DOCX upload: store directly.
    PUT: Update Briefkopf fields + file.
    DELETE: Delete Briefkopf (not if it's the only one or default).
    PATCH: Set as default (toggle istStandard, unset on others).

    **9. Ordner-Schemata API (src/app/api/ordner-schemata/route.ts):**
    GET: List all schemas. Can filter by sachgebiet.
    POST: Create schema with name, sachgebiet, ordner array.
    PUT: Update schema.
    DELETE: Delete (not if istStandard).
    When creating a new Akte (check existing Akte creation endpoint), apply matching OrdnerSchema to create default folder structure.
  </action>
  <verify>
    <automated>npx prisma validate && npx tsc --noEmit src/lib/vorlagen.ts src/lib/briefkopf.ts && npx next build 2>&1 | tail -10</automated>
    <manual>Test template generation via API with a real Akte</manual>
  </verify>
  <done>DokumentVorlage has versioning, tags, Freigabe, customFelder. Briefkopf model exists with CRUD. OrdnerSchema model exists. Generation endpoint fills template with case data and applies Briefkopf. Briefkopf header/footer merge works. Vorlagen versioning tracks changes.</done>
</task>

<task type="auto">
  <name>Task 2: Vorlagen UI (Card Browser + Wizard + Placeholder Sidebar) + Briefkopf Editor + PDF Export + Settings Tabs</name>
  <files>
    src/app/(dashboard)/vorlagen/page.tsx,
    src/components/vorlagen/vorlagen-uebersicht.tsx,
    src/components/vorlagen/vorlagen-wizard.tsx,
    src/components/vorlagen/platzhalter-sidebar.tsx,
    src/components/briefkopf/briefkopf-editor.tsx,
    src/components/briefkopf/pdf-export-dialog.tsx,
    src/app/(dashboard)/einstellungen/page.tsx,
    src/components/einstellungen/vorlagen-tab.tsx,
    src/components/einstellungen/briefkopf-tab.tsx,
    src/components/einstellungen/ordner-schemata-tab.tsx,
    src/components/einstellungen/fristen-tab.tsx
  </files>
  <action>
    **1. Vorlagen Overview Page (src/app/(dashboard)/vorlagen/page.tsx):**
    Page route at /vorlagen. Contains VorlagenUebersicht component.

    **2. Vorlagen Card Browser (src/components/vorlagen/vorlagen-uebersicht.tsx):**
    Card-based layout (per user decision: "Karten-Uebersicht, not file-tree").
    - Search field at top: full-text search across name, beschreibung, tags.
    - Category filter pills (based on VorlageKategorie enum + custom tags).
    - "Favoriten" section at top showing user's favorited templates.
    - "Zuletzt verwendet" section (tracked in localStorage).
    - Grid of template cards: each shows name, kategorie badge, beschreibung preview, tags, favorite toggle (heart icon), Freigabe status badge.
    - Click card -> opens wizard OR navigates to template detail.
    - "Neue Vorlage" button for creating templates.
    - Responsive grid: 3 cols on lg, 2 on md, 1 on sm.

    **3. Vorlagen Wizard (src/components/vorlagen/vorlagen-wizard.tsx):**
    4-step wizard dialog (per user decision):
    Step 1: Template is pre-selected (from card click) or select from dropdown.
    Step 2: Select Akte + Mandant. Akte search/autocomplete. Pre-filled if opened from Akte view.
    Step 3: Custom fields (rendered from template's customFelder definition). Each field type: Text (input), Number (number input), Date (date picker), Dropdown (select from optionen).
    Step 4: Preview + Confirm. Show auto-generated filename (editable). Show target folder (suggest from template category, user can change). Checkbox "In OnlyOffice oeffnen" (default on, per user decision). Show which Briefkopf will be applied.
    Submit calls POST /api/vorlagen/{id}/generieren.
    On success: navigate to document in OnlyOffice editor (if checkbox on) or show success toast.

    **4. Placeholder Sidebar (src/components/vorlagen/platzhalter-sidebar.tsx):**
    For use inside OnlyOffice editor (or template editing context):
    - Lists all available placeholder groups (from PLATZHALTER_GRUPPEN in vorlagen.ts).
    - Organized by group: Akte, Mandant, Gegner, etc.
    - Each placeholder: click to copy `{{mandant.name}}` to clipboard (with toast "Platzhalter kopiert").
    - Search/filter field.
    - Show example values next to each placeholder.

    **5. Briefkopf Editor (src/components/briefkopf/briefkopf-editor.tsx):**
    Two modes per user decision:
    Mode 1: Structured form -- Logo upload (drag-and-drop), Kanzleiname, Adresse, Telefon, Fax, Email, Website, Steuernr, USt-IdNr, IBAN, BIC, Bankname, BRAO-Info. Live preview showing layout: Logo + firm name at top, contact/BRAO info in right sidebar (modern layout per user decision).
    Mode 2: Full DOCX editing in OnlyOffice -- opens Briefkopf DOCX in OnlyOffice editor for complete control.
    Toggle between modes. Save updates Briefkopf record + MinIO file.
    "Als Standard setzen" button.

    **6. PDF Export Dialog (src/components/briefkopf/pdf-export-dialog.tsx):**
    Dialog with options per user decision:
    - Choose Briefkopf (dropdown, default pre-selected). Only shown if multiple exist.
    - PDF/A format checkbox (optional).
    - Watermark text input (optional, e.g., "ENTWURF").
    - "Exportieren" button calls POST /api/onlyoffice/convert with options.
    - Download resulting PDF.
    Reusable: can be opened from document detail, OnlyOffice editor, or Akte documents tab.

    **7. Kanzlei-Einstellungen Page Enhancement (src/app/(dashboard)/einstellungen/page.tsx):**
    Add new tabs to the settings page (per user decision: tab-based, VS Code style, auto-save):
    - Existing tabs stay.
    - Add "Fristen" tab containing FristenTab component.
    - Add "Vorlagen" tab containing VorlagenTab component.
    - Add "Briefkoepfe" tab containing BriefkopfTab component.
    - Add "Ordner-Schemata" tab containing OrdnerSchemataTab component.

    **8. Fristen Settings Tab (src/components/einstellungen/fristen-tab.tsx):**
    - Default Vorfristen (7/3/1 days) -- editable.
    - Default Bundesland dropdown.
    - Fristen-Presets management (table with CRUD inline editing).
    - Eskalation settings: hours until Vertreter notified, hours until Admin notified.
    - Kanzlei-Arbeitszeiten (Mo-Fr start/end times).
    - All auto-save on change (per user decision).

    **9. Vorlagen Settings Tab (src/components/einstellungen/vorlagen-tab.tsx):**
    - List all templates with Freigabe status.
    - Freigeben/Zurueckziehen buttons.
    - Upload new template.
    - Category management.

    **10. Briefkopf Settings Tab (src/components/einstellungen/briefkopf-tab.tsx):**
    - List all Briefkoepfe. Default marked.
    - Edit/Delete/Set Default buttons.
    - "Neuer Briefkopf" button opens BriefkopfEditor.

    **11. Ordner-Schemata Tab (src/components/einstellungen/ordner-schemata-tab.tsx):**
    - List schemas with Sachgebiet badges.
    - Inline edit folder list (add/remove/reorder folders).
    - "Neues Schema" button.
    - Default schema marked.

    Use Tailwind CSS, shadcn/ui components, German UI labels, English code comments throughout. Follow existing layout and component patterns.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Navigate to /vorlagen page, verify card layout. Click a template, walk through 4-step wizard. Open Einstellungen page, verify new tabs appear with correct content.</manual>
  </verify>
  <done>Vorlagen page shows card-based overview with search, categories, favorites. 4-step wizard generates documents with filled placeholders and Briefkopf. PDF export dialog works. Briefkopf editor has structured form and OnlyOffice mode. Settings page has Fristen, Vorlagen, Briefkopf, and Ordner-Schemata tabs. All auto-save.</done>
</task>

</tasks>

<verification>
```bash
# Schema validates
npx prisma validate

# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build

# Template generation works end-to-end
curl -s -X POST http://localhost:3000/api/vorlagen/{id}/generieren \
  -H "Content-Type: application/json" \
  -d '{"akteId": "{testAkteId}"}' \
  | jq '.id'
```
</verification>

<success_criteria>
- Card-based Vorlagen overview at /vorlagen with search, categories, and favorites
- 4-step wizard generates DOCX with filled placeholders from case data
- Briefkopf applied to generated documents (logo + firm data, modern sidebar layout, first/subsequent page differentiation)
- PDF export via OnlyOffice Conversion API with Briefkopf selection and watermark option
- Multiple Briefkoepfe supported, one default
- Template versioning with old versions accessible
- Freigabe workflow: drafts by anyone, freigeben by ADMIN/ANWALT only
- Ordner-Schemata configurable per Rechtsgebiet
- Kanzlei-Einstellungen has Fristen, Vorlagen, Briefkopf, Ordner-Schemata tabs
- Auto-save on all settings (VS Code style)
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-04-SUMMARY.md`
</output>
