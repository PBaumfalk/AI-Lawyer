---
phase: 06-ai-features-bea
plan: 05
type: execute
wave: 3
depends_on:
  - "06-04"
files_modified:
  - src/app/(dashboard)/bea/page.tsx
  - src/app/(dashboard)/bea/[id]/page.tsx
  - src/app/(dashboard)/bea/compose/page.tsx
  - src/app/api/bea/messages/route.ts
  - src/app/api/bea/messages/[id]/route.ts
  - src/app/api/bea/messages/[id]/eeb/route.ts
  - src/app/api/bea/auto-assign/route.ts
  - src/components/bea/bea-inbox.tsx
  - src/components/bea/bea-message-detail.tsx
  - src/components/bea/bea-compose.tsx
  - src/components/bea/xjustiz-viewer.tsx
  - src/components/bea/pruefprotokoll-viewer.tsx
  - src/components/bea/eeb-button.tsx
autonomous: false
requirements:
  - REQ-BA-001
  - REQ-BA-002
  - REQ-BA-003
  - REQ-BA-004
  - REQ-BA-005
  - REQ-BA-006

must_haves:
  truths:
    - "User can authenticate with beA via software token in the browser"
    - "User can view beA inbox with received messages and their status"
    - "User can send beA messages with document attachments (ANWALT role only)"
    - "User can acknowledge receipt (eEB) with one click on incoming Zustellungen"
    - "User can view Pruefprotokoll for any beA message"
    - "Safe-IDs are managed on Kontakt records and auto-pulled when composing"
    - "XJustiz attachments are parsed and rendered as structured readable views"
    - "beA messages are auto-assigned to Akten via Aktenzeichen/Gerichtsbezug matching"
    - "Helena scans stored beA messages for deadlines and parties"
  artifacts:
    - path: "src/app/(dashboard)/bea/page.tsx"
      provides: "beA inbox/outbox page replacing stub"
    - path: "src/components/bea/bea-compose.tsx"
      provides: "beA message compose form with SAFE-ID lookup"
    - path: "src/components/bea/xjustiz-viewer.tsx"
      provides: "Structured viewer for parsed XJustiz data"
    - path: "src/app/api/bea/messages/route.ts"
      provides: "beA message CRUD API with auto-assign and Helena scan trigger"
      exports: ["GET", "POST"]
  key_links:
    - from: "src/components/bea/bea-inbox.tsx"
      to: "src/lib/bea/client.ts"
      via: "browser-side API calls with session keys"
      pattern: "beaClient\\.|beaGetMessages|beaLogin"
    - from: "src/app/api/bea/messages/route.ts"
      to: "prisma.beaNachricht"
      via: "persist fetched messages to database"
      pattern: "prisma\\.beaNachricht\\.create"
    - from: "src/app/api/bea/messages/route.ts"
      to: "ai-scan queue"
      via: "trigger Helena scan after message stored"
      pattern: "aiScanQueue\\.add"
---

<objective>
Build the beA UI layer: inbox/outbox pages, message detail view, compose form with SAFE-ID lookup, eEB one-click acknowledgment button, Pruefprotokoll viewer, XJustiz inline viewer, and all supporting API routes. Wire auto-assignment and Helena scan triggers into message storage.

Purpose: Attorneys can send and receive legally required electronic court messages directly within the application, with automated case assignment and AI scanning.
Output: Full beA section with inbox, outbox, compose, eEB, Pruefprotokoll, XJustiz viewer, and Helena integration.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-features-bea/06-RESEARCH.md
@.planning/phases/06-ai-features-bea/06-01-SUMMARY.md
@.planning/phases/06-ai-features-bea/06-03-SUMMARY.md
@.planning/phases/06-ai-features-bea/06-04-SUMMARY.md

# Foundation from Plan 04
@src/lib/bea/client.ts
@src/lib/bea/session.ts
@src/lib/bea/auto-assign.ts
@src/lib/xjustiz/parser.ts

# Existing beA stub
@src/app/(dashboard)/bea/page.tsx
@prisma/schema.prisma

# Helena scan integration
@src/lib/ai/scan-processor.ts

# Versand gate for send restrictions
@src/lib/versand-gate.ts

# Kontakt model with beaSafeId
@src/app/api/kontakte/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: beA API Routes + Inbox/Outbox Page + Message Detail</name>
  <files>
    src/app/api/bea/messages/route.ts
    src/app/api/bea/messages/[id]/route.ts
    src/app/api/bea/messages/[id]/eeb/route.ts
    src/app/api/bea/auto-assign/route.ts
    src/app/(dashboard)/bea/page.tsx
    src/app/(dashboard)/bea/[id]/page.tsx
    src/components/bea/bea-inbox.tsx
    src/components/bea/bea-message-detail.tsx
    src/components/bea/eeb-button.tsx
    src/components/bea/pruefprotokoll-viewer.tsx
    src/components/bea/xjustiz-viewer.tsx
  </files>
  <action>
1. Create `GET/POST /api/bea/messages/route.ts`:
   - GET: List BeaNachricht from database. Filter by status (EINGANG/GESENDET), akteId, search term. Paginated. Includes akte relation.
   - POST: Store a new beA message fetched from bea.expert into database. Body: full message data from client.
     - Run auto-assign: call autoAssignToAkte() from src/lib/bea/auto-assign.ts. If SICHER, set akteId. If WAHRSCHEINLICH, set akteId but add flag for confirmation.
     - If XJustiz attachment detected (MIME type or filename pattern), parse via parseXJustiz() from src/lib/xjustiz/parser.ts and store in xjustizData field.
     - Trigger Helena ai-scan: add to ai-scan queue with type='bea'.
   - Auth check on all operations.

2. Create `GET/PATCH /api/bea/messages/[id]/route.ts`:
   - GET: Return single BeaNachricht with full content. Auth check.
   - PATCH: Update akteId (manual assignment), status (GELESEN, ZUGEORDNET), eebStatus.

3. Create `POST /api/bea/messages/[id]/eeb/route.ts`:
   - Auth check: session.user.role must be ANWALT (per CONTEXT: "nur Anwalt").
   - Calls bea.expert eEBanswer via browser (this route validates and records -- actual eEB call happens client-side).
   - Updates BeaNachricht: eebStatus='BESTAETIGT', eebDatum=now().
   - Returns success with timestamp.

4. Create `POST /api/bea/auto-assign/route.ts`:
   - Manually trigger auto-assignment for a message.
   - Body: {nachrichtId}.
   - Calls autoAssignToAkte(), updates BeaNachricht.akteId.
   - Returns assignment result with confidence.

5. Replace `src/app/(dashboard)/bea/page.tsx` (currently a stub):
   - Wrap with BeaSessionProvider from src/lib/bea/session.ts.
   - If not authenticated: Show beA login dialog with software token file input + PIN field + "Anmelden" button.
   - If authenticated: Show BeaInbox component with tabs (Posteingang | Postausgang).
   - "Neue Nachricht" button (only visible to ANWALT role).
   - Session status indicator: "Verbunden als {safeId}" or "Sitzung abgelaufen".

6. Create `src/components/bea/bea-inbox.tsx` ("use client"):
   - Two data sources: Fresh messages from bea.expert API (via beaGetMessages from client.ts), and stored messages from GET /api/bea/messages.
   - Sync flow: On page load, fetch from bea.expert, diff against stored, POST new ones to /api/bea/messages.
   - Message list table: Status icon, Betreff, Absender/Empfaenger, Akte badge (if assigned, otherwise "Nicht zugeordnet" warning), Datum.
   - Click to navigate to /bea/[id].
   - Status indicators: EINGANG (blue), GELESEN (gray), ZUGEORDNET (green), GESENDET (purple), FEHLER (red).
   - "Zuordnen" quick-action button for unassigned messages (opens Akte selector dialog).

7. Create `src/app/(dashboard)/bea/[id]/page.tsx` + `src/components/bea/bea-message-detail.tsx`:
   - Server component fetching BeaNachricht from database.
   - Detail view: Header (Absender, Empfaenger with SAFE-IDs, Datum, Betreff), Body content, Attachments list.
   - Akte assignment section: Current Akte or "Nicht zugeordnet" with assign button.
   - eEB section: If incoming Zustellung, show EebButton component.
   - Pruefprotokoll button: "Pruefprotokoll anzeigen" -> fetches and shows PruefprotokollViewer.
   - XJustiz viewer: If xjustizData exists on the message, render XJustizViewer inline.
   - Helena suggestions: If Helena has suggestions for this message (FRIST_ERKANNT etc.), show them as inline cards.

8. Create `src/components/bea/eeb-button.tsx` ("use client"):
   - "Empfangsbekenntnis bestaetigen" button. Only shown for incoming Zustellungen where eebStatus != 'BESTAETIGT'.
   - On click: Calls beaSendEeb() via bea.expert client (browser-side), then POST /api/bea/messages/[id]/eeb to record.
   - Loading state during processing. Success: Green check + date. Error: Toast with error message.
   - RBAC: Only rendered if user.role === 'ANWALT'.

9. Create `src/components/bea/pruefprotokoll-viewer.tsx`:
   - Receives pruefprotokoll Json data.
   - Renders as structured table: Pruefschritt, Ergebnis (success/fail icon), Details, Zeitstempel.
   - Collapsible by default -- "Pruefprotokoll anzeigen" button expands.

10. Create `src/components/bea/xjustiz-viewer.tsx`:
    - Receives parsed XJustizData object from src/lib/xjustiz/parser.ts.
    - Renders sections: Grunddaten (key-value table), Beteiligte (list with roles and addresses), Instanzen (timeline), Termine (list with dates).
    - Collapsible sections. German labels.
    - Handle missing data gracefully -- only show sections that have data.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Navigate to /bea -- login dialog appears. After login, inbox shows messages. Message detail shows eEB button, Pruefprotokoll, and XJustiz viewer.</manual>
  </verify>
  <done>beA API routes operational. Inbox/outbox page with login dialog and message list. Message detail with eEB button, Pruefprotokoll viewer, XJustiz inline viewer. Auto-assignment and Helena scan triggered on message storage.</done>
</task>

<task type="auto">
  <name>Task 2: beA Compose Form + End-to-End Wiring</name>
  <files>
    src/app/(dashboard)/bea/compose/page.tsx
    src/components/bea/bea-compose.tsx
  </files>
  <action>
1. Create `src/app/(dashboard)/bea/compose/page.tsx` + `src/components/bea/bea-compose.tsx`:
   - RBAC: Only ANWALT can access. Redirect others with error.
   - Form fields: Empfaenger (SAFE-ID input with autocomplete from Kontakte where beaSafeId is set), Betreff, Inhalt (textarea), Akte selector (optional, for reference).
   - Document attachments: Picker from DMS. Only FREIGEGEBEN documents allowed (enforce via versand-gate pattern).
   - "Senden" button: Calls beaSendMessage() via browser client, then stores sent message in DB via POST /api/bea/messages.
   - No Freigabe-Workflow for beA (per CONTEXT: "Direkt senden, nur Anwalt").
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -50</automated>
    <manual>Navigate to /bea/compose -- SAFE-ID autocomplete from Kontakte works, document attachment picker shows only FREIGEGEBEN documents, non-ANWALT users are redirected.</manual>
  </verify>
  <done>beA compose form with SAFE-ID autocomplete, document attachment picker (FREIGEGEBEN only), ANWALT RBAC enforcement, direct send via bea.expert client.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify beA Integration End-to-End</name>
  <files>src/app/(dashboard)/bea/page.tsx</files>
  <action>
Human verification checkpoint for the complete beA integration: authentication, inbox, message detail, compose, eEB, Pruefprotokoll, XJustiz viewer, auto-assignment, Helena scan. This checkpoint verifies the browser-side authentication flow works with the bea.expert library.

Steps to verify:
1. Navigate to /bea -- login dialog should appear with software token upload and PIN input
2. If bea.expert test account available: Upload software token, enter PIN, verify "Verbunden als {safeId}" appears
3. If no test account: Verify the login UI renders correctly, error handling works for invalid credentials
4. Navigate to /bea message detail -- verify eEB button, Pruefprotokoll button, XJustiz viewer render
5. Navigate to /bea/compose -- verify SAFE-ID autocomplete from Kontakte, document attachment picker
6. Verify non-ANWALT users cannot access compose or send eEB (RBAC check)

Resume signal: Type "approved" or describe issues to fix.
  </action>
  <verify>Manual visual inspection of /bea page, message detail, compose form, and RBAC enforcement</verify>
  <done>beA integration verified end-to-end: login dialog, inbox rendering, message detail with eEB/Pruefprotokoll/XJustiz, compose with SAFE-ID, RBAC enforcement confirmed.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /bea page renders login dialog, then inbox after authentication
3. Messages are auto-assigned to Akten with confidence levels
4. eEB button sends acknowledgment and records timestamp
5. Pruefprotokoll renders as structured table
6. XJustiz XML rendered as readable sections via xjustiz-viewer
7. Compose form enforces ANWALT RBAC and FREIGEGEBEN document requirement
8. Helena scans stored beA messages (trigger visible in ai-scan queue)
</verification>

<success_criteria>
- beA authentication works in browser via software token
- Inbox displays received messages with status indicators
- Messages auto-assigned to correct Akten (via Aktenzeichen, SAFE-ID, court reference)
- eEB acknowledgment is one-click for ANWALT users
- Pruefprotokoll is viewable on demand per message
- XJustiz attachments render as structured, readable views
- beA messages trigger Helena AI scanning
- Compose form uses SAFE-ID from Kontakte and only allows FREIGEGEBEN documents
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-features-bea/06-05-SUMMARY.md`
</output>
