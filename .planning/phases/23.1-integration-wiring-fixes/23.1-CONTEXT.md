# Phase 23.1: Integration Wiring Fixes - Context

**Gathered:** 2026-02-27
**Status:** Ready for planning

<domain>
## Phase Boundary

Close two specific cross-phase integration gaps found by the v0.2 milestone audit:
1. Wire `notifyDraftCreated` in `update-akte-rag.ts` — the 6th and final write-tool site (DRFT-06)
2. Enable multi-turn Schriftsatz Rueckfragen — route user answers back to resume the pipeline (ORCH-04)

No new features. No UI redesign. Just connect existing modules that are orphaned.

</domain>

<decisions>
## Implementation Decisions

### DRFT-06: Notification Wiring
- Copy the existing `notifyDraftCreated` pattern from the other 5 write-tool sites
- Import `notifyDraftCreated` from `draft-notification.ts` in `update-akte-rag.ts`
- Call fire-and-forget after `helenaDraft.create`, same as `create-draft-dokument.ts` etc.

### ORCH-04: Multi-Turn Rueckfragen Flow

#### Answer Experience
- Rueckfrage looks like a normal Helena chat bubble — no special card or styling
- Include context of what Helena already knows: "Fuer die Kuendigungsschutzklage (Klaeger: Max Muster) brauche ich noch: Wann wurde die Kuendigung zugestellt?"
- Collapsible "Bisherige Angaben" section below the Rueckfrage showing all filled slots
- User can naturally correct earlier slots mid-flow: "Der Klaeger heisst eigentlich Mueller" → LLM detects correction and updates
- One Rueckfrage at a time (slot-filler already works this way)

#### State Persistence
- Per-user state — each user has their own independent pending pipeline per Akte, no cross-user interference
- One pending pipeline per user per Akte (multiple across different Akten allowed)
- Database-persisted — survives page reload and logout
- 7-day TTL with notification on expire: "Dein Entwurf fuer X ist abgelaufen. Starte bei Bedarf neu."
- When user opens Akte with pending Rueckfrage: proactive reminder re-displays the pending question (only for initiator, not other users)
- Proactive reminder includes a "Verwerfen" button to dismiss without typing

#### Resume Mechanism
- Auto-detect intent: LLM classifies if user message is an answer to the pending Rueckfrage or an unrelated request
- If unrelated → clear pending state, handle as normal Helena message
- If answer → parse free-text into slot values, re-invoke pipeline with `userSlotValues`
- Re-run `prefillSlotsFromAkte` on each resume so Akte data changes are reflected
- Show progress indicator on resume: "Verarbeite Angaben...", "Pruefe Vollstaendigkeit..." (use existing `onStepUpdate` pattern)
- If user starts a NEW Schriftsatz request while one is pending: warn "Du hast noch einen offenen Entwurf fuer X. Verwerfen und neu starten?" — explicit choice

#### Round Cap & Completion
- Maximum 5 Rueckfrage rounds before fallback
- Show round counter: "(3/5)" so user knows how many rounds remain
- At cap: create draft with PLATZHALTERs and list them: "Ich erstelle den Entwurf mit Platzhaltern fuer: Kuendigungsdatum, Zustelldatum. Diese kannst du spaeter ergaenzen."
- When all slots are filled: create draft immediately — no confirmation summary

#### Cancellation
- User can type "abbrechen" or click "Verwerfen" button on reminder
- Silent clear — no acknowledgment message, just remove pending state

### Claude's Discretion
- Exact DB schema for pending pipeline state (extend HelenaMemory or new table)
- LLM prompt design for parsing free-text answers into slot values
- LLM prompt for intent classification (answer vs unrelated message)
- Error handling if pipeline resume fails
- How "Bisherige Angaben" collapsible section is implemented (accordion, details tag, etc.)

</decisions>

<specifics>
## Specific Ideas

- Rueckfrage context format: "Fuer die [Klageart] ([known slot]: [value]) brauche ich noch: [question]"
- Round counter format: "(3/5)" — subtle, not intrusive
- PLATZHALTER listing format: "Ich erstelle den Entwurf mit Platzhaltern fuer: [slot1], [slot2]. Diese kannst du spaeter ergaenzen."
- Expiry notification: "Dein Entwurf fuer [Klageart] ist abgelaufen. Starte bei Bedarf neu."
- Override warning: "Du hast noch einen offenen Entwurf fuer [Klageart]. Verwerfen und neu starten?"

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 23.1-integration-wiring-fixes*
*Context gathered: 2026-02-27*
