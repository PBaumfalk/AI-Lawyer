---
phase: 05-financial-module
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/lib/finance/invoice/e-rechnung.ts
  - src/app/api/finanzen/rechnungen/[id]/e-rechnung/route.ts
  - src/app/api/finanzen/rechnungen/[id]/pdf/route.ts
autonomous: true
requirements:
  - REQ-FI-007

must_haves:
  truths:
    - "Invoice PDF is automatically generated as ZUGFeRD PDF/A-3 with embedded CII XML per user decision"
    - "User can download XRechnung CII as separate XML file"
    - "E-Rechnung output conforms to EN16931 standard with all required fields"
  artifacts:
    - path: "src/lib/finance/invoice/e-rechnung.ts"
      provides: "ZUGFeRD PDF/A-3 generation and XRechnung CII XML generation"
      exports: ["generateZugferdPdf", "generateXRechnungXml", "mapInvoiceToEN16931"]
    - path: "src/app/api/finanzen/rechnungen/[id]/e-rechnung/route.ts"
      provides: "E-Rechnung export endpoint (XRechnung XML download)"
      exports: ["GET"]
  key_links:
    - from: "src/lib/finance/invoice/e-rechnung.ts"
      to: "@e-invoice-eu/core"
      via: "Library for EN16931 CII/UBL generation and PDF/A-3 transformation"
      pattern: "EInvoice|e-invoice"
    - from: "src/app/api/finanzen/rechnungen/[id]/pdf/route.ts"
      to: "src/lib/finance/invoice/e-rechnung.ts"
      via: "Every invoice PDF is auto-converted to ZUGFeRD PDF/A-3"
      pattern: "generateZugferdPdf"
---

<objective>
Integrate E-Rechnung generation using @e-invoice-eu/core: every invoice PDF is automatically a ZUGFeRD PDF/A-3 with embedded CII XML, and XRechnung CII is available as a separate XML download.

Purpose: E-Rechnung is legally mandatory for B2B since 2025-01-01 (receiving) and will be mandatory for sending by 2027/2028. Building ZUGFeRD/XRechnung now ensures compliance. Per user decision, every invoice PDF is automatically ZUGFeRD.

Output: E-Rechnung library that transforms invoice PDFs to ZUGFeRD PDF/A-3 and generates standalone XRechnung CII XML, integrated into the existing invoice PDF endpoint.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-financial-module/05-RESEARCH.md
@.planning/phases/05-financial-module/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: E-Rechnung Library + Integration</name>
  <files>
    src/lib/finance/invoice/e-rechnung.ts
    src/app/api/finanzen/rechnungen/[id]/e-rechnung/route.ts
    src/app/api/finanzen/rechnungen/[id]/pdf/route.ts
  </files>
  <action>
    **0. Install dependency:**
    ```bash
    npm install @e-invoice-eu/core
    ```
    If @e-invoice-eu/core proves too difficult to use programmatically (the research noted its API may be spreadsheet-oriented), fall back to:
    - For XRechnung CII XML: hand-build CII XML using the EN16931 field mappings from the research. The CII namespace is `urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100`. Core elements: ExchangedDocumentContext, ExchangedDocument (ID, IssueDateTime, TypeCode=380), SupplyChainTradeTransaction (ApplicableHeaderTradeAgreement, ApplicableHeaderTradeDelivery, ApplicableHeaderTradeSettlement with line items).
    - For ZUGFeRD PDF/A-3: embed the CII XML as an attachment in the PDF using pdf-lib (FileAttachment with AFRelationship = /Alternative). Note: true PDF/A-3 requires ICC color profiles and XMP metadata which pdf-lib can handle via custom metadata streams.

    **1. E-Rechnung Library** (src/lib/finance/invoice/e-rechnung.ts):

    `mapInvoiceToEN16931(invoice, kanzlei, mandant, empfaenger)`: Map internal invoice data to EN16931 structure:
    - BT-1: Invoice number (rechnungsnummer)
    - BT-2: Issue date (rechnungsdatum)
    - BT-3: Type code (380 = Commercial invoice)
    - BT-5: Currency (EUR)
    - BT-6: VAT accounting currency (EUR)
    - BT-9: Payment due date (faelligAm)
    - BT-20: Payment terms text ("Zahlbar innerhalb von {zahlungszielTage} Tagen")
    - BG-4: Seller (Kanzlei: name, address, Steuernr BT-32, UStIdNr BT-31)
    - BG-7: Buyer (Empfaenger: name, address)
    - BG-16: Payment instructions (IBAN BT-84, BIC BT-86, payment means code 58=SEPA)
    - BG-22: Document totals (BT-106 net, BT-110 VAT, BT-112 gross, BT-115 payable)
    - BG-23: VAT breakdown per rate (BT-116 category, BT-117 base, BT-118 amount, BT-119 rate)
    - BG-25-BG-30: Invoice lines (each position with BT-126 line ID, BT-153 description, BT-129 quantity, BT-146 price, BT-131 net amount, BT-151 VAT category + rate)

    `generateXRechnungXml(invoice, kanzlei, mandant, empfaenger): Promise<string>`:
    Either use @e-invoice-eu/core or hand-build CII XML. Return valid XRechnung CII XML string. Include proper XML declaration, namespaces, and all mandatory BT fields.

    `generateZugferdPdf(pdfBuffer: Buffer, invoice, kanzlei, mandant, empfaenger): Promise<Buffer>`:
    1. Generate CII XML via generateXRechnungXml()
    2. Load PDF via pdf-lib
    3. Embed CII XML as file attachment (name: "factur-x.xml", relationship: "Alternative", MIME: "text/xml")
    4. Set PDF metadata: XMP with Factur-X conformance level (EN16931)
    5. Return modified PDF buffer

    NOTE: If true PDF/A-3 conformance proves too complex with pdf-lib alone (ICC profiles, output intents), document this limitation and create the best-effort ZUGFeRD by embedding the XML attachment. The XRechnung CII XML is the legally important part -- the PDF/A-3 wrapper is a delivery format.

    **2. Update Invoice PDF endpoint** (src/app/api/finanzen/rechnungen/[id]/pdf/route.ts):
    Modify the existing PDF generation endpoint from Plan 02:
    - After generating the base invoice PDF via generateInvoicePdf()
    - Pass the PDF buffer through generateZugferdPdf() to embed CII XML
    - Return the ZUGFeRD PDF (per user decision: "Every invoice PDF is automatically ZUGFeRD PDF/A-3")
    - Add query parameter `?format=plain` to skip ZUGFeRD embedding if needed

    **3. XRechnung XML endpoint** (src/app/api/finanzen/rechnungen/[id]/e-rechnung/route.ts):
    - GET: Load invoice with full relations. Call generateXRechnungXml(). Return with `Content-Type: application/xml` and `Content-Disposition: attachment; filename="XRechnung-{rechnungsnummer}.xml"`.
    - Auth check, invoice must be status GESTELLT or BEZAHLT (not ENTWURF).
    - Validate that Kanzlei has Steuernummer or UStIdNr set (required for E-Rechnung).
  </action>
  <verify>
    <automated>npx tsc --noEmit</automated>
    <manual>Check that the e-rechnung.ts file produces valid XML with correct EN16931 namespace and all BT fields. Verify pdf/route.ts calls generateZugferdPdf. Verify e-rechnung/route.ts returns XML with correct Content-Type.</manual>
  </verify>
  <done>
    E-Rechnung library generates valid XRechnung CII XML and embeds it into invoice PDFs as ZUGFeRD. Every invoice PDF is automatically ZUGFeRD. XRechnung downloadable as separate XML. EN16931 fields mapped from internal data. Kanzlei Steuernr/UStIdNr validated.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- XRechnung XML contains proper CII namespace and all mandatory BT fields
- Invoice PDF endpoint returns PDF with embedded factur-x.xml attachment
- XRechnung endpoint returns XML with Content-Type: application/xml
- Only GESTELLT/BEZAHLT invoices can generate E-Rechnung (not ENTWURF)
</verification>

<success_criteria>
- E-Rechnung CII XML generated with all mandatory EN16931 fields (invoice number, dates, seller, buyer, payment, lines, VAT)
- Every invoice PDF automatically includes embedded ZUGFeRD CII XML per user decision
- XRechnung available as separate XML download
- Kanzlei must have Steuernummer/UStIdNr for E-Rechnung generation
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-module/05-04-SUMMARY.md`
</output>
