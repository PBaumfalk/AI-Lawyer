---
phase: 15-normen-verknuepfung-in-akte
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/ki-chat/route.ts
autonomous: true
requirements:
  - GESETZ-04

must_haves:
  truths:
    - "When an Akte has pinned normen, the ki-chat system prompt includes a PINNED NORMEN block with the full § text of each pinned norm"
    - "Pinned norms block appears between the AKTEN-KONTEXT block and the QUELLEN block — highest legal priority for the Akte"
    - "Each pinned norm entry shows: gesetzKuerzel, paragraphNr, titel, content, optional anmerkung, 'nicht amtlich' disclaimer, sourceUrl"
    - "When no Akte is selected (akteId is null), the pinned norm lookup is skipped entirely"
    - "When a pinned norm's law_chunk is not found (null), that norm is silently skipped — no 'undefined' text in system prompt"
    - "Chain A total execution time stays under 500ms for up to 20 pinned norms (parallel Promise.all)"
  artifacts:
    - path: "src/app/api/ki-chat/route.ts"
      provides: "Extended Chain A with pinned norms injection"
      contains: "PINNED NORMEN"
  key_links:
    - from: "src/app/api/ki-chat/route.ts"
      to: "prisma.akteNorm.findMany"
      via: "Chain A closure — parallel with existing Akte fetch"
      pattern: "akteNorm\\.findMany"
    - from: "src/app/api/ki-chat/route.ts"
      to: "prisma.lawChunk.findFirst"
      via: "Promise.all per pinned norm"
      pattern: "lawChunk\\.findFirst"
---

<objective>
Extend ki-chat Chain A to fetch pinned normen for the current Akte and inject them into the system prompt with highest priority — before the QUELLEN block (document chunks) and GESETZE-QUELLEN block (auto-retrieved normen from Chain D).

Purpose: Pinned norms represent the lawyer's explicit legal strategy for this Akte. Helena must prioritize them over auto-retrieved normen from Chain D.
Output: Modified ki-chat/route.ts where Chain A returns `{ aktenKontextBlock: string, pinnedNormenBlock: string }` and the system prompt builder injects pinnedNormenBlock after aktenKontextBlock.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md

<interfaces>
<!-- Key context from src/app/api/ki-chat/route.ts — current structure -->

Current Chain A (lines ~234-365) returns a `string` (aktenKontextBlock).
Current system prompt assembly (lines ~451-481):
```typescript
let systemPrompt = SYSTEM_PROMPT_BASE + aktenKontextBlock;

if (confidenceFlag === "none") systemPrompt += NO_SOURCES_INSTRUCTION;
else if (confidenceFlag === "low") systemPrompt += LOW_CONFIDENCE_INSTRUCTION;

// [QUELLEN block — document chunks]
if (sources.length > 0) {
  systemPrompt += "\n\n--- QUELLEN ---\n";
  // ...
  systemPrompt += "\n--- ENDE QUELLEN ---";
}

// [GESETZE-QUELLEN block — Chain D auto-retrieved]
if (lawChunks.length > 0) {
  systemPrompt += "\n\n--- GESETZE-QUELLEN (nicht amtlich) ---\n";
  // ...
  systemPrompt += "\n--- ENDE GESETZE-QUELLEN ---";
}
```

Current chain await (line ~440):
```typescript
const [aktenKontextBlock, ragResult, [model, modelName, providerName], lawChunks] =
  await Promise.all([akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise]);
```

AkteNorm Prisma model fields: id, akteId, gesetzKuerzel, paragraphNr, anmerkung?, addedById, createdAt
LawChunk Prisma fields: gesetzKuerzel, paragraphNr, titel, content, sourceUrl, syncedAt, embedding (Unsupported)

CRITICAL: Do NOT join AkteNorm with LawChunk in Prisma include — Unsupported("vector(1024)") blocks JOINs.
Use separate findMany + Promise.all(findFirst) calls.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Chain A to fetch pinned normen and build injection block</name>
  <files>src/app/api/ki-chat/route.ts</files>
  <action>
Modify `src/app/api/ki-chat/route.ts` to inject pinned normen into the system prompt.

**Step 1: Change Chain A return type from `Promise<string>` to `Promise<{ aktenKontextBlock: string; pinnedNormenBlock: string }>`**

Inside the `akteContextPromise` IIFE (currently returns `string`), after building the Akte context string and before `return`, add the pinned norm fetch:

```typescript
// After the existing return string is built (after "--- ENDE AKTEN-KONTEXT ---"):
let pinnedNormenBlock = "";

const pinnedNormen = await prisma.akteNorm.findMany({
  where: { akteId },
  orderBy: { createdAt: "asc" },
});

if (pinnedNormen.length > 0) {
  const chunks = await Promise.all(
    pinnedNormen.map((norm) =>
      prisma.lawChunk.findFirst({
        where: {
          gesetzKuerzel: norm.gesetzKuerzel,
          paragraphNr: norm.paragraphNr,
        },
        select: { titel: true, content: true, sourceUrl: true, syncedAt: true },
      })
    )
  );

  pinnedNormenBlock = `\n\n--- PINNED NORMEN (Akte ${akte.aktenzeichen} — höchste Priorität) ---\n`;
  pinnedNormen.forEach((norm, i) => {
    const chunk = chunks[i];
    if (!chunk) return; // Skip if law_chunk no longer exists — guard against null
    const standDate = new Date(chunk.syncedAt).toLocaleDateString("de-DE", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
    });
    pinnedNormenBlock += `\n[P${i + 1}] ${norm.gesetzKuerzel} ${norm.paragraphNr}: ${chunk.titel}\n`;
    pinnedNormenBlock += `${chunk.content}\n`;
    if (norm.anmerkung) {
      pinnedNormenBlock += `Anmerkung des Anwalts: ${norm.anmerkung}\n`;
    }
    pinnedNormenBlock += `HINWEIS: nicht amtlich — Stand: ${standDate} | Quelle: ${chunk.sourceUrl ?? "https://www.gesetze-im-internet.de/"}\n`;
  });
  pinnedNormenBlock += "\n--- ENDE PINNED NORMEN ---";
  pinnedNormenBlock += "\n\nDiese Normen wurden vom Anwalt explizit für diese Akte verknüpft. Beziehe dich bevorzugt auf diese §§.";
}

return { aktenKontextBlock: akteContextStr, pinnedNormenBlock };
```

Where `akteContextStr` is the existing string that was previously returned. Rename the local variable holding the return string from the implicit return to `akteContextStr`.

When `!akteId`, the early return `return ""` must become `return { aktenKontextBlock: "", pinnedNormenBlock: "" }`.
Also handle the catch block: `return { aktenKontextBlock: "", pinnedNormenBlock: "" }`.

**Step 2: Update the destructuring of Promise.all**

Change line `const [aktenKontextBlock, ragResult, ...]` to:
```typescript
const [{ aktenKontextBlock, pinnedNormenBlock }, ragResult, [model, modelName, providerName], lawChunks] =
  await Promise.all([akteContextPromise, ragPromise, modelConfigPromise, lawChunksPromise]);
```

**Step 3: Inject pinnedNormenBlock into system prompt**

In the system prompt assembly section, insert `pinnedNormenBlock` after the confidenceFlag block and BEFORE the QUELLEN block:

```typescript
let systemPrompt = SYSTEM_PROMPT_BASE + aktenKontextBlock;

if (confidenceFlag === "none") systemPrompt += NO_SOURCES_INSTRUCTION;
else if (confidenceFlag === "low") systemPrompt += LOW_CONFIDENCE_INSTRUCTION;

// [NEW] Pinned norms — highest legal priority context for this Akte
if (pinnedNormenBlock) {
  systemPrompt += pinnedNormenBlock;
}

// [EXISTING] QUELLEN block
if (sources.length > 0) { /* ... unchanged ... */ }

// [EXISTING] GESETZE-QUELLEN block
if (lawChunks.length > 0) { /* ... unchanged ... */ }
```

**What NOT to do:**
- Do NOT touch Chain B, C, or D
- Do NOT create a new Chain E — this is a Chain A extension
- Do NOT use a Prisma include join between AkteNorm and LawChunk — Unsupported("vector") blocks JOINs
- Do NOT run the pinned norm fetch when akteId is null (the early return guards this correctly)
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "ki-chat" | head -20</verify>
  <done>
- TypeScript compiles without errors on ki-chat/route.ts
- When chatting with an Akte selected that has pinned normen, the system prompt (visible via console.log or debug) contains "--- PINNED NORMEN ---"
- When chatting with no Akte, no PINNED NORMEN block appears
- Chain A logs show reasonable timing (under 500ms)
  </done>
</task>

</tasks>

<verification>
```bash
# TypeScript check
npx tsc --noEmit 2>&1 | grep -E "ki-chat" | head -20

# Grep for required PINNED NORMEN string in modified file
grep -n "PINNED NORMEN" src/app/api/ki-chat/route.ts

# Grep for akteNorm.findMany in ki-chat route
grep -n "akteNorm" src/app/api/ki-chat/route.ts
```
</verification>

<success_criteria>
- `npx tsc --noEmit` passes with 0 errors on ki-chat/route.ts
- `grep "PINNED NORMEN" src/app/api/ki-chat/route.ts` returns at least 2 matches
- `grep "akteNorm.findMany" src/app/api/ki-chat/route.ts` returns 1 match
- `grep "Promise.all" src/app/api/ki-chat/route.ts` shows pinnedNormenBlock extraction is present
- Chain A return type is `{ aktenKontextBlock: string; pinnedNormenBlock: string }` — not plain string
</success_criteria>

<output>
After completion, create `.planning/phases/15-normen-verknuepfung-in-akte/15-02-SUMMARY.md`
</output>
