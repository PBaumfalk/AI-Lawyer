---
phase: 03-email-client
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/components/email/compose-popup.tsx
  - src/components/email/compose-editor.tsx
  - src/components/email/compose-toolbar.tsx
  - src/components/email/compose-attachments.tsx
  - src/components/email/compose-recipients.tsx
  - src/components/email/compose-manager.tsx
  - src/lib/email/signature.ts
  - src/app/(dashboard)/einstellungen/email/page.tsx
  - src/components/email/mailbox-config/mailbox-form.tsx
  - src/components/email/mailbox-config/mailbox-list.tsx
  - src/components/email/mailbox-config/connection-test.tsx
  - src/components/email/mailbox-config/provider-profiles.tsx
  - src/components/email/mailbox-config/signature-editor.tsx
  - src/components/email/mailbox-config/sync-dashboard.tsx
  - src/components/email/mailbox-config/user-assignment.tsx
  - src/app/api/email-konten/[id]/sync/route.ts
  - src/app/api/email-send/cancel/route.ts
autonomous: true
requirements:
  - REQ-EM-006
  - REQ-EM-002

must_haves:
  truths:
    - "User can compose a new email with rich-text editing (bold, italic, links, lists, tables, images)"
    - "Compose opens as a floating popup that can be minimized/maximized, keeping inbox visible"
    - "Multiple compose drafts can be open simultaneously as minimized tabs"
    - "User can add recipients with auto-complete from previous contacts and Mandanten/Kontakte"
    - "User can attach files via drag-and-drop or from DMS (Aus Akte picker)"
    - "Outgoing email includes the sender's personalized signature from the kanzlei template"
    - "Send has a 10-second undo toast before actual SMTP delivery"
    - "Scheduled sending queues emails for future delivery with BullMQ delayed jobs"
    - "Admin can add/edit/delete mailboxes with IMAP/SMTP configuration"
    - "Admin can test connection with live feedback"
    - "Admin can define kanzlei-wide signature template with TipTap"
    - "Sync dashboard shows per-mailbox status and errors"
  artifacts:
    - path: "src/components/email/compose-popup.tsx"
      provides: "Floating Gmail-style compose window"
      min_lines: 100
    - path: "src/components/email/compose-editor.tsx"
      provides: "TipTap rich-text editor for email body"
      min_lines: 60
    - path: "src/components/email/mailbox-config/mailbox-form.tsx"
      provides: "Add/edit mailbox configuration form"
      min_lines: 100
    - path: "src/components/email/mailbox-config/signature-editor.tsx"
      provides: "TipTap-based HTML signature template editor"
      min_lines: 60
    - path: "src/lib/email/signature.ts"
      provides: "Signature template rendering with placeholder substitution"
      exports: ["renderSignature"]
  key_links:
    - from: "src/components/email/compose-popup.tsx"
      to: "/api/email-send"
      via: "POST to queue outgoing email"
      pattern: "fetch.*api/email-send"
    - from: "src/components/email/compose-popup.tsx"
      to: "src/components/email/compose-editor.tsx"
      via: "Embeds TipTap editor for email body"
      pattern: "<ComposeEditor"
    - from: "src/components/email/mailbox-config/mailbox-form.tsx"
      to: "/api/email-konten"
      via: "POST/PATCH to create or update mailbox"
      pattern: "fetch.*api/email-konten"
    - from: "src/lib/email/signature.ts"
      to: "prisma.emailKonto"
      via: "Load signature template from EmailKonto.signaturVorlage"
      pattern: "signaturVorlage"
---

<objective>
Build the email compose system (floating popup with TipTap rich-text editor, recipient auto-complete, DMS file picker, signature injection, send with 10-second undo, scheduled sending) and the complete mailbox administration UI (add/edit/delete mailboxes, connection testing, provider auto-discovery, signature template editor, user assignment, sync dashboard).

Purpose: This plan enables sending emails and managing mailbox accounts — the write side of the email client. Compose is the second-most used feature after inbox reading. Mailbox admin is required for first-time setup.
Output: Gmail-style floating compose popup with rich-text editing and attachments. Einstellungen > E-Mail admin tab with full mailbox management.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-client/03-CONTEXT.md
@.planning/phases/03-email-client/03-RESEARCH.md
@.planning/phases/03-email-client/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gmail-style floating compose popup with TipTap editor, recipient auto-complete, attachments, signature, send queue, and scheduled sending</name>
  <files>
    src/components/email/compose-popup.tsx
    src/components/email/compose-editor.tsx
    src/components/email/compose-toolbar.tsx
    src/components/email/compose-attachments.tsx
    src/components/email/compose-recipients.tsx
    src/components/email/compose-manager.tsx
    src/lib/email/signature.ts
    src/app/api/email-send/cancel/route.ts
  </files>
  <action>
Create `src/lib/email/signature.ts`:
- `renderSignature(template: string, userData: { name, titel, mobil, durchwahl, email })` — replace {{name}}, {{titel}}, {{mobil}}, {{durchwahl}}, {{email}} placeholders in HTML template with user's profile data. Return rendered HTML string. If template is null/empty, return empty string.
- `getSignatureForUser(userId: string, kontoId: string)` — load kanzlei signature template from EmailKonto.signaturVorlage, load user profile data, render and return.

Create `src/components/email/compose-manager.tsx`:
- "use client" component that manages multiple compose windows. Renders as a fixed bar at bottom-right of screen.
- State: array of compose instances, each with { id, minimized, emailData }.
- `openCompose(initial?)` — add new compose instance (max 5 concurrent).
- `minimizeCompose(id)` — minimize to tab bar at bottom (show only Betreff).
- `maximizeCompose(id)` — expand back to full popup.
- `closeCompose(id)` — remove from array (with unsaved changes warning if dirty).
- Minimized drafts show as small tabs at bottom-right: Betreff text only, click to restore.
- Render ComposePopup for each non-minimized instance.
- Export `useComposeManager()` hook for triggering compose from action bar (Reply/Forward).

Create `src/components/email/compose-popup.tsx`:
- "use client" floating popup component (position: fixed, bottom-right). Per user decision: like Gmail, keeps inbox visible.
- Draggable header bar with: minimize button, maximize/fullscreen toggle, close button.
- Header fields: Von (dropdown of user's assigned mailboxes, default last-used or Kanzlei mailbox), An, CC (hidden by default, toggle to show), BCC (hidden by default), Betreff, Akte (optional typeahead via /api/akten search).
- Rich-text body via ComposeEditor.
- Attachment area via ComposeAttachments.
- Footer: Senden button (primary), "Spaeter senden" dropdown (morgen 08:00, naechster Montag 09:00, custom datetime picker) per user decision, priority dropdown (Normal/Hoch/Niedrig), "Lesebestaetigung" checkbox, discard (Verwerfen) button.
- On Senden: POST /api/email-send with all fields. Show "E-Mail wird in 10s gesendet — Rueckgaengig" sonner toast. On undo click: DELETE /api/email-send/cancel with jobId.
- Scheduled send: POST /api/email-send with geplanterVersand datetime. Show confirmation "Geplant fuer {datetime}".
- Validation: warn if no Betreff (dialog "Ohne Betreff senden?"), warn if no An field, warn if Reply-All with 5+ recipients.
- Auto-save draft every 30 seconds: create/update EmailNachricht with sendeStatus="ENTWURF" and save to IMAP Drafts folder via API.
- Reply/ReplyAll/Forward modes: accept initialData prop with quoted original (wrapped in blockquote), pre-filled recipients, "Re:" or "Fwd:" subject prefix. AW:/WG: for German per user CONTEXT decision on German prefixes — use Re:/Fwd: (standard headers).
- Append signature to email body on open. Load via getSignatureForUser(). Insert above quoted text in reply.

Create `src/components/email/compose-editor.tsx`:
- "use client" TipTap editor wrapper. Extensions: StarterKit, Link (openOnClick false), Image, Table + TableRow + TableCell + TableHeader, Placeholder ("Ihre Nachricht..."), Color, TextStyle.
- `onChange(html)` callback for parent.
- `getHTML()` method for send.
- Handle screenshot paste from clipboard: convert to base64 inline image (per Claude's discretion — simpler than MinIO upload for inline images).

Create `src/components/email/compose-toolbar.tsx`:
- Toolbar above editor with buttons: Bold (B), Italic (I), Underline (U), Strikethrough, Link, Ordered List, Unordered List, Table insert, Image insert, Text Color picker, Heading (H1/H2/H3 dropdown), Code, Blockquote, Horizontal Rule.
- Use lucide-react icons. Toggle state reflects current selection.

Create `src/components/email/compose-recipients.tsx`:
- "use client" component for To/CC/BCC fields with auto-complete.
- Auto-complete sources: 1) Previous sent/received email addresses (query /api/emails with distinct absender/empfaenger), 2) Mandanten/Kontakte from Akten (query /api/kontakte).
- Tag-style input: each recipient shown as a removable chip/badge with email address.
- Debounced search (300ms) triggers auto-complete dropdown.

Create `src/components/email/compose-attachments.tsx`:
- "use client" component for managing email attachments.
- Two methods per user decision: 1) File upload via drag-and-drop zone + file button (validates <25MB), 2) "Aus Akte" button opens DMS file picker modal — fetches folder tree for selected Akte, allows multi-select with file size shown.
- Attached files shown as chips with filename, size, remove button.
- Track total attachment size.

Create `src/app/api/email-send/cancel/route.ts`:
- POST: Cancel a queued send. Accept jobId. Remove job from emailSendQueue. Update EmailNachricht.sendeStatus back to "ENTWURF". Return 200 on success, 409 if already sent.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Open compose popup, verify TipTap editor renders with toolbar, verify recipient auto-complete works, verify send shows 10s undo toast</manual>
  </verify>
  <done>Gmail-style floating compose popup opens with TipTap rich-text editor, recipient auto-complete, attachment upload + DMS picker, signature injection, 10-second send-with-undo via BullMQ queue, scheduled sending, and auto-save drafts. Multiple compose windows can be open as minimized tabs. Reply/ReplyAll/Forward modes pre-fill correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create mailbox admin settings page with configuration form, connection test, provider profiles, signature editor, user assignment, and sync dashboard</name>
  <files>
    src/app/(dashboard)/einstellungen/email/page.tsx
    src/components/email/mailbox-config/mailbox-form.tsx
    src/components/email/mailbox-config/mailbox-list.tsx
    src/components/email/mailbox-config/connection-test.tsx
    src/components/email/mailbox-config/provider-profiles.tsx
    src/components/email/mailbox-config/signature-editor.tsx
    src/components/email/mailbox-config/sync-dashboard.tsx
    src/components/email/mailbox-config/user-assignment.tsx
    src/app/api/email-konten/[id]/sync/route.ts
  </files>
  <action>
Create `src/app/(dashboard)/einstellungen/email/page.tsx`:
- Admin-only page (check session.user.role === "ADMIN", redirect to /einstellungen if not).
- Tab layout with 4 sections per user decision:
  1. "Postfaecher" — mailbox list and management
  2. "Signatur" — kanzlei-wide signature template editor
  3. "Sync-Status" — per-mailbox sync dashboard
  4. "Zuweisung" — user-to-mailbox assignment
- Follow existing Kanzlei-Einstellungen tab pattern from Phase 2 (glass card sections).

Create `src/components/email/mailbox-config/mailbox-list.tsx`:
- "use client" component. Lists all EmailKonto with: name, emailAdresse, status indicator (green/red/gray for VERBUNDEN/FEHLER/GETRENNT), aktiv toggle, istKanzlei badge.
- "Neues Postfach hinzufuegen" button opens MailboxForm dialog.
- Each row: click to edit (opens MailboxForm), delete button with AlertDialog confirmation.
- Active/inactive toggle calls PATCH /api/email-konten/[id] with { aktiv }.

Create `src/components/email/mailbox-config/mailbox-form.tsx`:
- "use client" dialog/sheet component for add/edit mailbox.
- Provider selection at top via ProviderProfiles component — selecting a provider pre-fills host/port/encryption.
- Form sections:
  - Allgemein: Name, E-Mail-Adresse, Benutzername, Ist Kanzlei-Postfach (checkbox)
  - IMAP: Host, Port, Verschluesselung (SSL/TLS/STARTTLS/Keine)
  - SMTP: Host, Port, Verschluesselung
  - Authentifizierung: Passwort field (masked, only shown for password auth). OAuth2 button for M365/Google (placeholder for now — show "OAuth2 wird in einer zukuenftigen Version unterstuetzt" info text).
  - Sync: Initial-Sync dropdown (Nur neue / Letzte 30 Tage / Alles), Soft-Delete Aufbewahrung dropdown (30/60/90/Unbegrenzt Tage), Import-Ordner name input (default "Importierte Emails").
- Validation with Zod. Submit calls POST (create) or PATCH (edit) /api/email-konten.
- "Verbindung testen" button triggers ConnectionTest component.

Create `src/components/email/mailbox-config/provider-profiles.tsx`:
- Provider auto-discovery profiles. Grid of provider cards:
  - Microsoft 365: imap.outlook.com:993/SSL, smtp.outlook.com:587/STARTTLS
  - Gmail: imap.gmail.com:993/SSL, smtp.gmail.com:587/STARTTLS
  - IONOS: imap.ionos.de:993/SSL, smtp.ionos.de:587/STARTTLS
  - Strato: imap.strato.de:993/SSL, smtp.strato.de:465/SSL
  - Manuell: empty fields for custom configuration
- Clicking a provider card fills the form fields with pre-configured values.

Create `src/components/email/mailbox-config/connection-test.tsx`:
- "use client" component. Triggers POST /api/email-konten/[id]/test (or uses unsaved form data for new accounts).
- Live feedback steps: "Verbinde mit IMAP-Server...", "Authentifiziere...", "Postfaecher abrufen...", "SMTP-Server pruefen...", "Erfolgreich!" or error detail.
- Uses streaming/polling to show progress. Each step shown with spinner -> checkmark/X.
- Error messages in German with troubleshooting hints.

Create `src/components/email/mailbox-config/signature-editor.tsx`:
- "use client" TipTap editor for the kanzlei-wide HTML signature template.
- Shows available placeholders: {{name}}, {{titel}}, {{mobil}}, {{durchwahl}}, {{email}} as clickable chips that insert into editor.
- Preview panel shows rendered signature with sample data.
- Save updates EmailKonto.signaturVorlage for the selected kanzlei mailbox (or all mailboxes if signaturVorlage is kanzlei-wide).
- Below editor: info text explaining that users fill their own field values in their profile.

Create `src/components/email/mailbox-config/sync-dashboard.tsx`:
- "use client" component. Per-mailbox sync status display.
- For each active mailbox: status indicator (VERBUNDEN/FEHLER/GETRENNT), last sync timestamp, total stored email count (from DB), last 5 errors from fehlerLog with timestamp and message.
- "Jetzt synchronisieren" button triggers manual sync via POST /api/email-konten/[id]/sync.
- Auto-refresh every 30 seconds.

Create `src/components/email/mailbox-config/user-assignment.tsx`:
- "use client" component. Table of users with checkboxes per mailbox.
- Rows: all users. Columns: all mailboxes. Cell: checkbox for assignment.
- Changes call POST/DELETE /api/email-konten/[id]/zuweisungen.

Create `src/app/api/email-konten/[id]/sync/route.ts`:
- POST (ADMIN only): Trigger immediate sync for a mailbox. Adds job to emailSyncQueue. Returns 202 Accepted.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Navigate to /einstellungen/email, verify mailbox list renders, add mailbox form opens with provider selection, connection test shows step-by-step feedback, signature editor allows HTML editing</manual>
  </verify>
  <done>Admin E-Mail settings page has 4 tabs: Postfaecher (list/add/edit/delete with provider profiles), Signatur (TipTap HTML template with placeholders), Sync-Status (per-mailbox dashboard with errors), Zuweisung (user-mailbox matrix). Connection test shows live step-by-step feedback. Provider auto-discovery pre-fills M365/Gmail/IONOS/Strato configs.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles without errors
2. Compose popup opens as floating window with TipTap editor
3. Recipients auto-complete from contacts and previous emails
4. Send triggers 10-second undo toast, then queues to BullMQ
5. Scheduled send creates delayed BullMQ job
6. Mailbox admin page at /einstellungen/email has all 4 tabs
7. Provider profiles pre-fill configuration
8. Connection test shows live feedback
9. Signature editor allows HTML template with placeholder insertion
</verification>

<success_criteria>
- Gmail-style compose popup fully functional with minimize/maximize/multiple drafts
- TipTap editor works with all extensions (bold, italic, links, tables, images, color)
- Send queue with 10-second undo works
- Mailbox admin CRUD works with connection testing
- Signature template renders correctly with user data
- TypeScript compilation passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-client/03-03-SUMMARY.md`
</output>
