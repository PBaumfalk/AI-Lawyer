---
phase: 02-deadline-calculation-document-templates
plan: 05
type: execute
wave: 3
depends_on:
  - 02-04
files_modified:
  - src/app/(dashboard)/vorlagen/page.tsx
  - src/components/vorlagen/vorlagen-uebersicht.tsx
  - src/components/vorlagen/vorlagen-wizard.tsx
  - src/components/vorlagen/platzhalter-sidebar.tsx
  - src/components/briefkopf/briefkopf-editor.tsx
  - src/components/briefkopf/pdf-export-dialog.tsx
  - src/app/(dashboard)/einstellungen/page.tsx
  - src/components/einstellungen/vorlagen-tab.tsx
  - src/components/einstellungen/briefkopf-tab.tsx
  - src/components/einstellungen/ordner-schemata-tab.tsx
  - src/components/einstellungen/fristen-tab.tsx
  - src/components/einstellungen/benachrichtigungen-tab.tsx
autonomous: true
requirements:
  - REQ-DV-001
  - REQ-DV-002
  - REQ-DV-003
  - REQ-DV-009

must_haves:
  truths:
    - "User can browse templates in card-based overview with categories, search, favorites, and Zuletzt verwendet section"
    - "User can generate a document via 4-step wizard: Select template -> Select Akte/Mandant -> Fill custom fields -> Preview + Confirm"
    - "User can export any DOCX document as PDF with Briefkopf via OnlyOffice Conversion API"
    - "Kanzlei-Einstellungen has Fristen, Vorlagen, Briefkopf, Ordner-Schemata, and Benachrichtigungen tabs"
    - "All settings changes are logged in Audit-Trail (per locked decision)"
    - "Each settings tab has a 'Auf Standard zuruecksetzen' button with confirmation dialog (per locked decision)"
  artifacts:
    - path: "src/components/vorlagen/vorlagen-uebersicht.tsx"
      provides: "Card-based template browser with search, categories, favorites"
      min_lines: 100
    - path: "src/components/vorlagen/vorlagen-wizard.tsx"
      provides: "4-step document generation wizard"
      min_lines: 120
    - path: "src/components/briefkopf/pdf-export-dialog.tsx"
      provides: "PDF export dialog with Briefkopf selection, PDF/A option, watermark option"
      exports: ["PdfExportDialog"]
    - path: "src/components/briefkopf/briefkopf-editor.tsx"
      provides: "Briefkopf editor with structured form and OnlyOffice mode"
      min_lines: 80
    - path: "src/components/einstellungen/fristen-tab.tsx"
      provides: "Fristen settings with presets management, defaults, escalation config"
      exports: ["FristenTab"]
    - path: "src/components/einstellungen/benachrichtigungen-tab.tsx"
      provides: "Stub Benachrichtigungen settings tab (admin-only notification config)"
      exports: ["BenachrichtigungenTab"]
  key_links:
    - from: "src/components/vorlagen/vorlagen-wizard.tsx"
      to: "src/app/api/vorlagen/[id]/generieren/route.ts"
      via: "fetch POST to generate document from template"
      pattern: "api/vorlagen/.*/generieren"
    - from: "src/components/briefkopf/pdf-export-dialog.tsx"
      to: "src/app/api/onlyoffice/convert/route.ts"
      via: "fetch POST /api/onlyoffice/convert for PDF generation"
      pattern: "api/onlyoffice/convert"
    - from: "src/components/einstellungen/*-tab.tsx"
      to: "logAuditEvent"
      via: "Audit-Trail logging on all settings saves"
      pattern: "logAuditEvent"
---

<objective>
Build all UI components for the Vorlagen-System (card browser, 4-step wizard, placeholder sidebar), Briefkopf editor, PDF export dialog, and Kanzlei-Einstellungen tabs (Fristen, Vorlagen, Briefkopf, Ordner-Schemata, Benachrichtigungen). Includes audit-trail logging on all settings changes and reset-to-default functionality per tab.

Purpose: Attorneys need to browse, search, and generate documents from templates via an intuitive card-based UI with a guided wizard. The Kanzlei-Einstellungen centralizes all configuration with VS Code-style auto-save, audit logging, and reset capabilities.

Output: Vorlagen page with card browser + wizard, Briefkopf editor component, PDF export dialog, settings page with all required tabs.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-deadline-calculation-document-templates/02-RESEARCH.md
@.planning/phases/02-deadline-calculation-document-templates/02-04-SUMMARY.md

@src/lib/vorlagen.ts
@src/lib/onlyoffice.ts
@src/app/api/vorlagen/route.ts
@src/app/(dashboard)/einstellungen/page.tsx
@src/components/dokumente/onlyoffice-editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vorlagen UI (Card Browser + Wizard + Placeholder Sidebar) + Briefkopf Editor + PDF Export</name>
  <files>
    src/app/(dashboard)/vorlagen/page.tsx,
    src/components/vorlagen/vorlagen-uebersicht.tsx,
    src/components/vorlagen/vorlagen-wizard.tsx,
    src/components/vorlagen/platzhalter-sidebar.tsx,
    src/components/briefkopf/briefkopf-editor.tsx,
    src/components/briefkopf/pdf-export-dialog.tsx
  </files>
  <action>
    **1. Vorlagen Overview Page (src/app/(dashboard)/vorlagen/page.tsx):**
    Page route at /vorlagen. Contains VorlagenUebersicht component.

    **2. Vorlagen Card Browser (src/components/vorlagen/vorlagen-uebersicht.tsx):**
    Card-based layout (per user decision: "Karten-Uebersicht, not file-tree").
    - Search field at top: full-text search across name, beschreibung, tags.
    - Category filter pills (based on VorlageKategorie enum + custom tags).
    - "Favoriten" section at top showing user's favorited templates.
    - "Zuletzt verwendet" section (tracked in localStorage).
    - Grid of template cards: each shows name, kategorie badge, beschreibung preview, tags, favorite toggle (heart icon), Freigabe status badge.
    - Click card -> opens wizard OR navigates to template detail.
    - "Neue Vorlage" button for creating templates.
    - Responsive grid: 3 cols on lg, 2 on md, 1 on sm.

    **3. Vorlagen Wizard (src/components/vorlagen/vorlagen-wizard.tsx):**
    4-step wizard dialog (per user decision):
    Step 1: Template is pre-selected (from card click) or select from dropdown.
    Step 2: Select Akte + Mandant. Akte search/autocomplete. Pre-filled if opened from Akte view.
    Step 3: Custom fields (rendered from template's customFelder definition). Each field type: Text (input), Number (number input), Date (date picker), Dropdown (select from optionen).
    Step 4: Preview + Confirm. Show auto-generated filename (editable). Show target folder (suggest from template category, user can change). Checkbox "In OnlyOffice oeffnen" (default on, per user decision). Show which Briefkopf will be applied.
    Submit calls POST /api/vorlagen/{id}/generieren.
    On success: navigate to document in OnlyOffice editor (if checkbox on) or show success toast.

    **4. Placeholder Sidebar (src/components/vorlagen/platzhalter-sidebar.tsx):**
    For use inside OnlyOffice editor (or template editing context):
    - Lists all available placeholder groups (from PLATZHALTER_GRUPPEN in vorlagen.ts).
    - Organized by group: Akte, Mandant, Gegner, etc.
    - Each placeholder: click to copy `{{mandant.name}}` to clipboard (with toast "Platzhalter kopiert").
    - Search/filter field.
    - Show example values next to each placeholder.

    **5. Briefkopf Editor (src/components/briefkopf/briefkopf-editor.tsx):**
    Two modes per user decision:
    Mode 1: Structured form -- Logo upload (drag-and-drop), Kanzleiname, Adresse, Telefon, Fax, Email, Website, Steuernr, USt-IdNr, IBAN, BIC, Bankname, BRAO-Info. Live preview showing layout: Logo + firm name at top, contact/BRAO info in right sidebar (modern layout per user decision).
    Mode 2: Full DOCX editing in OnlyOffice -- opens Briefkopf DOCX in OnlyOffice editor for complete control.
    Toggle between modes. Save updates Briefkopf record + MinIO file.
    "Als Standard setzen" button.

    **6. PDF Export Dialog (src/components/briefkopf/pdf-export-dialog.tsx):**
    Dialog with options per user decision:
    - Choose Briefkopf (dropdown, default pre-selected). Only shown if multiple exist.
    - PDF/A format checkbox (optional).
    - Watermark text input (optional, e.g., "ENTWURF").
    - "Exportieren" button calls POST /api/onlyoffice/convert with options.
    - Download resulting PDF.
    Reusable: can be opened from document detail, OnlyOffice editor, or Akte documents tab.

    Use Tailwind CSS, shadcn/ui components, German UI labels, English code comments throughout. Follow existing layout and component patterns.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Navigate to /vorlagen page, verify card layout. Click a template, walk through 4-step wizard. Test PDF export dialog. Test Briefkopf editor both modes.</manual>
  </verify>
  <done>Vorlagen page shows card-based overview with search, categories, favorites, Zuletzt verwendet. 4-step wizard generates documents with filled placeholders and Briefkopf. PDF export dialog with Briefkopf selection and watermark. Briefkopf editor has structured form and OnlyOffice mode. Placeholder sidebar lists all available placeholders by group.</done>
</task>

<task type="auto">
  <name>Task 2: Kanzlei-Einstellungen Tabs (Fristen + Vorlagen + Briefkopf + Ordner-Schemata + Benachrichtigungen) with Audit-Trail + Reset</name>
  <files>
    src/app/(dashboard)/einstellungen/page.tsx,
    src/components/einstellungen/vorlagen-tab.tsx,
    src/components/einstellungen/briefkopf-tab.tsx,
    src/components/einstellungen/ordner-schemata-tab.tsx,
    src/components/einstellungen/fristen-tab.tsx,
    src/components/einstellungen/benachrichtigungen-tab.tsx
  </files>
  <action>
    **Kanzlei-Einstellungen Page Enhancement (src/app/(dashboard)/einstellungen/page.tsx):**
    Add new tabs to the settings page (per user decision: tab-based, VS Code style, auto-save):
    - Existing tabs stay.
    - Add "Fristen" tab containing FristenTab component.
    - Add "Vorlagen" tab containing VorlagenTab component.
    - Add "Briefkoepfe" tab containing BriefkopfTab component.
    - Add "Ordner-Schemata" tab containing OrdnerSchemataTab component.
    - Add "Benachrichtigungen" tab containing BenachrichtigungenTab component.

    **CRITICAL: All settings changes logged in Audit-Trail (per locked decision).**
    Every settings tab MUST call `logAuditEvent()` (existing from Phase 1) on every save operation, with: entity type "SystemSetting", action "UPDATE", details including setting key, old value, new value. Import logAuditEvent from the existing audit utility.

    **CRITICAL: Reset per tab with confirmation dialog (per locked decision).**
    Every settings tab MUST include an "Auf Standard zuruecksetzen" button at the bottom. When clicked, show a confirmation dialog: "Moechten Sie die Einstellungen in diesem Bereich auf die Standardwerte zuruecksetzen? Diese Aktion kann nicht rueckgaengig gemacht werden." On confirm, reset all settings in that tab to their default values and call logAuditEvent for the reset action.

    **1. Fristen Settings Tab (src/components/einstellungen/fristen-tab.tsx):**
    - Default Vorfristen (7/3/1 days) -- editable.
    - Default Bundesland dropdown.
    - Fristen-Presets management (table with CRUD inline editing).
    - Eskalation settings: hours until Vertreter notified, hours until Admin notified.
    - Kanzlei-Arbeitszeiten (Mo-Fr start/end times).
    - All auto-save on change (per user decision).
    - logAuditEvent on every save.
    - "Auf Standard zuruecksetzen" button with confirmation.

    **2. Vorlagen Settings Tab (src/components/einstellungen/vorlagen-tab.tsx):**
    - List all templates with Freigabe status.
    - Freigeben/Zurueckziehen buttons.
    - Upload new template.
    - Category management.
    - logAuditEvent on every action.
    - "Auf Standard zuruecksetzen" button with confirmation.

    **3. Briefkopf Settings Tab (src/components/einstellungen/briefkopf-tab.tsx):**
    - List all Briefkoepfe. Default marked.
    - Edit/Delete/Set Default buttons.
    - "Neuer Briefkopf" button opens BriefkopfEditor.
    - logAuditEvent on every action.
    - "Auf Standard zuruecksetzen" button with confirmation.

    **4. Ordner-Schemata Tab (src/components/einstellungen/ordner-schemata-tab.tsx):**
    - List schemas with Sachgebiet badges.
    - Inline edit folder list (add/remove/reorder folders).
    - "Neues Schema" button.
    - Default schema marked.
    - logAuditEvent on every action.
    - "Auf Standard zuruecksetzen" button with confirmation.

    **5. Benachrichtigungen Tab (src/components/einstellungen/benachrichtigungen-tab.tsx):**
    Stub tab per locked decision ("Benachrichtigungseinstellungen: Admin-managed only"). Contains:
    - Header: "Benachrichtigungseinstellungen (Admin)"
    - Description: "Hier koennen Benachrichtigungseinstellungen fuer Fristen und Wiedervorlagen konfiguriert werden."
    - Placeholder content showing: Frist-Vorfristen Benachrichtigungen (enabled/disabled toggle, stub), Eskalation (link to Fristen tab where config actually lives), E-Mail-Benachrichtigungen (disabled with note "Verfuegbar nach Einrichtung des E-Mail-Systems (Phase 3)").
    - Info box: "Benutzer koennen ihre eigenen Benachrichtigungseinstellungen nicht aendern, um sicherzustellen, dass keine kritischen Fristbenachrichtigungen deaktiviert werden."
    - logAuditEvent on any toggle.
    - "Auf Standard zuruecksetzen" button with confirmation.

    Use Tailwind CSS, shadcn/ui components, German UI labels, English code comments throughout. Follow existing layout and component patterns.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npx next build 2>&1 | tail -10</automated>
    <manual>Open Einstellungen page, verify all new tabs appear. Change a Fristen setting, verify audit log entry created. Click "Auf Standard zuruecksetzen" and verify confirmation dialog appears. Check Benachrichtigungen tab shows stub content.</manual>
  </verify>
  <done>Settings page has Fristen, Vorlagen, Briefkopf, Ordner-Schemata, and Benachrichtigungen tabs. All settings auto-save. All saves logged in Audit-Trail. Each tab has "Auf Standard zuruecksetzen" with confirmation. Benachrichtigungen tab is functional stub with admin-only notice.</done>
</task>

</tasks>

<verification>
```bash
# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npx next build
```
</verification>

<success_criteria>
- Card-based Vorlagen overview at /vorlagen with search, categories, and favorites
- 4-step wizard generates DOCX with filled placeholders from case data
- PDF export via OnlyOffice Conversion API with Briefkopf selection and watermark option
- Briefkopf editor has structured form and OnlyOffice mode
- Kanzlei-Einstellungen has Fristen, Vorlagen, Briefkopf, Ordner-Schemata, and Benachrichtigungen tabs
- All settings changes logged in Audit-Trail (who, when, what, old value, new value)
- Each settings tab has "Auf Standard zuruecksetzen" button with confirmation dialog
- Auto-save on all settings (VS Code style)
</success_criteria>

<output>
After completion, create `.planning/phases/02-deadline-calculation-document-templates/02-05-SUMMARY.md`
</output>
