---
phase: 02.1-wire-frist-reminder-pipeline
verified: 2026-02-24T13:30:00Z
status: passed
score: 5/5 must-haves verified
re_verification: false
---

# Phase 2.1: Wire Frist-Reminder Pipeline Verification Report

**Phase Goal:** The frist-reminder worker processor is live at runtime — pre-deadline reminders (7/3/1 day) are scheduled via cron, processed by the BullMQ worker, and delivered as notifications. The dual queue registry is consolidated so the frist-reminder queue is visible in admin monitoring. SystemSettings defaults are initialized at startup for fresh installs.
**Verified:** 2026-02-24T13:30:00Z
**Status:** passed
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `processFristReminders()` is imported and registered as a BullMQ Worker in `src/worker.ts` for the `frist-reminder` queue | VERIFIED | Lines 6, 85-97: Worker("frist-reminder", async () => processFristReminders(), ...) with concurrency:1 |
| 2 | `registerFristReminderJob()` is called at worker startup, scheduling the repeatable cron job | VERIFIED | Lines 199-215 in worker.ts: async startup() reads fristen.scan_zeit from SystemSettings, constructs cronPattern, calls registerFristReminderJob(cronPattern) |
| 3 | The frist-reminder queue appears in `ALL_QUEUES` and is visible in the admin Bull Board monitor | VERIFIED | queues.ts line 37: `ALL_QUEUES = [testQueue, fristReminderQueue]`; admin route imports ALL_QUEUES and iterates over it in GET handler |
| 4 | `initializeDefaults()` is called at app/worker startup so fresh installs have default settings | VERIFIED | worker.ts line 201: `await initializeDefaults()` is the first call in async startup(); settings.ts initializeDefaults() inserts only missing keys |
| 5 | E2E flow: a Frist with Vorfrist 7 days out triggers a reminder notification when the cron runs | VERIFIED | processFristReminders() queries all FRIST KalenderEintraege, iterates vorfristen[], calls shouldFireToday(), then sendVorfristNotification() which creates in-app notification + attempts email via trySendEmail() |

**Score:** 5/5 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/lib/queue/queues.ts` | Consolidated queue registry with ALL_QUEUES including frist-reminder | VERIFIED | Exports fristReminderQueue (line 31), ALL_QUEUES=[testQueue, fristReminderQueue] (line 37), registerFristReminderJob() (line 45) |
| `src/lib/email/send.ts` | Nodemailer SMTP transport wrapper | VERIFIED | Full implementation: lazy transporter, isEmailConfigured(), sendEmail() returns boolean, never throws |
| `src/worker.ts` | Worker entry point with frist-reminder processor registered | VERIFIED | fristReminderWorker registered at lines 85-97, pushed to workers[] at line 129, startup() wires initializeDefaults + registerFristReminderJob |
| `src/workers/processors/frist-reminder.ts` | Enhanced processor with deduplication, dual-channel delivery, weekend shift, catch-up | VERIFIED | 649 lines: isReminderAlreadySent(), shouldFireToday(), trySendEmail(), sendVorfristNotification(), sendOverdueEscalation(), processFristReminders() all implemented and substantive |
| `src/lib/settings/defaults.ts` | Default settings including fristen_scan_zeit | VERIFIED | fristen.scan_zeit (line 70), fristen.email_enabled (line 77), fristen.max_retry_age_days (line 83) all present; CATEGORY_LABELS includes "fristen": "Fristen" (line 108) |
| `src/lib/queues.ts` | Thin re-export (no duplicate Queue instances) | VERIFIED | 6 lines — re-exports fristReminderQueue and registerFristReminderJob from canonical queues.ts |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `src/worker.ts` | `src/workers/processors/frist-reminder.ts` | BullMQ Worker registration importing processFristReminders | WIRED | Line 6: `import { processFristReminders } from "@/workers/processors/frist-reminder"` — used at line 88 inside Worker callback |
| `src/worker.ts` | `src/lib/queue/queues.ts` | Calls registerFristReminderJob() at startup | WIRED | Line 4: imported; called at line 209 in startup() and line 180 in settings:changed handler |
| `src/worker.ts` | `src/lib/settings/service.ts` | Calls initializeDefaults() at startup | WIRED | Line 7: imported; called at line 201 in startup() |
| `src/workers/processors/frist-reminder.ts` | `src/lib/email/send.ts` | Sends reminder emails after in-app notification | WIRED | Line 21: imported; called in trySendEmail() (line 253) which is invoked after every createNotification() call |
| `src/lib/queue/queues.ts` | Admin Bull Board monitor | ALL_QUEUES array includes fristReminderQueue | WIRED | ALL_QUEUES imported by `src/app/api/admin/jobs/[[...path]]/route.ts` line 3; iterated in GET handler to return queue counts for all queues including frist-reminder |

---

### Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| REQ-FK-003 | 02.1-01-PLAN.md | Vorfristen-Erinnerungen (konfigurierbar, Standard: 7/3/1 Tag vorher) + Vorfrist | SATISFIED | processFristReminders() iterates vorfristen[], vorfrist, halbfrist fields; shouldFireToday() handles date matching; sendVorfristNotification() delivers in-app + email; deduplication prevents duplicates; catch-up handles downtime; fristen.scan_zeit makes timing configurable |

No orphaned requirements — REQ-FK-003 is the only requirement declared in the plan and it is satisfied.

---

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| None found | — | — | — | — |

No TODO/FIXME/placeholder comments found in phase-modified files. No empty implementations, stub returns, or console.log-only handlers detected.

**TypeScript Compilation:** One pre-existing error in `.next/types/app/api/ordner-schemata/route.ts` — this is a generated Next.js file, pre-existing before this phase (confirmed in SUMMARY.md: "Pre-existing TSC error confirmed via git stash test"). The error is in `getDefaultOrdnerForSachgebiet` exported from an API route — unrelated to any phase 2.1 changes. All phase 2.1 source files compile cleanly.

---

### Human Verification Required

None. All success criteria are verifiable programmatically via static analysis. The E2E flow (item 5) requires a running Redis + Postgres environment to confirm actual notification delivery, but all code paths are wired and substantive. This is flagged as a future runtime smoke test, not a blocker.

#### Optional Runtime Smoke Test (not blocking)

**Test:** Start the worker process with Redis + Postgres running; create a KalenderEintrag of typ=FRIST with a vorfrist date of today; wait for the cron to fire or manually enqueue a job on the frist-reminder queue.
**Expected:** The worker logs "Frist reminder processing complete" with vorfristenSent > 0; a Notification record appears in the DB; if SMTP is configured, an email is sent.
**Why human:** Requires running infrastructure — cannot verify notification creation in DB via static analysis alone.

---

## Commit Evidence

All three task commits are present in the repository:
- `e3bc5e8` — feat(02.1-01): consolidate queue registry, add email transport, add fristen settings
- `ef236da` — feat(02.1-01): enhance frist-reminder processor with dedup, dual-channel, weekend shift, catch-up
- `fda01a2` — feat(02.1-01): register frist-reminder worker, wire startup init, settings reschedule

---

## Summary

Phase 2.1 fully achieves its goal. All five success criteria are verified against the actual codebase:

1. The `fristReminderWorker` is registered in `src/worker.ts` with `concurrency: 1`, bound to the "frist-reminder" queue, and correctly invokes `processFristReminders()` on each job.
2. The `startup()` function reads `fristen.scan_zeit` from SystemSettings (defaulting to "06:00"), converts it to a cron pattern, and calls `registerFristReminderJob()` — which uses `upsertJobScheduler` with `tz: "Europe/Berlin"` for idempotent scheduling.
3. `fristReminderQueue` is included in `ALL_QUEUES` in the canonical `src/lib/queue/queues.ts`; the admin jobs API route imports `ALL_QUEUES` and returns counts for all queues including frist-reminder to the monitoring dashboard.
4. `initializeDefaults()` is the first call in `startup()`, seeding missing SystemSettings (including `fristen.scan_zeit`, `fristen.email_enabled`, `fristen.max_retry_age_days`) on fresh installs without overwriting existing values.
5. The E2E data flow is fully wired: `processFristReminders()` queries FRIST KalenderEintraege, evaluates `shouldFireToday()` with weekend/holiday shift, checks deduplication via `isReminderAlreadySent()`, sends in-app notification via `createNotification()`, and attempts email delivery via `trySendEmail()` which calls the nodemailer wrapper in `src/lib/email/send.ts`.

The dual queue registry is consolidated (src/lib/queues.ts is a thin re-export). The old file contains no duplicate Queue instances. REQ-FK-003 is fully satisfied.

---

_Verified: 2026-02-24T13:30:00Z_
_Verifier: Claude (gsd-verifier)_
