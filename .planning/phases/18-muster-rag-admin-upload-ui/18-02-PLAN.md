---
phase: 18-muster-rag-admin-upload-ui
plan: "02"
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/app/(dashboard)/admin/layout.tsx
  - src/app/(dashboard)/admin/muster/page.tsx
  - src/app/api/admin/muster/route.ts
  - src/app/api/admin/muster/[id]/route.ts
  - src/lib/queue/queues.ts
  - src/lib/queue/processors/ner-pii.processor.ts
  - src/lib/queue/processors/muster-ingestion.processor.ts
  - src/worker.ts
autonomous: true
requirements: [ARBW-02, ARBW-03]

must_haves:
  truths:
    - "Admin can upload a DOCX or PDF to /admin/muster — file appears in table with PENDING_NER status immediately"
    - "After NER passes (INDEXED), muster_chunks are automatically inserted — no manual trigger needed"
    - "REJECTED_PII_DETECTED muster never enters muster_chunks — PII gate invariant holds without bypass"
    - "Admin can delete a Muster — MinIO object and muster_chunks are removed"
    - "muster-ingestion queue appears in Bull Board for monitoring"
  artifacts:
    - path: "src/app/(dashboard)/admin/muster/page.tsx"
      provides: "Admin upload form + file table with NER status badges"
      min_lines: 80
    - path: "src/app/api/admin/muster/route.ts"
      provides: "GET (list) + POST (upload + nerPiiQueue.add)"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/muster/[id]/route.ts"
      provides: "DELETE + PATCH (retry NER)"
      exports: ["DELETE", "PATCH"]
    - path: "src/lib/queue/processors/muster-ingestion.processor.ts"
      provides: "processMusterIngestionJob() — calls insertMusterChunks(musterId) after INDEXED (no content param — fetches from MinIO, real uploaded files only)"
      exports: ["processMusterIngestionJob", "MusterIngestionJobData"]
  key_links:
    - from: "src/app/api/admin/muster/route.ts POST"
      to: "nerPiiQueue.add({ musterId })"
      via: "after MinIO upload + prisma.muster.create"
      pattern: "nerPiiQueue.add"
    - from: "src/lib/queue/processors/ner-pii.processor.ts:processMusterNer"
      to: "musterIngestionQueue.add({ musterId })"
      via: "after INDEXED transition (line ~122)"
      pattern: "musterIngestionQueue.add"
    - from: "src/lib/queue/processors/muster-ingestion.processor.ts"
      to: "insertMusterChunks(musterId)"
      via: "after confirming nerStatus === INDEXED guard — no content param (real file, fetches from MinIO)"
      pattern: "insertMusterChunks"
---

<objective>
Build the admin upload UI at /admin/muster, the REST API (GET/POST/DELETE/PATCH), the muster-ingestion BullMQ queue + processor, and wire the automatic post-NER ingestion trigger in ner-pii.processor.ts.

Purpose: This plan creates the full pipeline from upload → NER gate (Phase 16) → chunk ingestion. ARBW-02 and ARBW-03's upload/status machine are fully realized here.

Output: /admin/muster page, /api/admin/muster routes, muster-ingestion queue, processor, worker registration, ner-pii.processor.ts trigger added.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-RESEARCH.md
@.planning/phases/18-muster-rag-admin-upload-ui/18-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/queue/queues.ts (existing exports — add musterIngestionQueue here):
```typescript
export const nerPiiQueue = new Queue("ner-pii", { ... attempts: 1 ... });
export const ALL_QUEUES: Queue[] = [
  testQueue, fristReminderQueue, emailSendQueue, emailSyncQueue,
  ocrQueue, embeddingQueue, previewQueue, aiScanQueue, aiBriefingQueue,
  aiProactiveQueue, gesetzeSyncQueue, nerPiiQueue, urteileSyncQueue,
  // ADD musterIngestionQueue here
];
```

From src/lib/queue/processors/ner-pii.processor.ts (where to add trigger):
- `processMusterNer(musterId)` — state machine at line ~84
- INDEXED transition is at line ~122: `await prisma.muster.update({ where: { id: musterId }, data: { nerStatus: "INDEXED" } })`
- After this line, add: `await musterIngestionQueue.add("ingest-muster", { musterId });`
- Import musterIngestionQueue from queues.ts (no circular dep — queues.ts has no processor imports)

From src/worker.ts (pattern to follow for new Worker registration):
```typescript
// Pattern from nerPiiWorker (line ~571):
const nerPiiWorker = new Worker<NerPiiJobData>(
  "ner-pii",
  async (job) => processNerPiiJob(job.data),
  { connection: getQueueConnection(), concurrency: 1 }
);
nerPiiWorker.on("completed", (job) => { ... });
nerPiiWorker.on("failed", (job, err) => { ... });
```

From src/app/(dashboard)/admin/layout.tsx (adminNavigation — add Muster):
```typescript
const adminNavigation = [
  { name: "Job-Monitor", href: "/admin/jobs" },
  { name: "System", href: "/admin/system" },
  { name: "Pipeline", href: "/admin/pipeline" },
  // ADD: { name: "Muster", href: "/admin/muster" },
  { name: "Dezernate", href: "/admin/dezernate" },
  ...
];
```

From src/app/api/admin/pipeline/route.ts (ADMIN role enforcement pattern):
```typescript
const session = await auth();
if (!session?.user) return NextResponse.json({ error: "Nicht authentifiziert" }, { status: 401 });
if ((session.user as any).role !== "ADMIN") return NextResponse.json({ error: "Keine Berechtigung" }, { status: 403 });
```

From src/lib/storage.ts:
```typescript
export async function uploadFile(key: string, body: Buffer, contentType: string, size: number): Promise<void>
export async function deleteFile(key: string): Promise<void>
export const BUCKET: string
```

From src/components/ui/badge.tsx (NER status badge mapping for admin UI):
```typescript
// Variant options: "default" | "secondary" | "destructive" | "outline"
// PENDING_NER    -> secondary ("Ausstehend")
// NER_RUNNING    -> default  ("PII-Prüfung läuft…")
// INDEXED        -> default  ("Indiziert") — add emerald color via className
// REJECTED_PII_DETECTED -> destructive ("Abgelehnt — PII")
```

From src/lib/muster/ingestion.ts (created in Plan 01):
```typescript
// content param is OPTIONAL — omit for real uploaded files (fetches from MinIO).
// Seed path passes content directly to bypass MinIO.
export async function insertMusterChunks(musterId: string, content?: string): Promise<{ inserted: number }>
```

NOTE: In processMusterIngestionJob, call `insertMusterChunks(data.musterId)` with NO content param — the file is a real MinIO upload and extractMusterFullText must run.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: musterIngestionQueue + muster-ingestion.processor.ts + ner-pii trigger + worker registration</name>
  <files>
    src/lib/queue/queues.ts
    src/lib/queue/processors/muster-ingestion.processor.ts
    src/lib/queue/processors/ner-pii.processor.ts
    src/worker.ts
  </files>
  <action>
**queues.ts — add musterIngestionQueue:**
Add after urteileSyncQueue export:
```typescript
export const musterIngestionQueue = new Queue("muster-ingestion", {
  connection: getQueueConnection(),
  defaultJobOptions: {
    attempts: 2,
    backoff: { type: "custom" },
    removeOnComplete: { age: 86_400 },
    removeOnFail: { age: 604_800 },
  },
});
```
Add `musterIngestionQueue` to the `ALL_QUEUES` array.

---

**src/lib/queue/processors/muster-ingestion.processor.ts — create new file:**
```typescript
export interface MusterIngestionJobData {
  musterId: string;
}

export async function processMusterIngestionJob(data: MusterIngestionJobData): Promise<void>
```
Implementation:
1. Load muster from DB with `prisma.muster.findUnique({ where: { id: data.musterId }, select: { nerStatus: true, name: true } })`
2. Guard: if not found or `nerStatus !== "INDEXED"`, log warning and return (no error — idempotent)
3. Call `insertMusterChunks(data.musterId)` from `@/lib/muster/ingestion` — NO content param, this is a real uploaded file that must be fetched from MinIO via extractMusterFullText
4. Log result: `log.info({ musterId, inserted }, "Muster ingestion complete")`

Also export `processMusterIngestPending(): Promise<void>` — startup sweep that re-enqueues any Muster where `nerStatus = INDEXED` and chunk count = 0:
```typescript
const stuck = await prisma.muster.findMany({
  where: { nerStatus: "INDEXED" },
  include: { _count: { select: { chunks: true } } },
});
for (const m of stuck) {
  if (m._count.chunks === 0) {
    await musterIngestionQueue.add("ingest-muster-recovery", { musterId: m.id });
  }
}
```

---

**ner-pii.processor.ts — add musterIngestionQueue trigger:**
Add import at top: `import { musterIngestionQueue } from "@/lib/queue/queues";`

In `processMusterNer()`, find the INDEXED transition block (where `prisma.muster.update({ data: { nerStatus: "INDEXED" } })` is called). After that update call, add:
```typescript
// Phase 18: trigger chunk ingestion after NER passes
await musterIngestionQueue.add("ingest-muster", { musterId });
```

Do NOT touch any other part of ner-pii.processor.ts. Only add the import and the single trigger line.

---

**worker.ts — register muster-ingestion Worker:**
Follow the exact pattern of the nerPiiWorker registration. Add:
```typescript
const musterIngestionWorker = new Worker<MusterIngestionJobData>(
  "muster-ingestion",
  async (job) => processMusterIngestionJob(job.data),
  { connection: getQueueConnection(), concurrency: 2 }
);
musterIngestionWorker.on("completed", (job) => {
  log.info({ jobId: job.id }, "muster-ingestion job completed");
});
musterIngestionWorker.on("failed", (job, err) => {
  log.error({ jobId: job?.id, err }, "muster-ingestion job failed");
});
```

Also call `processMusterIngestPending()` in the startup() try/catch block (non-fatal, same as recoverStuckNerJobs).

Add `"muster-ingestion"` to the startup log queue list (where other queues are listed in the startup log).

Finally, call `seedAmtlicheFormulare()` from `@/lib/muster/seed-amtliche` in the startup() block (non-fatal try/catch). This seeds amtliche Formulare on first boot and is idempotent thereafter.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -20 && grep -c "musterIngestionQueue" src/lib/queue/queues.ts && grep -c "musterIngestionQueue.add" src/lib/queue/processors/ner-pii.processor.ts</automated>
  </verify>
  <done>musterIngestionQueue exported in queues.ts and in ALL_QUEUES; muster-ingestion.processor.ts created with processMusterIngestionJob + processMusterIngestPending; ner-pii.processor.ts has musterIngestionQueue.add() after INDEXED transition; worker.ts registers musterIngestionWorker; tsc --noEmit exits 0</done>
</task>

<task type="auto">
  <name>Task 2: Admin UI /admin/muster page + API routes (GET/POST/DELETE/PATCH)</name>
  <files>
    src/app/(dashboard)/admin/layout.tsx
    src/app/(dashboard)/admin/muster/page.tsx
    src/app/api/admin/muster/route.ts
    src/app/api/admin/muster/[id]/route.ts
  </files>
  <action>
**admin/layout.tsx — add Muster to navigation:**
Insert `{ name: "Muster", href: "/admin/muster" }` after Pipeline in adminNavigation.

---

**src/app/api/admin/muster/route.ts:**

`GET` handler — list all Muster ordered by createdAt desc:
```typescript
prisma.muster.findMany({
  orderBy: { createdAt: "desc" },
  include: {
    uploadedBy: { select: { name: true } },
    _count: { select: { chunks: true } },
  },
})
```
Return `{ muster }` as JSON. ADMIN role required (auth() + role check).

`POST` handler — upload new kanzlei-eigenes Muster:
1. Parse `request.formData()` — extract `file: File`, `name: string`, `kategorie: string`, `beschreibung?: string`
2. Validate: file + name + kategorie required (400 if missing)
3. Validate MIME type: only `application/pdf` and `application/vnd.openxmlformats-officedocument.wordprocessingml.document` allowed — return 415 for anything else
4. `const buffer = Buffer.from(await file.arrayBuffer())`
5. Create Muster row with `isKanzleiEigen: true`, `nerStatus: "PENDING_NER"`, `minioKey: "placeholder"` (updated below), `mimeType: file.type`, `uploadedById: userId`
6. Build storage key: `muster-uploads/${muster.id}_${file.name.replace(/[^a-zA-Z0-9._-]/g, "_")}`
7. `await uploadFile(minioKey, buffer, file.type, buffer.length)`
8. Update Muster with real minioKey
9. `await nerPiiQueue.add("ner-muster", { musterId: muster.id })`
10. Return `{ muster }` with status 201

---

**src/app/api/admin/muster/[id]/route.ts:**

`DELETE` handler:
1. ADMIN role check
2. Load Muster to get minioKey
3. `await prisma.$executeRaw\`DELETE FROM muster_chunks WHERE "musterId" = ${id}\``
4. `await deleteFile(muster.minioKey)` (from storage.ts)
5. `await prisma.muster.delete({ where: { id } })`
6. Return 204

`PATCH` handler — retry NER for REJECTED or PENDING_NER muster:
1. ADMIN role check
2. Load Muster — return 404 if not found
3. If nerStatus is not REJECTED_PII_DETECTED and not PENDING_NER, return 409 with message "Nur REJECTED oder PENDING_NER können erneut geprüft werden"
4. `await prisma.muster.update({ where: { id }, data: { nerStatus: "PENDING_NER" } })`
5. `await nerPiiQueue.add("ner-muster-retry", { musterId: id })`
6. Return `{ ok: true }`

---

**src/app/(dashboard)/admin/muster/page.tsx:**

Server component (async). Mark with `"use server"` is NOT needed — it is a server component by default in App Router.

Fetch muster list from DB directly (not via API — this is a server component):
```typescript
const muster = await prisma.muster.findMany({
  orderBy: { createdAt: "desc" },
  include: { uploadedBy: { select: { name: true } }, _count: { select: { chunks: true } } },
});
```

UI structure using GlassPanel + GlassCard from `@/components/ui/glass-panel` and `@/components/ui/glass-card`:
- Page heading: "Schriftsatzmuster" with subtext "Kanzlei-eigene Muster für Helenas Schriftsatz-RAG"
- Upload section (GlassCard): simple HTML form with `action="/api/admin/muster"` method POST encType multipart/form-data
  - File input (accept=".pdf,.docx"), text inputs for name + kategorie + beschreibung
  - Submit button using Button component from `@/components/ui/button`
  - Note: form is a plain HTML form POST — no client-side JS needed for basic upload
- Muster table (GlassPanel): plain HTML `<table>` with Tailwind classes
  - Columns: Name | Kategorie | Herkunft | NER-Status | Chunks | Hochgeladen von | Datum | Aktionen
  - NER status cell: Badge component with variant and label from NER_STATUS_BADGE mapping:
    - PENDING_NER: `<Badge variant="secondary">Ausstehend</Badge>`
    - NER_RUNNING: `<Badge variant="default">PII-Prüfung läuft…</Badge>`
    - INDEXED: `<Badge variant="default" className="bg-emerald-500/10 text-emerald-700 border-emerald-200">Indiziert</Badge>`
    - REJECTED_PII_DETECTED: `<Badge variant="destructive">Abgelehnt — PII</Badge>`
  - Herkunft column: "Kanzlei-eigen" if isKanzleiEigen else "Amtlich"
  - Aktionen: for REJECTED/PENDING_NER — a form POST to /api/admin/muster/{id} with method PATCH and a "Erneut prüfen" button; for all — a form with DELETE method and "Löschen" button
  - For the delete/retry form actions, use Next.js form action patterns with hidden `_method` field OR separate route handler — simplest: two separate form buttons pointing to the correct API endpoint with appropriate fetch methods

IMPORTANT: This page does NOT need client-side state for the table. It renders server-side. Real-time NER status updates are NOT required for v0.1 — user can refresh manually. Keep the page simple.

IMPORTANT: Check that an ADMIN session exists (auth() check) — redirect to /login if unauthenticated, redirect to /dashboard if not ADMIN. Follow the same pattern as src/app/(dashboard)/admin/layout.tsx.
  </action>
  <verify>
    <automated>cd /Users/patrickbaumfalk/Projekte/AI-Lawyer && npx tsc --noEmit 2>&1 | head -20 && curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/admin/muster 2>/dev/null || echo "server not running — TypeScript check sufficient"</automated>
  </verify>
  <done>All 4 files created/modified; admin navigation includes "Muster"; tsc --noEmit exits 0; GET /api/admin/muster returns 401 (unauthenticated); POST validates MIME type returning 415 for unsupported types; DELETE + PATCH routes exist at /api/admin/muster/[id]</done>
</task>

</tasks>

<verification>
- `grep "muster-ingestion" src/worker.ts` — Worker registered
- `grep "musterIngestionQueue.add" src/lib/queue/processors/ner-pii.processor.ts` — trigger present
- `grep "seedAmtlicheFormulare" src/worker.ts` — startup seed call present
- `grep "Muster.*admin/muster" src/app/\(dashboard\)/admin/layout.tsx` — nav entry added
- `ls src/app/\(dashboard\)/admin/muster/page.tsx` — file exists
- `ls src/app/api/admin/muster/route.ts src/app/api/admin/muster/\[id\]/route.ts` — both exist
- `npx tsc --noEmit` — exits 0
</verification>

<success_criteria>
- musterIngestionQueue exported in queues.ts and present in ALL_QUEUES (visible in Bull Board)
- ner-pii.processor.ts fires musterIngestionQueue.add() after INDEXED transition
- worker.ts registers musterIngestionWorker (concurrency:2) and calls processMusterIngestPending() on startup
- worker.ts calls seedAmtlicheFormulare() on startup (idempotent via SystemSetting v0.1 check)
- /admin/muster page exists with upload form + muster table with NER status badges
- POST /api/admin/muster: uploads to MinIO muster-uploads/, creates Muster with isKanzleiEigen:true, enqueues nerPiiQueue
- DELETE /api/admin/muster/[id]: removes chunks, MinIO object, and Muster row
- PATCH /api/admin/muster/[id]: retries NER for REJECTED/PENDING_NER muster
- TypeScript clean
</success_criteria>

<output>
After completion, create `.planning/phases/18-muster-rag-admin-upload-ui/18-02-SUMMARY.md`
</output>
