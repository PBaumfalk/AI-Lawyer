---
phase: 23.1-integration-wiring-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/helena/tools/_write/update-akte-rag.ts
autonomous: true
requirements: [DRFT-06]

must_haves:
  truths:
    - "update-akte-rag tool sends Socket.IO + persisted notification after creating a HelenaDraft, matching the pattern of all 5 other write tools"
    - "Notification failure does not cause the tool to fail (fire-and-forget pattern)"
    - "Akte owner (anwaltId fallback sachbearbeiterId) receives the notification"
  artifacts:
    - path: "src/lib/helena/tools/_write/update-akte-rag.ts"
      provides: "Draft notification wiring for the 6th and final write-tool site"
      contains: "notifyDraftCreated"
  key_links:
    - from: "src/lib/helena/tools/_write/update-akte-rag.ts"
      to: "src/lib/helena/draft-notification.ts"
      via: "import { notifyDraftCreated }"
      pattern: "notifyDraftCreated"
---

<objective>
Wire `notifyDraftCreated` in the `update-akte-rag.ts` write tool -- the only write tool that is missing the notification call after `helenaDraft.create`.

Purpose: Completes DRFT-06 requirement. All 6 write-tool sites now consistently notify the Akte owner when Helena creates a draft.
Output: Modified `update-akte-rag.ts` with notification call.
</objective>

<execution_context>
@/Users/patrickbaumfalk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrickbaumfalk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Exact pattern from create-draft-dokument.ts (lines 56-67) that must be replicated -->

From src/lib/helena/draft-notification.ts:
```typescript
export async function notifyDraftCreated(draft: {
  id: string;
  akteId: string;
  userId: string;
  typ: string;
  titel: string;
}, akteAnwaltId: string | null): Promise<void>;
```

From src/lib/helena/tools/_write/update-akte-rag.ts (current state -- NO notification):
```typescript
// Line 61-77: creates helenaDraft, returns result -- missing notifyDraftCreated call
const draft = await ctx.prisma.helenaDraft.create({
  data: {
    akteId: targetAkteId,
    userId: ctx.userId,
    typ: "DOKUMENT",
    status: "PENDING",
    titel: "Vorgeschlagene Akten-Aktualisierung",
    inhalt: Object.entries(updates)
      .filter(([, v]) => v !== undefined && v !== null)
      .map(([k, v]) => `**${k}:** ${v}`)
      .join("\n"),
    meta: {
      subtype: "akte_update",
      proposedUpdates: updates,
    },
  },
});

return {
  data: {
    draftId: draft.id,
    typ: "DOKUMENT",
    proposedUpdates: updates,
    status: "PENDING",
  },
  source: { table: "helena_drafts", id: draft.id },
};
```

Pattern to replicate (from create-draft-dokument.ts lines 56-67):
```typescript
import { notifyDraftCreated } from "@/lib/helena/draft-notification";

// After helenaDraft.create:
const akte = await ctx.prisma.akte.findUnique({
  where: { id: targetAkteId },
  select: { anwaltId: true, sachbearbeiterId: true },
});
const akteAnwaltId = akte?.anwaltId ?? akte?.sachbearbeiterId ?? null;

// Fire-and-forget: notification failure must not fail the tool
notifyDraftCreated(
  { id: draft.id, akteId: targetAkteId, userId: ctx.userId, typ: draft.typ, titel: draft.titel },
  akteAnwaltId,
).catch(() => {});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire notifyDraftCreated in update-akte-rag.ts</name>
  <files>src/lib/helena/tools/_write/update-akte-rag.ts</files>
  <action>
  1. Add import at the top of the file (after existing imports):
     ```typescript
     import { notifyDraftCreated } from "@/lib/helena/draft-notification";
     ```

  2. After the `helenaDraft.create` call (line 77) and BEFORE the `return` statement (line 79), add the notification block:
     ```typescript
     // Resolve Akte owner for notification recipients
     const akte = await ctx.prisma.akte.findUnique({
       where: { id: targetAkteId },
       select: { anwaltId: true, sachbearbeiterId: true },
     });
     const akteAnwaltId = akte?.anwaltId ?? akte?.sachbearbeiterId ?? null;

     // Fire-and-forget: notification failure must not fail the tool
     notifyDraftCreated(
       { id: draft.id, akteId: targetAkteId, userId: ctx.userId, typ: draft.typ, titel: draft.titel },
       akteAnwaltId,
     ).catch(() => {});
     ```

  This is an exact copy of the pattern used in `create-draft-dokument.ts`, `create-notiz.ts`, `create-draft-frist.ts`, `create-draft-zeiterfassung.ts`, and `create-alert.ts`.

  IMPORTANT: The `.catch(() => {})` is mandatory -- notification failure must NEVER propagate to the tool result.
  </action>
  <verify>
  Run: `npx tsc --noEmit src/lib/helena/tools/_write/update-akte-rag.ts 2>&1 | head -20`
  Verify: no type errors.
  Also verify: `grep -c "notifyDraftCreated" src/lib/helena/tools/_write/*.ts` shows 6 files (all write tools now have the call).
  </verify>
  <done>
  - `update-akte-rag.ts` imports `notifyDraftCreated` from `@/lib/helena/draft-notification`
  - After `helenaDraft.create`, it resolves `akteAnwaltId` from Akte owner and calls `notifyDraftCreated` fire-and-forget
  - Pattern matches all 5 other write tools exactly
  - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `grep -c "notifyDraftCreated" src/lib/helena/tools/_write/*.ts` -- all 6 files show count >= 1
2. `npx tsc --noEmit` -- no new type errors
3. Visual diff: the notification block in update-akte-rag.ts matches create-draft-dokument.ts pattern
</verification>

<success_criteria>
- All 6 Helena write-tool sites call `notifyDraftCreated` after `helenaDraft.create`
- `update-akte-rag.ts` uses the fire-and-forget pattern (`.catch(() => {})`)
- No type errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/23.1-integration-wiring-fixes/23.1-01-SUMMARY.md`
</output>
